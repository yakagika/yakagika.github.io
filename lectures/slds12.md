---
title: ç‰¹åˆ¥è¬›ç¾©DS Ch12 ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«
description: è³‡æ–™
tags:
    - datascience
    - statistics
    - python
featured: true
date: 2025-11-04
tableOfContents: true
previousChapter: slds11.html
nextChapter: slds13.html
---

# çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°


å‰å›(Ch11)ã§ã¯ç·šå½¢ã®é‡å›å¸°ã‚’åˆ©ç”¨ã—ã¦,ã‚ã‚‹ç¨‹åº¦æ­£ç¢ºãªèª¬æ˜/äºˆæ¸¬ãŒå¯èƒ½ã¨ãªã‚Šã¾ã—ãŸ.
ã—ã‹ã—,ã“ã‚ŒãŒæœ€å–„ã®ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“.
ã¾ãŸ, ç·šå½¢å›å¸°ã§ã†ã¾ãè¡¨ã›ãªã„ã‹ã‚‰ã¨è¨€ã£ã¦,é–¢ä¿‚ãŒãªã„ã¨æ–­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“.
ã‚ˆã‚Šæ­£ç¢ºã«èª¬æ˜ã§ãã‚‹ã‚ˆã‚Šè‰¯ã„ãƒ¢ãƒ‡ãƒ«ãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™.

å‰å›ã®äº‹ä¾‹ã«å³ã—ã¦è€ƒãˆã‚‹ã¨ä¾‹ãˆã°,

::: note

- Scholarshipã®æœ‰ç„¡ã«ã‚ˆã£ã¦,ãã‚Œãã‚Œã®å‚¾ããŒç•°ãªã‚‹ã®ã§ã¯?

å¥¨å­¦é‡‘ã‚’ã‚‚ã‚‰ã£ã¦ã„ã‚‹äººã®ã»ã†ãŒãã‚‚ãã‚‚å‹‰å¼·æ™‚é–“ã‚ãŸã‚Šã®GPAã®ä¼¸ã³ç‡ãŒé«˜ã„ãªã©,å±¤ã”ã¨ã«ç•°ãªã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™.

- æ®‹å·®ã®åˆ†å¸ƒãŒæ­£è¦åˆ†å¸ƒã§ã¯ãªã„ã®ã§ã¯?

é‡å›å¸°åˆ†æã§ã¯æ®‹å·®ãŒæ­£è¦åˆ†å¸ƒã§ã‚ã‚‹ã¨ã„ã†ä»®å®šã®ã‚‚ã¨åˆ†æã‚’è¡Œã£ã¦ã„ã¾ã™ãŒ,ãã®ã‚ˆã†ãªæ¤œè¨¼ã¯è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“.

:::

åŸºæœ¬çš„ã«ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã§è¡¨ç¾ã™ã‚‹å ´åˆã«ã¯,ã‚°ãƒ©ãƒ•ã‚„ç‰¹å¾´é‡ãªã©ã‹ã‚‰è€ƒãˆã‚‰ã‚Œã‚‹å¹¾ã¤ã‹ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ãƒ»æ¯”è¼ƒæ¤œè¨ã—,æœ€å–„ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒå¿…è¦ã«ãªã‚Šã¾ã™.
ã“ã®ã‚ˆã†ãªè¡Œç‚ºã‚’ãƒ¢ãƒ‡ãƒ«é¸æŠ/çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¨ã„ã„ã¾ã™.

Ch 12ã§ã¯ã“ã®ã‚ˆã†ãª,é‡å›å¸°åˆ†æã§ã¯æ‰±ãˆãªã„ãƒ¢ãƒ‡ãƒªãƒ³ã‚°æŠ€æ³•ã¨ã—ã¦,ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã«åŸºã¥ã„ãŸä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã«é–¢ã—ã¦å­¦ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†.





# åŸºç¤çŸ¥è­˜ ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦æ¦‚è¦

å‰ç« ã¾ã§ã«æ‰±ã£ã¦ããŸ,çµ±è¨ˆçš„ä»®èª¬æ¤œå®šã‚„å›å¸°åˆ†æã¯ç„¡é™å›è©¦è¡Œã‚’è¡Œã£ãŸéš›ã«åæŸã™ã‚‹ç›¸å¯¾åº¦æ•°(**å®¢è¦³ç¢ºç‡**)ã‚’ç¢ºç‡ã®å®šç¾©ã¨ã™ã‚‹**é »åº¦ä¸»ç¾©**ã«åŸºã¥ã„ãŸçµ±è¨ˆçš„æ‰‹æ³•ã§ã™(è©³ç´°ã¯ï½¢çµ±è¨ˆå­¦å…¥é–€(ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã®çµ±è¨ˆå­¦)ï½£ãªã©ã«è­²ã‚Šã¾ã™.) ãã®ã‚ˆã†ãªå‰æã«ãŸã£ãŸçµ±è¨ˆå­¦ã‚’**ä¼çµ±çš„çµ±è¨ˆå­¦**ã¨ã‚‚å‘¼ã³ã¾ã™.

ä¸€æ–¹ã§,2000å¹´ä»£åˆé ­ã‹ã‚‰,è¨ˆç®—æ©Ÿã®æ€§èƒ½å‘ä¸Šã¨,MCMCãªã©ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é–‹ç™ºã«ã‚ˆã£ã¦,åˆ†æè€…ã®æƒ…å ±,çŸ¥è­˜,çµŒé¨“ãªã©ã«ã‚ˆã‚‹ä¸»è¦³ã«ã‚ˆã£ã¦å®šã‚ã‚‰ã‚‹**ä¸»è¦³ç¢ºç‡**ã«åŸºã¥ãç¢ºç‡çš„å®šç¾©(**ãƒ™ã‚¤ã‚ºä¸»ç¾©**)ã‚’å‰æã¨ã—ãŸæ‰‹æ³•ãŒç”¨ã„ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ.





## ãƒ™ã‚¤ã‚ºã®å®šç†

ã¾ãšã¯,ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã®ä¸­æ ¸ã¨ãªã‚‹**ãƒ™ã‚¤ã‚ºç¢ºç‡(é€†ç¢ºç‡)**,**ãƒ™ã‚¤ã‚ºã®å®šç†**ãªã©ã®åŸºç¤æ¦‚å¿µã®æ¦‚è¦ã‚’æŠŠæ¡ã—ã¾ã—ã‚‡ã†.

::: warn

ã“ã“ã§ã¯,æœ€ä½é™ã®è¨˜æ³•ã®æ„å‘³ãªã©ã«ã¤ã„ã¦æ¦‚è¦ã‚’è§£èª¬ã—ã¾ã™.
ã“ã‚Œä»¥å‰ã®åŸºæœ¬çš„ãªç¢ºç‡è¨ˆç®—ã‚„å®šç¾©ã«é–¢ã—ã¦ã¯ï½¢çµ±è¨ˆå­¦å…¥é–€ï½£, ï½¢ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã®çµ±è¨ˆå­¦ï½£ãªã©ã‚’,
ãƒ™ã‚¤ã‚ºã‚„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®è©³ç´°ã«é–¢ã—ã¦ã¯ï½¢ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹å®Ÿè·µï½£ï½¢ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã®çµ±è¨ˆå­¦å®Ÿè·µï½£ãªã©ã®è¬›ç¾©ã‚’å—è¬›ã—ã¦ä¸‹ã•ã„.

:::

ãƒ™ã‚¤ã‚ºç¢ºç‡ã‚„ãƒ™ã‚¤ã‚ºã®å®šç†ã¯,1740å¹´ä»£ã«æ•°å­¦å¥½ãã®ç‰§å¸«ã§ã‚ã£ãŸãƒˆãƒ¼ãƒã‚¹ï½¥ãƒ™ã‚¤ã‚ºã«ã‚ˆã£ã¦ã¾ã¨ã‚ã‚‰ã‚Œã¾ã—ãŸ. ãƒ™ã‚¤ã‚ºã¯,ç¥å­¦ã¸ã®èˆˆå‘³ã‹ã‚‰,ï½¢ä¸–ç•ŒãŒåŸåˆç¥ã«ã‚ˆã£ã¦ä½œã‚‰ã‚ŒãŸã“ã¨ï½£ã‚’ï½¢ç¾åœ¨ã®äº‹è±¡ï½£ã«ã‚ˆã£ã¦è¨¼æ˜ã§ãã‚‹ã‹,ã¨ã„ã†å•é¡Œã«é–¢å¿ƒã‚’å¯„ã›ã¦ã„ã¾ã—ãŸ. ãƒ™ã‚¤ã‚ºã¯ã“ã®ã‚ˆã†ãªå•é¡Œã‚’è§£ããŸã‚ã«, ä»®ã®ç¢ºç‡ã‚’ä»Šç¾åœ¨ã®æƒ…å ±ã«ã‚ˆã£ã¦æ›´æ–°ã—,éå»ã®å‡ºæ¥äº‹ã‚’æ¨æ¸¬ã™ã‚‹ã¨ã„ã†ã‚¢ã‚¤ãƒ‡ã‚¢(é€†ç¢ºç‡)ã‚’ã¾ã¨ã‚ã¾ã—ãŸ.

ã—ã‹ã—,ãƒ™ã‚¤ã‚ºè‡ªèº«ã¯ã“ã‚Œã‚’ç™ºè¡¨ã›ãš, 1763å¹´ã«ãƒªãƒãƒ£ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ©ã‚¤ã‚¹ã«ã‚ˆã£ã¦ãƒ™ã‚¤ã‚ºã®éºç¨¿ãŒç™ºè¡¨ã•ã‚ŒãŸã“ã¨ã§å†æ³¨ç›®ã•ã‚Œã¾ã—ãŸ(ã“ã®ã“ã¨ã«ã‚ˆã£ã¦è¿‘å¹´ã§ã¯,ãƒ™ã‚¤ã‚ºã®å®šç†ãŒ**ãƒ™ã‚¤ã‚ºãƒ»ãƒ—ãƒ©ã‚¤ã‚¹ã®å®šç†**ã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™.)

å¤å…¸çš„ç¢ºç‡ã®å®šç«‹ã«è²¢çŒ®ã—ãŸãƒ©ãƒ—ãƒ©ã‚¹ã‚‚åŒæ§˜ã®è¦³ç‚¹ã«æ³¨ç›®ã—ãŸæ™‚æœŸãŒã‚ã‚Š,ãƒ™ã‚¤ã‚ºã®å®šç†ã‹ã‚‰ç¢ºç‡çš„ãªæ¨è«–ã‚’å®Ÿæ–½ã™ã‚‹æ–¹æ³•ãªã©ãŒã¾ã¨ã‚ã‚‰ã‚Œã¾ã—ãŸãŒ,å½“æ™‚ã®è¨ˆç®—ãƒ»ãƒ‡ãƒ¼ã‚¿ç’°å¢ƒãªã©ã‹ã‚‰ãã‚Œä»¥ä¸Šæ·±ã‚ã‚‰ã‚Œã‚‹ã“ã¨ã¯ãªã,å¤å…¸çš„ç¢ºç‡ã«å‰‡ã£ãŸé »åº¦ä¸»ç¾©ã‚„ä¼çµ±çš„çµ±è¨ˆå­¦ãŒç™ºå±•ã—ã¦ã„ãã¾ã™.

(cf. ã‚·ãƒ£ãƒ­ãƒ³ãƒ»ãƒãƒ¼ãƒãƒ¥ ãƒã‚°ãƒ¬ã‚¤ãƒ³ (è‘—), ç•°ç«¯ã®çµ±è¨ˆå­¦ ãƒ™ã‚¤ã‚º, è‰æ€ç¤¾, 2013)

ãã‚Œã§ã¯,é€†ç¢ºç‡ã‚„ãƒ™ã‚¤ã‚ºã®å®šç†ãŒã©ã®ã‚ˆã†ãªã‚‚ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†.

### æ¡ä»¶ä»˜ãç¢ºç‡

äº‹è±¡Aã®ä¸‹ã§ã®äº‹è±¡Bã®æ¡ä»¶ä»˜ãç¢ºç‡

$$P(B|A) = \frac{P(B \cap A)}{P(A)}$$

 ã‚’å¤‰å½¢ã—ãŸ

 $$P(B \cap A) = P(A) P(B | A) $$

ã‚’ä¹—æ³•å®šç†ã¨å‘¼ã³ã¾ã™.

ã“ã®ã¨ã Aã¨Bã¯å¯¾ç§°ãªã®ã§,

 $$P(B \cap A) = P(A \cap B) = P(B) P(A | B)  $$

ã‚‚æˆã‚Šç«‹ã¡ã¾ã™.

### ãƒ™ã‚¤ã‚ºã®å®šç†

$A$ ã‚’å¾—ã‚‰ã‚ŒãŸçµæœ, $H_1,H_2,...,H_k$ ã‚’åŸå› ã¨ã—ãŸã¨ã,äº‹è±¡Aã®ä¸‹ã§ã®äº‹è±¡$H_i$ã®æ¡ä»¶ä»˜ãç¢ºç‡ã¯,

$$ P(H_i | A) = \frac{P(H_i \cap A)}{P(A)}$$

ã¨ãªã‚Šã¾ã™.

ãŸã ã—, ã“ã“ã§ $H_i$ ã¯äº’ã„ã«æ’åã§, $$ \bigcup_{i=1} H_i = \Omega $$ ã‹ã¤ $$ \sum_{i=1} P(H_i) =1 $$

ã“ã®ã¨ã,ä¹—æ³•å®šç†ã‹ã‚‰

$$ P(H_i \cap A) = P(H_i)P(A | H_i)$$

ãŒæ±‚ã¾ã‚Šã¾ã™. ã“ã‚Œã‚’ä»£å…¥ã—ã¦,

$$ P(H_i | A) = \frac{P(H_i)P(A | H_i)}{P(A)} $$

ã¨ãªã‚Š,ã“ã‚Œã‚’ãƒ™ã‚¤ã‚ºã®å®šç†ã¨ã„ã„ã¾ã™.

ã¾ãŸ,

$$ P(A) = \sum_{i=1}^{k} P(A \cap H_i) = \sum_{i=1}^{k} P(H_i)P(A|H_i) $$

ã§ã‚ã‚‹ã‹ã‚‰,

$$ P(H_i |A) = \frac{P(H_i)P(A|H_i)}{\sum_{i=1}^{k} P(H_i)P(A|H_i) }$$

ã¨è¡¨ã™å ´åˆã‚‚ã‚ã‚Šã¾ã™.

ã“ã®ã¨ã, $P(H_i)$ã‚’(AãŒèµ·ã“ã‚‹)**äº‹å‰ç¢ºç‡**,$P(H_i|A)$ã‚’(AãŒèµ·ã“ã‚‹)**äº‹å¾Œç¢ºç‡**ã¨ã„ã„ã¾ã™. ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã§ã¯ã—ã°ã—ã°äº‹å‰ç¢ºç‡ã«**ä¸»è¦³ç¢ºç‡**ãŒç”¨ã„ã‚‰ã‚Œ,ã“ã‚Œã‚’åŸºç¤ã¨ã™ã‚‹çµ±è¨ˆçš„æ–¹æ³•ã‚’**ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦**ã¨ã„ã„ã¾ã™.

::: note

- å®¢è¦³ç¢ºç‡

é »åº¦èª¬ã§ã¯ã€äº‹è±¡$A$ã®èµ·ã“ã‚‹ç¢ºç‡$P(A)$ã‚’ç”Ÿèµ·å›æ•°ã®ç›¸å¯¾é »åº¦ã§æ±‚ã‚ã¦ã„ã¾ã™.ã“ã‚Œã¯èª°ãŒè¨ˆç®—ã—ã¦ã‚‚åŒä¸€ã®å®¢è¦³çš„ãªå€¤ã¨ã„ãˆã¾ã™.

- ä¸»è¦³ç¢ºç‡

ç ”ç©¶è€…ãŒä¸»è¦³çš„ã«ã‚ã‚‹ç¢ºç‡ã‚’ä¸ãˆã¦åˆ†æã‚’è¡Œã„ã¾ã™. ã“ã®å ´åˆç¢ºç‡ã¯,ç ”ç©¶è€…ã®çµŒé¨“,æƒ…å ±,çŸ¥è­˜ã«ã‚ˆã£ã¦ç•°ãªã‚‹å€¤ãŒç”¨ã„ã‚‰ã‚Œã¾ã™.
å½“ç„¶,ä¸»è¦³ç¢ºç‡ã«ã‚ˆã£ã¦çµæœã¯ç•°ãªã‚Šã¾ã™. ãŸã ã—,å¾Œã«è¦‹ã‚‹ã‚ˆã†ã«å¤šé‡ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã£ã¦ä¸»è¦³æ€§ã‚’æ¸›ã‚‰ã›ã‚‹.


- äº‹å‰ç¢ºç‡ã¨äº‹å¾Œç¢ºç‡ã®æ„å‘³

**äº‹å‰ç¢ºç‡$P(H_i)$**ã¯,ãƒ‡ãƒ¼ã‚¿$A$ãŒè¦³æ¸¬ã•ã‚Œã‚‹**å‰**ã®,ä»®èª¬$H_i$ã«å¯¾ã™ã‚‹(ä¸»è¦³çš„ãª)ç¢ºä¿¡åº¦ã‚’è¡¨ã—ã¾ã™. ã¤ã¾ã‚Š,ãƒ‡ãƒ¼ã‚¿ã‚’è¦³æ¸¬ã™ã‚‹å‰ã«,ã©ã®ä»®èª¬ãŒçœŸã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‹ã‚’è¡¨ã™ç¢ºç‡ã§ã™.

**äº‹å¾Œç¢ºç‡$P(H_i|A)$**ã¯,ãƒ‡ãƒ¼ã‚¿$A$ãŒè¦³æ¸¬ã•ã‚ŒãŸ**å¾Œ**ã®,ä»®èª¬$H_i$ã«å¯¾ã™ã‚‹ç¢ºä¿¡åº¦ã‚’è¡¨ã—ã¾ã™. ã¤ã¾ã‚Š,ãƒ‡ãƒ¼ã‚¿$A$ãŒå¾—ã‚‰ã‚ŒãŸã¨ã„ã†æƒ…å ±ã‚’è¸ã¾ãˆãŸä¸Šã§,ã©ã®ä»®èª¬ãŒçœŸã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‹ã‚’è¡¨ã™ç¢ºç‡ã§ã™.

:::

ãƒ™ã‚¤ã‚ºã®å®šç†ã¯,äº‹å‰ç¢ºç‡ã¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰äº‹å¾Œç¢ºç‡ã‚’è¨ˆç®—ã™ã‚‹æ–¹æ³•ã‚’æä¾›ã—ã¾ã™. ã“ã®éç¨‹ã§ã¯,ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã‚‹ã“ã¨ã§,ä»®èª¬ã«å¯¾ã™ã‚‹ç¢ºä¿¡åº¦ãŒæ›´æ–°ã•ã‚Œã¾ã™. ä¾‹ãˆã°,äº‹å‰ç¢ºç‡ãŒä½ã‹ã£ãŸä»®èª¬ã§ã‚‚,ãƒ‡ãƒ¼ã‚¿ãŒãã®ä»®èª¬ã‚’æ”¯æŒã™ã‚‹ã‚‚ã®ã§ã‚ã‚Œã°,äº‹å¾Œç¢ºç‡ã¯é«˜ããªã‚Šã¾ã™. é€†ã«,äº‹å‰ç¢ºç‡ãŒé«˜ã‹ã£ãŸä»®èª¬ã§ã‚‚,ãƒ‡ãƒ¼ã‚¿ãŒãã®ä»®èª¬ã¨çŸ›ç›¾ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Œã°,äº‹å¾Œç¢ºç‡ã¯ä½ããªã‚Šã¾ã™.

æ¡ä»¶ä»˜ãç¢ºç‡ã®ç¯„å›²ã§ã¯, ï½¢åŸå› ã‹ã‚‰çµæœã®ç¢ºç‡ã‚’è¨ˆç®—ï½£ã—ã¾ã™ãŒ,ãƒ™ã‚¤ã‚ºã®å®šç†ã§ã¯çµæœã‹ã‚‰åŸå› ã‚’è€ƒãˆã¦ã„ã¾ã™.


### æ¡ä»¶ä»˜ãç¢ºç‡

äº‹è±¡AãŒèµ·ã“ã£ãŸã¨åˆ†ã‹ã£ã¦ã„ã‚‹å ´åˆã«äº‹è±¡Bã®èµ·ã“ã‚‹ç¢ºç‡

$$ P(B|A) = \frac{P(A \cap B)}{P(A)}$$

ä¾‹:é¸ã°ã‚ŒãŸå£ºã‹ã‚‰å‡ºã‚‹ãŸã¾ã®ç¢ºç‡ã‚’è¨ˆç®—

å£ºã«ç™½,èµ¤ãã‚Œãã‚Œ3ã¤ã®ç‰ãŒå…¥ã£ã¦ã„ã‚‹.ç™½ç‰ã«ã¯1,1,2ã¨æ•°å­—,èµ¤ç‰ã«ã¯1,2,2ã¨æ•°å­—ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹.
æ¬¡ã«å‡ºã‚‹ç‰ãŒç™½ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã«1ã®ç‰ãŒã§ã‚‹ç¢ºç‡ã¯?

![](/images/slds/ch12/conditional_probability.png)

$$
P(1 | ç™½) = \frac{ç™½ \cap 1}{P(ç™½)} = \frac{2 / 6}{ 1/ 2} = \frac{2}{3}
$$


ğ‘ƒ(ç‰ã®è‰²|é¸ã‚“ã å£º)ã§ã‚ã‚Š, ğ‘ƒ(çµæœ|åŸå› )ã®è¨ˆç®—

### ãƒ™ã‚¤ã‚ºç¢ºç‡

äº‹è±¡BãŒèµ·ã“ã£ãŸã¨åˆ†ã‹ã£ã¦ã„ã‚‹å ´åˆã«,äº‹è±¡AãŒèµ·ãã¦ã„ã‚‹ç¢ºç‡

$$ P(H_i | A) = \frac{P(H_i)P(A | H_i)}{P(A)} $$

ä¾‹. å‡ºãŸç‰ã‹ã‚‰å£ºãŒé¸ã°ã‚Œã¦ã„ã‚‹ç¢ºç‡ã‚’è¨ˆç®—

2ã¤ã®å£ºãŒã‚ã‚Š,

- ç¬¬1ã®å£ºã«ã¯ç™½ç‰ãŒ3å€‹,é»’ç‰ãŒ1å€‹

- ç¬¬2ã®å£ºã«ã¯ç™½ç‰ãŒ1å€‹,é»’ç‰ãŒï¼’å€‹

- $ğ»_1$:ç¬¬1ã®å£ºã‹ã‚‰å–ã‚Šå‡ºã™

- $ğ»_2$:ç¬¬2ã®å£ºã‹ã‚‰å–ã‚Šå‡ºã™

- $A$:ç™½ç‰ãŒå‡ºãŸã¨ã„ã†äº‹è±¡

ã¨ã™ã‚‹ã¨,ã„ãšã‚Œã‹ã®å£ºã‹ã‚‰ç‰ã‚’1å€‹å–ã‚Šå‡ºã—ãŸã¨ã“ã‚ç™½ç‰ã§ã‚ã£ãŸ,ã©ã¡ã‚‰ã®å£ºã‹ã‚‰å–ã‚Šå‡ºã—ãŸç¢ºç‡ãŒé«˜ã„ã‹.

![](/images/slds/ch12/beys_example.png)

ã¾ãš,ã©ã¡ã‚‰ã®å£ºã‹ã‚‰å–ã‚Šå‡ºã™ã‹ã¯**äº”åˆ†äº”åˆ†**ã§ã‚ã‚‹ã¨ä»®å®šã™ã‚‹. ã“ã“ã§ã“ã®ä»®å®šãŒå®Œå…¨ã«åˆ†æè€…ã®ä¸»è¦³ã«åŸºã¥ãã®ã§ã‚ã‚Œã°**ä¸»è¦³ç¢ºç‡**ã§ã‚ã‚Š,ä½•ã‚‰ã‹ã®å®Ÿé¨“ç­‰ã«ã‚ˆã£ã¦ç¢ºç‡0.5ã§ã‚ã‚‹ã¨ç¢ºã‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯**å®¢è¦³ç¢ºç‡**ã¨ã¿ãªã•ã‚Œã‚‹.

$$P(H_1) = P(H_2) = \frac{1}{2}$$

$$P(A|H_1) = \frac{3}{4}, \quad P(A|H_2) = \frac{1}{3}$$

ã§ã‚ã‚‹ã‹ã‚‰,

$$P(H_1|A) = \frac{\frac{1}{2} \cdot \frac{3}{4}}{\frac{1}{2} \cdot \frac{3}{4} + \frac{1}{2} \cdot \frac{1}{3}} = \frac{9}{13}$$

$$P(H_2|A) = \frac{\frac{1}{2} \cdot \frac{1}{3}}{\frac{1}{2} \cdot \frac{3}{4} + \frac{1}{2} \cdot \frac{1}{3}} = \frac{4}{13}$$

ã“ã®ï½¢$H_1$ã®å£ºãŒé¸ã°ã‚Œã¦ã„ã‚‹ï½£ã¨ã„ã†çµæœã¯,å£ºãŒé¸ã°ã‚Œã‚‹ç¢ºç‡ãŒç­‰ã—ã„ã¨ã„ã†ä¸»è¦³ç¢ºç‡ãŒæ­£ã—ã‘ã‚Œã°æ­£ã—ã„ã¨è¨€ãˆã¾ã™.

ã“ã®äº‹ä¾‹ã§è¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã®ã¯ ğ‘ƒ(é¸ã‚“ã å£º|ç‰ã®è‰²) ã§ã‚ã‚Š, ğ‘ƒ(åŸå› |çµæœ)ã¨ã„ã†è¨ˆç®—ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™.


ã“ã®ã‚ˆã†ã«äº‹ä¾‹ã‚’è¦‹ã¦ã¿ã‚‹ã¨, ä¸»è¦³ç¢ºç‡ã‚’åˆ©ç”¨ã—ãŸè¨ˆç®—ã¯,ä¸»è¦³ç¢ºç‡ã®æ­£ã—ã•ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã‚ã¾ã‚Šå®Ÿç”¨æ€§ãŒã‚ã‚‹ã‚ˆã†ã«ã¯æ€ãˆã¾ã›ã‚“.
ãã“ã§é‡è¦ã«ãªã£ã¦ãã‚‹ã®ãŒ,**ãƒ™ã‚¤ã‚ºæ›´æ–°**ã¨ã„ã†æ¦‚å¿µã§ã™.

## ãƒ™ã‚¤ã‚ºæ›´æ–°

### ç‹¬ç«‹æ€§

äº‹è±¡$A$ã®èµ·ã“ã‚‹ç¢ºç‡ãŒä»–ã®äº‹è±¡$B$ã«å½±éŸ¿ã•ã‚Œãªã„å ´åˆ,äº‹è±¡$A$ã¨äº‹è±¡$B$ã¯**ç‹¬ç«‹ã§ã‚ã‚‹**ã¨ã„ã†.

ã“ã®ã¨ã

$$P(A) = P(A|B)$$

ãŒæˆã‚Šç«‹ã¡ã¾ã™. ä¹—æ³•å®šç† $P(A \cap B) = P(B)P(A|B)$ ã‚ˆã‚Š,

$$P(A \cap B) = P(A)P(B)$$

ãŒæˆã‚Šç«‹ã¤.

**ä¾‹:** ã‚µã‚¤ã‚³ãƒ­ã‚’2å›æŠ•ã’ã¦é€£ç¶šã§1ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ã‚’è€ƒãˆã‚‹.

- äº‹è±¡$A$: 1å›ç›®1ãŒå‡ºã‚‹
- äº‹è±¡$B$: 2å›ç›®1ãŒå‡ºã‚‹

$$P(A \cap B) = \frac{1}{36}, \quad P(A) \cdot P(B) = \frac{1}{6} \cdot \frac{1}{6} = \frac{1}{36}$$

ãªã®ã§,äº‹è±¡$A$ã¨$B$ã¯ç‹¬ç«‹ã¨ã„ãˆã‚‹.


ãƒ™ã‚¤ã‚ºã®ç›®çš„ã¯,è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦äº‹å¾Œç¢ºç‡ã®æ¨å®šã‚’æ›´æ–°ã—ã¦ã„ãã“ã¨ã«ã‚ã‚Šã¾ã™.

### è¤‡æ•°ã®äº‹è±¡ã‹ã‚‰ãªã‚‹æ¡ä»¶ä»˜ãç¢ºç‡

è¤‡æ•°ã®äº‹è±¡$A, B, C$ãŒã‚ã‚‹å ´åˆã®æ¡ä»¶ä»˜ãç¢ºç‡ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ã•ã‚Œã¾ã™.

$$P(B \cap C | A) = \frac{P(A \cap B \cap C)}{P(A)}$$

ã“ã®å¼ã¯,ä¹—æ³•å®šç†(ç©ã®æ³•å‰‡)ã«ã‚ˆã‚Šä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™.

$$\Leftrightarrow P(A \cap B \cap C) = P(B \cap C | A)P(A)$$

åŒæ§˜ã«,$A$ãŒ$B \cap C$ã®æ¡ä»¶ä¸‹ã§èµ·ã“ã‚‹ç¢ºç‡ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™.

$$P(A | B \cap C) = \frac{P(A \cap B \cap C)}{P(B \cap C)}$$

ã“ã‚Œã‚‚ç©ã®æ³•å‰‡ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™.

$$\Leftrightarrow P(A \cap B \cap C) = P(A | B \cap C)P(B \cap C)$$

ã“ã‚Œã‚‰ã®å¼ã‚’ä»£å…¥ã—ã¦æ•´ç†ã™ã‚‹ã¨,ä»¥ä¸‹ã®é–¢ä¿‚ãŒå¾—ã‚‰ã‚Œã¾ã™.

$$P(A | B \cap C) = \frac{P(B \cap C | A)P(A)}{P(B \cap C)}$$

### ãƒ™ã‚¤ã‚ºæ›´æ–°ã®é©ç”¨

åŸå› $H$ã¨,ç¾åœ¨ã®çŠ¶æ³$B, C$ãŒã‚ã‚‹ã¨ã,äº‹å¾Œç¢ºç‡$P(H | B \cap C)$ã¯ãƒ™ã‚¤ã‚ºã®å®šç†ã«ã‚ˆã‚Šä»¥ä¸‹ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã¾ã™.

$$P(H | B \cap C) = \frac{P(B \cap C | H)P(H)}{P(B \cap C)}$$

ã‚‚ã—äº‹è±¡$B$ã¨$C$ãŒç‹¬ç«‹ã§ã‚ã‚Œã°,æ¡ä»¶ä»˜ãç¢ºç‡$P(B \cap C | H)$ã¯$P(B | H)P(C | H)$ã¨ãªã‚Š,åˆ†æ¯ã®$P(B \cap C)$ã¯$P(B)P(C)$ã¨ãªã‚Šã¾ã™. ã•ã‚‰ã«,$P(H | C) = \frac{P(C | H)P(H)}{P(C)}$ã®é–¢ä¿‚ã‚’åˆ©ç”¨ã™ã‚‹ã¨,ä¸Šè¨˜ã®å¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰å½¢ã§ãã¾ã™.

$$P(H | B \cap C) = \frac{P(B | H)P(C | H)P(H)}{P(B)P(C)} = \frac{P(B | H)P(H | C)}{P(B)}$$

ã“ã“ã§,æƒ…å ±$C$ã«ã‚ˆã£ã¦æ—¢ã«æ±‚ã‚ã‚‰ã‚ŒãŸäº‹å¾Œç¢ºç‡$P(H | C)$ã‚’æ–°ã—ã„äº‹å‰ç¢ºç‡$P(H)^*$ã¨ã™ã‚‹ã¨,ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å¼ã¯ã‚ˆã‚Šç°¡æ½”ã«è¡¨ç¾ã§ãã¾ã™.

$$P(H | B \cap C) = \frac{P(B | H)P(H)^*}{P(B)}$$

ã“ã®æ–¹æ³•ã«ã‚ˆã‚Š,æƒ…å ±ãŒä¸ãˆã‚‰ã‚Œã‚‹ãŸã³ã«äº‹å¾Œç¢ºç‡ã‚’è¨ˆç®—ã—,ãã‚Œã‚’æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹äº‹å‰åˆ†å¸ƒã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã§,åˆ†å¸ƒã®æ¨å®šã‚’é€æ¬¡çš„ã«æ›´æ–°ã—ã¦ã„ãã“ã¨ãŒã§ãã¾ã™.

### ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã®æ€§è³ª

äº‹å‰ç¢ºç‡ã«é–¢ã™ã‚‹æƒ…å ±ãŒãªã,$P(H)$ãŒå®Œå…¨ã«ä¸»è¦³çš„ã«æ±ºã‚ã‚‰ã‚ŒãŸã¨ã—ã¦ã‚‚,ãƒ‡ãƒ¼ã‚¿ ($A,B,C, \dots$)ãŒå¤§é‡ã«ã‚ã‚‹å ´åˆã¯,

$$P(H|A \cap B \cap C \cap D \dots) = \frac{P(A \cap B \cap C \cap D \dots|H) P(H)}{P(A \cap B \cap C \cap D \dots)}$$

ä»¥ä¸‹ã®ã‚ˆã†ã«æ®µéšçš„ã«æ›´æ–°ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™.

ã¾ãš,ãƒ‡ãƒ¼ã‚¿$A$ãŒå¾—ã‚‰ã‚ŒãŸã¨ã:

$$P(H|A) = \frac{P(A|H)P(H)}{P(A)}$$

æ¬¡ã«,ãƒ‡ãƒ¼ã‚¿$B$ãŒå¾—ã‚‰ã‚ŒãŸã¨ã,å‰ã®äº‹å¾Œç¢ºç‡$P(H|A) = \frac{P(A|H)P(H)}{P(A)} = P(H)^*$ ã‚’æ–°ã—ã„äº‹å‰ç¢ºç‡ã¨ã—ã¦åˆ©ç”¨:

$$P(H|A \cap B) = \frac{P(B|H)P(H|A)}{P(B)} = \frac{P(B|H)P(H)^*}{P(B)} $$

ã•ã‚‰ã«,ãƒ‡ãƒ¼ã‚¿$C$ãŒå¾—ã‚‰ã‚ŒãŸã¨ã,å‰ã®äº‹å¾Œç¢ºç‡$P(H|A \cap B) = P(H)^{**}$ã‚’æ–°ã—ã„äº‹å‰ç¢ºç‡ã¨ã—ã¦åˆ©ç”¨:

$$P(H|A \cap B \cap C) = \frac{P(C|H)P(H)^{**}}{P(C)} $$

ã“ã®ã‚ˆã†ã«,ãƒ‡ãƒ¼ã‚¿$D, E, \dots$ãŒå¾—ã‚‰ã‚Œã‚‹ãŸã³ã«,å‰ã®äº‹å¾Œç¢ºç‡ã‚’äº‹å‰ç¢ºç‡ã¨ã—ã¦åˆ©ç”¨ã—ã¦æ›´æ–°ã‚’ç¶šã‘ã¦ã„ãã¾ã™. ãƒ‡ãƒ¼ã‚¿( $A,B,C,D, \dots$ )ã‚’å¤§é‡ã«é›†ã‚ã‚Œã°,æœ€åˆã«è¨­å®šã—ãŸäº‹å‰ç¢ºç‡$P(H)$ã®å½±éŸ¿ãŒå°‘ãªããªã‚Š,äº‹å¾Œç¢ºç‡ $P(H|A \cap B \cap C \cap D \dots)$ãŒå®‰å®šã™ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™. 


::: note

ã“ã®æ€§è³ªã¯,**ãƒ™ã‚¤ã‚ºçš„ä¸€è‡´æ€§(Bayesian consistency)**ã¨å‘¼ã°ã‚Œã¾ã™. å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ€§è³ªãŒæˆã‚Šç«‹ã¡ã¾ã™:

- **ä¸€è‡´æ€§**: ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã¦,äº‹å¾Œç¢ºç‡åˆ†å¸ƒã¯çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã«åæŸã—ã¾ã™. ã¤ã¾ã‚Š,ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºãŒç„¡é™å¤§ã«è¿‘ã¥ãã¨,äº‹å¾Œç¢ºç‡ã¯çœŸã®å€¤ã«é›†ä¸­ã—ã¦ã„ãã¾ã™.

- **äº‹å¾Œç¢ºç‡ã®å®‰å®šæ€§**: ç•°ãªã‚‹äº‹å‰åˆ†å¸ƒã‹ã‚‰å‡ºç™ºã—ã¦ã‚‚,ãƒ‡ãƒ¼ã‚¿ãŒååˆ†ã«å¤šã‘ã‚Œã°,æœ€çµ‚çš„ãªäº‹å¾Œåˆ†å¸ƒã¯ã»ã¼åŒã˜çµæœã«ãªã‚Šã¾ã™. ã“ã‚Œã¯,ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã¦,å°¤åº¦é–¢æ•°$P(A \cap B \cap C \cap D \dots|H)$ã®å½±éŸ¿ãŒäº‹å‰ç¢ºç‡$P(H)$ã®å½±éŸ¿ã‚’ä¸Šå›ã‚‹ãŸã‚ã§ã™.

- **äº‹å‰ç¢ºç‡ã®å½±éŸ¿ã®æ¸›å°‘**: ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ã¨ãã¯äº‹å‰ç¢ºç‡$P(H)$ã®é¸æŠãŒçµæœã«å¤§ããå½±éŸ¿ã—ã¾ã™ãŒ,ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã¦,ãã®å½±éŸ¿ã¯ç›¸å¯¾çš„ã«å°ã•ããªã‚Šã¾ã™. æœ€çµ‚çš„ã«ã¯,ãƒ‡ãƒ¼ã‚¿ã®æƒ…å ±ãŒæ”¯é…çš„ã«ãªã‚Š,äº‹å‰ç¢ºç‡ã®é¸æŠãŒçµæœã«ä¸ãˆã‚‹å½±éŸ¿ã¯é™å®šçš„ã«ãªã‚Šã¾ã™.

:::

ã—ã‹ã—,ã“ã®ã‚ˆã†ãªæ›´æ–°ã«ã¯å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã«åŠ ãˆã¦,ãƒ‡ãƒ¼ã‚¿ã”ã¨ã«åˆ†å¸ƒã‚’æ¨å®šã—ç›´ã™ã«ã¯è†¨å¤§ãªè¨ˆç®—ãŒå¿…è¦ã¨ãªã‚‹ãŸã‚, ãƒ©ãƒ—ãƒ©ã‚¹ã‚‰ã®æ™‚ä»£ã«ã¯ç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ.

ç¾ä»£ã§ã¯, æƒ…å ±é€šä¿¡æŠ€è¡“ã®ç™ºå±•ã«ã‚ˆã£ã¦å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã¨,å¤§é‡ã®è¨ˆç®—ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸ.ã¾ãŸ,è¨ˆç®—ã®ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ (ãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ãªã©)ãŒç™ºæ˜ã•ã‚ŒãŸã“ã¨ã§,ãƒ™ã‚¤ã‚ºæ›´æ–°ã«åŸºã¥ãæ¨å®šãŒç¾å®Ÿçš„ãªé¸æŠè‚¢ã¨ãªã‚Šãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™.

## ãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•

### å°¤åº¦(Likelihood)

å°¤åº¦ã¨ã¯,ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã¸ã®å½“ã¦ã¯ã¾ã‚Šã®è‰¯ã•ã‚’è¡¨ã™çµ±è¨ˆé‡ã§ã™.

- $\theta$ã‚’æ¯æ•°ã¨ã™ã‚‹ç¢ºç‡åˆ†å¸ƒã‹ã‚‰è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿$y_i$ãŒç™ºç”Ÿã—ãŸå ´åˆ,ãã®ç¢ºç‡ã¯$P(y_i|\theta)$ã¨è¡¨ã•ã‚Œã¾ã™.
- å°¤åº¦$L(\theta|Y)$ã¯,è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿$Y = \{y_1, y_2, \dots, y_n\}$ãŒä¸ãˆã‚‰ã‚ŒãŸã¨ãã®,ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã®ã€Œã‚‚ã£ã¨ã‚‚ã‚‰ã—ã•ã€ã‚’ç¤ºã™é–¢æ•°ã§,ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™.

$$L(\theta|Y) = \prod_{i} P(y_i|\theta)$$

å°¤åº¦ã¯ãã®ã¾ã¾ã§ã¯è¨ˆç®—ã—ã«ãã„å ´åˆãŒå¤šã„ãŸã‚,å¯¾æ•°åŒ–ã—ãŸå¯¾æ•°å°¤åº¦ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™.

$$\log L(\theta|Y) = \sum_{i} \log P(y_i|\theta)$$

å‰æ®µã§èª¬æ˜ã—ãŸãƒ™ã‚¤ã‚ºæ›´æ–°ã¨å°¤åº¦ã«ã¯å¯†æ¥ãªé–¢ä¿‚ãŒã‚ã‚Šã¾ã™.

ãƒ™ã‚¤ã‚ºã®å®šç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ã•ã‚Œã¾ã—ãŸ:

$$P(H|A) = \frac{P(A|H)P(H)}{P(A)}$$

ã“ã®å¼ã«ãŠã„ã¦,$P(A|H)$ã¯ã€Œä»®èª¬$H$ãŒçœŸã§ã‚ã‚‹ã¨ãã«ãƒ‡ãƒ¼ã‚¿$A$ãŒè¦³æ¸¬ã•ã‚Œã‚‹ç¢ºç‡ã€ã§ã‚ã‚Š,ã“ã‚Œã¯**å°¤åº¦é–¢æ•°**ã«å¯¾å¿œã—ã¾ã™.

ä¸€èˆ¬çš„ãªå°¤åº¦ã®èª¬æ˜ã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’$\theta$ã§è¡¨ã—ã¾ã—ãŸãŒ,ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã§ã¯ä»®èª¬$H$ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã¿ãªã™ã“ã¨ãŒã§ãã¾ã™. è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿$Y = \{y_1, y_2, \dots, y_n\}$ãŒå¾—ã‚‰ã‚ŒãŸå ´åˆ,ãƒ™ã‚¤ã‚ºã®å®šç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:

$$P(H|Y) = \frac{P(Y|H)P(H)}{P(Y)} = \frac{L(H|Y)P(H)}{P(Y)}$$

ã“ã“ã§,$P(Y|H) = \prod_{i} P(y_i|H)$ã¯å°¤åº¦é–¢æ•°$L(H|Y) = \prod_{i} P(y_i|H)$ã¨ä¸€è‡´ã—ã¾ã™. ã—ãŸãŒã£ã¦,ãƒ™ã‚¤ã‚ºã®å®šç†ã¯å°¤åº¦é–¢æ•°ã‚’ç”¨ã„ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¾ã§ãã¾ã™:

$$P(H|Y) \propto L(H|Y)P(H)$$

ã¤ã¾ã‚Š,äº‹å¾Œç¢ºç‡ã¯ã€Œå°¤åº¦Ã—äº‹å‰ç¢ºç‡ã€ã«æ¯”ä¾‹ã—ã¾ã™. ã“ã®é–¢ä¿‚ã‹ã‚‰ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™:

- å°¤åº¦$L(H|Y)$ãŒå¤§ãã„ã»ã©,ãã®ä»®èª¬$H$ã®äº‹å¾Œç¢ºç‡$P(H|Y)$ã‚‚å¤§ãããªã‚Šã¾ã™.
- ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã¦,å°¤åº¦é–¢æ•°ã®å½±éŸ¿ãŒäº‹å‰ç¢ºç‡ã®å½±éŸ¿ã‚’ä¸Šå›ã‚Š,äº‹å¾Œç¢ºç‡ãŒå®‰å®šã—ã¦ã„ãã¾ã™.
- ãƒ™ã‚¤ã‚ºæ›´æ–°ã§ã¯,æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã‚‹ãŸã³ã«å°¤åº¦é–¢æ•°ã‚’è¨ˆç®—ã—,ãã‚Œã¨äº‹å‰ç¢ºç‡ã‚’çµ„ã¿åˆã‚ã›ã¦äº‹å¾Œç¢ºç‡ã‚’æ›´æ–°ã—ã¦ã„ãã¾ã™.

### æœ€å°¤æ¨å®š (Maximum Likelihood Estimation)

ã“ã®å¯¾æ•°å°¤åº¦ã‚’æœ€å¤§ã«ã™ã‚‹ã‚ˆã†ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¨å®šé‡$\hat{\theta}$ã‚’æ¨å®šã™ã‚‹ã“ã¨ã‚’**æœ€å°¤æ¨å®š**ã¨ã„ã„ã¾ã™.

$\hat{\theta}$ã¯æ•°ç†çš„ã«æ±‚ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ãªå ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒ,ãƒ¢ãƒ‡ãƒ«ãŒè¤‡é›‘ãªå ´åˆã¯å›°é›£ãªã®ã§æ©Ÿæ¢°çš„ã«æ±‚ã‚ã‚‹ã“ã¨ãŒå¤šã,ãã®æ‰‹æ³•ã®ä»£è¡¨çš„ãªã‚‚ã®ãŒãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•(MCMC)ã§ã™.

### ãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³• MCMC(Markov chain Monte Carlo Method)

å‰æ®µã§èª¬æ˜ã—ãŸãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã«ãŠã„ã¦,äº‹å¾Œç¢ºç‡$P(H|Y) \propto L(H|Y)P(H)$ã‚’è¨ˆç®—ã™ã‚‹ã«ã¯,åˆ†æ¯ã®æ­£è¦åŒ–å®šæ•°$P(Y)$ã‚’æ±‚ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™. ã—ã‹ã—,ãƒ¢ãƒ‡ãƒ«ãŒè¤‡é›‘ãªå ´åˆã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¤šå¤‰æ•°ã®å ´åˆ,ã“ã®æ­£è¦åŒ–å®šæ•°ã®è¨ˆç®—ã¯è§£æçš„ã«å›°é›£ã§ã™. ã¾ãŸ,æœ€å°¤æ¨å®šã«ãŠã„ã¦ã‚‚,è§£æçš„ã«æœ€å°¤æ¨å®šé‡$\hat{\theta}$ãŒæ±‚ã‚ã‚‰ã‚Œãªã„(é›£ã—ã„)å ´åˆãŒã‚ã‚Šã¾ã™.

ã“ã®ã‚ˆã†ãªå ´åˆã«ç”¨ã„ã‚‰ã‚Œã‚‹ã®ãŒ,è¨ˆç®—æ©Ÿã«ã‚ˆã‚‹ç¹°ã‚Šè¿”ã—è¨ˆç®—ã§å°‘ã—ãšã¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å€¤ã‚’å¤‰åŒ–ã•ã›,æœ€é©ãªå€¤ã‚’æ¢ã—å‡ºã™æ–¹æ³•ã§ã‚ã‚‹**ãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•(MCMC)**ã§ã™.

::: note

- MCMCã®åŸºæœ¬çš„ãªä»•çµ„ã¿

MCMCã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã§å‹•ä½œã—ã¾ã™:

1. **åˆæœŸå€¤ã®è¨­å®š**: è¤‡æ•°ã®åˆæœŸå€¤$\theta$ã‚’é©å½“ã«æ±ºã‚ã¾ã™.

2. **ãƒ©ãƒ³ãƒ€ãƒ ãªæ¢ç´¢**: ãƒ©ãƒ³ãƒ€ãƒ ã«$\theta$ã‚’å°‘ã—å¢—æ¸›ã•ã›ã¾ã™.

3. **å°¤åº¦ã®è©•ä¾¡**: æ–°ã—ã„$\theta$ã®å€¤ã§ã®å°¤åº¦ã‚’è¨ˆç®—ã—,å‰ã®å€¤ã¨æ¯”è¼ƒã—ã¾ã™.

4. **ç§»å‹•ã®æ±ºå®š**: å°¤åº¦ãŒæ”¹å–„ã—ãŸã‚‰,$\theta$ã‚’ãã®æ–¹å‘ã«ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™. ãŸã ã—,**ãƒ¡ãƒˆãƒ­ãƒãƒªã‚¹æ³•**ãªã©ã®æ‰‹æ³•ã§ã¯,ãŸã¾ã«å°¤åº¦ãŒæ‚ªããªã£ã¦ã‚‚ä¸€å®šã®ç¢ºç‡ã§ãã¡ã‚‰ã«é€²ã‚€ã“ã¨ã§,å±€æ‰€æœ€é©è§£ã«é™¥ã‚‹ã“ã¨ã‚’é˜²ãã¾ã™.

5. **ç¹°ã‚Šè¿”ã—**: ã“ã®éç¨‹ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’æ¢ç´¢ã—,æœ€å°¤æ¨å®šé‡ã‚„äº‹å¾Œåˆ†å¸ƒã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™.

![](/images/slds/ch12/mcmc.png)

:::

MCMCã«ã‚ˆã‚Š,ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã«ãŠã‘ã‚‹è¤‡é›‘ãªäº‹å¾Œåˆ†å¸ƒã®æ¨å®šã‚„,æœ€å°¤æ¨å®šã«ãŠã‘ã‚‹å›°é›£ãªæœ€é©åŒ–å•é¡Œã‚’,è¨ˆç®—æ©Ÿä¸Šã§åŠ¹ç‡çš„ã«è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ.

# ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã«ã‚ˆã‚‹çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å®Ÿè·µ

ãã‚Œã§ã¯,å®Ÿéš›ã«ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã«åŸºã¥ã„ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã—ã¦ã¿ã¾ã—ã‚‡ã†.
å‰ç« ã§é‡å›å¸°ã§å®Ÿæ–½ã—ãŸã‚‚ã®ã¨è‰¯ãä¼¼ãŸ[ã“ã¡ã‚‰ã®ãƒ‡ãƒ¼ã‚¿](https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/ch12/hierarchical_regression.csv)ã‚’äº‹ä¾‹ã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™.

| GPA | Scholarship | Study_Hours | Sports_hours | Part_time_Work | StudentID |
|-----|-------------|-------------|--------------|----------------|-----------|
| 1.348928 | True | 10.348188 | 5.398119 | 14.944201 | 0 |
| 1.968662 | False | 8.803971 | 3.799566 | 15.340118 | 1 |
| 2.246881 | True | 10.367043 | 5.139604 | 19.937536 | 2 |
| 1.167275 | True | 2.049724 | 4.229373 | 21.009315 | 3 |
| 3.295929 | True | 9.121312 | 5.227035 | 14.271377 | 4 |
| ... | ... | ... | ... | ... | ... |
| 0.974230 | False | 4.256551 | 0.396158 | 13.299289 | 185 |
| 2.208293 | False | 14.652655 | 1.969618 | 10.523032 | 186 |
| 0.786660 | False | 10.040932 | 7.733749 | 13.232559 | 187 |
| 2.068987 | True | 6.073965 | 8.289935 | 13.540597 | 188 |
| 2.531604 | True | 11.848414 | 4.501928 | 11.335318 | 189 |

å„è‡ªã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ©ç”¨ã—ã¦ä¸‹ã•ã„.


## é‡å›å¸°ã§ã®çµæœç¢ºèª

ã¾ãšã¯,ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’è¡Œã„ã¾ã™. å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯å„è‡ªã§ `pip install`ã—ã¦ãã ã•ã„.

~~~ py
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import statsmodels.api as sm
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error



df = pd.read_csv('hierarchical_regression.csv'
                ,dtype={'GPA': float
                       ,'Scholarship': bool
                       ,'Study_Hours': float
                       ,'Sports_hours': float
                       ,'Part_time_Work': float
                       ,'StudentID':int})

print(df)

"""
          GPA  Scholarship  Study_Hours  Sports_hours  Part_time_Work  StudentID
0    1.348928         True    10.348188      5.398119       14.944201          0
1    1.968662        False     8.803971      3.799566       15.340118          1
2    2.246881         True    10.367043      5.139604       19.937536          2
3    1.167275         True     2.049724      4.229373       21.009315          3
4    3.295929         True     9.121312      5.227035       14.271377          4
..        ...          ...          ...           ...             ...        ...
185  0.974230        False     4.256551      0.396158       13.299289        185
186  2.208293        False    14.652655      1.969618       10.523032        186
187  0.786660        False    10.040932      7.733749       13.232559        187
188  2.068987         True     6.073965      8.289935       13.540597        188
189  2.531604         True    11.848414      4.501928       11.335318        189
"""

~~~

ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¾ã™.

~~~ py

# ãƒšã‚¢ãƒ—ãƒ­ãƒƒãƒˆ
sns.pairplot(df
            ,vars=["GPA", "Study_Hours", "Sports_hours", "Part_time_Work"]
            ,hue="Scholarship"
            ,diag_kind="hist")
plt.suptitle("Pairplot with Scholarship", y=1.02)
plt.savefig('PairplotwithScholarship.png')
plt.close()

#joinplotã§ç”·å¥³åˆ¥ã«å¯†åº¦ãƒ—ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤º
fig = sns.jointplot(df
               ,x ="Study_Hours"
               ,y ="GPA"
               ,hue='Scholarship'
               ,joint_kws = dict(alpha=0.5))
plt.savefig('kde.png')
plt.close()
~~~


![](/images/slds/ch12/PairplotwithScholarship.png)

ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã¨æ¦‚ã­ä¼¼ãŸå‚¾å‘(å¥¨å­¦é‡‘ã‚ã‚ŠãŒå°‘ã—é«˜ã„,å‹‰å¼·æ™‚é–“ã¨GPAã«ç›¸é–¢,å‹‰å¼·æ™‚é–“ã¨ãƒã‚¤ãƒˆæ™‚é–“ã«è² ã®ç›¸é–¢ãªã©,)ãŒç¢ºèªã§ãã¾ã™.
ãŸã ã—,å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã¨æ¯”ã¹ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã®ã°ã‚‰ã¤ããŒå¤§ãã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.

![](/images/slds/ch12/kde-compare.png)

å‰å›ã¨åŒæ§˜ã®æ‰‹æ³•ã§,ç·šå½¢é‡å›å¸°ã®å®Ÿæ–½ã¨çµæœã®ç¢ºèªã‚’è¡Œã„ã¾ã™.

~~~ py

# æ•°é‡åŒ–
df = pd.get_dummies(df, columns=['Scholarship'], dtype='int')

#æ¨™æº–åŒ–
from sklearn.preprocessing import StandardScaler
scaler = StandardScaler()
df[['Scholarship_True'
   ,'Study_Hours'
   ,'Part_time_Work'
   ,'Sports_hours']] = scaler.fit_transform(df[['Scholarship_True'
                                               ,'Study_Hours'
                                               ,'Part_time_Work'
                                               ,'Sports_hours']])

#ç·šå½¢å›å¸°
# èª¬æ˜å¤‰æ•°(X)ã¨ç›®çš„å¤‰æ•°(y)ã«åˆ†å‰²
X = df[['Scholarship_True', 'Study_Hours']]
y = df['GPA']


# åˆ‡ç‰‡(å®šæ•°é …)ã‚’è¿½åŠ 
X = sm.add_constant(X)
lm = sm.OLS(y, X).fit()
print("\n[é€šå¸¸ã®ç·šå½¢å›å¸°ã®çµæœ]\n")
print(lm.summary())
lm_preds = lm.predict(X)

plt.figure(figsize=(8, 6))
plt.scatter(df['GPA'], lm_preds, alpha=0.7, edgecolors="k")
plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.title("Actual vs. Predicted")
plt.plot([df['GPA'].min(), df['GPA'].max()], [df['GPA'].min(), df['GPA'].max()], color="red", linestyle="--")  # å®Œå…¨ä¸€è‡´ã®ãƒ©ã‚¤ãƒ³
plt.grid()
plt.savefig('lm.png')
plt.close()

plt.figure(figsize=(16,8))
sns.kdeplot(lm_preds, label = 'Predicted')
sns.kdeplot(df['GPA'], label = 'Actual')
plt.title('Actual/Predicted')
plt.xlabel('GPA')
plt.ylabel('Density')
plt.legend()
plt.savefig('lm_kde.png')
plt.close()

"""
                            OLS Regression Results                            
==============================================================================
Dep. Variable:                    GPA   R-squared:                       0.444
Model:                            OLS   Adj. R-squared:                  0.438
Method:                 Least Squares   F-statistic:                     74.76
Date:                Tue, 04 Nov 2025   Prob (F-statistic):           1.38e-24
Time:                        16:50:17   Log-Likelihood:                -187.55
No. Observations:                 190   AIC:                             381.1
Df Residuals:                     187   BIC:                             390.8
Df Model:                           2                                         
Covariance Type:            nonrobust                                         
====================================================================================
                       coef    std err          t      P>|t|      [0.025      0.975]
------------------------------------------------------------------------------------
const                2.0000      0.047     42.122      0.000       1.906       2.094
Scholarship_True     0.1385      0.047      2.917      0.004       0.045       0.232
Study_Hours          0.5620      0.047     11.835      0.000       0.468       0.656
==============================================================================
Omnibus:                       11.718   Durbin-Watson:                   1.974
Prob(Omnibus):                  0.003   Jarque-Bera (JB):               14.133
Skew:                          -0.457   Prob(JB):                     0.000853
Kurtosis:                       3.975   Cond. No.                         1.01
==============================================================================
"""
~~~

å…¨èˆ¬çš„ã«æœ‰æ„ã§ã¯ã‚ã‚‹ã‚‚ã®ã®,ç²¾åº¦ãŒãã‚Œã»ã©é«˜ãã‚ã‚Šã¾ã›ã‚“.
![](/images/slds/ch12/lm.png)
![](/images/slds/ch12/lm_kde.png)

ã‚°ãƒ©ãƒ•ã‚’è¦‹ã¦ã¿ã‚‹ã¨, å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¯äºˆæ¸¬å€¤ã«å¯¾ã—ã¦åˆ†æ•£ãŒå¤§ãããƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£ã‚’äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ãŒèª¬æ˜ã—ãã‚Œã¦ã„ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.
R2ã‚’ç¢ºèªã—ã¦ã‚‚,ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã¦ã„ã‚‹å¤‰æ•°ã§ã¯å…¨ä½“ã®å¤‰å‹•ã®ã†ã¡44%ã»ã©ã—ã‹èª¬æ˜ã§ãã¦ã„ã¾ã›ã‚“.


## éåˆ†æ•£ã¨å€‹åˆ¥å·®

ã“ã®ã‚ˆã†ã«,è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£ãŒ,ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã‹ã‚‰é€¸è„±ã—ã¦ãŠã‚Š,ãƒ¢ãƒ‡ãƒ«ã§ã¯ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£ãŒèª¬æ˜ã§ãã¦ã„ãªã„çŠ¶æ…‹ã‚’**éåˆ†æ•£**ã¨ã„ã„ã¾ã™.

ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜åŠ›ã‚’ä¸Šã’ã‚‹ãŸã‚ã«ã¯,ã“ã®ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦èª¬æ˜ã§ãã¦ã„ãªã„ã°ã‚‰ã¤ãã‚’èª¬æ˜ã™ã‚‹æ‹¡å¼µãŒå¿…è¦ã¨ãªã‚Šã¾ã™.

ã“ã“ã§ã¯,ï½¢ãƒ‡ãƒ¼ã‚¿(ã®è¦³æ¸¬å¯¾è±¡)=å­¦ç”Ÿï½£ãªã®ã§,ï½¢ã°ã‚‰ã¤ã=å­¦ç”Ÿå·®ï½£ã¨ä»®å®šã—ã¦ã¿ã¾ã™.
ä¾‹ãˆã°,ãã‚‚ãã‚‚éå»ã®å­¦ç¿’çµŒé¨“,å‹‰å¼·ç’°å¢ƒãªã©ã«ã‚ˆã‚Š,ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹å­¦åŠ›ãŒå­¦ç”Ÿãã‚Œãã‚Œã§ç•°ãªã‚‹ãªã©,å­¦ç”Ÿå·®ã«ã‚ˆã‚‹ã°ã‚‰ã¤ãã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã«ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’æ‹¡å¼µã—ãŸ**ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«**ã‚’æ§‹ç¯‰ã—ã¦ã¿ã¾ã—ã‚‡ã†.


## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)

**ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(Generalized Linear Model, GLM)**ã¯,ç·šå½¢å›å¸°åˆ†æã‚’ä¸€èˆ¬åŒ–ã—ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã§ã™. ç·šå½¢å›å¸°åˆ†æã§ã¯ä»¥ä¸‹ã®å¼ã«ãŠã‘ã‚‹

$$
Y_i = \beta_0 + \beta_1 X_i + \epsilon_i \quad (i=1,2,\dots,n)
$$

**èª¤å·®é …** $\epsilon_i$ ã®ã¿ãŒ**æ­£è¦åˆ†å¸ƒ**ã«å¾“ã†ã¨ä»®å®šã—ã¦åˆ†æã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã—ãŸ.

$$
\epsilon_i \sim N(0, \sigma^2)
$$

ã“ã‚Œã«å¯¾ã—,ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã¯ä»¥ä¸‹ã®3ã¤ã®è¦ç´ ã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™:

1. **ç¢ºç‡åˆ†å¸ƒ**: ç›®çš„å¤‰æ•°$y_i$ãŒå¾“ã†ç¢ºç‡åˆ†å¸ƒ(æ­£è¦åˆ†å¸ƒ,ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ,äºŒé …åˆ†å¸ƒãªã©)
2. **ç·šå½¢äºˆæ¸¬å­**: èª¬æ˜å¤‰æ•°ã®ç·šå½¢çµåˆ$\eta_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \cdots$
3. **ãƒªãƒ³ã‚¯é–¢æ•°**: ç›®çš„å¤‰æ•°ã®æœŸå¾…å€¤$E[y_i]$ã¨ç·šå½¢äºˆæ¸¬å­$\eta_i$ã‚’çµã³ä»˜ã‘ã‚‹é–¢æ•°$g(E[y_i]) = \eta_i$

ç·šå½¢å›å¸°ã¯,ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã®ç‰¹æ®Šã‚±ãƒ¼ã‚¹(æ­£è¦åˆ†å¸ƒ + æ’ç­‰ãƒªãƒ³ã‚¯é–¢æ•°)ã¨ã—ã¦æ‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™. ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚Š,æ­£è¦åˆ†å¸ƒä»¥å¤–ã®åˆ†å¸ƒã‚„,éç·šå½¢ãªé–¢ä¿‚ã‚‚ãƒ¢ãƒ‡ãƒ«åŒ–ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™.

ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã®ãƒ¢ãƒ‡ãƒ«ã«ãŠã„ã¦æœ€å°¤æ¨å®šã™ã‚‹å¯¾è±¡ã¯, ãƒ¢ãƒ‡ãƒ«ã®æ¯æ•° $\theta$ã§ã‚ã‚Š,
ãƒ‡ãƒ¼ã‚¿ãŒã©ã®ã‚ˆã†ãªåˆ†å¸ƒã§ã‚ã‚‹ã‹ã‚’è¦³å¯Ÿã—,ãã‚Œã‚’å†ç¾ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã™.

ãã“ã§,ä»Šå›ã®ç›®çš„å¤‰æ•°ã§ã‚ã‚‹GPAã®åˆ†å¸ƒã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†.

~~~ py
plt.figure(figsize=(8, 5))
sns.kdeplot(df["GPA"], fill=True, bw_adjust=0.5)
plt.title("Kernel Density Estimate of GPA")
plt.xlabel("GPA")
plt.ylabel("Density")
plt.grid(True)
plt.savefig('kde-gpa.png')
plt.close()
~~~

![](/images/slds/ch12/gpa-kde.png)

ã‚«ãƒ¼ãƒãƒ«å¯†åº¦ãƒ—ãƒ­ãƒƒãƒˆã®çµæœã‹ã‚‰,ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã¯æ­£è¦åˆ†å¸ƒã—ã¦ã„ã‚‹ã¨ä»®å®šã—ã¦å•é¡Œãªã•ãã†ã§ã™.

$$ y_i \sim N(\mu_i, \sigma^2) $$

ã“ã“ã§,ä»Šå›ã¯æ­£è¦åˆ†å¸ƒã®æ¯æ•°ã§ã‚ã‚‹å¹³å‡ $\mu$ ã‚’æ¨å®šã™ã‚‹ç›®çš„ã¨ã—ã¦ã¿ã¾ã™.

::: warn 

ãƒ¢ãƒ‡ãƒ«ã®è¨­è¨ˆã§ã¯åˆ†æ•£ $\sigma$ ã‚’æ¨å®šã®ç›®çš„ã¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒ,å˜ç´”åŒ–ã®ãŸã‚ã«å›ºå®šã¨ã—ã¾ã™.
ä»Šå›ã¯èª¬æ˜ç”¨ã®å˜ç´”ãªãƒ¢ãƒ‡ãƒ«ã§ã™ãŒ,å¿…è¦ã«å¿œã˜ã¦ã‚ˆã‚Šè¤‡é›‘ãªãƒ¢ãƒ‡ãƒ«ã‚’è³‡æ–™ã«è¿½åŠ ã—ã¦ã„ãã¾ã™.

:::

ã“ã®ã¨ã,èª¬æ˜å¤‰æ•°ã¨ã—ã¦gpaã«å½±éŸ¿ã™ã‚‹ã‚‚ã®é…ä¸‹ã®ã‚ˆã†ã«ä»®å®šã—ã¾ã™.

- $S_t$ (Study Hours): å‹‰å¼·æ™‚é–“
- $S_s$ (Scholarship): å¥¨å­¦é‡‘
- $\alpha_i$: å­¦ç”Ÿå€‹åˆ¥ã®ã‚‚ã¨ã‚‚ã¨ã®å­¦åŠ›ï¼ˆãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡ï¼‰

ã“ã‚Œã‚‰ã®å¤‰æ•°ã‚’ç”¨ã„ã¦, $\mu$ ã‚’è¡¨ã™å¼ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç«‹ã¦ã¾ã™.

$$\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s$$

ã“ã®ã‚ˆã†ãªå¼ã‚’,**ç·šå½¢äºˆæ¸¬å­(linear predictor)**ã¨ã„ã„ã¾ã™.

::: note

ç·šå½¢äºˆæ¸¬å­ã¯,èª¬æ˜å¤‰æ•°ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç·šå½¢çµåˆã§æ§‹æˆã•ã‚Œã‚‹å¼ã§ã™. 

ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ã§ã¯,ç·šå½¢äºˆæ¸¬å­$\eta_i$ã¨ç›®çš„å¤‰æ•°ã®æœŸå¾…å€¤$E[y_i]$ã‚’ãƒªãƒ³ã‚¯é–¢æ•°$g(\cdot)$ã§çµã³ä»˜ã‘ã¾ã™:

$$g(E[y_i]) = \eta_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s$$

ä»Šå›ã¯æ­£è¦åˆ†å¸ƒã‚’ä»®å®šã—ã¦ã„ã‚‹ãŸã‚,æ’ç­‰ãƒªãƒ³ã‚¯é–¢æ•°(identity link function) $g(x) = x$ ã‚’ä½¿ç”¨ã—ã¾ã™. æ’ç­‰ãƒªãƒ³ã‚¯é–¢æ•°ã§ã¯,

$$g(E[y_i]) = E[y_i] = \mu_i = \eta_i$$

ã¨ãªã‚Š,$\mu_i = E[y_i] = \eta_i$ã¨ã„ã†é–¢ä¿‚ãŒæˆã‚Šç«‹ã¡ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ç·šå½¢å›å¸°ã¨åŒã˜å½¢å¼ã«ãªã‚Šã¾ã™.

ä»–ã®åˆ†å¸ƒã§ã¯,ä¾‹ãˆã°:

- ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ: å¯¾æ•°ãƒªãƒ³ã‚¯é–¢æ•° $g(E[y_i]) = \log(E[y_i]) = \eta_i$
- äºŒé …åˆ†å¸ƒ: ãƒ­ã‚¸ãƒƒãƒˆãƒªãƒ³ã‚¯é–¢æ•° $g(E[y_i]) = \log\left(\frac{E[y_i]}{1-E[y_i]}\right) = \eta_i$

ãªã©ãŒç”¨ã„ã‚‰ã‚Œã¾ã™.

ä»Šå›ã¯ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã¨ã®æ¥ç¶šã®ãŸã‚ã«,æ­£è¦åˆ†å¸ƒã‚’ä»®å®šã—ã¦ã„ã¾ã™ãŒ,ãã‚‚ãã‚‚ãƒ‡ãƒ¼ã‚¿ãŒæ­£è¦åˆ†å¸ƒã§ã¯èª¬æ˜ã§ããªã„ã“ã¨ãŒæ˜ã‚‰ã‹ãªå ´åˆã«ã¯,é©ã—ãŸåˆ†å¸ƒã‚’é¸æŠã™ã‚‹ã“ã¨ã§ãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦ãŒæ ¼æ®µã«ä¸ŠãŒã‚Šã¾ã™.

:::

ã“ã“ã§,è§£ãã¹ãå•é¡Œã¯,

$$E[y_i] = \mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s$$

ã¨ãªã‚‹ã‚ˆã†ãª$\alpha_i, \beta_{st}, \beta_{ss}$ã‚’æ¨å®šã™ã‚‹ã“ã¨ã§ã™.

## å€‹ä½“å·®ã®ãƒ¢ãƒ‡ãƒªãƒ³ã‚°

æ’ç­‰ãƒªãƒ³ã‚¯é–¢æ•°ã‚’ç”¨ã„ãŸãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ã¯,ç·šå½¢å›å¸°ã¨åŒã˜å½¢å¼ã®å¼ã¨ãªã‚Šã¾ã™ãŒ,
ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã§ã¯å…¨ä½“ã®åˆ†å¸ƒã‚’ä»®å®šã—ã¦ã„ã‚‹ãŸã‚å€‹ä½“å·®ã‚’ãƒ¢ãƒ‡ãƒ«ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™.



### ç·šå½¢å›å¸°ã§ã®å•é¡Œ

å€‹ä½“å·®ã‚’ãƒ¢ãƒ‡ãƒ«ã«å–ã‚Šè¾¼ã‚‚ã†ã¨ã™ã‚‹å ´åˆ,ç·šå½¢å›å¸°ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã™:

- **ãƒ€ãƒŸãƒ¼å¤‰æ•°ã®å°å…¥**: å„å­¦ç”Ÿã®å€‹åˆ¥ã®å­¦åŠ›ã‚’æ¨å®šã™ã‚‹ãŸã‚ã«,å­¦ç”Ÿã”ã¨ã«ãƒ€ãƒŸãƒ¼å¤‰æ•°ã‚’å°å…¥ã™ã‚‹æ–¹æ³•ãŒè€ƒãˆã‚‰ã‚Œã¾ã™.

- **ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„å ´åˆã®å•é¡Œ**: å„å­¦ç”Ÿæ¯ã«ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„å ´åˆ(ä»Šå›ã¯1äºº1ãƒ‡ãƒ¼ã‚¿),å„ãƒ€ãƒŸãƒ¼å¤‰æ•°ã¯èª¤å·®ã¨ç­‰ã—ããªã£ã¦ã—ã¾ã„ã¾ã™.

- **éå­¦ç¿’ã®å•é¡Œ**: çµæœã¨ã—ã¦,ãƒ‡ãƒ¼ã‚¿ = äºˆæ¸¬å€¤ ($\hat{y}_i = y_i$) ã¨ã—ã¦ã„ã‚‹ã®ã¨å¤‰ã‚ã‚‰ãªããªã‚Šã¾ã™. ã“ã‚Œã¯æ¨å®šã®æ„å‘³ãŒãªã,**éå­¦ç¿’**ã‚’èµ·ã“ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™.

### ãƒ™ã‚¤ã‚ºæ¨è«–ã«ã‚ˆã‚‹è§£æ±º

ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã§ã¯,ã“ã®å•é¡Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è§£æ±ºã—ã¾ã™:

- **éšå±¤æ§‹é€ ã®å°å…¥**: å„å­¦ç”Ÿã®å­¦åŠ›$\alpha_i$ã«å¯¾ã—ã¦,äº‹å‰åˆ†å¸ƒã¨ã—ã¦æ­£è¦åˆ†å¸ƒ$\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$ã‚’è¨­å®šã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,**éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«(hierarchical Bayesian model)**ã¾ãŸã¯**ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«(random effects model)**ã‚’æ§‹ç¯‰ã—ã¾ã™.

- **åˆ†å¸ƒã®æ¯æ•°ã‚’æ¨å®š**: æ¨å®šã™ã‚‹ã®ã¯å€‹åˆ¥ã®å­¦åŠ›$\alpha_i$ã§ã¯ãªã,ãã®åˆ†å¸ƒã®æ¯æ•°$(\mu_{\alpha}, \sigma_{\alpha})$ã§ã™. ã“ã‚Œã«ã‚ˆã‚Š,ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªãã¦ã‚‚,å…¨ä½“ã®åˆ†å¸ƒã‹ã‚‰æƒ…å ±ã‚’å€Ÿç”¨(**borrowing strength**, æƒ…å ±ã®å…±æœ‰)ã—ã¦æ¨å®šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™. å„å­¦ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªãã¦ã‚‚,ä»–ã®å­¦ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§,ã‚ˆã‚Šå®‰å®šã—ãŸæ¨å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™.

- **æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã¸ã®å¯¾å¿œ**: åˆ†å¸ƒã®æ¯æ•°$(\mu_{\alpha}, \sigma_{\alpha})$ãŒæ¨å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚,æ–°ã—ã„å­¦ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚ŒãŸå ´åˆã§ã‚‚,æ¨å®šã•ã‚ŒãŸåˆ†å¸ƒ$N(\mu_{\alpha}, \sigma_{\alpha}^2)$ã«åŸºã¥ã„ã¦å­¦åŠ›ã‚’æ¨å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,æ±åŒ–æ€§èƒ½ã®é«˜ã„ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã§ãã¾ã™.


![](/images/slds/ch12/random_image.png)


ãã‚Œã§ã¯å®Ÿéš›ã«,ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¦ã¿ã¾ã—ã‚‡ã†.

### ãƒ¢ãƒ‡ãƒ«ã®ä»®å®š

éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§ã¯,ä»®èª¬ã«å¾“ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†å¸ƒã‚’è¨­å®šã—ã¾ã™.

- **ä»®èª¬: åŸºç¤å­¦åŠ›ã¯å­¦ç”Ÿã«ã‚ˆã£ã¦ç•°ãªã‚‹**
  - å€‹åˆ¥ã«ç•°ãªã‚‹$\alpha_i$

- **ä»®å®š: åŸºç¤å­¦åŠ›ã¯æ­£è¦åˆ†å¸ƒã«å¾“ã†**
  - $\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$
  - ã“ã‚Œã‚’**äº‹å‰åˆ†å¸ƒ(prior distribution)**ã¨ã„ã„ã¾ã™.

- **æ›´ã«ãã‚Œãã‚Œã®æ¯æ•°ã®åˆ†å¸ƒã‚’ä»®å®šã™ã‚‹**
  - $\mu_{\alpha} \sim N(0, 1)$
  - $\sigma_{\alpha} \sim HN(1)$
  - ã“ã“ã§,$HN$ã¯**åŠæ­£è¦åˆ†å¸ƒ(Half-Normal distribution)**ã‚’è¡¨ã—ã¾ã™.

![](/images/slds/ch12/dist_setting.png)

ã“ã®ã‚ˆã†ã«,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(è¶…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿)ã«ã¤ã„ã¦ã‚‚åˆ†å¸ƒã‚’ä»®å®šã™ã‚‹ã“ã¨ã§,éšå±¤çš„ãªæ§‹é€ ã‚’æŒã¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã™. ã“ã‚Œã¯**éšå±¤äº‹å‰åˆ†å¸ƒ(hierarchical prior)**ã¨å‘¼ã°ã‚Œã¾ã™.

### ãƒ©ãƒ³ãƒ€ãƒ å‚¾ãã¨ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡

ã“ã‚Œã¾ã§,å­¦ç”Ÿã®åŸºç¤å­¦åŠ›ã®é•ã„(ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡$\alpha_i$)ã«ã¤ã„ã¦è€ƒãˆã¦ãã¾ã—ãŸãŒ,ä»–ã«ã‚‚å€‹ä½“å·®ã¨ã—ã¦è€ƒæ…®ã§ãã‚‹è¦ç´ ãŒã‚ã‚Šã¾ã™.

- **ä»®èª¬: å‹‰å¼·æ™‚é–“ã«ã‚ˆã‚‹åŠ¹æœã¯äººã«ã‚ˆã£ã¦é•ã†**

ãŸã ã—,å­¦ç”Ÿå€‹åˆ¥ã®å€‹ä½“å·®$\alpha_i$(ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡)ã®ã‚ˆã†ã«,å­¦ç”Ÿå€‹åˆ¥ã®å‹‰å¼·æ™‚é–“ã‚ãŸã‚Šã®GPAã®ä¸Šæ˜‡ç‡$\beta_{st,i} \cdot S_t$ã¨ã„ã†æ¨å®šã¯,ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯ãƒ¢ãƒ‡ãƒ«åŒ–**ã§ãã¾ã›ã‚“**.

ã“ã®ã‚ˆã†ãªå€‹åˆ¥ã®å‚¾ãã‚’**ãƒ©ãƒ³ãƒ€ãƒ å‚¾ã(random slope)**ã¨ã„ã„ã¾ã™.

#### ãªãœãƒ¢ãƒ‡ãƒ«åŒ–ã§ããªã„ã®ã‹?

- **å­¦ç”Ÿ1äººã«ã¤ã1ã¤ã—ã‹ãƒ‡ãƒ¼ã‚¿ãŒãªã„**: ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯,å„å­¦ç”Ÿã«ã¤ã„ã¦1ã¤ã®è¦³æ¸¬å€¤ã—ã‹ã‚ã‚Šã¾ã›ã‚“.

- **åˆ‡ç‰‡ã¯ãã‚Œãã‚Œã®å€¤ã‹ã‚‰æ¨å®šã§ãã‚‹**: åˆ‡ç‰‡$\alpha_i$ã¯,ä»¥ä¸‹ã®ã‚ˆã†ã«å„å­¦ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥æ¨å®šã§ãã¾ã™:
  $$\alpha_i = y_i - \beta_{st} \cdot S_t - \beta_{ss} \cdot S_s$$

- **å‚¾ãã¯è¤‡æ•°ã®è¦³æ¸¬ç‚¹ãŒå¿…è¦**: å‚¾ãã¯ã€Œå¤‰åŒ–ã®å‚¾å‘(å‹¾é…)ã€ãªã®ã§,æ¨å®šã«ã¯è¤‡æ•°ã®è¦³æ¸¬ç‚¹ãŒå¿…è¦ã§ã™. å‚¾ã$\beta_{st,i}$ã‚’æ¨å®šã™ã‚‹ã«ã¯,å°‘ãªãã¨ã‚‚2ç‚¹ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§,ä»¥ä¸‹ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã¾ã™:
  $$\beta_{st,i} = \frac{y_i - y_j}{S_{t,i} - S_{t,j}}$$

ãã®ãŸã‚,1äºº1ãƒ‡ãƒ¼ã‚¿ã—ã‹ãªã„ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯,å­¦ç”Ÿã”ã¨ã®ãƒ©ãƒ³ãƒ€ãƒ å‚¾ãã‚’æ¨å®šã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“. ãƒ©ãƒ³ãƒ€ãƒ å‚¾ãã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹ã«ã¯,å„å­¦ç”Ÿã«ã¤ã„ã¦è¤‡æ•°ã®æ™‚ç‚¹ã§ã®ãƒ‡ãƒ¼ã‚¿(ç¸¦æ–­ãƒ‡ãƒ¼ã‚¿)ãŒå¿…è¦ã«ãªã‚Šã¾ã™.

![](/images/slds/ch12/random_slope.png)

ã—ãŸãŒã£ã¦ä»Šå›ã¯,å­¦ç”Ÿå€‹åˆ¥ã®å­¦ç¿’èƒ½åŠ›ã¯å…¨ä½“ã§åŒä¸€(å›ºå®šåŠ¹æœ)ã¨ã—ã¦æ‰±ã„ã¾ã™. ã¾ãŸ,å¥¨å­¦é‡‘ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«å­¦ç”Ÿã”ã¨ã®å·®ã¯ç„¡ã„ã‚‚ã®ã¨ã—ã¦æ‰±ã„ã¾ã™(ãƒ©ãƒ³ãƒ€ãƒ å‚¾ããƒ¢ãƒ‡ãƒ«ã«é–¢ã—ã¦ã¯,ä»Šå¾Œå­¦ç”Ÿã®éœ€è¦ãŒã‚ã‚Œã°è³‡æ–™ã«è¿½åŠ ã—ã¾ã™.)




## ãƒ¢ãƒ‡ãƒ«å…¨ä½“åƒ

ã“ã‚Œã¾ã§èª¬æ˜ã—ã¦ããŸå†…å®¹ã‚’æ•´ç†ã™ã‚‹ã¨,ä»¥ä¸‹ã®ã‚ˆã†ãªéšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã«ãªã‚Šã¾ã™:

### æ¨å®šã™ã‚‹åˆ†å¸ƒ

$$y_i \sim N(\mu_i, \sigma^2)$$

ã“ã“ã§,$y_i$ã¯å­¦ç”Ÿ$i$ã®GPAã§ã™. èª¤å·®ã®æ¨™æº–åå·®$\sigma$ã¯,ä»Šå›ã¯å›ºå®šå€¤$\sigma = 0.3$ã¨ã—ã¦æ‰±ã„ã¾ã™.

### ç·šå½¢äºˆæ¸¬å­

$$\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s$$

ã“ã“ã§:

- $S_t$ã¯å‹‰å¼·æ™‚é–“(Study Hours)
- $S_s$ã¯å¥¨å­¦é‡‘å—çµ¦ã®æœ‰ç„¡(Scholarship, 0ã¾ãŸã¯1)
- $\alpha_i$ã¯å­¦ç”Ÿ$i$ã®åŸºç¤å­¦åŠ›(ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡)
- $\beta_{st}$ã¯å‹‰å¼·æ™‚é–“ã®åŠ¹æœ(å›ºå®šåŠ¹æœ)
- $\beta_{ss}$ã¯å¥¨å­¦é‡‘ã®åŠ¹æœ(å›ºå®šåŠ¹æœ)

### å°¤åº¦é–¢æ•°

$$p(y | \alpha, \beta_{st}, \beta_{ss}, \sigma) = \prod_{i=1}^{N} N(y_i | \mu_i, \sigma^2)$$

ã“ã“ã§,$\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s$ã§ã™.

### äº‹å‰åˆ†å¸ƒ

#### ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡(éšå±¤æ§‹é€ )

- $\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$: å­¦ç”Ÿå€‹åˆ¥ã®åŸºç¤å­¦åŠ›(ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡)

  ã“ã‚Œã¯éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã«ã‚ˆã‚Šä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¾ã•ã‚Œã¾ã™:
  
  $$z_{\alpha,i} \sim N(0, 1)$$
  $$\alpha_i = \mu_{\alpha} + \sigma_{\alpha} \cdot z_{\alpha,i}$$

::: note

- éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–(non-centered parameterization)

éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã«ãŠã„ã¦,ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡$\alpha_i$ã‚’è¡¨ç¾ã™ã‚‹æ–¹æ³•ã«ã¯2é€šã‚Šã‚ã‚Šã¾ã™:

1. **ä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–(centered parameterization)**:
   $$\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$$
   ã“ã‚Œã¯,ç›´æ¥$\alpha_i$ã‚’å¹³å‡$\mu_{\alpha}$ã¨æ¨™æº–åå·®$\sigma_{\alpha}$ã‚’æŒã¤æ­£è¦åˆ†å¸ƒã‹ã‚‰ç”Ÿæˆã™ã‚‹æ–¹æ³•ã§ã™.

2. **éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–(non-centered parameterization)**:
   $$z_{\alpha,i} \sim N(0, 1)$$
   $$\alpha_i = \mu_{\alpha} + \sigma_{\alpha} \cdot z_{\alpha,i}$$
   ã“ã‚Œã¯,æ¨™æº–æ­£è¦åˆ†å¸ƒ$N(0, 1)$ã‹ã‚‰$z_{\alpha,i}$ã‚’ç”Ÿæˆã—,ãã‚Œã‚’ç·šå½¢å¤‰æ›ã—ã¦$\alpha_i$ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ã§ã™.

æ•°å­¦çš„ã«ã¯,ä¸¡è€…ã¯åŒã˜åˆ†å¸ƒ$\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$ã‚’ç”Ÿæˆã—ã¾ã™ãŒ,MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã«ãŠã‘ã‚‹æŒ™å‹•ãŒå¤§ããç•°ãªã‚Šã¾ã™.

**MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã«ãŠã‘ã‚‹åŠ¹æœ:**

éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã¯,ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®åŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã¾ã™:

1. **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã®ç›¸é–¢ã®ä½æ¸›**: ä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã§ã¯,$\alpha_i$ã¨$(\mu_{\alpha}, \sigma_{\alpha})$ã®é–“ã«å¼·ã„ç›¸é–¢ãŒç”Ÿã˜ã¾ã™. ç‰¹ã«,$\sigma_{\alpha}$ãŒå°ã•ã„å ´åˆ,$\alpha_i$ã®å€¤ã¯$\mu_{\alpha}$ã«è¿‘ããªã‚Š,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã®æ¢ç´¢ãŒå›°é›£ã«ãªã‚Šã¾ã™. éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã§ã¯,$z_{\alpha,i}$ã¯æ¨™æº–æ­£è¦åˆ†å¸ƒã‹ã‚‰ç‹¬ç«‹ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã®ç›¸é–¢ãŒä½æ¸›ã•ã‚Œ,åŠ¹ç‡çš„ãªæ¢ç´¢ãŒå¯èƒ½ã«ãªã‚Šã¾ã™.

2. **ãƒ•ã‚¡ãƒãƒ«å½¢çŠ¶ã®å•é¡Œã®å›é¿**: éšå±¤ãƒ¢ãƒ‡ãƒ«ã§ã¯,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ãŒã€Œãƒ•ã‚¡ãƒãƒ«(funnel)ã€å½¢çŠ¶ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™. $\sigma_{\alpha}$ãŒå°ã•ã„é ˜åŸŸã§ã¯,è¨±å®¹ã•ã‚Œã‚‹$\alpha_i$ã®ç¯„å›²ãŒç‹­ããªã‚Š,ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒå›°é›£ã«ãªã‚Šã¾ã™. éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã«ã‚ˆã‚Š,ã“ã®å•é¡Œã‚’å›é¿ã§ãã¾ã™.

3. **åæŸã®æ”¹å–„**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã®ç›¸é–¢ãŒä½æ¸›ã•ã‚Œã‚‹ã“ã¨ã§,ãƒãƒ«ã‚³ãƒ•é€£é–ãŒã‚ˆã‚Šé€Ÿãæ··åˆã—,åæŸãŒæ”¹å–„ã•ã‚Œã¾ã™. ç‰¹ã«,éšå±¤ãƒ¢ãƒ‡ãƒ«ã§ã¯,éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§,ç™ºæ•£(divergence)ã®ç™ºç”Ÿã‚’å¤§å¹…ã«æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™.

4. **ESS(Effective Sample Size)ã®å‘ä¸Š**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã®ç›¸é–¢ãŒä½æ¸›ã•ã‚Œã‚‹ã“ã¨ã§,ã‚µãƒ³ãƒ—ãƒ«é–“ã®è‡ªå·±ç›¸é–¢ãŒæ¸›å°‘ã—,å®Ÿè³ªçš„ãªã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º(ESS)ãŒå‘ä¸Šã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ã‚ˆã‚Šå°‘ãªã„ã‚µãƒ³ãƒ—ãƒ«æ•°ã§,ã‚ˆã‚Šä¿¡é ¼æ€§ã®é«˜ã„æ¨å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™.


ãŸã ã—,ã™ã¹ã¦ã®å ´åˆã«éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãŒæœ€é©ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“. ãƒ‡ãƒ¼ã‚¿ãŒååˆ†ã«å¤šã„å ´åˆã‚„,$\sigma_{\alpha}$ãŒå¤§ãã„å ´åˆã«ã¯,ä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã§ã‚‚å•é¡Œãªãå‹•ä½œã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™. ã—ã‹ã—,ä¸€èˆ¬çš„ã«ã¯,éšå±¤ãƒ¢ãƒ‡ãƒ«ã§ã¯éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™.

:::


#### å›ºå®šåŠ¹æœ

- $\beta_{st} \sim N(0, 1)$: å‹‰å¼·æ™‚é–“ã®åŠ¹æœ(å›ºå®šåŠ¹æœ, å­¦ç”Ÿé–“ã§åŒã˜å€¤)
- $\beta_{ss} \sim N(0, 1)$: å¥¨å­¦é‡‘ã®åŠ¹æœ(å›ºå®šåŠ¹æœ, å­¦ç”Ÿé–“ã§åŒã˜å€¤)

### è¶…äº‹å‰åˆ†å¸ƒ

- $\mu_{\alpha} \sim N(0, 1)$: ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡ã®å¹³å‡
- $\sigma_{\alpha} \sim HN(1)$: ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡ã®æ¨™æº–åå·®(åŠæ­£è¦åˆ†å¸ƒ)


ä»¥ä¸‹ã¯å¾Œè¿°ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ãƒ¢ãƒ‡ãƒ«å…¨ä½“åƒã‚’è¡¨ã™å›³ã§ã™. 

![](/images/slds/ch12/hierarchical_bayes_model.png)

ã“ã®ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚Š,å­¦ç”Ÿé–“ã®åŸºç¤å­¦åŠ›ã®å€‹ä½“å·®ã‚’è€ƒæ…®ã—ãªãŒã‚‰(ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡),å‹‰å¼·æ™‚é–“ã¨å¥¨å­¦é‡‘ãŒGPAã«ä¸ãˆã‚‹å½±éŸ¿ã‚’å›ºå®šåŠ¹æœã¨ã—ã¦æ¨å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™.

# ç’°å¢ƒæ§‹ç¯‰

ãã‚Œã§ã¯,å®Ÿéš›ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸Šã§ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰,æ¨å®šã—ã¦ã¿ã¾ã—ã‚‡ã†.

`Python`ã«ãŠã„ã¦ãƒ™ã‚¤ã‚ºçµ±è¨ˆå­¦ã«åŸºã¥ã„ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦`PyMC5`ãŒã‚ã‚Šã¾ã™(å¤ã„Versionã¨ã—ã¦`PyMC3`ãŒã‚ã‚Šå…¨ãç•°ãªã‚‹è¨˜æ³•ãªã©ã‚’ç”¨ã„ã¦ã„ã‚‹ã®ã§æ³¨æ„ã—ã¦ä¸‹ã•ã„). ã“ã¡ã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯,Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã‚ã‚‹`anaconda`ã‚’åˆ©ç”¨ã—ã¾ã™.
é€šå¸¸ã“ã‚Œã¾ã§ã«åˆ©ç”¨ã—ã¦ããŸ`pip`ã«ã‚ˆã‚‹ç’°å¢ƒã¨`anaconda`ç’°å¢ƒã®ä½µç”¨ã¯å›°é›£ã§ã™. ãŸã ã—,ã“ã®è¬›ç¾©ã§ã¯,`pyenv`ã‚’ç’°å¢ƒæ§‹ç¯‰ã«åˆ©ç”¨ã—ã¦ã„ã¾ã™ã®ã§, `PyMC`ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®localç’°å¢ƒã«ã®ã¿`anaconda`ç”¨ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™.

ã¾ãšã¯,ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§`PyMC`ã‚’å®Ÿè¡Œã™ã‚‹ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—,ãã“ã«ç§»å‹•ã—ã¦ä¸‹ã•ã„.

ä»¥ä¸‹, ç§»å‹•ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«`anaconda`ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™.

## `anaconda`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

::: warn
`MacOS`ã®æ–¹ã¯ `pyenv install -l` ã§`anaconda`ç³»çµ±ã®ç’°å¢ƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ `pyenv install anacondaXXX` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ã§ã™.

åŸ·ç­†æ™‚ç‚¹ã®æœ€æ–°ç‰ˆ `anaconda3-2024.10-1`ã¯`PyMC5`ãŒå¯¾å¿œã—ã¦ã„ãªã„ãŸã‚,`anaconda3-2024.02-1`ãŒæ¨å¥¨ã•ã‚Œã¾ã™.
:::

`Windows`ã®å ´åˆã¯ `pyenv` ã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæä¾›ã•ã‚Œã¦ã„ãªã„ã®ã§,æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™.

`anaconda`ã®[å…¬å¼ãƒšãƒ¼ã‚¸](https://www.anaconda.com/download#Downloads)ã«è¡Œã,`Get Started`ã‹ã‚‰æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç­‰ã‚’ä½œæˆã—ã¦ä¸‹ã•ã„.

![](/images/slds/ch12/anaconda/anaconda-HP.png)

ç¶šã„ã¦, Windowsç‰ˆã®`anaconda`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™.

![](/images/slds/ch12/anaconda/anaconda-DW.png)

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰,ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•ã—ã¾ã™.
è¨­å®šã¯å¤‰æ›´ã›ãš`Next`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã„ãã¾ã™.

![](/images/slds/ch12/anaconda/anaconda-Explorer.png)

![](/images/slds/ch12/anaconda/anaconda-installer.png)

![](/images/slds/ch12/anaconda/anaconda-just-me.png)

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®è¨­å®šç”»é¢ãŒå‡ºãŸã‚‰, `pyenv`ã®`versions`ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ã¾ã™.
ãƒ‘ã‚¹ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æŒ‡å®šã—ã¦æ¬¡ã«é€²ã¿ã¾ã—ã‚‡ã†

`C:\Users\xxx\.pyenv\pyenv-win\versions\anaconda`
(XXXã®éƒ¨åˆ†ã‚’è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ã—ã¾ã—ã‚‡ã†.)

![](/images/slds/ch12/anaconda/anaconda-pass.png)

ãã®å¾Œã¯åŸºæœ¬çš„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã®ã¾ã¾,`Next`,`Finish`ã‚’æŠ¼ã—ã¾ã—ã‚‡ã†.

![](/images/slds/ch12/anaconda/anaconda-installer-end.png)

![](/images/slds/ch12/anaconda/anaconda-installer-end2.png)

![](/images/slds/ch12/anaconda/anaconda-installer-end3.png)

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ãŸã‚‰,ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãä½œæ¥­ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¦,`pyenv versions` ã‚³ãƒãƒ³ãƒ‰ã§`anaconda`ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†.

![](/images/slds/ch12/anaconda/anaconda-pyenv.png)

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«`anaconda`ã‚’æŒ‡å®šã—ã¾ã™.

~~~ sh
pyenv local anaconda
pyenv rehash
~~~

`anaconda`ã§ã¯`pip`ã§ã¯ãªã`conda`ã‚’åˆ©ç”¨ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™. ã¾ãšã¯,`anaconda`è‡ªä½“ã‚’`update`ã—ã¾ã—ã‚‡ã†.

~~~ sh
conda update -n base -c defaults conda
~~~

~~~ sh
Proceed ([y]/n)? y
~~~
ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰, `y` ã‚’æŠ¼ã—ã¦`Enter`ã—ã¾ã™.

ç¶šã„ã¦`PyMC5`ã®å…¬å¼ã‚µã‚¤ãƒˆã«å¾“ã„,`anaconda`ä¸Šã§`PyMC5`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™.
`pyenv`ãŒæ—¢ã«ä»®æƒ³ç’°å¢ƒã§ã™ãŒ,`conda create`ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ `pymc`ãªã©ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ`python`ã®ä»®æƒ³ç’°å¢ƒã‚’æ›´ã«æ§‹ç¯‰ã—ã¾ã™.

~~~ sh
conda create -c conda-forge -n pymc_env "pymc>=5"
~~~

å…¥åŠ›å¾Œå®Œäº†ã—ãŸã‚‰,ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã«terminalã‚’ä¸€åº¦åˆæœŸåŒ–ã—ã¾ã™.

~~~ sh
conda init powershell
~~~

::: warn
`MacOS`ã®å ´åˆã¯, `conda init zsh` ã‚³ãƒãƒ³ãƒ‰ã§ã™.
:::


ã‚’å…¥åŠ›ã—, **`Terminal`ã‚’é–‰ã˜ã¦å†åº¦ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ãŸã‚ã¨**ã«ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ä¸‹ã•ã„.


~~~ sh
conda activate pymc_env
~~~

::: warn
Macã®å ´åˆã¯, ã“ã®ã‚ã¨ä»®æƒ³ç’°å¢ƒã‚’localã«æŒ‡å®šã—ã¾ã™.

~~~ sh
pyenv versions
  system
  3.12.3
* anaconda3-2024.02-1
  anaconda3-2024.02-1/envs/pymc_env
â¯ pyenv local anaconda3-2024.02-1/envs/pymc_env
â¯ pyenv local
anaconda3-2024.02-1/envs/pymc_env
~~~

:::


ç’°å¢ƒã®ç¢ºèªã‚’ã—ã¾ã™.

~~~ sh
Get-Command python
~~~

::: warn
`MacOS`ã®å ´åˆã¯, `witch python` ã‚³ãƒãƒ³ãƒ‰ã§ã™.
:::

ä»¥ä¸‹ã®ã‚ˆã†ã«`pymc_env`å†…ã®pythonãŒè¡¨ç¤ºã•ã‚Œã‚Œã°åˆ©ç”¨å¯èƒ½ãªçŠ¶æ³ã«ãªã£ã¦ã„ã¾ã™.

~~~ sh
CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Application     python.exe                                         3.11.14... C:\Users\akagi\.pyenv\pyenv-win\versions\anaconda\envs\pymc_env\python.exe
~~~

å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™.

~~~ sh
conda install seaborn scikit-learn statsmodels
conda install -c conda-forge compilers
~~~

é€”ä¸­ã§,`Proceed ([y]/n)?` ã¨è¡¨ç¤ºã•ã‚ŒãŸã‚‰`y`ã¨å…¥åŠ›ã—ã¦ENTERã‚’æŠ¼ã—ã¾ã™.

~~~sh
Preparing transaction: done
Verifying transaction: done
Executing transaction: done
~~~
ãªã©ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°,ç’°å¢ƒæ§‹ç¯‰å®Œäº†ã§ã™.

ä»¥é™,Terminalã§ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ãŸå¾Œ`conda activate pymc_env` ã§ã“ã®ç’°å¢ƒãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™.


# PyMC å®Ÿè£…

ã‚³ãƒ¼ãƒ‰ãŒè¤‡é›‘ã«ãªã‚‹ãŸã‚,å…ˆã«ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“åƒã‚’ç¤ºã—ãŸå¾Œ, å€‹åˆ¥ã«æ„å‘³ã‚’è§£èª¬ã—ã¾ã™.
ã¾ãšã¯,ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ãŸå¾Œ,å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†.

::: warn

æœ€åˆã®ç”»åƒã®ä¿å­˜å…ˆã‚„ãƒ‡ãƒ¼ã‚¿ã®å‚ç…§å…ˆã¯,ç’°å¢ƒã«å¿œã˜ã¦å¤‰ãˆã¦ä¸‹ã•ã„.

`save_dir = '/images/slds/ch12/'`

:::

~~~ py
import pymc as pm
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import arviz as az
import graphviz
from pymc import model_to_graphviz
import statsmodels.api as sm
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error
from scipy.stats import norm, rankdata


save_dir = '../../images/slds/ch12/'

if __name__ == "__main__":

    # ---------------------------
    # 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    # ---------------------------
    df = pd.read_csv('hierarchical_regression.csv'
                ,dtype={'GPA': float
                       ,'Scholarship': bool
                       ,'Study_Hours': float
                       ,'Sports_hours': float
                       ,'Part_time_Work': float
                       ,'StudentID':int})

    # æ•°é‡åŒ–
    df = pd.get_dummies(df, columns=['Scholarship'], dtype='int')

    #æ¨™æº–åŒ–
    from sklearn.preprocessing import StandardScaler
    scaler = StandardScaler()
    df[['Scholarship_True'
       ,'Study_Hours'
       ,'Part_time_Work'
       ,'Sports_hours']] = scaler.fit_transform(df[['Scholarship_True'
                                                   ,'Study_Hours'
                                                   ,'Part_time_Work'
                                                   ,'Sports_hours']])

    # ---------------------------
    # ï¼’. ç·šå½¢å›å¸°
    # ---------------------------
    
    # èª¬æ˜å¤‰æ•°(X)ã¨ç›®çš„å¤‰æ•°(y)ã«åˆ†å‰²
    X = df[['Scholarship_True', 'Study_Hours']]
    y = df['GPA']


    # åˆ‡ç‰‡(å®šæ•°é …)ã‚’è¿½åŠ 
    X = sm.add_constant(X)
    lm = sm.OLS(y, X).fit()
    print("\n[é€šå¸¸ã®ç·šå½¢å›å¸°ã®çµæœ]\n")
    print(lm.summary())
    lm_preds = lm.predict(X)

    plt.figure(figsize=(8, 6))
    plt.scatter(df['GPA'], lm_preds, alpha=0.7, edgecolors="k")
    plt.xlabel("Predicted")
    plt.ylabel("Actual")
    plt.title("Actual vs. Predicted")
    plt.plot([df['GPA'].min(), df['GPA'].max()], [df['GPA'].min(), df['GPA'].max()], color="red", linestyle="--")  # å®Œå…¨ä¸€è‡´ã®ãƒ©ã‚¤ãƒ³
    plt.grid()
    plt.savefig(save_dir + 'lm.png')
    plt.close()

    plt.figure(figsize=(16,8))
    sns.kdeplot(lm_preds, label = 'Predicted')
    sns.kdeplot(df['GPA'], label = 'Actual')
    plt.title('Actual/Predicted')
    plt.xlabel('GPA')
    plt.ylabel('Density')
    plt.legend()
    plt.savefig(save_dir + 'lm_kde.png')
    plt.close()
    
    # ---------------------------
    # ï¼“. ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«
    # ---------------------------

    coords = {
        "student": df["StudentID"].values,
        "obs_id": np.arange(len(df))
    }

    with pm.Model(coords=coords) as model:
        st = pm.Data("st", df["Study_Hours"])
        #ptw = pm.Data("ptw", df["Part_time_Work"])
        ss = pm.Data("ss", df["Scholarship_True"])
        student_idx = pm.Data("student_idx", df["StudentID"])

        #ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡
        z_alpha = pm.Normal("z_alpha", 0, 1, dims="student")
        mu_alpha = pm.Normal("mu_alpha", 0, 1)
        sigma_alpha = pm.HalfNormal("sigma_alpha", 1)
        alpha = pm.Deterministic("alpha", mu_alpha + sigma_alpha * z_alpha, dims="student")


        # å‹‰å¼·æ™‚é–“ã®åŠ¹æœ
        beta_st = pm.Normal("beta_st",0,1)
        
        # å¥¨å­¦é‡‘ã®åŠ¹æœ
        beta_ss = pm.Normal("beta_ss",0,1)
 
        mu = alpha[student_idx] + beta_st * st +  beta_ss * ss

        #sigma = pm.HalfNormal("sigma", 1)
        sigma = 0.3
        gpa_obs = pm.Normal("GPA",
                            mu=mu,
                            sigma=sigma,
                            observed=df["GPA"],
                            dims="obs_id"
                        )
        trace = pm.sample(draws =2000, tune=2000, chains=4, target_accept=0.95, return_inferencedata=True)
        posterior_predictive = pm.sample_posterior_predictive(trace)

    # ---------------------------
    # 4. ãƒ¢ãƒ‡ãƒ«è¨ºæ–­ã¨å¯è¦–åŒ–
    # ---------------------------
    graph = model_to_graphviz(model)
    graph.render(filename= save_dir + "hierarchical_bayes_model", format="pdf")

    az.plot_trace(trace
                 ,var_names=["sigma_alpha"
                            ,"alpha"
                            ,"beta_st"
                            ,"beta_ss"])
    plt.tight_layout()
    plt.savefig(save_dir + 'trace.png')
    plt.close()

    print(az.summary(trace
                    ,var_names=["sigma_alpha"
                               ,"alpha"
                               ,"beta_st"
                               ,"beta_ss"]))
    summary_df = az.summary(trace
                           ,var_names=["sigma_alpha"
                                      ,"alpha"
                                      ,"beta_st"
                                      ,"beta_ss"])
    summary_df.to_csv("bayesian_summary.csv"
                     ,encoding="utf-8-sig")


    # ---------------------------
    # 6. éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬ç²¾åº¦è©•ä¾¡
    # ---------------------------
    idata = trace.copy()
    idata.extend(posterior_predictive)
    az.plot_ppc(idata, data_pairs={"GPA": "GPA"})
    plt.savefig(save_dir + 'ppc.png')
    plt.close()


    #------------------------------------------------------------------
    # äºˆæ¸¬å€¤ã®å¯è¦–åŒ–
    #------------------------------------------------------------------

    posterior_mean = idata.posterior_predictive["GPA"].mean(dim=("chain", "draw")).values
    bayes_rmse = mean_squared_error(df["GPA"], posterior_mean)
    print(f"[éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®RMSE] {bayes_rmse:.4f}\n")
    # äº‹å¾Œäºˆæ¸¬ã®å¹³å‡ï¼ˆäºˆæ¸¬å€¤ï¼‰ã‚’å–ã‚Šå‡ºã™
    posterior_mean = idata.posterior_predictive["GPA"].mean(dim=("chain", "draw")).values

    # ãƒ—ãƒ­ãƒƒãƒˆ
    plt.figure(figsize=(8, 6))
    plt.scatter(df['GPA'], posterior_mean, alpha=0.7, edgecolors="k")
    plt.xlabel("Predicted (Bayesian)")
    plt.ylabel("Actual GPA")
    plt.title("Bayesian Actual vs. Predicted")
    plt.plot([df['GPA'].min(), df['GPA'].max()],
             [df['GPA'].min(), df['GPA'].max()],
             color="red", linestyle="--", label="Perfect prediction")
    plt.grid()
    plt.legend()
    plt.savefig(save_dir + 'bayes.png')
    plt.close()

    plt.figure(figsize=(16,8))
    sns.kdeplot(posterior_mean, label = 'Predicted')
    sns.kdeplot(df['GPA'], label = 'Actual')
    plt.title('Actual/Predicted')
    plt.xlabel('GPA')
    plt.ylabel('Density')
    plt.legend()
    plt.savefig(save_dir + 'bayes_kde.png')
    plt.close()

    #------------------------------------------------------------------
    # äºˆæ¸¬ç¯„å›²ã®å¯è¦–åŒ–
    #------------------------------------------------------------------

    # xè»¸ç”¨ã® study_hours ã®ç¯„å›²ï¼ˆ100ç‚¹ï¼‰
    study_grid = np.linspace(df["Study_Hours"].min(), df["Study_Hours"].max(), 100)

    # å¥¨å­¦é‡‘ãªã—ã®äºˆæ¸¬
    predict_df_0 = pd.DataFrame({
        "Study_Hours": study_grid,
        "Scholarship_True": 0,
        "StudentID": 0
    })

    # å¥¨å­¦é‡‘ã‚ã‚Šã®äºˆæ¸¬
    predict_df_1 = pd.DataFrame({
        "Study_Hours": study_grid,
        "Scholarship_True": 1,
        "StudentID": 0
    })

    # ã‚ˆã‚Šç°¡å˜ãªæ–¹æ³•ï¼šäº‹å¾Œåˆ†å¸ƒã‹ã‚‰ç›´æ¥äºˆæ¸¬
    # äº‹å¾Œåˆ†å¸ƒã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—ï¼ˆæ–°ã—ã„APIã‚’ä½¿ç”¨ï¼‰
    posterior_samples = az.extract(trace)
    
    # äºˆæ¸¬è¨ˆç®—
    n_samples = len(posterior_samples.draw)
    n_grid = len(study_grid)
    
    # äºˆæ¸¬å€¤ã‚’æ ¼ç´ã™ã‚‹é…åˆ—ï¼ˆå¥¨å­¦é‡‘ãªã—ãƒ»ã‚ã‚Šï¼‰
    predictions_0 = np.zeros((n_samples, n_grid))
    predictions_1 = np.zeros((n_samples, n_grid))
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã«å–å¾—
    mu_alpha_vals = posterior_samples.mu_alpha.values
    sigma_alpha_vals = posterior_samples.sigma_alpha.values
    z_alpha_vals = posterior_samples.z_alpha.values  # å…¨å­¦ç”Ÿã®z_alpha    
    beta_st_vals = posterior_samples.beta_st.values    
    beta_ss_vals = posterior_samples.beta_ss.values
    
    for i in range(n_samples):
        # å„ã‚µãƒ³ãƒ—ãƒ«ã§ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå­¦ç”Ÿ0ã®åˆ‡ç‰‡ã‚’è¨ˆç®—ï¼‰
        alpha_0 = mu_alpha_vals[i] + sigma_alpha_vals[i] * z_alpha_vals[0, i]  # å­¦ç”Ÿ0ã®åˆ‡ç‰‡
        
        # å¥¨å­¦é‡‘ãªã—ã®äºˆæ¸¬å€¤ã®è¨ˆç®—
        mu_pred_0 = alpha_0 + beta_st_vals[i] * study_grid + beta_ss_vals[i] * predict_df_0["Scholarship_True"]
        predictions_0[i, :] = np.random.normal(mu_pred_0, 0.3)
        
        # å¥¨å­¦é‡‘ã‚ã‚Šã®äºˆæ¸¬å€¤ã®è¨ˆç®—
        mu_pred_1 = alpha_0 + beta_st_vals[i] * study_grid + beta_ss_vals[i] * predict_df_1["Scholarship_True"]
        predictions_1[i, :] = np.random.normal(mu_pred_1, 0.3)

    # å¹³å‡ã¨äºˆæ¸¬åŒºé–“ï¼ˆ94%ï¼‰
    mean_pred_0 = np.mean(predictions_0, axis=0)
    lower_pred_0 = np.percentile(predictions_0, 3, axis=0)
    upper_pred_0 = np.percentile(predictions_0, 97, axis=0)
    
    mean_pred_1 = np.mean(predictions_1, axis=0)
    lower_pred_1 = np.percentile(predictions_1, 3, axis=0)
    upper_pred_1 = np.percentile(predictions_1, 97, axis=0)

    # å®Ÿãƒ‡ãƒ¼ã‚¿ã‚‚åˆã‚ã›ã¦è¡¨ç¤ºï¼ˆå¥¨å­¦é‡‘ã®æœ‰ç„¡ã§è‰²åˆ†ã‘ï¼‰
    plt.figure(figsize=(12, 8))
    
    # å¥¨å­¦é‡‘ãªã—ã®äºˆæ¸¬ç·š
    plt.plot(study_grid, mean_pred_0, color="blue", label="Bayesian prediction (Scholarship=0)")
    plt.fill_between(study_grid, lower_pred_0, upper_pred_0, color="blue", alpha=0.2, label="94% CI (Scholarship=0)")
    
    # å¥¨å­¦é‡‘ã‚ã‚Šã®äºˆæ¸¬ç·š
    plt.plot(study_grid, mean_pred_1, color="green", label="Bayesian prediction (Scholarship=1)")
    plt.fill_between(study_grid, lower_pred_1, upper_pred_1, color="green", alpha=0.2, label="94% CI (Scholarship=1)")
    
    # å¥¨å­¦é‡‘ã®æœ‰ç„¡ã§å®Ÿæ¸¬å€¤ã‚’è‰²åˆ†ã‘
    scholarship_0 = df[df["Scholarship_True"] == 0]
    scholarship_1 = df[df["Scholarship_True"] == 1]
    
    plt.scatter(scholarship_0["Study_Hours"], scholarship_0["GPA"], 
                color="red", alpha=0.6, label="Observed GPA (Scholarship=0)", s=30)
    plt.scatter(scholarship_1["Study_Hours"], scholarship_1["GPA"], 
                color="orange", alpha=0.6, label="Observed GPA (Scholarship=1)", s=30)
    
    plt.xlabel("Study Hours")
    plt.ylabel("GPA")
    plt.title("Bayesian Regression Lines with 94% Prediction Intervals")
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    plt.savefig(save_dir + "bayes_prediction_band.png")
    plt.close()


    # ---------------------------
    # 7. åŒ…æ‹¬çš„ãªçµæœè¡¨ç¤º
    # ---------------------------
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è§£é‡ˆå¯èƒ½æ€§ã‚’å‘ä¸Š
    print("\n=== ãƒ¢ãƒ‡ãƒ«çµæœã®è§£é‡ˆ ===")
    print(f"å‹‰å¼·æ™‚é–“ã®åŠ¹æœ (beta_st): {np.mean(beta_st_vals):.3f} Â± {np.std(beta_st_vals):.3f}")
    print(f"å¥¨å­¦é‡‘ã®åŠ¹æœ (beta_ss): {np.mean(beta_ss_vals):.3f} Â± {np.std(beta_ss_vals):.3f}")
    print(f"å­¦ç”Ÿé–“ã®ã°ã‚‰ã¤ã (sigma_alpha): {np.mean(sigma_alpha_vals):.3f} Â± {np.std(sigma_alpha_vals):.3f}")
    #
    ## åŠ¹æœé‡ã®è¨ˆç®—
    effect_size_study = np.mean(beta_st_vals) / np.mean(sigma_alpha_vals)
    effect_size_scholarship = np.mean(beta_ss_vals) / np.mean(sigma_alpha_vals)
    print(f"å‹‰å¼·æ™‚é–“ã®æ¨™æº–åŒ–åŠ¹æœé‡: {effect_size_study:.3f}")
    print(f"å¥¨å­¦é‡‘ã®æ¨™æº–åŒ–åŠ¹æœé‡: {effect_size_scholarship:.3f}")
    #
    ## äºˆæ¸¬ç²¾åº¦ã®è©³ç´°è©•ä¾¡
    r2 = r2_score(df["GPA"], posterior_mean)
    mae = mean_absolute_error(df["GPA"], posterior_mean)
    print(f"\n=== äºˆæ¸¬ç²¾åº¦ ===")
    print(f"RÂ²: {r2:.4f}")
    print(f"MAE: {mae:.4f}")
    print(f"RMSE: {bayes_rmse:.4f}")
    
    # éšå±¤åŠ¹æœã®å¯è¦–åŒ–
    plt.figure(figsize=(12, 8))
    
    # å­¦ç”Ÿåˆ¥ã®åˆ‡ç‰‡åˆ†å¸ƒ
    alpha_means = np.mean(posterior_samples.alpha.values, axis=1)
    alpha_stds = np.std(posterior_samples.alpha.values, axis=1)
    
    plt.subplot(2, 2, 1)
    plt.errorbar(range(len(alpha_means)), alpha_means, yerr=alpha_stds, fmt='o', alpha=0.6)
    plt.xlabel("Student ID")
    plt.ylabel("Random Intercept (Î±)")
    plt.title("Student-specific Random Intercepts")
    plt.grid(True)
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®äº‹å¾Œåˆ†å¸ƒ
    plt.subplot(2, 2, 2)
    plt.hist(beta_st_vals, bins=50, alpha=0.7, label='Study Hours Effect')
    plt.hist(beta_ss_vals, bins=50, alpha=0.7, label='Scholarship Effect')
    plt.xlabel("Parameter Value")
    plt.ylabel("Frequency")
    plt.title("Posterior Distributions of Effects")
    plt.legend()
    plt.grid(True)
    
    # äºˆæ¸¬ç²¾åº¦ã®æ¯”è¼ƒ
    plt.subplot(2, 2, 3)
    plt.scatter(df["GPA"], posterior_mean, alpha=0.6, label='Bayesian')
    plt.scatter(df["GPA"], lm_preds, alpha=0.6, label='Linear Regression')
    plt.plot([df["GPA"].min(), df["GPA"].max()], 
             [df["GPA"].min(), df["GPA"].max()], 'r--', label='Perfect')
    plt.xlabel("Actual GPA")
    plt.ylabel("Predicted GPA")
    plt.title("Prediction Accuracy Comparison")
    plt.legend()
    plt.grid(True)
    
    # æ®‹å·®åˆ†æ
    plt.subplot(2, 2, 4)
    residuals = df["GPA"] - posterior_mean
    plt.scatter(posterior_mean, residuals, alpha=0.6)
    plt.axhline(y=0, color='r', linestyle='--')
    plt.xlabel("Predicted GPA")
    plt.ylabel("Residuals")
    plt.title("Residual Plot")
    plt.grid(True)
    
    plt.tight_layout()
    plt.savefig(save_dir + "comprehensive_results.png", dpi=300, bbox_inches='tight')
    plt.close()
    
    # çµæœã®è¦ç´„ã‚’CSVã«ä¿å­˜
    results_summary = {
        'Metric': ['RÂ²', 'MAE', 'RMSE', 'Study_Effect_Mean', 'Study_Effect_Std', 
                  'Scholarship_Effect_Mean', 'Scholarship_Effect_Std', 'Student_Variability'],
        'Value': [r2, mae, bayes_rmse, np.mean(beta_st_vals), np.std(beta_st_vals),
                 np.mean(beta_ss_vals), np.std(beta_ss_vals), np.mean(sigma_alpha_vals)]
    }
    
    results_df = pd.DataFrame(results_summary)
    results_df.to_csv("model_results_summary.csv", index=False, encoding='utf-8-sig')

~~~

ä»¥ä¸‹, å€‹åˆ¥ã®éƒ¨åˆ†ã«é–¢ã—ã¦ç¢ºèªã—ã¦ã„ãã¾ã™.
ç‰¹ã«ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šéƒ¨åˆ†ã«é–¢ã—ã¦,ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©ã¨ã®å¯¾å¿œé–¢ä¿‚ã‚’ç¢ºèªã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†.

## äº‹å‰æº–å‚™

ã¾ãšã¯,ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ,ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿,æ•°é‡åŒ–,æ¨™æº–åŒ–ãªã©ã‚’å®Ÿæ–½ã—ã¾ã™.

~~~ py
import pymc as pm
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import arviz as az
import graphviz
from pymc import model_to_graphviz
import statsmodels.api as sm
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error
from scipy.stats import norm, rankdata


save_dir = '../../images/slds/ch12/'

if __name__ == "__main__":

    # ---------------------------
    # 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    # ---------------------------
    df = pd.read_csv('hierarchical_regression.csv'
                ,dtype={'GPA': float
                       ,'Scholarship': bool
                       ,'Study_Hours': float
                       ,'Sports_hours': float
                       ,'Part_time_Work': float
                       ,'StudentID':int})

    # æ•°é‡åŒ–
    df = pd.get_dummies(df, columns=['Scholarship'], dtype='int')

    #æ¨™æº–åŒ–
    from sklearn.preprocessing import StandardScaler
    scaler = StandardScaler()
    df[['Scholarship_True'
       ,'Study_Hours'
       ,'Part_time_Work'
       ,'Sports_hours']] = scaler.fit_transform(df[['Scholarship_True'
                                                   ,'Study_Hours'
                                                   ,'Part_time_Work'
                                                   ,'Sports_hours']])

    # ---------------------------
    # ï¼’. ç·šå½¢å›å¸°
    # ---------------------------
    
    # èª¬æ˜å¤‰æ•°(X)ã¨ç›®çš„å¤‰æ•°(y)ã«åˆ†å‰²
    X = df[['Scholarship_True', 'Study_Hours']]
    y = df['GPA']


    # åˆ‡ç‰‡(å®šæ•°é …)ã‚’è¿½åŠ 
    X = sm.add_constant(X)
    lm = sm.OLS(y, X).fit()
    print("\n[é€šå¸¸ã®ç·šå½¢å›å¸°ã®çµæœ]\n")
    print(lm.summary())
    lm_preds = lm.predict(X)
~~~

::: warn

- `if __name__ == "__main__":` ã®å¿…è¦æ€§

ã“ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ã¯,ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã‚’`if __name__ == "__main__":`ã®ä¸‹ã«è¨˜è¿°ã—ã¦ã„ã¾ã™. ã“ã‚Œã¯ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰é‡è¦ã§ã™:

- **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é˜²ã**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå ´åˆã«,ãƒ¡ã‚¤ãƒ³å‡¦ç†ãŒè‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ãã¾ã™.

- **PyMCã®ä¸¦åˆ—å‡¦ç†ã¨ã®äº’æ›æ€§**: PyMCã¯MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ™‚ã«ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†ãŸã‚,`multiprocessing`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™. `multiprocessing`ã¯å„ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚,`if __name__ == "__main__":`ãŒãªã„ã¨,ç„¡é™å†å¸°ã‚„äºˆæœŸã—ãªã„å‹•ä½œãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™.

- **Windowsã§ã®å®Ÿè¡Œä¿è¨¼**: ç‰¹ã«Windowsç’°å¢ƒã§ã¯,`multiprocessing`ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«`if __name__ == "__main__":`ãŒå¿…é ˆã§ã™. ã“ã‚ŒãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™.

ãã®ãŸã‚,ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’è¡Œã†éš›ã¯,å¿…ãšãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’`if __name__ == "__main__":`ã®ä¸‹ã«è¨˜è¿°ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„.

ä»¥é™ã®ã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦`if __name__ == "__main__":`ã®ä¸‹ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹å‰æã¨ãªã‚Šã¾ã™ã®ã§æ³¨æ„ã—ã¦ä¸‹ã•ã„.

:::


## åº§æ¨™è¨­å®š

ã¾ãš,`PyMC`ã§ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ã«å½“ãŸã£ã¦,**åº§æ¨™(coordinates)**ã‚’å®šç¾©ã—ã¾ã™.

~~~ py
    coords = {
        "student": df["StudentID"].values,
        "obs_id": np.arange(len(df))
    }
~~~

::: warn

- åº§æ¨™(coordinates)ã®æ„å‘³

`coords`ã¯,`PyMC`ã§å¤šæ¬¡å…ƒãƒ‡ãƒ¼ã‚¿ã‚„éšå±¤ãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ã†éš›ã«ä½¿ç”¨ã™ã‚‹åº§æ¨™ç³»ã®å®šç¾©ã§ã™. ã“ã®è¾æ›¸ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¹å‰²ã‚’æŒã¡ã¾ã™:

- **`"student"`**: å­¦ç”Ÿã®IDã‚’è¡¨ã™åº§æ¨™è»¸ã§ã™. `df["StudentID"].values`ã«ã‚ˆã‚Š,å„ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆãŒã©ã®å­¦ç”Ÿã«å¯¾å¿œã™ã‚‹ã‹ã‚’å®šç¾©ã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡$\alpha_i$ã‚’å­¦ç”Ÿã”ã¨ã«å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™.

- **`"obs_id"`**: è¦³æ¸¬å€¤ã®IDã‚’è¡¨ã™åº§æ¨™è»¸ã§ã™. `np.arange(len(df))`ã«ã‚ˆã‚Š,å„è¦³æ¸¬å€¤ã«é€£ç•ªã®IDã‚’å‰²ã‚Šå½“ã¦ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ãƒ‡ãƒ¼ã‚¿ã®é †åºã‚’ä¿æŒã—,å„è¦³æ¸¬å€¤ã«å¯¾å¿œã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„å¤‰æ•°ã‚’å®šç¾©ã§ãã¾ã™.

ã“ã®åº§æ¨™ç³»ã«ã‚ˆã‚Š,`PyMC`ã¯å­¦ç”Ÿã”ã¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿($\alpha_i$ãªã©)ã‚’é©åˆ‡ã«ç®¡ç†ã—,éšå±¤ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™.

:::

## ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰

æ¬¡ã«ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™. ä»¥ä¸‹,ãƒ¢ãƒ‡ãƒ«å…¨ä½“åƒã§å®šç¾©ã—ãŸå„è¦ç´ ã¨PyMCã‚³ãƒ¼ãƒ‰ã®å¯¾å¿œé–¢ä¿‚ã‚’ç¤ºã—ãªãŒã‚‰èª¬æ˜ã—ã¾ã™.

~~~ py
    with pm.Model(coords=coords) as model:
        st = pm.Data("st", df["Study_Hours"])
        #ptw = pm.Data("ptw", df["Part_time_Work"])
        ss = pm.Data("ss", df["Scholarship_True"])
        student_idx = pm.Data("student_idx", df["StudentID"])

        #ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡
        z_alpha = pm.Normal("z_alpha", 0, 1, dims="student")
        mu_alpha = pm.Normal("mu_alpha", 0, 1)
        sigma_alpha = pm.HalfNormal("sigma_alpha", 1)
        alpha = pm.Deterministic("alpha", mu_alpha + sigma_alpha * z_alpha, dims="student")


        # å‹‰å¼·æ™‚é–“ã®åŠ¹æœ
        beta_st = pm.Normal("beta_st",0,1)
        
        # å¥¨å­¦é‡‘ã®åŠ¹æœ
        beta_ss = pm.Normal("beta_ss",0,1)
 
        mu = alpha[student_idx] + beta_st * st +  beta_ss * ss

        #sigma = pm.HalfNormal("sigma", 1)
        sigma = 0.3
        gpa_obs = pm.Normal("GPA",
                            mu=mu,
                            sigma=sigma,
                            observed=df["GPA"],
                            dims="obs_id"
                        )
        trace = pm.sample(draws =2000, tune=2000, chains=4, target_accept=0.95, return_inferencedata=True)
        posterior_predictive = pm.sample_posterior_predictive(trace)
~~~

### ãƒ¢ãƒ‡ãƒ«å…¨ä½“åƒã¨ã®å¯¾å¿œé–¢ä¿‚

| ãƒ¢ãƒ‡ãƒ«å…¨ä½“åƒ | PyMCã‚³ãƒ¼ãƒ‰ | èª¬æ˜ |
|------------|-----------|------|
| $y_i \sim N(\mu_i, \sigma^2)$ | `gpa_obs = pm.Normal("GPA", mu=mu, sigma=sigma, observed=df["GPA"])` | ç›®çš„å¤‰æ•°ã®åˆ†å¸ƒ |
| $\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s$ | `mu = alpha[student_idx] + beta_st * st + beta_ss * ss` | ç·šå½¢äºˆæ¸¬å­ |
| $\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$ | `alpha = pm.Deterministic(..., mu_alpha + sigma_alpha * z_alpha, dims="student")` | ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡ |
| $\mu_{\alpha} \sim N(0, 1)$, $\sigma_{\alpha} \sim HN(1)$ | `mu_alpha = pm.Normal(0, 1)`, `sigma_alpha = pm.HalfNormal(1)` | è¶…äº‹å‰åˆ†å¸ƒ(Î±) |
| $\beta_{st} \sim N(0, 1)$ | `beta_st = pm.Normal("beta_st", 0, 1)` | å‹‰å¼·æ™‚é–“ã®åŠ¹æœ(å›ºå®šåŠ¹æœ) |
| $\beta_{ss} \sim N(0, 1)$ | `beta_ss = pm.Normal("beta_ss", 0, 1)` | å¥¨å­¦é‡‘ã®åŠ¹æœ(å›ºå®šåŠ¹æœ) |

::: note

- ã‚³ãƒ¼ãƒ‰ã®è©³ç´°èª¬æ˜

- **éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–**: `alpha = mu_alpha + sigma_alpha * z_alpha`ã¨ã„ã†å½¢å¼ã¯,**éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–(non-centered parameterization)**ã¨å‘¼ã°ã‚Œã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,$z_{\alpha} \sim N(0, 1)$ã‹ã‚‰$\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$ã‚’ç”Ÿæˆã—ã¾ã™. ã“ã®æ–¹æ³•ã¯,MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™.

- **`dims="student"`**: ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡$\alpha_i$ã¯å­¦ç”Ÿã”ã¨ã«ç•°ãªã‚‹ãŸã‚,`dims="student"`ã‚’æŒ‡å®šã—ã¦å­¦ç”Ÿã®åº§æ¨™è»¸ã«æ²¿ã£ã¦å®šç¾©ã—ã¾ã™.

- **`alpha[student_idx]`**: å„è¦³æ¸¬å€¤ã«å¯¾å¿œã™ã‚‹å­¦ç”Ÿã®åˆ‡ç‰‡ã‚’å–å¾—ã—ã¾ã™. `student_idx`ã¯å„è¦³æ¸¬å€¤ãŒã©ã®å­¦ç”Ÿã«å¯¾å¿œã™ã‚‹ã‹ã‚’ç¤ºã™ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã™.

- **`beta_st`ã¨`beta_ss`ã¯å›ºå®šåŠ¹æœ**: ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«ã§ã¯,`beta_st`ã¨`beta_ss`ã¯å­¦ç”Ÿé–“ã§åŒã˜å€¤ã‚’æŒã¤å›ºå®šåŠ¹æœã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã¾ã™. ã“ã‚Œã‚‰ã¯éšå±¤æ§‹é€ ã‚’æŒãŸãš,ç›´æ¥$N(0, 1)$ã®äº‹å‰åˆ†å¸ƒã‹ã‚‰æ¨å®šã•ã‚Œã¾ã™.

- **`observed=df["GPA"]`**: è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§,å°¤åº¦é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¾ã™.

:::

## MCMC

ç¶šã„ã¦,ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’MCMCã«ã‚ˆã£ã¦,æ¨å®šã—ã¾ã™.


~~~py
        # MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®å®Ÿè¡Œ
        trace = pm.sample(draws =2000, tune=2000, chains=4, target_accept=0.95, return_inferencedata=True)
        # äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
        posterior_predictive = pm.sample_posterior_predictive(trace)
~~~

::: note

- MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ä»•çµ„ã¿

1. **åˆæœŸå€¤ã®è¨­å®š**: å„ãƒã‚§ãƒ¼ãƒ³ã¯ç•°ãªã‚‹åˆæœŸå€¤ã‹ã‚‰é–‹å§‹ã—ã¾ã™.

2. **ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æœŸé–“**: `tune`æœŸé–“ä¸­,ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’æ¢ç´¢ã—,åŠ¹ç‡çš„ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ãŸã‚ã«èª¿æ•´ã•ã‚Œã¾ã™.

3. **ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æœŸé–“**: `draws`æœŸé–“ä¸­,äº‹å¾Œåˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—ã—ã¾ã™. å„ã‚¹ãƒ†ãƒƒãƒ—ã§,ç¾åœ¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã‹ã‚‰æ–°ã—ã„å€¤ã‚’ææ¡ˆã—,å—å®¹/æ£„å´ã‚’æ±ºå®šã—ã¾ã™.

4. **åæŸã®ç¢ºèª**: è¤‡æ•°ã®ãƒã‚§ãƒ¼ãƒ³ãŒåŒã˜åˆ†å¸ƒã«åæŸã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«è¡Œã‚ã‚ŒãŸã‹ã‚’è¨ºæ–­ã§ãã¾ã™.


- MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®åŸºæœ¬æ¦‚å¿µ

**`pm.sample()`**ã¯,MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œã—,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®äº‹å¾Œåˆ†å¸ƒã‚’æ¨å®šã—ã¾ã™. å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ„å‘³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™.

- **`draws=2000`**: å„ãƒã‚§ãƒ¼ãƒ³ã‹ã‚‰å–å¾—ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«æ•°ã§ã™. ã“ã®ä¾‹ã§ã¯,å„ãƒã‚§ãƒ¼ãƒ³ã‹ã‚‰2000å€‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—ã—ã¾ã™. åˆè¨ˆã§ã¯`chains Ã— draws = 4 Ã— 2000 = 8000`å€‹ã®ã‚µãƒ³ãƒ—ãƒ«ãŒå¾—ã‚‰ã‚Œã¾ã™.

- **`tune=2000`**: **ãƒãƒ¼ãƒ³ã‚¤ãƒ³æœŸé–“(burn-in period)**ã¾ãŸã¯**ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æœŸé–“**ã§ã™. ã“ã®æœŸé–“ä¸­ã«å–å¾—ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ã¯ç ´æ£„ã•ã‚Œã¾ã™. MCMCã¯åˆæœŸå€¤ã‹ã‚‰é–‹å§‹ã™ã‚‹ãŸã‚,åˆæœŸã®ã‚µãƒ³ãƒ—ãƒ«ã¯äº‹å¾Œåˆ†å¸ƒã«åæŸã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™. ã“ã®æœŸé–“ã§ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹ã‚ˆã†èª¿æ•´ã•ã‚Œã¾ã™.

- **`chains=4`**: ä¸¦åˆ—ã«å®Ÿè¡Œã™ã‚‹**ãƒãƒ«ã‚³ãƒ•é€£é–**ã®æ•°ã§ã™. è¤‡æ•°ã®ãƒã‚§ãƒ¼ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§,åæŸã®è¨ºæ–­ãŒå¯èƒ½ã«ãªã‚Šã¾ã™. é€šå¸¸ã¯4ã¤ã®ãƒã‚§ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—,ãã‚Œãã‚Œç•°ãªã‚‹åˆæœŸå€¤ã‹ã‚‰é–‹å§‹ã—ã¾ã™. ã™ã¹ã¦ã®ãƒã‚§ãƒ¼ãƒ³ãŒåŒã˜åˆ†å¸ƒã«åæŸã™ã‚Œã°,é©åˆ‡ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§ãã¦ã„ã‚‹ã¨åˆ¤æ–­ã§ãã¾ã™.

- **`target_accept=0.95`**: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®**å—å®¹ç‡(acceptance rate)**ã®ç›®æ¨™å€¤ã§ã™. NUTS(No-U-Turn Sampler)ãªã©ã®é©å¿œå‹MCMCã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã¯,ã“ã®å—å®¹ç‡ã‚’èª¿æ•´ã—ãªãŒã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã™. 0.95ã¯é«˜ã„å—å®¹ç‡ã§,ã‚ˆã‚ŠåŠ¹ç‡çš„ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’ç›®æŒ‡ã—ã¾ã™.

- **`return_inferencedata=True`**: çµæœã‚’`arviz`ã®`InferenceData`å½¢å¼ã§è¿”ã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,å¯è¦–åŒ–ã‚„è¨ºæ–­ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™.

**`pm.sample_posterior_predictive(trace)`**ã¯,æ¨å®šã•ã‚ŒãŸäº‹å¾Œåˆ†å¸ƒã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬æ€§èƒ½ã‚’è©•ä¾¡ã—ãŸã‚Š,äºˆæ¸¬åŒºé–“ã‚’è¨ˆç®—ã—ãŸã‚Šã§ãã¾ã™.

:::

ä¸Šè¨˜ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§,æ¨™æº–å‡ºåŠ›ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºãŒãªã•ã‚Œã¾ã™.

~~~ sh
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 2 jobs)
NUTS: [z_alpha, mu_alpha, sigma_alpha, beta_st, beta_ss]
  Progress                                   Draws   Divergences   Step size   Grad evals   Sampling Speed   Elapsed   Remaining
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   4000    0             0.205       15           326.43 draws/s   0:00:12   0:00:00
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   4000    0             0.222       31           340.23 draws/s   0:00:11   0:00:00
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   4000    0             0.203       15           151.86 draws/s   0:00:26   0:00:00
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   4000    0             0.182       15           158.16 draws/s   0:00:25   0:00:00
~~~

#### æ¨™æº–å‡ºåŠ›ã®è§£èª¬

ã“ã®å‡ºåŠ›ã¯,MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®å®Ÿè¡ŒçŠ¶æ³ã‚’ç¤ºã—ã¦ã„ã¾ã™. å„é …ç›®ã®æ„å‘³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

- **`Initializing NUTS using jitter+adapt_diag...`**: NUTS(No-U-Turn Sampler)ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™. `jitter+adapt_diag`ã¯åˆæœŸå€¤ã®è¨­å®šæ–¹æ³•ã¨,ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã®èª¿æ•´æ–¹æ³•ã‚’è¡¨ã—ã¾ã™.

- **`Multiprocess sampling (4 chains in 2 jobs)`**: 4ã¤ã®ãƒã‚§ãƒ¼ãƒ³ã‚’2ã¤ã®ä¸¦åˆ—ã‚¸ãƒ§ãƒ–ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,è¨ˆç®—æ™‚é–“ã‚’çŸ­ç¸®ã§ãã¾ã™.

- **`NUTS: [z_alpha, mu_alpha, ...]`**: NUTSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆã§ã™. ãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã—ãŸã™ã¹ã¦ã®ç¢ºç‡å¤‰æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™.

![](/images/slds/ch12/mcmc.png)

::: note

- NUTSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**NUTS(No-U-Turn Sampler)**ã¯,ãƒãƒŸãƒ«ãƒˆãƒ‹ã‚¢ãƒ³ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•(HMC)ã®ä¸€ç¨®ã§,PyMCã§ã¯,ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§NUTSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚,ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®è©³ç´°ã‚’æ„è­˜ã›ãšã«,åŠ¹ç‡çš„ãªãƒ™ã‚¤ã‚ºæ¨å®šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™.

é€šå¸¸ã®MCMCã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ (ãƒ¡ãƒˆãƒ­ãƒãƒªã‚¹æ³•ãªã©)ã¨æ¯”ã¹ã¦ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™.

**é€šå¸¸ã®MCMC(ãƒ¡ãƒˆãƒ­ãƒãƒªã‚¹æ³•ãªã©):**

- **ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯**: ç¾åœ¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«è¿‘ãã®å€¤ã‚’ææ¡ˆã—ã¾ã™.
- **ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã®å›ºå®š**: ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™.
- **åŠ¹ç‡ã®ä½ã•**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’ã‚†ã£ãã‚Šã¨æ¢ç´¢ã™ã‚‹ãŸã‚,å¤šãã®ã‚µãƒ³ãƒ—ãƒ«ãŒå¿…è¦ã§ã™.
- **é«˜æ¬¡å…ƒã§ã®éåŠ¹ç‡**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ãŒå¢—ãˆã‚‹ã¨,æ¢ç´¢ãŒéå¸¸ã«éåŠ¹ç‡ã«ãªã‚Šã¾ã™.

**NUTSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**

- **å‹¾é…æƒ…å ±ã®åˆ©ç”¨**: å°¤åº¦é–¢æ•°ã®å‹¾é…(å¾®åˆ†)ã‚’è¨ˆç®—ã—ã¦,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’åŠ¹ç‡çš„ã«æ¢ç´¢ã—ã¾ã™.
- **é©å¿œçš„ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚º**: ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’è‡ªå‹•çš„ã«èª¿æ•´ã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,æ‰‹å‹•ã§ã®èª¿æ•´ãŒä¸è¦ã«ãªã‚Šã¾ã™.
- **é•·è·é›¢ã®ç§»å‹•**: 1ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’å¤§ããç§»å‹•ã§ãã‚‹ãŸã‚,å°‘ãªã„ã‚µãƒ³ãƒ—ãƒ«æ•°ã§åŠ¹ç‡çš„ã«æ¢ç´¢ã§ãã¾ã™.
- **ã€ŒUã‚¿ãƒ¼ãƒ³ã€ã®å›é¿**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’æ¢ç´¢ã™ã‚‹éš›ã«,åŒã˜æ–¹å‘ã«æˆ»ã‚‹ã“ã¨ã‚’é¿ã‘ã¾ã™. ã“ã‚ŒãŒã€ŒNo-U-Turnã€ã¨ã„ã†åå‰ã®ç”±æ¥ã§ã™.
- **é«˜æ¬¡å…ƒã§ã®åŠ¹ç‡**: é«˜æ¬¡å…ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã§ã‚‚åŠ¹ç‡çš„ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§ãã¾ã™.

:::


å„è¡Œã¯1ã¤ã®ãƒã‚§ãƒ¼ãƒ³ã®é€²æ—çŠ¶æ³ã‚’è¡¨ã—ã¾ã™(ã“ã®ä¾‹ã§ã¯4ã¤ã®ãƒã‚§ãƒ¼ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™). å„åˆ—ã®æ„å‘³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

- **`Progress`**: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®é€²æ—çŠ¶æ³ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã—ã¾ã™. `â”`ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã»ã©,ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒé€²ã‚“ã§ã„ã¾ã™.

- **`Draws`**: ç¾åœ¨ã¾ã§ã«å–å¾—ã—ãŸã‚µãƒ³ãƒ—ãƒ«æ•°ã§ã™. `tune + draws = 2000 + 2000 = 4000`ã¨ãªã‚‹ãŸã‚,åˆè¨ˆ4000ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã¾ã™.

- **`Divergences`**: **ç™ºæ•£(divergence)**ã®ç™ºç”Ÿå›æ•°ã§ã™. ç™ºæ•£ã¯,ã‚µãƒ³ãƒ—ãƒ©ãƒ¼ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã®å›°é›£ãªé ˜åŸŸã«é­é‡ã—ãŸéš›ã«ç™ºç”Ÿã—ã¾ã™. ç™ºæ•£ãŒå¤šã„å ´åˆ(é€šå¸¸ã¯100ã‚’è¶…ãˆã‚‹å ´åˆ),ãƒ¢ãƒ‡ãƒ«ã‚„ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨­å®šã‚’è¦‹ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™. ã“ã®ä¾‹ã§ã¯,ã™ã¹ã¦ã®ãƒã‚§ãƒ¼ãƒ³ã§ç™ºæ•£ãŒ0å›ã¨ãªã£ã¦ãŠã‚Š,è‰¯å¥½ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™. ã“ã‚Œã¯,éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã«ã‚ˆã‚Š,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã®ç›¸é–¢ãŒä½æ¸›ã•ã‚Œ,åŠ¹ç‡çš„ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒå®Ÿç¾ã•ã‚ŒãŸçµæœã§ã™.

- **`Step size`**: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®**ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚º**ã§ã™. ã“ã‚ŒãŒå¤§ãã„ã»ã©,1ã‚¹ãƒ†ãƒƒãƒ—ã§å¤§ãããƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã‚’ç§»å‹•ã—ã¾ã™. NUTSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯,ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’è‡ªå‹•çš„ã«èª¿æ•´ã—ã¾ã™. ã“ã®ä¾‹ã§ã¯,0.182-0.222ã®ç¯„å›²ã§èª¿æ•´ã•ã‚Œã¦ãŠã‚Š,é©åˆ‡ãªã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™. å€¤ã¯ãƒã‚§ãƒ¼ãƒ³ã”ã¨ã«ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™.

- **`Grad evals`**: 1ã‚¹ãƒ†ãƒƒãƒ—ã‚ãŸã‚Šã®**å‹¾é…è©•ä¾¡å›æ•°**ã§ã™. NUTSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯,å°¤åº¦é–¢æ•°ã®å‹¾é…ã‚’è¨ˆç®—ã—ã¦åŠ¹ç‡çš„ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¾ã™. ã“ã®å€¤ãŒå¤§ãã„ã»ã©,ã‚ˆã‚Šå¤šãã®æ¢ç´¢ã‚’è¡Œã£ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™. ã“ã®ä¾‹ã§ã¯,15-31å›ã¨ãªã£ã¦ãŠã‚Š,åŠ¹ç‡çš„ãªæ¢ç´¢ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™.

- **`Sampling Speed`**: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®é€Ÿåº¦(1ç§’ã‚ãŸã‚Šã®ã‚µãƒ³ãƒ—ãƒ«æ•°)ã§ã™. ã“ã®å€¤ãŒå¤§ãã„ã»ã©,é«˜é€Ÿã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§ãã¾ã™. ãƒ¢ãƒ‡ãƒ«ã®è¤‡é›‘ã•ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã«ã‚ˆã£ã¦å¤§ããå¤‰ã‚ã‚Šã¾ã™. ã“ã®ä¾‹ã§ã¯,151.86-340.23 draws/sã¨ãªã£ã¦ãŠã‚Š,æ¯”è¼ƒçš„é«˜é€Ÿã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™.

::: warn 

- **ç™ºæ•£ã«ã¤ã„ã¦:**

ç™ºæ•£ãŒå¤šãç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã¯,ãƒ¢ãƒ‡ãƒ«ç­‰ãŒãƒ‡ãƒ¼ã‚¿ã«ä¸Šæ‰‹ãé©åˆã—ã¦ã„ãªã„çŠ¶æ³ã‚’è¡¨ã—ã¦ã„ã¾ã™.
ä»Šå›ã¯å®Ÿæ–½ã—ã¾ã›ã‚“ãŒ,ãã®ã‚ˆã†ãªå ´åˆã«ã¯ä»¥ä¸‹ã®å¯¾å‡¦ã«ã‚ˆã£ã¦,ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ‰‹æ³•ã‚„ãƒ¢ãƒ‡ãƒ«ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™.

- ãƒ¢ãƒ‡ãƒ«ã®å†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–(éä¸­å¿ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã®ä½¿ç”¨)
- `target_accept`ã®èª¿æ•´(é€šå¸¸ã¯0.8-0.9ãŒæ¨å¥¨ã•ã‚Œã‚‹)
- äº‹å‰åˆ†å¸ƒã®è¦‹ç›´ã—
- ãƒ‡ãƒ¼ã‚¿ã®å†æ¤œè¨

ãŸã ã—,ç™ºæ•£ãŒå°‘ãªã„å ´åˆã§ã‚‚,ä»¥ä¸‹ã§è¡Œã†ãƒ¢ãƒ‡ãƒ«è¨ºæ–­(ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ)ã§åæŸã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™.

:::



## ãƒ¢ãƒ‡ãƒ«è¨ºæ–­ã¨å¯è¦–åŒ–

ã¾ãšã¯ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªã—ã¾ã™.

~~~ py
    graph = model_to_graphviz(model)
    graph.render(filename= save_dir + "hierarchical_bayes_model", format="pdf")
~~~

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§,ãƒ¢ãƒ‡ãƒ«ã®å…¨ä½“åƒãŒpdfãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™.

![](/images/slds/ch12/hierarchical_bayes_model.png)

è«–æ–‡ç­‰ã«æ²è¼‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§,ã‚³ãƒ¼ãƒ‰ã¨ã®å¯¾å¿œé–¢ä¿‚ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†.

ç¶šã„ã¦,ãƒ¢ãƒ‡ãƒ«ã®è¨ºæ–­çµæœã‚’ç¢ºèªã—ã¾ã™. `az.plot_trace()`ã‚’ç”¨ã„ã‚‹ã“ã¨ã§,æŒ‡å®šã—ãŸå¤‰æ•°ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°éç¨‹ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™.

~~~ py
    az.plot_trace(trace
                 ,var_names=["sigma_alpha"
                            ,"alpha"
                            ,"beta_st"
                            ,"beta_ss"])
    plt.tight_layout()
    plt.savefig(save_dir + 'trace.png')
    plt.close()
~~~

![](/images/slds/ch12/trace.png)

ã“ã®å›³ã§ã¯,å·¦å´ã«4ã¤ã®ã‚µãƒ³ãƒ—ãƒ«ã”ã¨ã«æ¨å®šã•ã‚ŒãŸåˆ†å¸ƒã®è¨ˆä¸Š,å³å´ã«ãƒˆãƒ¬ãƒ¼ã‚¹ã®éç¨‹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™. 

![](/images/slds/ch12/sampling_image.png)

å¤§ã¾ã‹ã«ã¯,

- å·¦å´ã®åˆ†å¸ƒãŒå…¨ã¦ã®ã‚µãƒ³ãƒ—ãƒ«ã§æ¦‚ã­åŒã˜å½¢çŠ¶ã«ãªã£ã¦ã„ã‚‹
- å³å´ã®ãƒˆãƒ¬ãƒ¼ã‚¹ãŒä¸€ç®‡æ‰€ã«åæŸã—ã¦ã„ã‚‹

ã“ã¨ã‹ã‚‰,æ¦‚ã­è‰¯å¥½ã«æ¨å®šã§ãã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.

ãŸã ã—,alphaã«é–¢ã—ã¦ã¯å­¦ç”Ÿåˆ¥ã®åˆ†å¸ƒãŒç•°ãªã‚‹è‰²ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ä¸‹ã•ã„.
å­¦ç”Ÿãã‚Œãã‚Œã®åŸºç¤å­¦åŠ›ã®åˆ†å¸ƒãŒç•°ãªã£ã¦ã„ã‚‹æ§˜ãŒè¡¨ç¾ã•ã‚Œã¦ã„ã¾ã™.

ã‚°ãƒ©ãƒ•ã§ã¯å¤§ã¾ã‹ãªå°è±¡ã—ã‹ã‚ã‹ã‚‰ãªã„ã®ã§æ›´ã«,`az.summary()`ã‚’åˆ©ç”¨ã—ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°çµæœã‚’æ•°å€¤ã§ç¢ºèªã—ã¦ã¿ã¾ã™.

~~~ py
    print(az.summary(trace
                    ,var_names=["sigma_alpha"
                               ,"alpha"
                               ,"beta_st"
                               ,"beta_ss"]))
    summary_df = az.summary(trace
                           ,var_names=["sigma_alpha"
                                      ,"alpha"
                                      ,"beta_st"
                                      ,"beta_ss"])
    summary_df.to_csv("bayesian_summary.csv"
                     ,encoding="utf-8-sig")
~~~

çµæœã¯å­¦ç”Ÿåˆ¥ã®alphaãŒå‡ºåŠ›ã•ã‚Œã¦ãŠã‚Šéå¸¸ã«é•·ã„ãŸã‚,æŠœç²‹ã—ãŸã‚‚ã®ãŒä»¥ä¸‹ã«ãªã‚Šã¾ã™.

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | mean | sd | hdi_3% | hdi_97% | mcse_mean | mcse_sd | ess_bulk | ess_tail | r_hat |
|-----------|------|----|--------|---------|-----------|---------|----------|----------|-------|
| sigma_alpha | 0.586 | 0.039 | 0.514 | 0.659 | 0.001 | 0.001 | 2193 | 4123 | 1 |
| alpha[0] | 1.337 | 0.276 | 0.826 | 1.851 | 0.003 | 0.002 | 9277 | 5519 | 1 |
| alpha[1] | 2.23 | 0.272 | 1.725 | 2.759 | 0.003 | 0.002 | 9863 | 6118 | 1 |
| alpha[2] | 2.044 | 0.267 | 1.541 | 2.543 | 0.003 | 0.002 | 9771 | 5823 | 1 |
| alpha[3] | 2.177 | 0.278 | 1.644 | 2.683 | 0.003 | 0.002 | 6533 | 5528 | 1 |
| alpha[4] | 3.02 | 0.27 | 2.506 | 3.512 | 0.003 | 0.002 | 10929 | 6162 | 1 |
| alpha[5] | 1.543 | 0.276 | 1.036 | 2.054 | 0.003 | 0.002 | 9980 | 5880 | 1 |
| alpha[6] | 1.709 | 0.275 | 1.184 | 2.22 | 0.003 | 0.002 | 7096 | 4980 | 1 |
| alpha[7] | 2.535 | 0.273 | 1.985 | 3.023 | 0.003 | 0.002 | 8866 | 5628 | 1 |
| alpha[8] | 2.003 | 0.265 | 1.503 | 2.498 | 0.003 | 0.002 | 8334 | 6208 | 1 |
| alpha[9] | 2.783 | 0.27 | 2.247 | 3.267 | 0.003 | 0.002 | 8919 | 4931 | 1 |
| alpha[10] | 2.443 | 0.271 | 1.944 | 2.977 | 0.003 | 0.002 | 8207 | 5363 | 1 |
| alpha[180] | 1.205 | 0.283 | 0.666 | 1.724 | 0.003 | 0.002 | 8038 | 5827 | 1 |
| alpha[181] | 1.952 | 0.274 | 1.443 | 2.463 | 0.003 | 0.002 | 7932 | 6444 | 1 |
| alpha[182] | 2.039 | 0.272 | 1.529 | 2.552 | 0.003 | 0.002 | 9013 | 5407 | 1 |
| alpha[183] | 2.503 | 0.265 | 2.018 | 3.006 | 0.003 | 0.002 | 10853 | 6100 | 1 |
| alpha[184] | 2.017 | 0.277 | 1.481 | 2.519 | 0.003 | 0.002 | 6437 | 5893 | 1 |
| alpha[185] | 1.985 | 0.274 | 1.483 | 2.521 | 0.003 | 0.002 | 7264 | 6106 | 1 |
| alpha[186] | 1.729 | 0.279 | 1.198 | 2.251 | 0.003 | 0.002 | 8657 | 5455 | 1 |
| alpha[187] | 1.153 | 0.274 | 0.65 | 1.68 | 0.003 | 0.002 | 11005 | 5637 | 1 |
| alpha[188] | 2.412 | 0.272 | 1.898 | 2.918 | 0.003 | 0.002 | 7896 | 5719 | 1 |
| alpha[189] | 2.093 | 0.269 | 1.588 | 2.6 | 0.003 | 0.002 | 7705 | 5726 | 1 |
| beta_st | 0.559 | 0.048 | 0.473 | 0.651 | 0.001 | 0.001 | 1889 | 3833 | 1 |
| beta_ss | 0.139 | 0.048 | 0.044 | 0.225 | 0.001 | 0.001 | 1957 | 3460 | 1 |

::: note

-  MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°çµ±è¨ˆé‡

ã“ã®è¡¨ã«ã¯,MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®çµæœã‚’è¦ç´„ã™ã‚‹çµ±è¨ˆé‡ãŒå«ã¾ã‚Œã¦ã„ã¾ã™.

- **`mean`**: äº‹å¾Œåˆ†å¸ƒã®**å¹³å‡å€¤**ã§ã™. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‚¹æ¨å®šå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™.

- **`sd`**: äº‹å¾Œåˆ†å¸ƒã®**æ¨™æº–åå·®**ã§ã™. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸ç¢ºå®Ÿæ€§ã‚’è¡¨ã—ã¾ã™.

- **`hdi_3%`, `hdi_97%`**: **æœ€é«˜å¯†åº¦åŒºé–“(Highest Density Interval, HDI)**ã®ä¸‹é™ã¨ä¸Šé™ã§ã™. äº‹å¾Œåˆ†å¸ƒã®94%ãŒå«ã¾ã‚Œã‚‹åŒºé–“ã‚’è¡¨ã—ã¾ã™. ã“ã‚Œã¯ä¿¡é ¼åŒºé–“ã®ã‚ˆã†ãªæ¦‚å¿µã§,ã“ã®åŒºé–“å†…ã«çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ãŒå«ã¾ã‚Œã‚‹ç¢ºç‡ãŒé«˜ã„ã“ã¨ã‚’ç¤ºã—ã¾ã™.

- **`mcse_mean`, `mcse_sd`**: **ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ¨™æº–èª¤å·®(Monte Carlo Standard Error)**ã§ã™. MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹æ¨å®šã®ä¸ç¢ºå®Ÿæ€§ã‚’è¡¨ã—ã¾ã™. ã“ã®å€¤ãŒå°ã•ã„ã»ã©,æ¨å®šãŒå®‰å®šã—ã¦ã„ã¾ã™.

- **`ess_bulk`, `ess_tail`**: **æœ‰åŠ¹ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º(Effective Sample Size, ESS)**ã§ã™. MCMCã‚µãƒ³ãƒ—ãƒ«ã«ã¯è‡ªå·±ç›¸é–¢ãŒã‚ã‚‹ãŸã‚,å®Ÿéš›ã«ç‹¬ç«‹ãªæƒ…å ±ã‚’å«ã‚€ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’è¡¨ã—ã¾ã™. `ess_bulk`ã¯åˆ†å¸ƒã®ä¸­å¿ƒéƒ¨åˆ†,`ess_tail`ã¯åˆ†å¸ƒã®å°¾éƒ¨ã®æœ‰åŠ¹ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã§ã™. é€šå¸¸,400ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™.

- **`r_hat`**: **$\hat{R}$çµ±è¨ˆé‡(Gelman-Rubinçµ±è¨ˆé‡)**ã§ã™. è¤‡æ•°ã®ãƒã‚§ãƒ¼ãƒ³ãŒåŒã˜åˆ†å¸ƒã«åæŸã—ã¦ã„ã‚‹ã‹ã‚’ç¤ºã™æŒ‡æ¨™ã§ã™. 1.0ã«è¿‘ã„ã»ã©è‰¯å¥½ã§,é€šå¸¸1.01ä»¥ä¸‹ãŒæ¨å¥¨ã•ã‚Œã¾ã™. 1.01ã‚’è¶…ãˆã‚‹å ´åˆã¯,ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒä¸ååˆ†ã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™.

:::


**åæŸã®è¨ºæ–­:**
- ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§`r_hat = 1.0`ã¨ãªã£ã¦ãŠã‚Š,è‰¯å¥½ãªåæŸã‚’ç¤ºã—ã¦ã„ã¾ã™. ã“ã‚Œã¯,4ã¤ã®ãƒã‚§ãƒ¼ãƒ³ãŒã™ã¹ã¦åŒã˜åˆ†å¸ƒã«åæŸã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™.

- æœ‰åŠ¹ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º(`ess_bulk`)ã¯,ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§400ã‚’å¤§ããè¶…ãˆã¦ãŠã‚Š,ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¯é©åˆ‡ã«è¡Œã‚ã‚Œã¦ã„ã¾ã™. ç‰¹ã«,`alpha[i]`ã®å¤šãã¯6000-11000ã®ç¯„å›²ã§,éå¸¸ã«è‰¯å¥½ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™. `beta_st`ã¨`beta_ss`ã¯1889ã¨1957ã¨ãªã£ã¦ãŠã‚Š,ã‚„ã‚„ä½ã‚ã§ã™ãŒ,æ¨å¥¨å€¤(400)ã‚’å¤§ããä¸Šå›ã£ã¦ãŠã‚Š,å•é¡Œã‚ã‚Šã¾ã›ã‚“.

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¨å®šå€¤:**

- **`sigma_alpha = 0.586`**: å­¦ç”Ÿé–“ã®åŸºç¤å­¦åŠ›ã®ã°ã‚‰ã¤ãã®æ¨™æº–åå·®ã§ã™. ã“ã®å€¤ãŒå¤§ãã„ã»ã©,å­¦ç”Ÿé–“ã®å­¦åŠ›å·®ãŒå¤§ãã„ã“ã¨ã‚’ç¤ºã—ã¾ã™. HDIåŒºé–“[0.514, 0.659]ã¯æ¯”è¼ƒçš„ç‹­ã,æ¨å®šã®ä¸ç¢ºå®Ÿæ€§ã¯å°ã•ã„ã§ã™.

- **`alpha[i]`**: å„å­¦ç”Ÿã®åŸºç¤å­¦åŠ›ã§ã™. ä¾‹ãˆã°,`alpha[4] = 3.02`ã¯,å­¦ç”Ÿ4ã®åŸºç¤å­¦åŠ›ãŒé«˜ã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™. ä¸€æ–¹,`alpha[187] = 1.153`ã¯,å­¦ç”Ÿ187ã®åŸºç¤å­¦åŠ›ãŒä½ã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™. å­¦ç”Ÿé–“ã§åŸºç¤å­¦åŠ›ã«å¤§ããªã°ã‚‰ã¤ããŒã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.

- **`beta_st = 0.559`**: å‹‰å¼·æ™‚é–“ã®åŠ¹æœã§ã™. ã“ã®å€¤ã¯æ­£ã§,å‹‰å¼·æ™‚é–“ãŒ1å˜ä½å¢—åŠ ã™ã‚‹ã¨,GPAãŒå¹³å‡çš„ã«0.559å¢—åŠ ã™ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™. HDIåŒºé–“[0.473, 0.651]ã¯0ã‚’å«ã¾ãªã„ãŸã‚,çµ±è¨ˆçš„ã«æœ‰æ„ãªæ­£ã®åŠ¹æœãŒã‚ã‚Šã¾ã™. ã“ã®åŒºé–“ã¯æ¯”è¼ƒçš„ç‹­ã,æ¨å®šã®ä¸ç¢ºå®Ÿæ€§ã¯å°ã•ã„ã§ã™.

- **`beta_ss = 0.139`**: å¥¨å­¦é‡‘ã®åŠ¹æœã§ã™. ã“ã®å€¤ã‚‚æ­£ã§,å¥¨å­¦é‡‘ã‚’å—çµ¦ã—ã¦ã„ã‚‹å­¦ç”Ÿã®GPAãŒå¹³å‡çš„ã«0.139é«˜ã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™. HDIåŒºé–“[0.044, 0.225]ã¯0ã‚’å«ã¾ãªã„ãŸã‚,çµ±è¨ˆçš„ã«æœ‰æ„ãªæ­£ã®åŠ¹æœãŒã‚ã‚Šã¾ã™. ã“ã®åŒºé–“ã‚‚æ¯”è¼ƒçš„ç‹­ã,æ¨å®šã®ä¸ç¢ºå®Ÿæ€§ã¯å°ã•ã„ã§ã™.


## çµæœã®å¯è¦–åŒ–

ç¶šã„ã¦ä»Šå›ã®ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜èƒ½åŠ›ã«ã¤ã„ã¦å¯è¦–åŒ–ã—ã¦ã„ãã¾ã™.



### äº‹å¾Œäºˆæ¸¬ãƒã‚§ãƒƒã‚¯(Posterior Predictive Check, PPC)

**äº‹å¾Œäºˆæ¸¬ãƒã‚§ãƒƒã‚¯**ã¯,æ¨å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã‚Œã ã‘ã‚ˆãèª¬æ˜ã§ãã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã§ã™. å…·ä½“çš„ã«ã¯,æ¨å®šã•ã‚ŒãŸäº‹å¾Œåˆ†å¸ƒã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—,ãã®åˆ†å¸ƒãŒå®Ÿéš›ã®è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã¨ã©ã®ç¨‹åº¦ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’å¯è¦–åŒ–ã—ã¾ã™.

~~~ py
    idata = trace.copy()
    idata.extend(posterior_predictive)
    az.plot_ppc(idata, data_pairs={"GPA": "GPA"})
    plt.savefig(save_dir + 'ppc.png')
    plt.close()
~~~

- `idata.extend(posterior_predictive)`: äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã®ã‚µãƒ³ãƒ—ãƒ«ã‚’`InferenceData`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã—ã¾ã™.
- `az.plot_ppc()`: äº‹å¾Œäºˆæ¸¬ãƒã‚§ãƒƒã‚¯ã®å¯è¦–åŒ–ã‚’è¡Œã„ã¾ã™. è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã¨äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã‚’æ¯”è¼ƒã—ã¾ã™.

![](/images/slds/ch12/ppc.png)

ã“ã®å›³ã¯,è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿(é»’ã„å®Ÿç·š)ã¨äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒ(é’ã„é ˜åŸŸ)ã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™.

- **é»’ã„å®Ÿç·š**: å®Ÿéš›ã«è¦³æ¸¬ã•ã‚ŒãŸGPAãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã§ã™.
- **é’ã„é ˜åŸŸ**: æ¨å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸäº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã§ã™. è¤‡æ•°ã®ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸåˆ†å¸ƒã®ç¯„å›²ã‚’ç¤ºã—ã¦ã„ã¾ã™.
- **ã‚ªãƒ¬ãƒ³ã‚¸ã®å®Ÿè·µ**: é’ã„å®Ÿç·šã®å¹³å‡å€¤

è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒãŒäº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã®ç¯„å›²å†…(é’ã„ç·šã®ç¯„å›²)ã«åã¾ã£ã¦ã„ã‚‹å ´åˆ,ãƒ¢ãƒ‡ãƒ«ã¯ãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«èª¬æ˜ã—ã¦ã„ã‚‹ã¨åˆ¤æ–­ã§ãã¾ã™. ä¸€æ–¹,è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒãŒäº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ã‚‹å ´åˆ,ãƒ¢ãƒ‡ãƒ«ã®ä»®å®šã‚„æ§‹é€ ã‚’è¦‹ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™.

ã“ã®ä¾‹ã§ã¯,è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒãŒäº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã®ç¯„å›²å†…ã«åã¾ã£ã¦ãŠã‚Š,ãƒ¢ãƒ‡ãƒ«ãŒãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«èª¬æ˜ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™.


### äºˆæ¸¬å€¤ã®ç¢ºèª

ã¤ãã«,ç·šå½¢å›å¸°ã¨åŒæ§˜ã«äºˆæ¸¬å€¤ã¨å®Ÿæ¸¬å€¤ã®é–¢ä¿‚ã¨kdeãƒ—ãƒ­ãƒƒãƒˆã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†. ã¾ãšã¯äºˆæ¸¬å€¤ã‚’å–ã‚Šå‡ºã—ã¾ã™.

~~~ py
    # äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã‹ã‚‰äºˆæ¸¬å€¤(å¹³å‡)ã‚’å–ã‚Šå‡ºã™
    posterior_mean = idata.posterior_predictive["GPA"].mean(dim=("chain", "draw")).values
    # RMSEã‚’è¨ˆç®—
    bayes_rmse = mean_squared_error(df["GPA"], posterior_mean)
    print(f"[éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®RMSE] {bayes_rmse:.4f}\n")
~~~

- **`idata.posterior_predictive["GPA"]`**: äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸGPAã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™. ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯,è¤‡æ•°ã®ãƒã‚§ãƒ¼ãƒ³(`chain`)ã¨è¤‡æ•°ã®ãƒ‰ãƒ­ãƒ¼(`draw`)ã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹å¤šæ¬¡å…ƒé…åˆ—ã§ã™.

- **`.mean(dim=("chain", "draw"))`**: ã™ã¹ã¦ã®ãƒã‚§ãƒ¼ãƒ³ã¨ãƒ‰ãƒ­ãƒ¼ã«ã‚ãŸã£ã¦å¹³å‡ã‚’è¨ˆç®—ã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,å„è¦³æ¸¬å€¤ã«ã¤ã„ã¦,äº‹å¾Œäºˆæ¸¬åˆ†å¸ƒã®å¹³å‡å€¤(æœŸå¾…å€¤)ã‚’å–å¾—ã§ãã¾ã™. ã¤ã¾ã‚Š,å„å­¦ç”Ÿã®GPAã«ã¤ã„ã¦,ãƒ¢ãƒ‡ãƒ«ãŒäºˆæ¸¬ã™ã‚‹å¹³å‡çš„ãªå€¤ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™.

- **`.values`**: `xarray`ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’NumPyé…åˆ—ã«å¤‰æ›ã—ã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,å¾Œç¶šã®è¨ˆç®—ã‚„å¯è¦–åŒ–ã§ä½¿ç”¨ã—ã‚„ã™ããªã‚Šã¾ã™.

- **`mean_squared_error(df["GPA"], posterior_mean)`**: å®Ÿæ¸¬å€¤(`df["GPA"]`)ã¨äºˆæ¸¬å€¤(`posterior_mean`)ã®é–“ã®å¹³å‡äºŒä¹—èª¤å·®(RMSE)ã‚’è¨ˆç®—ã—ã¾ã™. ã“ã®å€¤ãŒå°ã•ã„ã»ã©,ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ç²¾åº¦ãŒé«˜ã„ã“ã¨ã‚’ç¤ºã—ã¾ã™.


~~~ py
    # ãƒ—ãƒ­ãƒƒãƒˆ
    plt.figure(figsize=(8, 6))
    plt.scatter(df['GPA'], posterior_mean, alpha=0.7, edgecolors="k")
    plt.xlabel("Predicted (Bayesian)")
    plt.ylabel("Actual GPA")
    plt.title("Bayesian Actual vs. Predicted")
    plt.plot([df['GPA'].min(), df['GPA'].max()],
             [df['GPA'].min(), df['GPA'].max()],
             color="red", linestyle="--", label="Perfect prediction")
    plt.grid()
    plt.legend()
    plt.savefig(save_dir + 'bayes.png')
    plt.close()

    plt.figure(figsize=(16,8))
    sns.kdeplot(posterior_mean, label = 'Predicted')
    sns.kdeplot(df['GPA'], label = 'Actual')
    plt.title('Actual/Predicted')
    plt.xlabel('GPA')
    plt.ylabel('Density')
    plt.legend()
    plt.savefig(save_dir + 'bayes_kde.png')
    plt.close()
~~~

![](/images/slds/ch12/bayes.png)
![](/images/slds/ch12/bayes_kde.png)

äºˆæ¸¬å€¤,åˆ†å¸ƒå…±ã«å¤§å¹…ã«æ”¹å–„ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.

### äºˆæ¸¬ç¯„å›²ã®å¯è¦–åŒ–

ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã¨ã¯ç•°ãªã‚Š,åˆ†å¸ƒã‚’æ¨å®šã—ã¦ã„ã‚‹ãŸã‚,å‹‰å¼·æ™‚é–“ã¨å¥¨å­¦é‡‘ã®æœ‰ç„¡ã«ã‚ˆã‚‹GPAã®äºˆæ¸¬å€¤ã¨,ãã®ä¸ç¢ºå®Ÿæ€§(94%äºˆæ¸¬åŒºé–“)ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™.
å¥¨å­¦é‡‘ã®æœ‰ç„¡ã§ç•°ãªã‚‹äºˆæ¸¬ç·šã‚’æç”»ã—,ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜èƒ½åŠ›ã‚’ç¢ºèªã—ã¾ã™.

~~~ py
    # xè»¸ç”¨ã® study_hours ã®ç¯„å›²ï¼ˆ100ç‚¹ï¼‰
    study_grid = np.linspace(df["Study_Hours"].min(), df["Study_Hours"].max(), 100)

    # å¥¨å­¦é‡‘ãªã—ã®äºˆæ¸¬
    predict_df_0 = pd.DataFrame({
        "Study_Hours": study_grid,
        "Scholarship_True": 0,
        "StudentID": 0
    })

    # å¥¨å­¦é‡‘ã‚ã‚Šã®äºˆæ¸¬
    predict_df_1 = pd.DataFrame({
        "Study_Hours": study_grid,
        "Scholarship_True": 1,
        "StudentID": 0
    })

    # ã‚ˆã‚Šç°¡å˜ãªæ–¹æ³•ï¼šäº‹å¾Œåˆ†å¸ƒã‹ã‚‰ç›´æ¥äºˆæ¸¬
    # äº‹å¾Œåˆ†å¸ƒã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—ï¼ˆæ–°ã—ã„APIã‚’ä½¿ç”¨ï¼‰
    posterior_samples = az.extract(trace)
    
    # äºˆæ¸¬è¨ˆç®—
    n_samples = len(posterior_samples.draw)
    n_grid = len(study_grid)
    
    # äºˆæ¸¬å€¤ã‚’æ ¼ç´ã™ã‚‹é…åˆ—ï¼ˆå¥¨å­¦é‡‘ãªã—ãƒ»ã‚ã‚Šï¼‰
    predictions_0 = np.zeros((n_samples, n_grid))
    predictions_1 = np.zeros((n_samples, n_grid))
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã«å–å¾—
    mu_alpha_vals = posterior_samples.mu_alpha.values
    sigma_alpha_vals = posterior_samples.sigma_alpha.values
    z_alpha_vals = posterior_samples.z_alpha.values  # å…¨å­¦ç”Ÿã®z_alpha    
    beta_st_vals = posterior_samples.beta_st.values    
    beta_ss_vals = posterior_samples.beta_ss.values
    
    for i in range(n_samples):
        # å„ã‚µãƒ³ãƒ—ãƒ«ã§ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå­¦ç”Ÿ0ã®åˆ‡ç‰‡ã‚’è¨ˆç®—ï¼‰
        alpha_0 = mu_alpha_vals[i] + sigma_alpha_vals[i] * z_alpha_vals[0, i]  # å­¦ç”Ÿ0ã®åˆ‡ç‰‡
        
        # å¥¨å­¦é‡‘ãªã—ã®äºˆæ¸¬å€¤ã®è¨ˆç®—
        mu_pred_0 = alpha_0 + beta_st_vals[i] * study_grid + beta_ss_vals[i] * predict_df_0["Scholarship_True"]
        predictions_0[i, :] = np.random.normal(mu_pred_0, 0.3)
        
        # å¥¨å­¦é‡‘ã‚ã‚Šã®äºˆæ¸¬å€¤ã®è¨ˆç®—
        mu_pred_1 = alpha_0 + beta_st_vals[i] * study_grid + beta_ss_vals[i] * predict_df_1["Scholarship_True"]
        predictions_1[i, :] = np.random.normal(mu_pred_1, 0.3)

    # å¹³å‡ã¨äºˆæ¸¬åŒºé–“ï¼ˆ94%ï¼‰
    mean_pred_0 = np.mean(predictions_0, axis=0)
    lower_pred_0 = np.percentile(predictions_0, 3, axis=0)
    upper_pred_0 = np.percentile(predictions_0, 97, axis=0)
    
    mean_pred_1 = np.mean(predictions_1, axis=0)
    lower_pred_1 = np.percentile(predictions_1, 3, axis=0)
    upper_pred_1 = np.percentile(predictions_1, 97, axis=0)

    # å®Ÿãƒ‡ãƒ¼ã‚¿ã‚‚åˆã‚ã›ã¦è¡¨ç¤ºï¼ˆå¥¨å­¦é‡‘ã®æœ‰ç„¡ã§è‰²åˆ†ã‘ï¼‰
    plt.figure(figsize=(12, 8))
    
    # å¥¨å­¦é‡‘ãªã—ã®äºˆæ¸¬ç·š
    plt.plot(study_grid, mean_pred_0, color="blue", label="Bayesian prediction (Scholarship=0)")
    plt.fill_between(study_grid, lower_pred_0, upper_pred_0, color="blue", alpha=0.2, label="94% CI (Scholarship=0)")
    
    # å¥¨å­¦é‡‘ã‚ã‚Šã®äºˆæ¸¬ç·š
    plt.plot(study_grid, mean_pred_1, color="green", label="Bayesian prediction (Scholarship=1)")
    plt.fill_between(study_grid, lower_pred_1, upper_pred_1, color="green", alpha=0.2, label="94% CI (Scholarship=1)")
    
    # å¥¨å­¦é‡‘ã®æœ‰ç„¡ã§å®Ÿæ¸¬å€¤ã‚’è‰²åˆ†ã‘
    scholarship_0 = df[df["Scholarship_True"] == 0]
    scholarship_1 = df[df["Scholarship_True"] == 1]
    
    plt.scatter(scholarship_0["Study_Hours"], scholarship_0["GPA"], 
                color="red", alpha=0.6, label="Observed GPA (Scholarship=0)", s=30)
    plt.scatter(scholarship_1["Study_Hours"], scholarship_1["GPA"], 
                color="orange", alpha=0.6, label="Observed GPA (Scholarship=1)", s=30)
    
    plt.xlabel("Study Hours")
    plt.ylabel("GPA")
    plt.title("Bayesian Regression Lines with 94% Prediction Intervals")
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    plt.savefig(save_dir + "bayes_prediction_band.png")
    plt.close()
~~~

![](/images/slds/ch12/bayes_prediction_band.png)


äºˆæ¸¬åŒºé–“å†…ã«å®Ÿæ¸¬å€¤ãŒå¤šãå«ã¾ã‚Œã¦ãŠã‚Š,ãƒ¢ãƒ‡ãƒ«ãŒãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«èª¬æ˜ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™. 
ã¾ãŸ,å¥¨å­¦é‡‘ã‚ã‚Šã®ã‚°ãƒ«ãƒ¼ãƒ—ã®äºˆæ¸¬ç·šãŒä¸Šã«ä½ç½®ã—ã¦ãŠã‚Š,å¥¨å­¦é‡‘ã®æ­£ã®åŠ¹æœãŒå¯è¦–åŒ–ã•ã‚Œã¦ã„ã¾ã™.

### ãã®ä»–ã®å¯è¦–åŒ–æ‰‹æ³•

æœ€å¾Œã«ãã®ä»–ã«ã‚ˆãåˆ©ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã¨ã—ã¦,ãƒ©ãƒ³ãƒ€ãƒ åˆ‡ç‰‡ã®å¯è¦–åŒ–æ‰‹æ³•ã¨ã—ã¦å­¦ç”Ÿã®å€‹åˆ¥ã®èƒ½åŠ›å€¤ã®åˆ†å¸ƒ,æ¨å®šã•ã‚ŒãŸåˆ†å¸ƒã®å¯è¦–åŒ–æ‰‹æ³•ã¨ã—ã¦å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¨å®šã•ã‚ŒãŸåˆ†å¸ƒ,Regidual Plotãªã©ã‚’ã¾ã¨ã‚ã¦æ²è¼‰ã—ã¾ã™. è«–æ–‡åŸ·ç­†ãªã©ã®éš›ã«ã¯,å¿…è¦ãªã‚‚ã®ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã‚°ãƒ©ãƒ•åŒ–ã—ã¾ã—ã‚‡ã†.

~~~ py
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è§£é‡ˆå¯èƒ½æ€§ã‚’å‘ä¸Š
    print("\n=== ãƒ¢ãƒ‡ãƒ«çµæœã®è§£é‡ˆ ===")
    print(f"å‹‰å¼·æ™‚é–“ã®åŠ¹æœ (beta_st): {np.mean(beta_st_vals):.3f} Â± {np.std(beta_st_vals):.3f}")
    print(f"å¥¨å­¦é‡‘ã®åŠ¹æœ (beta_ss): {np.mean(beta_ss_vals):.3f} Â± {np.std(beta_ss_vals):.3f}")
    print(f"å­¦ç”Ÿé–“ã®ã°ã‚‰ã¤ã (sigma_alpha): {np.mean(sigma_alpha_vals):.3f} Â± {np.std(sigma_alpha_vals):.3f}")
    #
    ## åŠ¹æœé‡ã®è¨ˆç®—
    effect_size_study = np.mean(beta_st_vals) / np.mean(sigma_alpha_vals)
    effect_size_scholarship = np.mean(beta_ss_vals) / np.mean(sigma_alpha_vals)
    print(f"å‹‰å¼·æ™‚é–“ã®æ¨™æº–åŒ–åŠ¹æœé‡: {effect_size_study:.3f}")
    print(f"å¥¨å­¦é‡‘ã®æ¨™æº–åŒ–åŠ¹æœé‡: {effect_size_scholarship:.3f}")
    #
    ## äºˆæ¸¬ç²¾åº¦ã®è©³ç´°è©•ä¾¡
    r2 = r2_score(df["GPA"], posterior_mean)
    mae = mean_absolute_error(df["GPA"], posterior_mean)
    print(f"\n=== äºˆæ¸¬ç²¾åº¦ ===")
    print(f"RÂ²: {r2:.4f}")
    print(f"MAE: {mae:.4f}")
    print(f"RMSE: {bayes_rmse:.4f}")
    
    # éšå±¤åŠ¹æœã®å¯è¦–åŒ–
    plt.figure(figsize=(12, 8))
    
    # å­¦ç”Ÿåˆ¥ã®åˆ‡ç‰‡åˆ†å¸ƒ
    alpha_means = np.mean(posterior_samples.alpha.values, axis=1)
    alpha_stds = np.std(posterior_samples.alpha.values, axis=1)
    
    plt.subplot(2, 2, 1)
    plt.errorbar(range(len(alpha_means)), alpha_means, yerr=alpha_stds, fmt='o', alpha=0.6)
    plt.xlabel("Student ID")
    plt.ylabel("Random Intercept (Î±)")
    plt.title("Student-specific Random Intercepts")
    plt.grid(True)
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®äº‹å¾Œåˆ†å¸ƒ
    plt.subplot(2, 2, 2)
    plt.hist(beta_st_vals, bins=50, alpha=0.7, label='Study Hours Effect')
    plt.hist(beta_ss_vals, bins=50, alpha=0.7, label='Scholarship Effect')
    plt.xlabel("Parameter Value")
    plt.ylabel("Frequency")
    plt.title("Posterior Distributions of Effects")
    plt.legend()
    plt.grid(True)
    
    # äºˆæ¸¬ç²¾åº¦ã®æ¯”è¼ƒ
    plt.subplot(2, 2, 3)
    plt.scatter(df["GPA"], posterior_mean, alpha=0.6, label='Bayesian')
    plt.scatter(df["GPA"], lm_preds, alpha=0.6, label='Linear Regression')
    plt.plot([df["GPA"].min(), df["GPA"].max()], 
             [df["GPA"].min(), df["GPA"].max()], 'r--', label='Perfect')
    plt.xlabel("Actual GPA")
    plt.ylabel("Predicted GPA")
    plt.title("Prediction Accuracy Comparison")
    plt.legend()
    plt.grid(True)
    
    # æ®‹å·®åˆ†æ
    plt.subplot(2, 2, 4)
    residuals = df["GPA"] - posterior_mean
    plt.scatter(posterior_mean, residuals, alpha=0.6)
    plt.axhline(y=0, color='r', linestyle='--')
    plt.xlabel("Predicted GPA")
    plt.ylabel("Residuals")
    plt.title("Residual Plot")
    plt.grid(True)
    
    plt.tight_layout()
    plt.savefig(save_dir + "comprehensive_results.png", dpi=300, bbox_inches='tight')
    plt.close()
    
    # çµæœã®è¦ç´„ã‚’CSVã«ä¿å­˜
    results_summary = {
        'Metric': ['RÂ²', 'MAE', 'RMSE', 'Study_Effect_Mean', 'Study_Effect_Std', 
                  'Scholarship_Effect_Mean', 'Scholarship_Effect_Std', 'Student_Variability'],
        'Value': [r2, mae, bayes_rmse, np.mean(beta_st_vals), np.std(beta_st_vals),
                 np.mean(beta_ss_vals), np.std(beta_ss_vals), np.mean(sigma_alpha_vals)]
    }
    
    results_df = pd.DataFrame(results_summary)
    results_df.to_csv("model_results_summary.csv", index=False, encoding='utf-8-sig')
  ~~~

  ![](/images/slds/ch12/comprehensive_results.png)


# ã¾ã¨ã‚ (ç·šå½¢å›å¸° VS ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒªãƒ³ã‚°)

ã“ã®ç« ã§ã¯,ç·šå½¢å›å¸°åˆ†æã¨ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®é•ã„,ãŠã‚ˆã³å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã¨ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«(éšå±¤ãƒ™ã‚¤ã‚º)ã®é•ã„ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸ. ä»¥ä¸‹ã«,ã“ã‚Œã‚‰ã®æ‰‹æ³•ã®æ¯”è¼ƒã¨ç‰¹å¾´ã‚’ã¾ã¨ã‚ã¾ã™.

## ç·šå½¢å›å¸°(é »åº¦ä¸»ç¾©)ã¨çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°(ãƒ™ã‚¤ã‚ºä¸»ç¾©)ã®æ¯”è¼ƒ

é »åº¦ä¸»ç¾©çš„ãªç·šå½¢å›å¸°åˆ†æã¨ãƒ™ã‚¤ã‚ºä¸»ç¾©çš„ãªçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã¯,ä»¥ä¸‹ã®ã‚ˆã†ãªæ ¹æœ¬çš„ãªé•ã„ãŒã‚ã‚Šã¾ã™.

| æ¯”è¼ƒé …ç›® | ç·šå½¢å›å¸°(é »åº¦ä¸»ç¾©) | çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°(ãƒ™ã‚¤ã‚ºä¸»ç¾©) |
|---------|------------------|------------------------|
| **åˆ†å¸ƒã®ä½¿ã„æ–¹** | èª¤å·®ã®ã¿ãŒæ­£è¦åˆ†å¸ƒã«å¾“ã†ã¨ä»®å®š<br>$\epsilon_i \sim N(0, \sigma^2)$ | å‡ºåŠ›ã‚‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚åˆ†å¸ƒã¨ã—ã¦æ‰±ã†<br>$y_i \sim N(\mu_i, \sigma^2)$<br>$\theta \sim F$ (ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®äº‹å‰åˆ†å¸ƒ) |
| **åˆ¶ç´„** | èª¤å·®ã®ã¿ã«åˆ¶ç´„ãŒã‚ã‚‹ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚‚åˆ¶ç´„ãŒã‚ã‚‹ |
| **æ¨å®šæ–¹æ³•** | æœ€å°äºŒä¹—æ³• | ãƒ™ã‚¤ã‚ºæ›´æ–°(MCMCãªã©) |
| **çµæœã®è§£é‡ˆ** | ç‚¹æ¨å®šã¨æ¤œå®š(åŒºé–“æ¨å®š) | äº‹å¾Œåˆ†å¸ƒã«åŸºã¥ãä¸ç¢ºå®Ÿæ€§ã®æ¨å®š |

### è©³ç´°ãªèª¬æ˜

**åˆ†å¸ƒã®ä½¿ã„æ–¹:**

é »åº¦ä¸»ç¾©çš„ãªç·šå½¢å›å¸°ã§ã¯,èª¤å·®é …$\epsilon_i$ã®ã¿ãŒæ­£è¦åˆ†å¸ƒã«å¾“ã†ã¨ä»®å®šã—ã¾ã™. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿($\beta_0, \beta_1$ãªã©)ã¯å›ºå®šå€¤ã¨ã—ã¦æ‰±ã‚ã‚Œ,åˆ†å¸ƒã‚’æŒã¡ã¾ã›ã‚“.

ä¸€æ–¹,ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ã¯,å‡ºåŠ›å¤‰æ•°$y_i$ã ã‘ã§ãªã,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è‡ªä½“ã‚‚ç¢ºç‡åˆ†å¸ƒã¨ã—ã¦æ‰±ã„ã¾ã™. äº‹å‰åˆ†å¸ƒã‚’è¨­å®šã—,ãƒ‡ãƒ¼ã‚¿ã‚’è¦³æ¸¬ã—ãŸå¾Œã®äº‹å¾Œåˆ†å¸ƒã‚’æ¨å®šã™ã‚‹ã“ã¨ã§,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸ç¢ºå®Ÿæ€§ã‚’è¡¨ç¾ã§ãã¾ã™.

**åˆ¶ç´„:**

ç·šå½¢å›å¸°ã§ã¯,èª¤å·®é …ã«å¯¾ã—ã¦ã®ã¿åˆ†å¸ƒã®ä»®å®š(æ­£è¦åˆ†å¸ƒ,ç­‰åˆ†æ•£æ€§ãªã©)ãŒèª²ã•ã‚Œã¾ã™. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯ç‰¹åˆ¥ãªåˆ¶ç´„ã¯ã‚ã‚Šã¾ã›ã‚“.

ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ã¯,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¯¾ã—ã¦äº‹å‰åˆ†å¸ƒã‚’è¨­å®šã™ã‚‹ã“ã¨ã§,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–ã‚Šã†ã‚‹ç¯„å›²ã‚„å€¤ã«åˆ¶ç´„ã‚’èª²ã™ã“ã¨ãŒã§ãã¾ã™. ã“ã‚Œã«ã‚ˆã‚Š,ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã§ã‚‚,äº‹å‰ã®çŸ¥è­˜ã‚’æ´»ç”¨ã—ãŸæ¨å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™.

**æ¨å®šæ–¹æ³•:**

ç·šå½¢å›å¸°ã§ã¯,æœ€å°äºŒä¹—æ³•ã«ã‚ˆã‚Šèª¤å·®ã®äºŒä¹—å’Œã‚’æœ€å°åŒ–ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ±‚ã‚ã¾ã™. ã“ã®æ–¹æ³•ã¯è§£æçš„ã«è§£ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ã,è¨ˆç®—ãŒæ¯”è¼ƒçš„ç°¡å˜ã§ã™.

ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ã¯,ãƒ™ã‚¤ã‚ºã®å®šç†ã«åŸºã¥ã„ã¦äº‹å¾Œåˆ†å¸ƒã‚’è¨ˆç®—ã—ã¾ã™. è¤‡é›‘ãªãƒ¢ãƒ‡ãƒ«ã§ã¯è§£æçš„ã«è§£ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒå›°é›£ãªãŸã‚,MCMC(ãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•)ãªã©ã®æ•°å€¤è¨ˆç®—æ‰‹æ³•ã‚’ç”¨ã„ã¦äº‹å¾Œåˆ†å¸ƒã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¾ã™.

**çµæœã®è§£é‡ˆ:**

ç·šå½¢å›å¸°ã§ã¯,æ¨å®šã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‚¹æ¨å®šå€¤ã¨,ãã®ä¿¡é ¼åŒºé–“ã‚„æ¤œå®šçµæœã‚’è§£é‡ˆã—ã¾ã™. çµæœã¯ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çœŸã®å€¤ã¯ã“ã®åŒºé–“ã«å«ã¾ã‚Œã‚‹ç¢ºç‡ãŒ95%ã€ã¨ã„ã†é »åº¦ä¸»ç¾©çš„ãªè§£é‡ˆã«ãªã‚Šã¾ã™.

ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ã¯,äº‹å¾Œåˆ†å¸ƒå…¨ä½“ã‚’è§£é‡ˆã—ã¾ã™. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸ç¢ºå®Ÿæ€§ã‚’ç¢ºç‡åˆ†å¸ƒã¨ã—ã¦è¡¨ç¾ã§ãã‚‹ãŸã‚,ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã“ã®å€¤ã§ã‚ã‚‹ç¢ºç‡ãŒ95%ã€ã¨ã„ã†ä¸»è¦³çš„ãªè§£é‡ˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™. ã¾ãŸ,äºˆæ¸¬åŒºé–“ã®è¨ˆç®—ã‚‚å®¹æ˜“ã§,äºˆæ¸¬ã®ä¸ç¢ºå®Ÿæ€§ã‚‚è¡¨ç¾ã§ãã¾ã™.

## å›ºå®šåŠ¹æœ(ãƒ€ãƒŸãƒ¼å¤‰æ•°)ã¨ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœ(éšå±¤ãƒ™ã‚¤ã‚º)ã®æ¯”è¼ƒ

å€‹ä½“å·®ã‚’è€ƒæ…®ã™ã‚‹éš›ã«,å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã¨ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,æ¨å®šæ–¹æ³•ã‚„çµæœã®è§£é‡ˆãŒå¤§ããç•°ãªã‚Šã¾ã™.

| æ¯”è¼ƒé …ç›® | ãƒ€ãƒŸãƒ¼å¤‰æ•°(å›ºå®šåŠ¹æœ) | ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœ(éšå±¤ãƒ™ã‚¤ã‚º) |
|---------|-------------------|----------------------|
| **å„å€‹ä½“ã®æ¨å®šå€¤** | å„å€‹ä½“ã¯ç‹¬ç«‹ã«è‡ªç”±ã«æ¨å®šã•ã‚Œã‚‹(åˆ¶ç´„ãªã—) | åˆ†å¸ƒã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦æ¨å®šã•ã‚Œã‚‹(åˆ¶ç´„ã‚ã‚Š) |
| **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°** | å€‹ä½“æ•°åˆ†ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ | åˆ†å¸ƒã®å¹³å‡ã¨åˆ†æ•£ã®ã¿(+å€‹ä½“ã”ã¨ã®æ½œåœ¨å¤‰æ•°) |
| **æ–°ã—ã„å€‹ä½“ã®äºˆæ¸¬** | ä¸å¯èƒ½(ãã®å€‹ä½“ã®ãƒ€ãƒŸãƒ¼ãŒãªã„ãŸã‚) | å¯èƒ½(åˆ†å¸ƒã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦æ‰±ãˆã‚‹ãŸã‚) |
| **éå­¦ç¿’ã®ãƒªã‚¹ã‚¯** | é«˜ã„(ç‰¹ã«ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å€‹ä½“ã§é¡•è‘—) | ç¸®å°æ¨å®šã«ã‚ˆã‚ŠæŠ‘åˆ¶ã•ã‚Œã‚‹ |
| **ãƒ¢ãƒ‡ãƒ«ã®æŸ”è»Ÿæ€§** | é«˜ã™ãã‚‹(éå‰°é©åˆã®å¯èƒ½æ€§) | é©åº¦ã«åˆ¶ç´„ã•ã‚ŒãŸæŸ”è»Ÿæ€§ |

### è©³ç´°ãªèª¬æ˜

**å„å€‹ä½“ã®æ¨å®šå€¤:**

å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,å„å€‹ä½“(ä¾‹:å­¦ç”Ÿ)ã«å¯¾ã—ã¦ç‹¬ç«‹ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(ä¾‹:åˆ‡ç‰‡$\alpha_i$)ã‚’æ¨å®šã—ã¾ã™. å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯ç‰¹åˆ¥ãªåˆ¶ç´„ãŒãªã,ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥æ¨å®šã•ã‚Œã¾ã™.

ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,å„å€‹ä½“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ,ã‚ˆã‚Šå¤§ããªåˆ†å¸ƒ(ä¾‹:$\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)$)ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ä»®å®šã—ã¾ã™. ã“ã®ä»®å®šã«ã‚ˆã‚Š,å€‹ä½“é–“ã§æƒ…å ±ã‚’å…±æœ‰ã—,ã‚ˆã‚Šå®‰å®šã—ãŸæ¨å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™.

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°:**

å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,å€‹ä½“æ•°$N$ã«å¯¾ã—ã¦$N$å€‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¨å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™. å€‹ä½“æ•°ãŒå¢—ãˆã‚‹ã¨,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã‚‚ç·šå½¢ã«å¢—åŠ ã—ã¾ã™.

ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(å¹³å‡$\mu_{\alpha}$ã¨åˆ†æ•£$\sigma_{\alpha}^2$)ã®ã¿ã‚’æ¨å®šã™ã‚Œã°ã‚ˆã,å€‹ä½“æ•°ã«é–¢ã‚ã‚‰ãšãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã¯ä¸€å®šã§ã™. ã“ã‚Œã«ã‚ˆã‚Š,å€‹ä½“æ•°ãŒå¤šãã¦ã‚‚åŠ¹ç‡çš„ã«æ¨å®šã§ãã¾ã™.

**æ–°ã—ã„å€‹ä½“ã®äºˆæ¸¬:**

å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,ãƒ¢ãƒ‡ãƒ«ã«å«ã¾ã‚Œã¦ã„ãªã„æ–°ã—ã„å€‹ä½“ã«å¯¾ã—ã¦äºˆæ¸¬ã‚’è¡Œã†ã“ã¨ã¯ã§ãã¾ã›ã‚“. ãã®å€‹ä½“ã®ãƒ€ãƒŸãƒ¼å¤‰æ•°ãŒå­˜åœ¨ã—ãªã„ãŸã‚,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¨å®šã§ããªã„ã‹ã‚‰ã§ã™.

ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,æ–°ã—ã„å€‹ä½“ã‚‚æ—¢å­˜ã®åˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ä»®å®šã™ã‚‹ã“ã¨ã§,äºˆæ¸¬ãŒå¯èƒ½ã§ã™. æ¨å®šã•ã‚ŒãŸåˆ†å¸ƒ$N(\mu_{\alpha}, \sigma_{\alpha}^2)$ã«åŸºã¥ã„ã¦,æ–°ã—ã„å€‹ä½“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¨å®šã§ãã¾ã™.

**éå­¦ç¿’ã®ãƒªã‚¹ã‚¯:**

å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,ç‰¹ã«å„å€‹ä½“ã®ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆ,éå­¦ç¿’ãŒç™ºç”Ÿã—ã‚„ã™ããªã‚Šã¾ã™. å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå€‹åˆ¥ã«æ¨å®šã•ã‚Œã‚‹ãŸã‚,ãƒ‡ãƒ¼ã‚¿ã«éåº¦ã«é©åˆã—ã¦ã—ã¾ã„ã¾ã™.

ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã§ã¯,ã€Œç¸®å°æ¨å®š(shrinkage estimation)ã€ãŒåƒãã¾ã™. å„å€‹ä½“ã®æ¨å®šå€¤ãŒ,å…¨ä½“ã®å¹³å‡$\mu_{\alpha}$ã«å‘ã‹ã£ã¦ã€Œç¸®å°ã€ã•ã‚Œã‚‹ãŸã‚,éå­¦ç¿’ãŒæŠ‘åˆ¶ã•ã‚Œã¾ã™. ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å€‹ä½“ã§ã‚‚,ä»–ã®å€‹ä½“ã®æƒ…å ±ã‚’æ´»ç”¨ã—ã¦å®‰å®šã—ãŸæ¨å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™.

**ãƒ¢ãƒ‡ãƒ«ã®æŸ”è»Ÿæ€§:**

å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã¯,å„å€‹ä½“ã«å¯¾ã—ã¦å®Œå…¨ã«ç‹¬ç«‹ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨±å®¹ã™ã‚‹ãŸã‚,éå¸¸ã«æŸ”è»Ÿã§ã™. ã—ã‹ã—,ã“ã®æŸ”è»Ÿæ€§ãŒéå‰°é©åˆã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™.

ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã¯,åˆ†å¸ƒã®ä»®å®šã«ã‚ˆã‚Šé©åº¦ã«åˆ¶ç´„ã•ã‚ŒãŸæŸ”è»Ÿæ€§ã‚’æŒã¡ã¾ã™. å€‹ä½“é–“ã§æƒ…å ±ã‚’å…±æœ‰ã—ãªãŒã‚‰ã‚‚,å€‹ä½“å·®ã‚’é©åˆ‡ã«è¡¨ç¾ã§ãã¾ã™.

## ã¾ã¨ã‚

ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¯,ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸ç¢ºå®Ÿæ€§ã‚’è¡¨ç¾ã—,äº‹å‰çŸ¥è­˜ã‚’æ´»ç”¨ã§ãã‚‹ç‚¹ã§,é »åº¦ä¸»ç¾©çš„ãªç·šå½¢å›å¸°ã‚’ä¸€èˆ¬åŒ–ã—ãŸæ‰‹æ³•ã¨ã„ãˆã¾ã™. ç‰¹ã«,éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«(ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«)ã¯,å€‹ä½“å·®ã‚’è€ƒæ…®ã—ãªãŒã‚‰ã‚‚,éå­¦ç¿’ã‚’æŠ‘åˆ¶ã—,æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹äºˆæ¸¬ã‚‚å¯èƒ½ã«ã™ã‚‹å„ªã‚ŒãŸæ‰‹æ³•ã§ã™.

ãŸã ã—,ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¯è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã,ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚„äº‹å‰åˆ†å¸ƒã®é¸æŠãŒçµæœã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ãŸã‚,é©åˆ‡ãªçŸ¥è­˜ã¨çµŒé¨“ãŒå¿…è¦ã§ã™. ç ”ç©¶ã®ç›®çš„ã‚„ãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ€§ã«å¿œã˜ã¦,é©åˆ‡ãªæ‰‹æ³•ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™.

