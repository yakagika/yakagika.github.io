<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>yakagika - Posts tagged statistics</title>
        <link></link>
        <description><![CDATA[Personal blog of yakagika]]></description>
        <atom:link href="/tags/statistics.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Tue, 04 Nov 2025 00:00:00 UT</lastBuildDate>
        <item>
    <title>特別講義DS Ch12 一般化線形モデル</title>
    <link>/lectures/slds12.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#統計モデリング" id="toc-統計モデリング"><span class="toc-section-number">1</span> 統計モデリング</a></li>
<li><a href="#基礎知識-ベイズ統計学概要" id="toc-基礎知識-ベイズ統計学概要"><span class="toc-section-number">2</span> 基礎知識 ベイズ統計学概要</a>
<ul>
<li><a href="#ベイズの定理" id="toc-ベイズの定理"><span class="toc-section-number">2.1</span> ベイズの定理</a>
<ul>
<li><a href="#条件付き確率" id="toc-条件付き確率"><span class="toc-section-number">2.1.1</span> 条件付き確率</a></li>
<li><a href="#ベイズの定理-1" id="toc-ベイズの定理-1"><span class="toc-section-number">2.1.2</span> ベイズの定理</a></li>
<li><a href="#条件付き確率-1" id="toc-条件付き確率-1"><span class="toc-section-number">2.1.3</span> 条件付き確率</a></li>
<li><a href="#ベイズ確率" id="toc-ベイズ確率"><span class="toc-section-number">2.1.4</span> ベイズ確率</a></li>
</ul></li>
<li><a href="#ベイズ更新" id="toc-ベイズ更新"><span class="toc-section-number">2.2</span> ベイズ更新</a>
<ul>
<li><a href="#独立性" id="toc-独立性"><span class="toc-section-number">2.2.1</span> 独立性</a></li>
<li><a href="#複数の事象からなる条件付き確率" id="toc-複数の事象からなる条件付き確率"><span class="toc-section-number">2.2.2</span> 複数の事象からなる条件付き確率</a></li>
<li><a href="#ベイズ更新の適用" id="toc-ベイズ更新の適用"><span class="toc-section-number">2.2.3</span> ベイズ更新の適用</a></li>
<li><a href="#ベイズ統計学の性質" id="toc-ベイズ統計学の性質"><span class="toc-section-number">2.2.4</span> ベイズ統計学の性質</a></li>
</ul></li>
<li><a href="#マルコフ連鎖モンテカルロ法" id="toc-マルコフ連鎖モンテカルロ法"><span class="toc-section-number">2.3</span> マルコフ連鎖モンテカルロ法</a>
<ul>
<li><a href="#尤度likelihood" id="toc-尤度likelihood"><span class="toc-section-number">2.3.1</span> 尤度(Likelihood)</a></li>
<li><a href="#最尤推定-maximum-likelihood-estimation" id="toc-最尤推定-maximum-likelihood-estimation"><span class="toc-section-number">2.3.2</span> 最尤推定 (Maximum Likelihood Estimation)</a></li>
<li><a href="#マルコフ連鎖モンテカルロ法-mcmcmarkov-chain-monte-carlo-method" id="toc-マルコフ連鎖モンテカルロ法-mcmcmarkov-chain-monte-carlo-method"><span class="toc-section-number">2.3.3</span> マルコフ連鎖モンテカルロ法 MCMC(Markov chain Monte Carlo Method)</a></li>
</ul></li>
</ul></li>
<li><a href="#ベイズ統計学による統計モデリング実践" id="toc-ベイズ統計学による統計モデリング実践"><span class="toc-section-number">3</span> ベイズ統計学による統計モデリング実践</a>
<ul>
<li><a href="#重回帰での結果確認" id="toc-重回帰での結果確認"><span class="toc-section-number">3.1</span> 重回帰での結果確認</a></li>
<li><a href="#過分散と個別差" id="toc-過分散と個別差"><span class="toc-section-number">3.2</span> 過分散と個別差</a></li>
<li><a href="#一般化線形モデルglm" id="toc-一般化線形モデルglm"><span class="toc-section-number">3.3</span> 一般化線形モデル(GLM)</a></li>
<li><a href="#個体差のモデリング" id="toc-個体差のモデリング"><span class="toc-section-number">3.4</span> 個体差のモデリング</a>
<ul>
<li><a href="#線形回帰での問題" id="toc-線形回帰での問題"><span class="toc-section-number">3.4.1</span> 線形回帰での問題</a></li>
<li><a href="#ベイズ推論による解決" id="toc-ベイズ推論による解決"><span class="toc-section-number">3.4.2</span> ベイズ推論による解決</a></li>
<li><a href="#モデルの仮定" id="toc-モデルの仮定"><span class="toc-section-number">3.4.3</span> モデルの仮定</a></li>
<li><a href="#ランダム傾きとランダム切片" id="toc-ランダム傾きとランダム切片"><span class="toc-section-number">3.4.4</span> ランダム傾きとランダム切片</a></li>
</ul></li>
<li><a href="#モデル全体像" id="toc-モデル全体像"><span class="toc-section-number">3.5</span> モデル全体像</a>
<ul>
<li><a href="#推定する分布" id="toc-推定する分布"><span class="toc-section-number">3.5.1</span> 推定する分布</a></li>
<li><a href="#線形予測子" id="toc-線形予測子"><span class="toc-section-number">3.5.2</span> 線形予測子</a></li>
<li><a href="#尤度関数" id="toc-尤度関数"><span class="toc-section-number">3.5.3</span> 尤度関数</a></li>
<li><a href="#事前分布" id="toc-事前分布"><span class="toc-section-number">3.5.4</span> 事前分布</a></li>
<li><a href="#超事前分布" id="toc-超事前分布"><span class="toc-section-number">3.5.5</span> 超事前分布</a></li>
</ul></li>
</ul></li>
<li><a href="#環境構築" id="toc-環境構築"><span class="toc-section-number">4</span> 環境構築</a>
<ul>
<li><a href="#anacondaのインストール" id="toc-anacondaのインストール"><span class="toc-section-number">4.1</span> <code>anaconda</code>のインストール</a></li>
</ul></li>
<li><a href="#pymc-実装" id="toc-pymc-実装"><span class="toc-section-number">5</span> PyMC 実装</a>
<ul>
<li><a href="#座標設定" id="toc-座標設定"><span class="toc-section-number">5.1</span> 座標設定</a></li>
<li><a href="#モデル構築" id="toc-モデル構築"><span class="toc-section-number">5.2</span> モデル構築</a>
<ul>
<li><a href="#モデル全体像との対応関係" id="toc-モデル全体像との対応関係"><span class="toc-section-number">5.2.1</span> モデル全体像との対応関係</a></li>
</ul></li>
<li><a href="#mcmc" id="toc-mcmc"><span class="toc-section-number">5.3</span> MCMC</a></li>
<li><a href="#モデル診断と可視化" id="toc-モデル診断と可視化"><span class="toc-section-number">5.4</span> モデル診断と可視化</a></li>
<li><a href="#結果の可視化" id="toc-結果の可視化"><span class="toc-section-number">5.5</span> 結果の可視化</a>
<ul>
<li><a href="#事後予測チェックposterior-predictive-check-ppc" id="toc-事後予測チェックposterior-predictive-check-ppc"><span class="toc-section-number">5.5.1</span> 事後予測チェック(Posterior Predictive Check, PPC)</a></li>
<li><a href="#予測値の確認" id="toc-予測値の確認"><span class="toc-section-number">5.5.2</span> 予測値の確認</a></li>
<li><a href="#予測範囲の可視化" id="toc-予測範囲の可視化"><span class="toc-section-number">5.5.3</span> 予測範囲の可視化</a></li>
<li><a href="#その他の可視化手法" id="toc-その他の可視化手法"><span class="toc-section-number">5.5.4</span> その他の可視化手法</a></li>
</ul></li>
</ul></li>
<li><a href="#まとめ-線形回帰-vs-ベイズモデリング" id="toc-まとめ-線形回帰-vs-ベイズモデリング"><span class="toc-section-number">6</span> まとめ (線形回帰 VS ベイズモデリング)</a>
<ul>
<li><a href="#線形回帰頻度主義と統計モデリングベイズ主義の比較" id="toc-線形回帰頻度主義と統計モデリングベイズ主義の比較"><span class="toc-section-number">6.1</span> 線形回帰(頻度主義)と統計モデリング(ベイズ主義)の比較</a>
<ul>
<li><a href="#詳細な説明" id="toc-詳細な説明"><span class="toc-section-number">6.1.1</span> 詳細な説明</a></li>
</ul></li>
<li><a href="#固定効果ダミー変数とランダム効果階層ベイズの比較" id="toc-固定効果ダミー変数とランダム効果階層ベイズの比較"><span class="toc-section-number">6.2</span> 固定効果(ダミー変数)とランダム効果(階層ベイズ)の比較</a>
<ul>
<li><a href="#詳細な説明-1" id="toc-詳細な説明-1"><span class="toc-section-number">6.2.1</span> 詳細な説明</a></li>
</ul></li>
<li><a href="#まとめ" id="toc-まとめ"><span class="toc-section-number">6.3</span> まとめ</a></li>
</ul></li>
</ul>
</div>
<h1 data-number="1" id="統計モデリング"><span class="header-section-number">1</span> 統計モデリング</h1>
<p>前回(Ch11)では線形の重回帰を利用して,ある程度正確な説明/予測が可能となりました.
しかし,これが最善のモデルであるとは限りません.
また, 線形回帰でうまく表せないからと言って,関係がないと断定することもできません.
より正確に説明できるより良いモデルが存在する可能性があります.</p>
<p>前回の事例に即して考えると例えば,</p>
<div class="note">
<ul>
<li>Scholarshipの有無によって,それぞれの傾きが異なるのでは?</li>
</ul>
<p>奨学金をもらっている人のほうがそもそも勉強時間あたりのGPAの伸び率が高いなど,層ごとに異なるパラメータを持つ可能性があります.</p>
<ul>
<li>残差の分布が正規分布ではないのでは?</li>
</ul>
<p>重回帰分析では残差が正規分布であるという仮定のもと分析を行っていますが,そのような検証は行われていません.</p>
</div>
<p>基本的にはデータを特定のモデルで表現する場合には,グラフや特徴量などから考えられる幾つかの可能性を考慮・比較検討し,最善のモデルを選択することが必要になります.
このような行為をモデル選択/統計モデリングといいます.</p>
<p>Ch 12ではこのような,重回帰分析では扱えないモデリング技法として,ベイズ統計学に基づいた一般化線形モデルに関して学習してみましょう.</p>
<h1 data-number="2" id="基礎知識-ベイズ統計学概要"><span class="header-section-number">2</span> 基礎知識 ベイズ統計学概要</h1>
<p>前章までに扱ってきた,統計的仮説検定や回帰分析は無限回試行を行った際に収束する相対度数(<strong>客観確率</strong>)を確率の定義とする<strong>頻度主義</strong>に基づいた統計的手法です(詳細は｢統計学入門(データ活用の統計学)｣などに譲ります.) そのような前提にたった統計学を<strong>伝統的統計学</strong>とも呼びます.</p>
<p>一方で,2000年代初頭から,計算機の性能向上と,MCMCなどのアルゴリズムの開発によって,分析者の情報,知識,経験などによる主観によって定めらる<strong>主観確率</strong>に基づく確率的定義(<strong>ベイズ主義</strong>)を前提とした手法が用いられるようになりました.</p>
<h2 data-number="2.1" id="ベイズの定理"><span class="header-section-number">2.1</span> ベイズの定理</h2>
<p>まずは,ベイズ統計学の中核となる<strong>ベイズ確率(逆確率)</strong>,<strong>ベイズの定理</strong>などの基礎概念の概要を把握しましょう.</p>
<div class="warn">
<p>ここでは,最低限の記法の意味などについて概要を解説します.
これ以前の基本的な確率計算や定義に関しては｢統計学入門｣, ｢データ活用の統計学｣などを,
ベイズやアルゴリズムの詳細に関しては｢データサイエンス実践｣｢データ活用の統計学実践｣などの講義を受講して下さい.</p>
</div>
<p>ベイズ確率やベイズの定理は,1740年代に数学好きの牧師であったトーマス･ベイズによってまとめられました. ベイズは,神学への興味から,｢世界が原初神によって作られたこと｣を｢現在の事象｣によって証明できるか,という問題に関心を寄せていました. ベイズはこのような問題を解くために, 仮の確率を今現在の情報によって更新し,過去の出来事を推測するというアイデア(逆確率)をまとめました.</p>
<p>しかし,ベイズ自身はこれを発表せず, 1763年にリチャード・プライスによってベイズの遺稿が発表されたことで再注目されました(このことによって近年では,ベイズの定理が<strong>ベイズ・プライスの定理</strong>と呼ばれることもあります.)</p>
<p>古典的確率の定立に貢献したラプラスも同様の観点に注目した時期があり,ベイズの定理から確率的な推論を実施する方法などがまとめられましたが,当時の計算・データ環境などからそれ以上深められることはなく,古典的確率に則った頻度主義や伝統的統計学が発展していきます.</p>
<p>(cf. シャロン・バーチュ マグレイン (著), 異端の統計学 ベイズ, 草思社, 2013)</p>
<p>それでは,逆確率やベイズの定理がどのようなものかを見ていきましょう.</p>
<h3 data-number="2.1.1" id="条件付き確率"><span class="header-section-number">2.1.1</span> 条件付き確率</h3>
<p>事象Aの下での事象Bの条件付き確率</p>
<p><span class="math display">P(B|A) = \frac{P(B \cap A)}{P(A)}</span></p>
<p>を変形した</p>
<p><span class="math display">P(B \cap A) = P(A) P(B | A) </span></p>
<p>を乗法定理と呼びます.</p>
<p>このとき AとBは対称なので,</p>
<p><span class="math display">P(B \cap A) = P(A \cap B) = P(B) P(A | B)  </span></p>
<p>も成り立ちます.</p>
<h3 data-number="2.1.2" id="ベイズの定理-1"><span class="header-section-number">2.1.2</span> ベイズの定理</h3>
<p><span class="math inline">A</span> を得られた結果, <span class="math inline">H_1,H_2,...,H_k</span> を原因としたとき,事象Aの下での事象<span class="math inline">H_i</span>の条件付き確率は,</p>
<p><span class="math display"> P(H_i | A) = \frac{P(H_i \cap A)}{P(A)}</span></p>
<p>となります.</p>
<p>ただし, ここで <span class="math inline">H_i</span> は互いに排反で, <span class="math display"> \bigcup_{i=1} H_i = \Omega </span> かつ <span class="math display"> \sum_{i=1} P(H_i) =1 </span></p>
<p>このとき,乗法定理から</p>
<p><span class="math display"> P(H_i \cap A) = P(H_i)P(A | H_i)</span></p>
<p>が求まります. これを代入して,</p>
<p><span class="math display"> P(H_i | A) = \frac{P(H_i)P(A | H_i)}{P(A)} </span></p>
<p>となり,これをベイズの定理といいます.</p>
<p>また,</p>
<p><span class="math display"> P(A) = \sum_{i=1}^{k} P(A \cap H_i) = \sum_{i=1}^{k} P(H_i)P(A|H_i) </span></p>
<p>であるから,</p>
<p><span class="math display"> P(H_i |A) = \frac{P(H_i)P(A|H_i)}{\sum_{i=1}^{k} P(H_i)P(A|H_i) }</span></p>
<p>と表す場合もあります.</p>
<p>このとき, <span class="math inline">P(H_i)</span>を(Aが起こる)<strong>事前確率</strong>,<span class="math inline">P(H_i|A)</span>を(Aが起こる)<strong>事後確率</strong>といいます. ベイズ統計学ではしばしば事前確率に<strong>主観確率</strong>が用いられ,これを基礎とする統計的方法を<strong>ベイズ統計学</strong>といいます.</p>
<div class="note">
<ul>
<li>客観確率</li>
</ul>
<p>頻度説では、事象<span class="math inline">A</span>の起こる確率<span class="math inline">P(A)</span>を生起回数の相対頻度で求めています.これは誰が計算しても同一の客観的な値といえます.</p>
<ul>
<li>主観確率</li>
</ul>
<p>研究者が主観的にある確率を与えて分析を行います. この場合確率は,研究者の経験,情報,知識によって異なる値が用いられます.
当然,主観確率によって結果は異なります. ただし,後に見るように多量のデータによって主観性を減らせる.</p>
<ul>
<li>事前確率と事後確率の意味</li>
</ul>
<p><strong>事前確率<span class="math inline">P(H_i)</span></strong>は,データ<span class="math inline">A</span>が観測される<strong>前</strong>の,仮説<span class="math inline">H_i</span>に対する(主観的な)確信度を表します. つまり,データを観測する前に,どの仮説が真である可能性が高いかを表す確率です.</p>
<p><strong>事後確率<span class="math inline">P(H_i|A)</span></strong>は,データ<span class="math inline">A</span>が観測された<strong>後</strong>の,仮説<span class="math inline">H_i</span>に対する確信度を表します. つまり,データ<span class="math inline">A</span>が得られたという情報を踏まえた上で,どの仮説が真である可能性が高いかを表す確率です.</p>
</div>
<p>ベイズの定理は,事前確率とデータから事後確率を計算する方法を提供します. この過程では,データが得られることで,仮説に対する確信度が更新されます. 例えば,事前確率が低かった仮説でも,データがその仮説を支持するものであれば,事後確率は高くなります. 逆に,事前確率が高かった仮説でも,データがその仮説と矛盾するものであれば,事後確率は低くなります.</p>
<p>条件付き確率の範囲では, ｢原因から結果の確率を計算｣しますが,ベイズの定理では結果から原因を考えています.</p>
<h3 data-number="2.1.3" id="条件付き確率-1"><span class="header-section-number">2.1.3</span> 条件付き確率</h3>
<p>事象Aが起こったと分かっている場合に事象Bの起こる確率</p>
<p><span class="math display"> P(B|A) = \frac{P(A \cap B)}{P(A)}</span></p>
<p>例:選ばれた壺から出るたまの確率を計算</p>
<p>壺に白,赤それぞれ3つの玉が入っている.白玉には1,1,2と数字,赤玉には1,2,2と数字が書かれている.
次に出る玉が白であることがわかっている場合に1の玉がでる確率は?</p>
<p><img src="/images/slds/ch12/conditional_probability.png" /></p>
<p><span class="math display">
P(1 | 白) = \frac{白 \cap 1}{P(白)} = \frac{2 / 6}{ 1/ 2} = \frac{2}{3}
</span></p>
<p>𝑃(玉の色|選んだ壺)であり, 𝑃(結果|原因)の計算</p>
<h3 data-number="2.1.4" id="ベイズ確率"><span class="header-section-number">2.1.4</span> ベイズ確率</h3>
<p>事象Bが起こったと分かっている場合に,事象Aが起きている確率</p>
<p><span class="math display"> P(H_i | A) = \frac{P(H_i)P(A | H_i)}{P(A)} </span></p>
<p>例. 出た玉から壺が選ばれている確率を計算</p>
<p>2つの壺があり,</p>
<ul>
<li><p>第1の壺には白玉が3個,黒玉が1個</p></li>
<li><p>第2の壺には白玉が1個,黒玉が２個</p></li>
<li><p><span class="math inline">𝐻_1</span>:第1の壺から取り出す</p></li>
<li><p><span class="math inline">𝐻_2</span>:第2の壺から取り出す</p></li>
<li><p><span class="math inline">A</span>:白玉が出たという事象</p></li>
</ul>
<p>とすると,いずれかの壺から玉を1個取り出したところ白玉であった,どちらの壺から取り出した確率が高いか.</p>
<p><img src="/images/slds/ch12/beys_example.png" /></p>
<p>まず,どちらの壺から取り出すかは<strong>五分五分</strong>であると仮定する. ここでこの仮定が完全に分析者の主観に基づくのであれば<strong>主観確率</strong>であり,何らかの実験等によって確率0.5であると確かめられている場合には<strong>客観確率</strong>とみなされる.</p>
<p><span class="math display">P(H_1) = P(H_2) = \frac{1}{2}</span></p>
<p><span class="math display">P(A|H_1) = \frac{3}{4}, \quad P(A|H_2) = \frac{1}{3}</span></p>
<p>であるから,</p>
<p><span class="math display">P(H_1|A) = \frac{\frac{1}{2} \cdot \frac{3}{4}}{\frac{1}{2} \cdot \frac{3}{4} + \frac{1}{2} \cdot \frac{1}{3}} = \frac{9}{13}</span></p>
<p><span class="math display">P(H_2|A) = \frac{\frac{1}{2} \cdot \frac{1}{3}}{\frac{1}{2} \cdot \frac{3}{4} + \frac{1}{2} \cdot \frac{1}{3}} = \frac{4}{13}</span></p>
<p>この｢<span class="math inline">H_1</span>の壺が選ばれている｣という結果は,壺が選ばれる確率が等しいという主観確率が正しければ正しいと言えます.</p>
<p>この事例で計算されているのは 𝑃(選んだ壺|玉の色) であり, 𝑃(原因|結果)という計算をしていることになります.</p>
<p>このように事例を見てみると, 主観確率を利用した計算は,主観確率の正しさに依存しているためあまり実用性があるようには思えません.
そこで重要になってくるのが,<strong>ベイズ更新</strong>という概念です.</p>
<h2 data-number="2.2" id="ベイズ更新"><span class="header-section-number">2.2</span> ベイズ更新</h2>
<h3 data-number="2.2.1" id="独立性"><span class="header-section-number">2.2.1</span> 独立性</h3>
<p>事象<span class="math inline">A</span>の起こる確率が他の事象<span class="math inline">B</span>に影響されない場合,事象<span class="math inline">A</span>と事象<span class="math inline">B</span>は<strong>独立である</strong>という.</p>
<p>このとき</p>
<p><span class="math display">P(A) = P(A|B)</span></p>
<p>が成り立ちます. 乗法定理 <span class="math inline">P(A \cap B) = P(B)P(A|B)</span> より,</p>
<p><span class="math display">P(A \cap B) = P(A)P(B)</span></p>
<p>が成り立つ.</p>
<p><strong>例:</strong> サイコロを2回投げて連続で1の目が出る確率を考える.</p>
<ul>
<li>事象<span class="math inline">A</span>: 1回目1が出る</li>
<li>事象<span class="math inline">B</span>: 2回目1が出る</li>
</ul>
<p><span class="math display">P(A \cap B) = \frac{1}{36}, \quad P(A) \cdot P(B) = \frac{1}{6} \cdot \frac{1}{6} = \frac{1}{36}</span></p>
<p>なので,事象<span class="math inline">A</span>と<span class="math inline">B</span>は独立といえる.</p>
<p>ベイズの目的は,複数のデータを利用して事後確率の推定を更新していくことにあります.</p>
<h3 data-number="2.2.2" id="複数の事象からなる条件付き確率"><span class="header-section-number">2.2.2</span> 複数の事象からなる条件付き確率</h3>
<p>複数の事象<span class="math inline">A, B, C</span>がある場合の条件付き確率は以下のように表されます.</p>
<p><span class="math display">P(B \cap C | A) = \frac{P(A \cap B \cap C)}{P(A)}</span></p>
<p>この式は,乗法定理(積の法則)により以下のように書き換えられます.</p>
<p><span class="math display">\Leftrightarrow P(A \cap B \cap C) = P(B \cap C | A)P(A)</span></p>
<p>同様に,<span class="math inline">A</span>が<span class="math inline">B \cap C</span>の条件下で起こる確率は以下の通りです.</p>
<p><span class="math display">P(A | B \cap C) = \frac{P(A \cap B \cap C)}{P(B \cap C)}</span></p>
<p>これも積の法則として以下のように書き換えられます.</p>
<p><span class="math display">\Leftrightarrow P(A \cap B \cap C) = P(A | B \cap C)P(B \cap C)</span></p>
<p>これらの式を代入して整理すると,以下の関係が得られます.</p>
<p><span class="math display">P(A | B \cap C) = \frac{P(B \cap C | A)P(A)}{P(B \cap C)}</span></p>
<h3 data-number="2.2.3" id="ベイズ更新の適用"><span class="header-section-number">2.2.3</span> ベイズ更新の適用</h3>
<p>原因<span class="math inline">H</span>と,現在の状況<span class="math inline">B, C</span>があるとき,事後確率<span class="math inline">P(H | B \cap C)</span>はベイズの定理により以下のように計算されます.</p>
<p><span class="math display">P(H | B \cap C) = \frac{P(B \cap C | H)P(H)}{P(B \cap C)}</span></p>
<p>もし事象<span class="math inline">B</span>と<span class="math inline">C</span>が独立であれば,条件付き確率<span class="math inline">P(B \cap C | H)</span>は<span class="math inline">P(B | H)P(C | H)</span>となり,分母の<span class="math inline">P(B \cap C)</span>は<span class="math inline">P(B)P(C)</span>となります. さらに,<span class="math inline">P(H | C) = \frac{P(C | H)P(H)}{P(C)}</span>の関係を利用すると,上記の式は以下のように変形できます.</p>
<p><span class="math display">P(H | B \cap C) = \frac{P(B | H)P(C | H)P(H)}{P(B)P(C)} = \frac{P(B | H)P(H | C)}{P(B)}</span></p>
<p>ここで,情報<span class="math inline">C</span>によって既に求められた事後確率<span class="math inline">P(H | C)</span>を新しい事前確率<span class="math inline">P(H)^*</span>とすると,ベイズ更新の式はより簡潔に表現できます.</p>
<p><span class="math display">P(H | B \cap C) = \frac{P(B | H)P(H)^*}{P(B)}</span></p>
<p>この方法により,情報が与えられるたびに事後確率を計算し,それを次のデータに対する事前分布として利用することで,分布の推定を逐次的に更新していくことができます.</p>
<h3 data-number="2.2.4" id="ベイズ統計学の性質"><span class="header-section-number">2.2.4</span> ベイズ統計学の性質</h3>
<p>事前確率に関する情報がなく,<span class="math inline">P(H)</span>が完全に主観的に決められたとしても,データ (<span class="math inline">A,B,C, \dots</span>)が大量にある場合は,</p>
<p><span class="math display">P(H|A \cap B \cap C \cap D \dots) = \frac{P(A \cap B \cap C \cap D \dots|H) P(H)}{P(A \cap B \cap C \cap D \dots)}</span></p>
<p>以下のように段階的に更新を実施することができます.</p>
<p>まず,データ<span class="math inline">A</span>が得られたとき:</p>
<p><span class="math display">P(H|A) = \frac{P(A|H)P(H)}{P(A)}</span></p>
<p>次に,データ<span class="math inline">B</span>が得られたとき,前の事後確率<span class="math inline">P(H|A) = \frac{P(A|H)P(H)}{P(A)} = P(H)^*</span> を新しい事前確率として利用:</p>
<p><span class="math display">P(H|A \cap B) = \frac{P(B|H)P(H|A)}{P(B)} = \frac{P(B|H)P(H)^*}{P(B)} </span></p>
<p>さらに,データ<span class="math inline">C</span>が得られたとき,前の事後確率<span class="math inline">P(H|A \cap B) = P(H)^{**}</span>を新しい事前確率として利用:</p>
<p><span class="math display">P(H|A \cap B \cap C) = \frac{P(C|H)P(H)^{**}}{P(C)} </span></p>
<p>このように,データ<span class="math inline">D, E, \dots</span>が得られるたびに,前の事後確率を事前確率として利用して更新を続けていきます. データ( <span class="math inline">A,B,C,D, \dots</span> )を大量に集めれば,最初に設定した事前確率<span class="math inline">P(H)</span>の影響が少なくなり,事後確率 <span class="math inline">P(H|A \cap B \cap C \cap D \dots)</span>が安定することが知られています.</p>
<div class="note">
<p>この性質は,<strong>ベイズ的一致性(Bayesian consistency)</strong>と呼ばれます. 具体的には以下のような性質が成り立ちます:</p>
<ul>
<li><p><strong>一致性</strong>: データが増えるにつれて,事後確率分布は真のパラメータ値に収束します. つまり,サンプルサイズが無限大に近づくと,事後確率は真の値に集中していきます.</p></li>
<li><p><strong>事後確率の安定性</strong>: 異なる事前分布から出発しても,データが十分に多ければ,最終的な事後分布はほぼ同じ結果になります. これは,データが増えるにつれて,尤度関数<span class="math inline">P(A \cap B \cap C \cap D \dots|H)</span>の影響が事前確率<span class="math inline">P(H)</span>の影響を上回るためです.</p></li>
<li><p><strong>事前確率の影響の減少</strong>: データが少ないときは事前確率<span class="math inline">P(H)</span>の選択が結果に大きく影響しますが,データが増えるにつれて,その影響は相対的に小さくなります. 最終的には,データの情報が支配的になり,事前確率の選択が結果に与える影響は限定的になります.</p></li>
</ul>
</div>
<p>しかし,このような更新には大量のデータが必要であることに加えて,データごとに分布を推定し直すには膨大な計算が必要となるため, ラプラスらの時代には現実的ではありませんでした.</p>
<p>現代では, 情報通信技術の発展によって大量のデータと,大量の計算が可能になりました.また,計算のためのアルゴリズム(マルコフ連鎖モンテカルロ法など)が発明されたことで,ベイズ更新に基づく推定が現実的な選択肢となりベイズ統計学が利用されるようになっています.</p>
<h2 data-number="2.3" id="マルコフ連鎖モンテカルロ法"><span class="header-section-number">2.3</span> マルコフ連鎖モンテカルロ法</h2>
<h3 data-number="2.3.1" id="尤度likelihood"><span class="header-section-number">2.3.1</span> 尤度(Likelihood)</h3>
<p>尤度とは,モデルのデータへの当てはまりの良さを表す統計量です.</p>
<ul>
<li><span class="math inline">\theta</span>を母数とする確率分布から観測データ<span class="math inline">y_i</span>が発生した場合,その確率は<span class="math inline">P(y_i|\theta)</span>と表されます.</li>
<li>尤度<span class="math inline">L(\theta|Y)</span>は,観測されたデータ<span class="math inline">Y = \{y_1, y_2, \dots, y_n\}</span>が与えられたときの,特定のパラメータ<span class="math inline">\theta</span>の「もっともらしさ」を示す関数で,以下のように定義されます.</li>
</ul>
<p><span class="math display">L(\theta|Y) = \prod_{i} P(y_i|\theta)</span></p>
<p>尤度はそのままでは計算しにくい場合が多いため,対数化した対数尤度を用いることが一般的です.</p>
<p><span class="math display">\log L(\theta|Y) = \sum_{i} \log P(y_i|\theta)</span></p>
<p>前段で説明したベイズ更新と尤度には密接な関係があります.</p>
<p>ベイズの定理は以下のように表されました:</p>
<p><span class="math display">P(H|A) = \frac{P(A|H)P(H)}{P(A)}</span></p>
<p>この式において,<span class="math inline">P(A|H)</span>は「仮説<span class="math inline">H</span>が真であるときにデータ<span class="math inline">A</span>が観測される確率」であり,これは<strong>尤度関数</strong>に対応します.</p>
<p>一般的な尤度の説明ではパラメータを<span class="math inline">\theta</span>で表しましたが,ベイズ統計学では仮説<span class="math inline">H</span>をパラメータとみなすことができます. 複数のデータ<span class="math inline">Y = \{y_1, y_2, \dots, y_n\}</span>が得られた場合,ベイズの定理は以下のようになります:</p>
<p><span class="math display">P(H|Y) = \frac{P(Y|H)P(H)}{P(Y)} = \frac{L(H|Y)P(H)}{P(Y)}</span></p>
<p>ここで,<span class="math inline">P(Y|H) = \prod_{i} P(y_i|H)</span>は尤度関数<span class="math inline">L(H|Y) = \prod_{i} P(y_i|H)</span>と一致します. したがって,ベイズの定理は尤度関数を用いて以下のように表現できます:</p>
<p><span class="math display">P(H|Y) \propto L(H|Y)P(H)</span></p>
<p>つまり,事後確率は「尤度×事前確率」に比例します. この関係から以下のことがわかります:</p>
<ul>
<li>尤度<span class="math inline">L(H|Y)</span>が大きいほど,その仮説<span class="math inline">H</span>の事後確率<span class="math inline">P(H|Y)</span>も大きくなります.</li>
<li>データが増えるにつれて,尤度関数の影響が事前確率の影響を上回り,事後確率が安定していきます.</li>
<li>ベイズ更新では,新しいデータが得られるたびに尤度関数を計算し,それと事前確率を組み合わせて事後確率を更新していきます.</li>
</ul>
<h3 data-number="2.3.2" id="最尤推定-maximum-likelihood-estimation"><span class="header-section-number">2.3.2</span> 最尤推定 (Maximum Likelihood Estimation)</h3>
<p>この対数尤度を最大にするようなパラメータの推定量<span class="math inline">\hat{\theta}</span>を推定することを<strong>最尤推定</strong>といいます.</p>
<p><span class="math inline">\hat{\theta}</span>は数理的に求めることが可能な場合もありますが,モデルが複雑な場合は困難なので機械的に求めることが多く,その手法の代表的なものがマルコフ連鎖モンテカルロ法(MCMC)です.</p>
<h3 data-number="2.3.3" id="マルコフ連鎖モンテカルロ法-mcmcmarkov-chain-monte-carlo-method"><span class="header-section-number">2.3.3</span> マルコフ連鎖モンテカルロ法 MCMC(Markov chain Monte Carlo Method)</h3>
<p>前段で説明したベイズ統計学において,事後確率<span class="math inline">P(H|Y) \propto L(H|Y)P(H)</span>を計算するには,分母の正規化定数<span class="math inline">P(Y)</span>を求める必要があります. しかし,モデルが複雑な場合やパラメータが多変数の場合,この正規化定数の計算は解析的に困難です. また,最尤推定においても,解析的に最尤推定量<span class="math inline">\hat{\theta}</span>が求められない(難しい)場合があります.</p>
<p>このような場合に用いられるのが,計算機による繰り返し計算で少しずつパラメータの値を変化させ,最適な値を探し出す方法である<strong>マルコフ連鎖モンテカルロ法(MCMC)</strong>です.</p>
<div class="note">
<ul>
<li>MCMCの基本的な仕組み</li>
</ul>
<p>MCMCは以下のような手順で動作します:</p>
<ol type="1">
<li><p><strong>初期値の設定</strong>: 複数の初期値<span class="math inline">\theta</span>を適当に決めます.</p></li>
<li><p><strong>ランダムな探索</strong>: ランダムに<span class="math inline">\theta</span>を少し増減させます.</p></li>
<li><p><strong>尤度の評価</strong>: 新しい<span class="math inline">\theta</span>の値での尤度を計算し,前の値と比較します.</p></li>
<li><p><strong>移動の決定</strong>: 尤度が改善したら,<span class="math inline">\theta</span>をその方向にして次のステップに進みます. ただし,<strong>メトロポリス法</strong>などの手法では,たまに尤度が悪くなっても一定の確率でそちらに進むことで,局所最適解に陥ることを防ぎます.</p></li>
<li><p><strong>繰り返し</strong>: この過程を繰り返すことで,パラメータ空間を探索し,最尤推定量や事後分布のサンプルを生成します.</p></li>
</ol>
<p><img src="/images/slds/ch12/mcmc.png" /></p>
</div>
<p>MCMCにより,ベイズ統計学における複雑な事後分布の推定や,最尤推定における困難な最適化問題を,計算機上で効率的に解決できるようになりました.</p>
<h1 data-number="3" id="ベイズ統計学による統計モデリング実践"><span class="header-section-number">3</span> ベイズ統計学による統計モデリング実践</h1>
<p>それでは,実際にベイズ統計学に基づいた統計モデリングを実施してみましょう.
前章で重回帰で実施したものと良く似た<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/ch12/hierarchical_regression.csv">こちらのデータ</a>を事例として利用します.</p>
<table>
<thead>
<tr class="header">
<th>GPA</th>
<th>Scholarship</th>
<th>Study_Hours</th>
<th>Sports_hours</th>
<th>Part_time_Work</th>
<th>StudentID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1.348928</td>
<td>True</td>
<td>10.348188</td>
<td>5.398119</td>
<td>14.944201</td>
<td>0</td>
</tr>
<tr class="even">
<td>1.968662</td>
<td>False</td>
<td>8.803971</td>
<td>3.799566</td>
<td>15.340118</td>
<td>1</td>
</tr>
<tr class="odd">
<td>2.246881</td>
<td>True</td>
<td>10.367043</td>
<td>5.139604</td>
<td>19.937536</td>
<td>2</td>
</tr>
<tr class="even">
<td>1.167275</td>
<td>True</td>
<td>2.049724</td>
<td>4.229373</td>
<td>21.009315</td>
<td>3</td>
</tr>
<tr class="odd">
<td>3.295929</td>
<td>True</td>
<td>9.121312</td>
<td>5.227035</td>
<td>14.271377</td>
<td>4</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>0.974230</td>
<td>False</td>
<td>4.256551</td>
<td>0.396158</td>
<td>13.299289</td>
<td>185</td>
</tr>
<tr class="even">
<td>2.208293</td>
<td>False</td>
<td>14.652655</td>
<td>1.969618</td>
<td>10.523032</td>
<td>186</td>
</tr>
<tr class="odd">
<td>0.786660</td>
<td>False</td>
<td>10.040932</td>
<td>7.733749</td>
<td>13.232559</td>
<td>187</td>
</tr>
<tr class="even">
<td>2.068987</td>
<td>True</td>
<td>6.073965</td>
<td>8.289935</td>
<td>13.540597</td>
<td>188</td>
</tr>
<tr class="odd">
<td>2.531604</td>
<td>True</td>
<td>11.848414</td>
<td>4.501928</td>
<td>11.335318</td>
<td>189</td>
</tr>
</tbody>
</table>
<p>各自でダウンロードして利用して下さい.</p>
<h2 data-number="3.1" id="重回帰での結果確認"><span class="header-section-number">3.1</span> 重回帰での結果確認</h2>
<p>まずは,データの読み込みを行います. 必要なライブラリは各自で <code>pip install</code>してください.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score, mean_absolute_error</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&#39;hierarchical_regression.csv&#39;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                ,dtype<span class="op">=</span>{<span class="st">&#39;GPA&#39;</span>: <span class="bu">float</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Scholarship&#39;</span>: <span class="bu">bool</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Study_Hours&#39;</span>: <span class="bu">float</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Sports_hours&#39;</span>: <span class="bu">float</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Part_time_Work&#39;</span>: <span class="bu">float</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;StudentID&#39;</span>:<span class="bu">int</span>})</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">          GPA  Scholarship  Study_Hours  Sports_hours  Part_time_Work  StudentID</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">0    1.348928         True    10.348188      5.398119       14.944201          0</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">1    1.968662        False     8.803971      3.799566       15.340118          1</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">2    2.246881         True    10.367043      5.139604       19.937536          2</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">3    1.167275         True     2.049724      4.229373       21.009315          3</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">4    3.295929         True     9.121312      5.227035       14.271377          4</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">..        ...          ...          ...           ...             ...        ...</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">185  0.974230        False     4.256551      0.396158       13.299289        185</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">186  2.208293        False    14.652655      1.969618       10.523032        186</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">187  0.786660        False    10.040932      7.733749       13.232559        187</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">188  2.068987         True     6.073965      8.289935       13.540597        188</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">189  2.531604         True    11.848414      4.501928       11.335318        189</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>まずはデータを可視化してみます.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ペアプロット</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sns.pairplot(df</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>            ,<span class="bu">vars</span><span class="op">=</span>[<span class="st">&quot;GPA&quot;</span>, <span class="st">&quot;Study_Hours&quot;</span>, <span class="st">&quot;Sports_hours&quot;</span>, <span class="st">&quot;Part_time_Work&quot;</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            ,hue<span class="op">=</span><span class="st">&quot;Scholarship&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            ,diag_kind<span class="op">=</span><span class="st">&quot;hist&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">&quot;Pairplot with Scholarship&quot;</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;PairplotwithScholarship.png&#39;</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#joinplotで男女別に密度プロットを表示</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> sns.jointplot(df</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>               ,x <span class="op">=</span><span class="st">&quot;Study_Hours&quot;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>               ,y <span class="op">=</span><span class="st">&quot;GPA&quot;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>               ,hue<span class="op">=</span><span class="st">&#39;Scholarship&#39;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>               ,joint_kws <span class="op">=</span> <span class="bu">dict</span>(alpha<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;kde.png&#39;</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code></pre></div>
<p><img src="/images/slds/ch12/PairplotwithScholarship.png" /></p>
<p>以前のデータと概ね似た傾向(奨学金ありが少し高い,勉強時間とGPAに相関,勉強時間とバイト時間に負の相関など,)が確認できます.
ただし,前回のデータと比べるとデータ全体のばらつきが大きいことが分かります.</p>
<p><img src="/images/slds/ch12/kde-compare.png" /></p>
<p>前回と同様の手法で,線形重回帰の実施と結果の確認を行います.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 数量化</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.get_dummies(df, columns<span class="op">=</span>[<span class="st">&#39;Scholarship&#39;</span>], dtype<span class="op">=</span><span class="st">&#39;int&#39;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#標準化</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>   ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>   ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>   ,<span class="st">&#39;Sports_hours&#39;</span>]] <span class="op">=</span> scaler.fit_transform(df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Sports_hours&#39;</span>]])</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#線形回帰</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 説明変数(X)と目的変数(y)に分割</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[[<span class="st">&#39;Scholarship_True&#39;</span>, <span class="st">&#39;Study_Hours&#39;</span>]]</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">&#39;GPA&#39;</span>]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 切片(定数項)を追加</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>lm <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">[通常の線形回帰の結果]</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(lm.summary())</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>lm_preds <span class="op">=</span> lm.predict(X)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>plt.scatter(df[<span class="st">&#39;GPA&#39;</span>], lm_preds, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">&quot;k&quot;</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Predicted&quot;</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Actual&quot;</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Actual vs. Predicted&quot;</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>plt.plot([df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()], [df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()], color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linestyle<span class="op">=</span><span class="st">&quot;--&quot;</span>)  <span class="co"># 完全一致のライン</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;lm.png&#39;</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(lm_preds, label <span class="op">=</span> <span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(df[<span class="st">&#39;GPA&#39;</span>], label <span class="op">=</span> <span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Actual/Predicted&#39;</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;GPA&#39;</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Density&#39;</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;lm_kde.png&#39;</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co">                            OLS Regression Results                            </span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">Dep. Variable:                    GPA   R-squared:                       0.444</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co">Model:                            OLS   Adj. R-squared:                  0.438</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co">Method:                 Least Squares   F-statistic:                     74.76</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="co">Date:                Tue, 04 Nov 2025   Prob (F-statistic):           1.38e-24</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co">Time:                        16:50:17   Log-Likelihood:                -187.55</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co">No. Observations:                 190   AIC:                             381.1</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="co">Df Residuals:                     187   BIC:                             390.8</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="co">Df Model:                           2                                         </span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="co">Covariance Type:            nonrobust                                         </span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="co">====================================================================================</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="co">                       coef    std err          t      P&gt;|t|      [0.025      0.975]</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------------------------------------------------------------------</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="co">const                2.0000      0.047     42.122      0.000       1.906       2.094</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="co">Scholarship_True     0.1385      0.047      2.917      0.004       0.045       0.232</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co">Study_Hours          0.5620      0.047     11.835      0.000       0.468       0.656</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="co">Omnibus:                       11.718   Durbin-Watson:                   1.974</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="co">Prob(Omnibus):                  0.003   Jarque-Bera (JB):               14.133</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="co">Skew:                          -0.457   Prob(JB):                     0.000853</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="co">Kurtosis:                       3.975   Cond. No.                         1.01</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>全般的に有意ではあるものの,精度がそれほど高くありません.
<img src="/images/slds/ch12/lm.png" />
<img src="/images/slds/ch12/lm_kde.png" /></p>
<p>グラフを見てみると, 元のデータは予測値に対して分散が大きくデータの分散を予測モデルが説明しきれていないことが分かります.
R2を確認しても,データに含まれている変数では全体の変動のうち44%ほどしか説明できていません.</p>
<h2 data-number="3.2" id="過分散と個別差"><span class="header-section-number">3.2</span> 過分散と個別差</h2>
<p>このように,観察データの分散が,モデルの予測から逸脱しており,モデルではデータの分散が説明できていない状態を<strong>過分散</strong>といいます.</p>
<p>モデルの説明力を上げるためには,このようなモデルによって説明できていないばらつきを説明する拡張が必要となります.</p>
<p>ここでは,｢データ(の観測対象)=学生｣なので,｢ばらつき=学生差｣と仮定してみます.
例えば,そもそも過去の学習経験,勉強環境などにより,ベースとなる学力が学生それぞれで異なるなど,学生差によるばらつきを表現するために線形モデルを拡張した<strong>一般化線形モデル</strong>を構築してみましょう.</p>
<h2 data-number="3.3" id="一般化線形モデルglm"><span class="header-section-number">3.3</span> 一般化線形モデル(GLM)</h2>
<p><strong>一般化線形モデル(Generalized Linear Model, GLM)</strong>は,線形回帰分析を一般化した統計モデルです. 線形回帰分析では以下の式における</p>
<p><span class="math display">
Y_i = \beta_0 + \beta_1 X_i + \epsilon_i \quad (i=1,2,\dots,n)
</span></p>
<p><strong>誤差項</strong> <span class="math inline">\epsilon_i</span> のみが<strong>正規分布</strong>に従うと仮定して分析を実施していました.</p>
<p><span class="math display">
\epsilon_i \sim N(0, \sigma^2)
</span></p>
<p>これに対し,一般化線形モデルは以下の3つの要素から構成されます:</p>
<ol type="1">
<li><strong>確率分布</strong>: 目的変数<span class="math inline">y_i</span>が従う確率分布(正規分布,ポアソン分布,二項分布など)</li>
<li><strong>線形予測子</strong>: 説明変数の線形結合<span class="math inline">\eta_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \cdots</span></li>
<li><strong>リンク関数</strong>: 目的変数の期待値<span class="math inline">E[y_i]</span>と線形予測子<span class="math inline">\eta_i</span>を結び付ける関数<span class="math inline">g(E[y_i]) = \eta_i</span></li>
</ol>
<p>線形回帰は,一般化線形モデルの特殊ケース(正規分布 + 恒等リンク関数)として捉えることができます. 一般化線形モデルにより,正規分布以外の分布や,非線形な関係もモデル化できるようになります.</p>
<p>ベイズ統計学のモデルにおいて最尤推定する対象は, モデルの母数 <span class="math inline">\theta</span>であり,
データがどのような分布であるかを観察し,それを再現するモデルを構築します.</p>
<p>そこで,今回の目的変数であるGPAの分布を確認してみましょう.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(df[<span class="st">&quot;GPA&quot;</span>], fill<span class="op">=</span><span class="va">True</span>, bw_adjust<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Kernel Density Estimate of GPA&quot;</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;GPA&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Density&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;kde-gpa.png&#39;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code></pre></div>
<p><img src="/images/slds/ch12/gpa-kde.png" /></p>
<p>カーネル密度プロットの結果から,今回のデータは正規分布していると仮定して問題なさそうです.</p>
<p><span class="math display"> y_i \sim N(\mu_i, \sigma^2) </span></p>
<p>ここで,今回は正規分布の母数である平均 <span class="math inline">\mu</span> を推定する目的としてみます.</p>
<div class="warn">
<p>モデルの設計では分散 <span class="math inline">\sigma</span> を推定の目的とすることも可能ですが,単純化のために固定とします.
今回は説明用の単純なモデルですが,必要に応じてより複雑なモデルを資料に追加していきます.</p>
</div>
<p>このとき,説明変数としてgpaに影響するもの配下のように仮定します.</p>
<ul>
<li><span class="math inline">S_t</span> (Study Hours): 勉強時間</li>
<li><span class="math inline">S_s</span> (Scholarship): 奨学金</li>
<li><span class="math inline">\alpha_i</span>: 学生個別のもともとの学力（ランダム切片）</li>
</ul>
<p>これらの変数を用いて, <span class="math inline">\mu</span> を表す式を以下のように立てます.</p>
<p><span class="math display">\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s</span></p>
<p>このような式を,<strong>線形予測子(linear predictor)</strong>といいます.</p>
<div class="note">
<p>線形予測子は,説明変数とパラメータの線形結合で構成される式です.</p>
<p>一般化線形モデル(GLM)では,線形予測子<span class="math inline">\eta_i</span>と目的変数の期待値<span class="math inline">E[y_i]</span>をリンク関数<span class="math inline">g(\cdot)</span>で結び付けます:</p>
<p><span class="math display">g(E[y_i]) = \eta_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s</span></p>
<p>今回は正規分布を仮定しているため,恒等リンク関数(identity link function) <span class="math inline">g(x) = x</span> を使用します. 恒等リンク関数では,</p>
<p><span class="math display">g(E[y_i]) = E[y_i] = \mu_i = \eta_i</span></p>
<p>となり,<span class="math inline">\mu_i = E[y_i] = \eta_i</span>という関係が成り立ちます. これにより,線形回帰と同じ形式になります.</p>
<p>他の分布では,例えば:</p>
<ul>
<li>ポアソン分布: 対数リンク関数 <span class="math inline">g(E[y_i]) = \log(E[y_i]) = \eta_i</span></li>
<li>二項分布: ロジットリンク関数 <span class="math inline">g(E[y_i]) = \log\left(\frac{E[y_i]}{1-E[y_i]}\right) = \eta_i</span></li>
</ul>
<p>などが用いられます.</p>
<p>今回は線形モデルとの接続のために,正規分布を仮定していますが,そもそもデータが正規分布では説明できないことが明らかな場合には,適した分布を選択することでモデルの精度が格段に上がります.</p>
</div>
<p>ここで,解くべき問題は,</p>
<p><span class="math display">E[y_i] = \mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s</span></p>
<p>となるような<span class="math inline">\alpha_i, \beta_{st}, \beta_{ss}</span>を推定することです.</p>
<h2 data-number="3.4" id="個体差のモデリング"><span class="header-section-number">3.4</span> 個体差のモデリング</h2>
<p>恒等リンク関数を用いたモデリングでは,線形回帰と同じ形式の式となりますが,
一般化線形モデルでは全体の分布を仮定しているため個体差をモデルに取り組むことが可能となります.</p>
<h3 data-number="3.4.1" id="線形回帰での問題"><span class="header-section-number">3.4.1</span> 線形回帰での問題</h3>
<p>個体差をモデルに取り込もうとする場合,線形回帰では以下のような問題が発生します:</p>
<ul>
<li><p><strong>ダミー変数の導入</strong>: 各学生の個別の学力を推定するために,学生ごとにダミー変数を導入する方法が考えられます.</p></li>
<li><p><strong>データ数が少ない場合の問題</strong>: 各学生毎にデータ数が少ない場合(今回は1人1データ),各ダミー変数は誤差と等しくなってしまいます.</p></li>
<li><p><strong>過学習の問題</strong>: 結果として,データ = 予測値 (<span class="math inline">\hat{y}_i = y_i</span>) としているのと変わらなくなります. これは推定の意味がなく,<strong>過学習</strong>を起こしている状態です.</p></li>
</ul>
<h3 data-number="3.4.2" id="ベイズ推論による解決"><span class="header-section-number">3.4.2</span> ベイズ推論による解決</h3>
<p>ベイズ統計学では,この問題を以下のように解決します:</p>
<ul>
<li><p><strong>階層構造の導入</strong>: 各学生の学力<span class="math inline">\alpha_i</span>に対して,事前分布として正規分布<span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>を設定します. これにより,<strong>階層ベイズモデル(hierarchical Bayesian model)</strong>または<strong>ランダム効果モデル(random effects model)</strong>を構築します.</p></li>
<li><p><strong>分布の母数を推定</strong>: 推定するのは個別の学力<span class="math inline">\alpha_i</span>ではなく,その分布の母数<span class="math inline">(\mu_{\alpha}, \sigma_{\alpha})</span>です. これにより,データ数が少なくても,全体の分布から情報を借用(<strong>borrowing strength</strong>, 情報の共有)して推定を行うことができます. 各学生のデータが少なくても,他の学生のデータと組み合わせることで,より安定した推定が可能になります.</p></li>
<li><p><strong>新しいデータへの対応</strong>: 分布の母数<span class="math inline">(\mu_{\alpha}, \sigma_{\alpha})</span>が推定されているため,新しい学生のデータが得られた場合でも,推定された分布<span class="math inline">N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>に基づいて学力を推定することが可能になります. これにより,汎化性能の高いモデルを構築できます.</p></li>
</ul>
<p><img src="/images/slds/ch12/random_image.png" /></p>
<p>それでは実際に,モデルを構築してみましょう.</p>
<h3 data-number="3.4.3" id="モデルの仮定"><span class="header-section-number">3.4.3</span> モデルの仮定</h3>
<p>階層ベイズモデルでは,仮説に従って以下のように分布を設定します.</p>
<ul>
<li><strong>仮説: 基礎学力は学生によって異なる</strong>
<ul>
<li>個別に異なる<span class="math inline">\alpha_i</span></li>
</ul></li>
<li><strong>仮定: 基礎学力は正規分布に従う</strong>
<ul>
<li><span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span></li>
<li>これを<strong>事前分布(prior distribution)</strong>といいます.</li>
</ul></li>
<li><strong>更にそれぞれの母数の分布を仮定する</strong>
<ul>
<li><span class="math inline">\mu_{\alpha} \sim N(0, 1)</span></li>
<li><span class="math inline">\sigma_{\alpha} \sim HN(1)</span></li>
<li>ここで,<span class="math inline">HN</span>は<strong>半正規分布(Half-Normal distribution)</strong>を表します.</li>
</ul></li>
</ul>
<p><img src="/images/slds/ch12/dist_setting.png" /></p>
<p>このように,パラメータの分布のパラメータ(超パラメータ)についても分布を仮定することで,階層的な構造を持つベイズモデルを構築します. これは<strong>階層事前分布(hierarchical prior)</strong>と呼ばれます.</p>
<h3 data-number="3.4.4" id="ランダム傾きとランダム切片"><span class="header-section-number">3.4.4</span> ランダム傾きとランダム切片</h3>
<p>これまで,学生の基礎学力の違い(ランダム切片<span class="math inline">\alpha_i</span>)について考えてきましたが,他にも個体差として考慮できる要素があります.</p>
<ul>
<li><strong>仮説: 勉強時間による効果は人によって違う</strong></li>
</ul>
<p>ただし,学生個別の個体差<span class="math inline">\alpha_i</span>(ランダム切片)のように,学生個別の勉強時間あたりのGPAの上昇率<span class="math inline">\beta_{st,i} \cdot S_t</span>という推定は,今回のデータではモデル化<strong>できません</strong>.</p>
<p>このような個別の傾きを<strong>ランダム傾き(random slope)</strong>といいます.</p>
<h4 data-number="3.4.4.1" id="なぜモデル化できないのか"><span class="header-section-number">3.4.4.1</span> なぜモデル化できないのか?</h4>
<ul>
<li><p><strong>学生1人につき1つしかデータがない</strong>: 今回のデータでは,各学生について1つの観測値しかありません.</p></li>
<li><p><strong>切片はそれぞれの値から推定できる</strong>: 切片<span class="math inline">\alpha_i</span>は,以下のように各学生のデータから直接推定できます:
<span class="math display">\alpha_i = y_i - \beta_{st} \cdot S_t - \beta_{ss} \cdot S_s</span></p></li>
<li><p><strong>傾きは複数の観測点が必要</strong>: 傾きは「変化の傾向(勾配)」なので,推定には複数の観測点が必要です. 傾き<span class="math inline">\beta_{st,i}</span>を推定するには,少なくとも2点以上のデータが必要で,以下のように計算されます:
<span class="math display">\beta_{st,i} = \frac{y_i - y_j}{S_{t,i} - S_{t,j}}</span></p></li>
</ul>
<p>そのため,1人1データしかない今回のケースでは,学生ごとのランダム傾きを推定することはできません. ランダム傾きをモデル化するには,各学生について複数の時点でのデータ(縦断データ)が必要になります.</p>
<p><img src="/images/slds/ch12/random_slope.png" /></p>
<p>したがって今回は,学生個別の学習能力は全体で同一(固定効果)として扱います. また,奨学金についても同様に学生ごとの差は無いものとして扱います(ランダム傾きモデルに関しては,今後学生の需要があれば資料に追加します.)</p>
<h2 data-number="3.5" id="モデル全体像"><span class="header-section-number">3.5</span> モデル全体像</h2>
<p>これまで説明してきた内容を整理すると,以下のような階層ベイズモデルになります:</p>
<h3 data-number="3.5.1" id="推定する分布"><span class="header-section-number">3.5.1</span> 推定する分布</h3>
<p><span class="math display">y_i \sim N(\mu_i, \sigma^2)</span></p>
<p>ここで,<span class="math inline">y_i</span>は学生<span class="math inline">i</span>のGPAです. 誤差の標準偏差<span class="math inline">\sigma</span>は,今回は固定値<span class="math inline">\sigma = 0.3</span>として扱います.</p>
<h3 data-number="3.5.2" id="線形予測子"><span class="header-section-number">3.5.2</span> 線形予測子</h3>
<p><span class="math display">\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s</span></p>
<p>ここで:</p>
<ul>
<li><span class="math inline">S_t</span>は勉強時間(Study Hours)</li>
<li><span class="math inline">S_s</span>は奨学金受給の有無(Scholarship, 0または1)</li>
<li><span class="math inline">\alpha_i</span>は学生<span class="math inline">i</span>の基礎学力(ランダム切片)</li>
<li><span class="math inline">\beta_{st}</span>は勉強時間の効果(固定効果)</li>
<li><span class="math inline">\beta_{ss}</span>は奨学金の効果(固定効果)</li>
</ul>
<h3 data-number="3.5.3" id="尤度関数"><span class="header-section-number">3.5.3</span> 尤度関数</h3>
<p><span class="math display">p(y | \alpha, \beta_{st}, \beta_{ss}, \sigma) = \prod_{i=1}^{N} N(y_i | \mu_i, \sigma^2)</span></p>
<p>ここで,<span class="math inline">\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s</span>です.</p>
<h3 data-number="3.5.4" id="事前分布"><span class="header-section-number">3.5.4</span> 事前分布</h3>
<h4 data-number="3.5.4.1" id="ランダム切片階層構造"><span class="header-section-number">3.5.4.1</span> ランダム切片(階層構造)</h4>
<ul>
<li><p><span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>: 学生個別の基礎学力(ランダム切片)</p>
<p>これは非中心パラメータ化により以下のように表現されます:</p>
<p><span class="math display">z_{\alpha,i} \sim N(0, 1)</span>
<span class="math display">\alpha_i = \mu_{\alpha} + \sigma_{\alpha} \cdot z_{\alpha,i}</span></p></li>
</ul>
<div class="note">
<ul>
<li>非中心パラメータ化(non-centered parameterization)</li>
</ul>
<p>階層ベイズモデルにおいて,ランダム切片<span class="math inline">\alpha_i</span>を表現する方法には2通りあります:</p>
<ol type="1">
<li><p><strong>中心パラメータ化(centered parameterization)</strong>:
<span class="math display">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>
これは,直接<span class="math inline">\alpha_i</span>を平均<span class="math inline">\mu_{\alpha}</span>と標準偏差<span class="math inline">\sigma_{\alpha}</span>を持つ正規分布から生成する方法です.</p></li>
<li><p><strong>非中心パラメータ化(non-centered parameterization)</strong>:
<span class="math display">z_{\alpha,i} \sim N(0, 1)</span>
<span class="math display">\alpha_i = \mu_{\alpha} + \sigma_{\alpha} \cdot z_{\alpha,i}</span>
これは,標準正規分布<span class="math inline">N(0, 1)</span>から<span class="math inline">z_{\alpha,i}</span>を生成し,それを線形変換して<span class="math inline">\alpha_i</span>を生成する方法です.</p></li>
</ol>
<p>数学的には,両者は同じ分布<span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>を生成しますが,MCMCサンプリングにおける挙動が大きく異なります.</p>
<p><strong>MCMCサンプリングにおける効果:</strong></p>
<p>非中心パラメータ化は,以下の理由からMCMCサンプリングの効率を大幅に向上させます:</p>
<ol type="1">
<li><p><strong>パラメータ間の相関の低減</strong>: 中心パラメータ化では,<span class="math inline">\alpha_i</span>と<span class="math inline">(\mu_{\alpha}, \sigma_{\alpha})</span>の間に強い相関が生じます. 特に,<span class="math inline">\sigma_{\alpha}</span>が小さい場合,<span class="math inline">\alpha_i</span>の値は<span class="math inline">\mu_{\alpha}</span>に近くなり,パラメータ空間の探索が困難になります. 非中心パラメータ化では,<span class="math inline">z_{\alpha,i}</span>は標準正規分布から独立に生成されるため,パラメータ間の相関が低減され,効率的な探索が可能になります.</p></li>
<li><p><strong>ファネル形状の問題の回避</strong>: 階層モデルでは,パラメータ空間が「ファネル(funnel)」形状になることがあります. <span class="math inline">\sigma_{\alpha}</span>が小さい領域では,許容される<span class="math inline">\alpha_i</span>の範囲が狭くなり,サンプリングが困難になります. 非中心パラメータ化により,この問題を回避できます.</p></li>
<li><p><strong>収束の改善</strong>: パラメータ間の相関が低減されることで,マルコフ連鎖がより速く混合し,収束が改善されます. 特に,階層モデルでは,非中心パラメータ化を使用することで,発散(divergence)の発生を大幅に減らすことができます.</p></li>
<li><p><strong>ESS(Effective Sample Size)の向上</strong>: パラメータ間の相関が低減されることで,サンプル間の自己相関が減少し,実質的なサンプルサイズ(ESS)が向上します. これにより,より少ないサンプル数で,より信頼性の高い推定が可能になります.</p></li>
</ol>
<p><strong>実用的な意味:</strong></p>
<ul>
<li><p><strong>階層モデルでは非中心パラメータ化を推奨</strong>: 特に,<span class="math inline">\sigma_{\alpha}</span>が小さい場合や,データが少ない場合には,非中心パラメータ化の効果が顕著に現れます.</p></li>
<li><p><strong>発散の減少</strong>: 非中心パラメータ化により,発散の発生を大幅に減らすことができます. 発散が多い場合には,まず非中心パラメータ化を試すことが推奨されます.</p></li>
<li><p><strong>計算効率の向上</strong>: 収束が改善され,ESSが向上することで,必要なサンプル数が減り,計算時間の短縮につながります.</p></li>
</ul>
<p>ただし,すべての場合に非中心パラメータ化が最適というわけではありません. データが十分に多い場合や,<span class="math inline">\sigma_{\alpha}</span>が大きい場合には,中心パラメータ化でも問題なく動作することがあります. しかし,一般的には,階層モデルでは非中心パラメータ化を使用することが推奨されます.</p>
</div>
<h4 data-number="3.5.4.2" id="固定効果"><span class="header-section-number">3.5.4.2</span> 固定効果</h4>
<ul>
<li><span class="math inline">\beta_{st} \sim N(0, 1)</span>: 勉強時間の効果(固定効果, 学生間で同じ値)</li>
<li><span class="math inline">\beta_{ss} \sim N(0, 1)</span>: 奨学金の効果(固定効果, 学生間で同じ値)</li>
</ul>
<h3 data-number="3.5.5" id="超事前分布"><span class="header-section-number">3.5.5</span> 超事前分布</h3>
<ul>
<li><span class="math inline">\mu_{\alpha} \sim N(0, 1)</span>: ランダム切片の平均</li>
<li><span class="math inline">\sigma_{\alpha} \sim HN(1)</span>: ランダム切片の標準偏差(半正規分布)</li>
</ul>
<p>以下は後述のコードから生成されるモデル全体像を表す図です.</p>
<p><img src="/images/slds/ch12/hierarchical_bayes_model.png" /></p>
<p>このモデルにより,学生間の基礎学力の個体差を考慮しながら(ランダム切片),勉強時間と奨学金がGPAに与える影響を固定効果として推定することができます.</p>
<h1 data-number="4" id="環境構築"><span class="header-section-number">4</span> 環境構築</h1>
<p>それでは,実際にプログラム上でこのモデルを構築,推定してみましょう.</p>
<p><code>Python</code>においてベイズ統計学に基づいた統計モデリングを実施するためのライブラリとして<code>PyMC5</code>があります(古いVersionとして<code>PyMC3</code>があり全く異なる記法などを用いているので注意して下さい). こちらのライブラリは,Pythonのパッケージマネージャーである<code>anaconda</code>を利用します.
通常これまでに利用してきた<code>pip</code>による環境と<code>anaconda</code>環境の併用は困難です. ただし,この講義では,<code>pyenv</code>を環境構築に利用していますので, <code>PyMC</code>を利用するためのディレクトリのlocal環境にのみ<code>anaconda</code>用の環境を構築することが可能です.</p>
<p>まずは,ターミナルで<code>PyMC</code>を実行する用のディレクトリを作成し,そこに移動して下さい.</p>
<p>以下, 移動したディレクトリ内に<code>anaconda</code>環境を構築していきます.</p>
<h2 data-number="4.1" id="anacondaのインストール"><span class="header-section-number">4.1</span> <code>anaconda</code>のインストール</h2>
<div class="warn">
<p><code>MacOS</code>の方は <code>pyenv install -l</code> で<code>anaconda</code>系統の環境が表示されるので <code>pyenv install anacondaXXX</code> でインストール可能です.</p>
<p>執筆時点の最新版 <code>anaconda3-2024.10-1</code>は<code>PyMC5</code>が対応していないため,<code>anaconda3-2024.02-1</code>が推奨されます.</p>
</div>
<p><code>Windows</code>の場合は <code>pyenv</code> でのインストールが提供されていないので,手動でインストールする必要があります.</p>
<p><code>anaconda</code>の<a href="https://www.anaconda.com/download#Downloads">公式ページ</a>に行き,<code>Get Started</code>から指示に従ってアカウント等を作成して下さい.</p>
<p><img src="/images/slds/ch12/anaconda/anaconda-HP.png" /></p>
<p>続いて, Windows版の<code>anaconda</code>のインストーラーをダウンロードします.</p>
<p><img src="/images/slds/ch12/anaconda/anaconda-DW.png" /></p>
<p>ダウンロードが完了したら,インストーラーをダブルクリックして起動します.
設定は変更せず<code>Next</code>をクリックしていきます.</p>
<p><img src="/images/slds/ch12/anaconda/anaconda-Explorer.png" /></p>
<p><img src="/images/slds/ch12/anaconda/anaconda-installer.png" /></p>
<p><img src="/images/slds/ch12/anaconda/anaconda-just-me.png" /></p>
<p>インストール先の設定画面が出たら, <code>pyenv</code>の<code>versions</code>フォルダに保存します.
パスを以下のように指定して次に進みましょう</p>
<p><code>C:\Users\xxx\.pyenv\pyenv-win\versions\anaconda</code>
(XXXの部分を自分のユーザー名にしましょう.)</p>
<p><img src="/images/slds/ch12/anaconda/anaconda-pass.png" /></p>
<p>その後は基本的にデフォルトの設定のまま,<code>Next</code>,<code>Finish</code>を押しましょう.</p>
<p><img src="/images/slds/ch12/anaconda/anaconda-installer-end.png" /></p>
<p><img src="/images/slds/ch12/anaconda/anaconda-installer-end2.png" /></p>
<p><img src="/images/slds/ch12/anaconda/anaconda-installer-end3.png" /></p>
<p>インストールが完了したら,ターミナルを開き作業用フォルダに移動して,<code>pyenv versions</code> コマンドで<code>anaconda</code>がインストールされているか確認しましょう.</p>
<p><img src="/images/slds/ch12/anaconda/anaconda-pyenv.png" /></p>
<p>ローカル環境に<code>anaconda</code>を指定します.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pyenv</span> local anaconda</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pyenv</span> rehash</span></code></pre></div>
<p><code>anaconda</code>では<code>pip</code>ではなく<code>conda</code>を利用してライブラリをインストールします. まずは,<code>anaconda</code>自体を<code>update</code>しましょう.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> update <span class="at">-n</span> base <span class="at">-c</span> defaults conda</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Proceed</span> <span class="er">(</span><span class="ex">[y]/n</span><span class="kw">)</span><span class="ex">?</span> y</span></code></pre></div>
<p>が表示されたら, <code>y</code> を押して<code>Enter</code>します.</p>
<p>続いて<code>PyMC5</code>の公式サイトに従い,<code>anaconda</code>上で<code>PyMC5</code>をインストールします.
<code>pyenv</code>が既に仮想環境ですが,<code>conda create</code>コマンドによって <code>pymc</code>などがインストールされた<code>python</code>の仮想環境を更に構築します.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-c</span> conda-forge <span class="at">-n</span> pymc_env <span class="st">&quot;pymc&gt;=5&quot;</span></span></code></pre></div>
<p>入力後完了したら,仮想環境を有効化するためにterminalを一度初期化します.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> init powershell</span></code></pre></div>
<p>を入力し, <strong><code>Terminal</code>を閉じて再度作業ディレクトリに移動したあと</strong>に仮想環境を有効化する以下のコマンドを入力して下さい.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate pymc_env</span></code></pre></div>
<div class="warn">
<p>Macの場合は, このあと仮想環境をlocalに指定します.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pyenv</span> versions</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">system</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">3.12.3</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> anaconda3-2024.02-1</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">anaconda3-2024.02-1/envs/pymc_env</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> pyenv local anaconda3-2024.02-1/envs/pymc_env</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> pyenv local</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">anaconda3-2024.02-1/envs/pymc_env</span></span></code></pre></div>
</div>
<p>環境の確認をします.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Get-Command</span> python</span></code></pre></div>
<div class="warn">
<p><code>MacOS</code>の場合は, <code>witch python</code> コマンドです.</p>
</div>
<p>以下のように<code>pymc_env</code>内のpythonが表示されれば利用可能な状況になっています.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">CommandType</span>     Name                                               Version    Source</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-----------</span>     <span class="at">----</span>                                               <span class="at">-------</span>    <span class="at">------</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Application</span>     python.exe                                         3.11.14... C:<span class="dt">\U</span>sers<span class="dt">\a</span>kagi<span class="dt">\.</span>pyenv<span class="dt">\p</span>yenv-win<span class="dt">\v</span>ersions<span class="dt">\a</span>naconda<span class="dt">\e</span>nvs<span class="dt">\p</span>ymc_env<span class="dt">\p</span>ython.exe</span></code></pre></div>
<p>必要なライブラリをインストールします.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install seaborn scikit-learn statsmodels</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install <span class="at">-c</span> conda-forge compilers</span></code></pre></div>
<p>途中で,<code>Proceed ([y]/n)?</code> と表示されたら<code>y</code>と入力してENTERを押します.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Preparing</span> transaction: done</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Verifying</span> transaction: done</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Executing</span> transaction: done</span></code></pre></div>
<p>などが表示されれば,環境構築完了です.</p>
<p>以降,Terminalで作業ディレクトリに移動した後<code>conda activate pymc_env</code> でこの環境が利用できるようになります.</p>
<h1 data-number="5" id="pymc-実装"><span class="header-section-number">5</span> PyMC 実装</h1>
<p>コードが複雑になるため,先にコードの全体像を示した後, 個別に意味を解説します.
まずは,以下のコードを作業ディレクトリに配置した後,実行してみましょう.</p>
<div class="warn">
<p>最初の画像の保存先やデータの参照先は,環境に応じて変えて下さい.</p>
<p><code>save_dir = '/images/slds/ch12/'</code></p>
</div>
<div class="sourceCode" id="cb16"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphviz</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc <span class="im">import</span> model_to_graphviz</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score, mean_absolute_error</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm, rankdata</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>save_dir <span class="op">=</span> <span class="st">&#39;../../images/slds/ch12/&#39;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. データ読み込み</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(<span class="st">&#39;hierarchical_regression.csv&#39;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>                ,dtype<span class="op">=</span>{<span class="st">&#39;GPA&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Scholarship&#39;</span>: <span class="bu">bool</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Study_Hours&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Sports_hours&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Part_time_Work&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;StudentID&#39;</span>:<span class="bu">int</span>})</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 数量化</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.get_dummies(df, columns<span class="op">=</span>[<span class="st">&#39;Scholarship&#39;</span>], dtype<span class="op">=</span><span class="st">&#39;int&#39;</span>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#標準化</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>       ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>       ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>       ,<span class="st">&#39;Sports_hours&#39;</span>]] <span class="op">=</span> scaler.fit_transform(df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="st">&#39;Sports_hours&#39;</span>]])</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ２. 線形回帰</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 説明変数(X)と目的変数(y)に分割</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[[<span class="st">&#39;Scholarship_True&#39;</span>, <span class="st">&#39;Study_Hours&#39;</span>]]</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">&#39;GPA&#39;</span>]</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 切片(定数項)を追加</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    lm <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">[通常の線形回帰の結果]</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(lm.summary())</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    lm_preds <span class="op">=</span> lm.predict(X)</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&#39;GPA&#39;</span>], lm_preds, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">&quot;k&quot;</span>)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted&quot;</span>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Actual&quot;</span>)</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Actual vs. Predicted&quot;</span>)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    plt.plot([df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()], [df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()], color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linestyle<span class="op">=</span><span class="st">&quot;--&quot;</span>)  <span class="co"># 完全一致のライン</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    plt.grid()</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;lm.png&#39;</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(lm_preds, label <span class="op">=</span> <span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(df[<span class="st">&#39;GPA&#39;</span>], label <span class="op">=</span> <span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;Actual/Predicted&#39;</span>)</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;GPA&#39;</span>)</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;Density&#39;</span>)</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;lm_kde.png&#39;</span>)</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ３. 一般化線形モデル</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;student&quot;</span>: df[<span class="st">&quot;StudentID&quot;</span>].values,</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;obs_id&quot;</span>: np.arange(<span class="bu">len</span>(df))</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> model:</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>        st <span class="op">=</span> pm.Data(<span class="st">&quot;st&quot;</span>, df[<span class="st">&quot;Study_Hours&quot;</span>])</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ptw = pm.Data(&quot;ptw&quot;, df[&quot;Part_time_Work&quot;])</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>        ss <span class="op">=</span> pm.Data(<span class="st">&quot;ss&quot;</span>, df[<span class="st">&quot;Scholarship_True&quot;</span>])</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>        student_idx <span class="op">=</span> pm.Data(<span class="st">&quot;student_idx&quot;</span>, df[<span class="st">&quot;StudentID&quot;</span>])</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ランダム切片</span></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>        z_alpha <span class="op">=</span> pm.Normal(<span class="st">&quot;z_alpha&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">&quot;student&quot;</span>)</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>        mu_alpha <span class="op">=</span> pm.Normal(<span class="st">&quot;mu_alpha&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>        sigma_alpha <span class="op">=</span> pm.HalfNormal(<span class="st">&quot;sigma_alpha&quot;</span>, <span class="dv">1</span>)</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> pm.Deterministic(<span class="st">&quot;alpha&quot;</span>, mu_alpha <span class="op">+</span> sigma_alpha <span class="op">*</span> z_alpha, dims<span class="op">=</span><span class="st">&quot;student&quot;</span>)</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 勉強時間の効果</span></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>        beta_st <span class="op">=</span> pm.Normal(<span class="st">&quot;beta_st&quot;</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 奨学金の効果</span></span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>        beta_ss <span class="op">=</span> pm.Normal(<span class="st">&quot;beta_ss&quot;</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> alpha[student_idx] <span class="op">+</span> beta_st <span class="op">*</span> st <span class="op">+</span>  beta_ss <span class="op">*</span> ss</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">#sigma = pm.HalfNormal(&quot;sigma&quot;, 1)</span></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>        gpa_obs <span class="op">=</span> pm.Normal(<span class="st">&quot;GPA&quot;</span>,</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>                            mu<span class="op">=</span>mu,</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>                            sigma<span class="op">=</span>sigma,</span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>                            observed<span class="op">=</span>df[<span class="st">&quot;GPA&quot;</span>],</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>                            dims<span class="op">=</span><span class="st">&quot;obs_id&quot;</span></span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>        trace <span class="op">=</span> pm.sample(draws <span class="op">=</span><span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">2000</span>, chains<span class="op">=</span><span class="dv">4</span>, target_accept<span class="op">=</span><span class="fl">0.95</span>, return_inferencedata<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>        posterior_predictive <span class="op">=</span> pm.sample_posterior_predictive(trace)</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. モデル診断と可視化</span></span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> model_to_graphviz(model)</span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>    graph.render(filename<span class="op">=</span> save_dir <span class="op">+</span> <span class="st">&quot;hierarchical_bayes_model&quot;</span>, <span class="bu">format</span><span class="op">=</span><span class="st">&quot;pdf&quot;</span>)</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>    az.plot_trace(trace</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>                 ,var_names<span class="op">=</span>[<span class="st">&quot;sigma_alpha&quot;</span></span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>                            ,<span class="st">&quot;alpha&quot;</span></span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>                            ,<span class="st">&quot;beta_st&quot;</span></span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>                            ,<span class="st">&quot;beta_ss&quot;</span>])</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;trace.png&#39;</span>)</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(az.summary(trace</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>                    ,var_names<span class="op">=</span>[<span class="st">&quot;sigma_alpha&quot;</span></span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>                               ,<span class="st">&quot;alpha&quot;</span></span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>                               ,<span class="st">&quot;beta_st&quot;</span></span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>                               ,<span class="st">&quot;beta_ss&quot;</span>]))</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>    summary_df <span class="op">=</span> az.summary(trace</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>                           ,var_names<span class="op">=</span>[<span class="st">&quot;sigma_alpha&quot;</span></span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>                                      ,<span class="st">&quot;alpha&quot;</span></span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>                                      ,<span class="st">&quot;beta_st&quot;</span></span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>                                      ,<span class="st">&quot;beta_ss&quot;</span>])</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    summary_df.to_csv(<span class="st">&quot;bayesian_summary.csv&quot;</span></span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>                     ,encoding<span class="op">=</span><span class="st">&quot;utf-8-sig&quot;</span>)</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. 階層ベイズモデルによる予測精度評価</span></span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> trace.copy()</span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>    idata.extend(posterior_predictive)</span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>    az.plot_ppc(idata, data_pairs<span class="op">=</span>{<span class="st">&quot;GPA&quot;</span>: <span class="st">&quot;GPA&quot;</span>})</span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;ppc.png&#39;</span>)</span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------------------------------------------------</span></span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測値の可視化</span></span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------------------------------------------------</span></span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>    posterior_mean <span class="op">=</span> idata.posterior_predictive[<span class="st">&quot;GPA&quot;</span>].mean(dim<span class="op">=</span>(<span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>)).values</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>    bayes_rmse <span class="op">=</span> mean_squared_error(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean)</span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;[階層ベイズモデルのRMSE] </span><span class="sc">{</span>bayes_rmse<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">&quot;</span>)</span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 事後予測の平均（予測値）を取り出す</span></span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a>    posterior_mean <span class="op">=</span> idata.posterior_predictive[<span class="st">&quot;GPA&quot;</span>].mean(dim<span class="op">=</span>(<span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>)).values</span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># プロット</span></span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&#39;GPA&#39;</span>], posterior_mean, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">&quot;k&quot;</span>)</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted (Bayesian)&quot;</span>)</span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Actual GPA&quot;</span>)</span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Bayesian Actual vs. Predicted&quot;</span>)</span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>    plt.plot([df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()],</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a>             [df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()],</span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linestyle<span class="op">=</span><span class="st">&quot;--&quot;</span>, label<span class="op">=</span><span class="st">&quot;Perfect prediction&quot;</span>)</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a>    plt.grid()</span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;bayes.png&#39;</span>)</span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(posterior_mean, label <span class="op">=</span> <span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(df[<span class="st">&#39;GPA&#39;</span>], label <span class="op">=</span> <span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;Actual/Predicted&#39;</span>)</span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;GPA&#39;</span>)</span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;Density&#39;</span>)</span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;bayes_kde.png&#39;</span>)</span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------------------------------------------------</span></span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測範囲の可視化</span></span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------------------------------------------------------------------</span></span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x軸用の study_hours の範囲（100点）</span></span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a>    study_grid <span class="op">=</span> np.linspace(df[<span class="st">&quot;Study_Hours&quot;</span>].<span class="bu">min</span>(), df[<span class="st">&quot;Study_Hours&quot;</span>].<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金なしの予測</span></span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a>    predict_df_0 <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Study_Hours&quot;</span>: study_grid,</span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Scholarship_True&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;StudentID&quot;</span>: <span class="dv">0</span></span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金ありの予測</span></span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>    predict_df_1 <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Study_Hours&quot;</span>: study_grid,</span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Scholarship_True&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;StudentID&quot;</span>: <span class="dv">0</span></span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a>    <span class="co"># より簡単な方法：事後分布から直接予測</span></span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 事後分布のサンプルを取得（新しいAPIを使用）</span></span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>    posterior_samples <span class="op">=</span> az.extract(trace)</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測計算</span></span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">len</span>(posterior_samples.draw)</span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>    n_grid <span class="op">=</span> <span class="bu">len</span>(study_grid)</span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測値を格納する配列（奨学金なし・あり）</span></span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a>    predictions_0 <span class="op">=</span> np.zeros((n_samples, n_grid))</span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a>    predictions_1 <span class="op">=</span> np.zeros((n_samples, n_grid))</span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータを一度に取得</span></span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a>    mu_alpha_vals <span class="op">=</span> posterior_samples.mu_alpha.values</span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a>    sigma_alpha_vals <span class="op">=</span> posterior_samples.sigma_alpha.values</span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a>    z_alpha_vals <span class="op">=</span> posterior_samples.z_alpha.values  <span class="co"># 全学生のz_alpha    </span></span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a>    beta_st_vals <span class="op">=</span> posterior_samples.beta_st.values    </span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a>    beta_ss_vals <span class="op">=</span> posterior_samples.beta_ss.values</span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 各サンプルでのパラメータ（学生0の切片を計算）</span></span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a>        alpha_0 <span class="op">=</span> mu_alpha_vals[i] <span class="op">+</span> sigma_alpha_vals[i] <span class="op">*</span> z_alpha_vals[<span class="dv">0</span>, i]  <span class="co"># 学生0の切片</span></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 奨学金なしの予測値の計算</span></span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>        mu_pred_0 <span class="op">=</span> alpha_0 <span class="op">+</span> beta_st_vals[i] <span class="op">*</span> study_grid <span class="op">+</span> beta_ss_vals[i] <span class="op">*</span> predict_df_0[<span class="st">&quot;Scholarship_True&quot;</span>]</span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a>        predictions_0[i, :] <span class="op">=</span> np.random.normal(mu_pred_0, <span class="fl">0.3</span>)</span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 奨学金ありの予測値の計算</span></span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a>        mu_pred_1 <span class="op">=</span> alpha_0 <span class="op">+</span> beta_st_vals[i] <span class="op">*</span> study_grid <span class="op">+</span> beta_ss_vals[i] <span class="op">*</span> predict_df_1[<span class="st">&quot;Scholarship_True&quot;</span>]</span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a>        predictions_1[i, :] <span class="op">=</span> np.random.normal(mu_pred_1, <span class="fl">0.3</span>)</span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 平均と予測区間（94%）</span></span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a>    mean_pred_0 <span class="op">=</span> np.mean(predictions_0, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a>    lower_pred_0 <span class="op">=</span> np.percentile(predictions_0, <span class="dv">3</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a>    upper_pred_0 <span class="op">=</span> np.percentile(predictions_0, <span class="dv">97</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a>    mean_pred_1 <span class="op">=</span> np.mean(predictions_1, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a>    lower_pred_1 <span class="op">=</span> np.percentile(predictions_1, <span class="dv">3</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a>    upper_pred_1 <span class="op">=</span> np.percentile(predictions_1, <span class="dv">97</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 実データも合わせて表示（奨学金の有無で色分け）</span></span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金なしの予測線</span></span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a>    plt.plot(study_grid, mean_pred_0, color<span class="op">=</span><span class="st">&quot;blue&quot;</span>, label<span class="op">=</span><span class="st">&quot;Bayesian prediction (Scholarship=0)&quot;</span>)</span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(study_grid, lower_pred_0, upper_pred_0, color<span class="op">=</span><span class="st">&quot;blue&quot;</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">&quot;94% CI (Scholarship=0)&quot;</span>)</span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金ありの予測線</span></span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a>    plt.plot(study_grid, mean_pred_1, color<span class="op">=</span><span class="st">&quot;green&quot;</span>, label<span class="op">=</span><span class="st">&quot;Bayesian prediction (Scholarship=1)&quot;</span>)</span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(study_grid, lower_pred_1, upper_pred_1, color<span class="op">=</span><span class="st">&quot;green&quot;</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">&quot;94% CI (Scholarship=1)&quot;</span>)</span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金の有無で実測値を色分け</span></span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a>    scholarship_0 <span class="op">=</span> df[df[<span class="st">&quot;Scholarship_True&quot;</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a>    scholarship_1 <span class="op">=</span> df[df[<span class="st">&quot;Scholarship_True&quot;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a>    plt.scatter(scholarship_0[<span class="st">&quot;Study_Hours&quot;</span>], scholarship_0[<span class="st">&quot;GPA&quot;</span>], </span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">&quot;red&quot;</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&quot;Observed GPA (Scholarship=0)&quot;</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb16-271"><a href="#cb16-271" aria-hidden="true" tabindex="-1"></a>    plt.scatter(scholarship_1[<span class="st">&quot;Study_Hours&quot;</span>], scholarship_1[<span class="st">&quot;GPA&quot;</span>], </span>
<span id="cb16-272"><a href="#cb16-272" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">&quot;orange&quot;</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&quot;Observed GPA (Scholarship=1)&quot;</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb16-273"><a href="#cb16-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Study Hours&quot;</span>)</span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;GPA&quot;</span>)</span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Bayesian Regression Lines with 94% Prediction Intervals&quot;</span>)</span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&quot;bayes_prediction_band.png&quot;</span>)</span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7. 包括的な結果表示</span></span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータの解釈可能性を向上</span></span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">=== モデル結果の解釈 ===&quot;</span>)</span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;勉強時間の効果 (beta_st): </span><span class="sc">{</span>np<span class="sc">.</span>mean(beta_st_vals)<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>np<span class="sc">.</span>std(beta_st_vals)<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;奨学金の効果 (beta_ss): </span><span class="sc">{</span>np<span class="sc">.</span>mean(beta_ss_vals)<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>np<span class="sc">.</span>std(beta_ss_vals)<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;学生間のばらつき (sigma_alpha): </span><span class="sc">{</span>np<span class="sc">.</span>mean(sigma_alpha_vals)<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>np<span class="sc">.</span>std(sigma_alpha_vals)<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a>    <span class="co">## 効果量の計算</span></span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a>    effect_size_study <span class="op">=</span> np.mean(beta_st_vals) <span class="op">/</span> np.mean(sigma_alpha_vals)</span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a>    effect_size_scholarship <span class="op">=</span> np.mean(beta_ss_vals) <span class="op">/</span> np.mean(sigma_alpha_vals)</span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;勉強時間の標準化効果量: </span><span class="sc">{</span>effect_size_study<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;奨学金の標準化効果量: </span><span class="sc">{</span>effect_size_scholarship<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a>    <span class="co">## 予測精度の詳細評価</span></span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean)</span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean)</span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">=== 予測精度 ===&quot;</span>)</span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;R²: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;MAE: </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;RMSE: </span><span class="sc">{</span>bayes_rmse<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 階層効果の可視化</span></span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 学生別の切片分布</span></span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a>    alpha_means <span class="op">=</span> np.mean(posterior_samples.alpha.values, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a>    alpha_stds <span class="op">=</span> np.std(posterior_samples.alpha.values, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a>    plt.errorbar(<span class="bu">range</span>(<span class="bu">len</span>(alpha_means)), alpha_means, yerr<span class="op">=</span>alpha_stds, fmt<span class="op">=</span><span class="st">&#39;o&#39;</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Student ID&quot;</span>)</span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Random Intercept (α)&quot;</span>)</span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Student-specific Random Intercepts&quot;</span>)</span>
<span id="cb16-320"><a href="#cb16-320" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb16-321"><a href="#cb16-321" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータの事後分布</span></span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a>    plt.hist(beta_st_vals, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">&#39;Study Hours Effect&#39;</span>)</span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a>    plt.hist(beta_ss_vals, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">&#39;Scholarship Effect&#39;</span>)</span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Parameter Value&quot;</span>)</span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Frequency&quot;</span>)</span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Posterior Distributions of Effects&quot;</span>)</span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測精度の比較</span></span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb16-334"><a href="#cb16-334" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&#39;Bayesian&#39;</span>)</span>
<span id="cb16-335"><a href="#cb16-335" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&quot;GPA&quot;</span>], lm_preds, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&#39;Linear Regression&#39;</span>)</span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a>    plt.plot([df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">min</span>(), df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">max</span>()], </span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a>             [df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">min</span>(), df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">max</span>()], <span class="st">&#39;r--&#39;</span>, label<span class="op">=</span><span class="st">&#39;Perfect&#39;</span>)</span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Actual GPA&quot;</span>)</span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Predicted GPA&quot;</span>)</span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Prediction Accuracy Comparison&quot;</span>)</span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-344"><a href="#cb16-344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残差分析</span></span>
<span id="cb16-345"><a href="#cb16-345" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> df[<span class="st">&quot;GPA&quot;</span>] <span class="op">-</span> posterior_mean</span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a>    plt.scatter(posterior_mean, residuals, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a>    plt.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">&#39;r&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>)</span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted GPA&quot;</span>)</span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Residuals&quot;</span>)</span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Residual Plot&quot;</span>)</span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&quot;comprehensive_results.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">&#39;tight&#39;</span>)</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 結果の要約をCSVに保存</span></span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>    results_summary <span class="op">=</span> {</span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Metric&#39;</span>: [<span class="st">&#39;R²&#39;</span>, <span class="st">&#39;MAE&#39;</span>, <span class="st">&#39;RMSE&#39;</span>, <span class="st">&#39;Study_Effect_Mean&#39;</span>, <span class="st">&#39;Study_Effect_Std&#39;</span>, </span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&#39;Scholarship_Effect_Mean&#39;</span>, <span class="st">&#39;Scholarship_Effect_Std&#39;</span>, <span class="st">&#39;Student_Variability&#39;</span>],</span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Value&#39;</span>: [r2, mae, bayes_rmse, np.mean(beta_st_vals), np.std(beta_st_vals),</span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a>                 np.mean(beta_ss_vals), np.std(beta_ss_vals), np.mean(sigma_alpha_vals)]</span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results_summary)</span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>    results_df.to_csv(<span class="st">&quot;model_results_summary.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8-sig&#39;</span>)</span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>    <span class="op">~~~</span></span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a>以下, 個別の部分に関して確認していきます.</span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>特にモデルの設定部分に関して,モデルの定義との対応関係を確認するようにしましょう.</span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a><span class="co">## 事前準備</span></span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>まずは,ライブラリのインポート,データの読み込み,数量化,標準化などを実施します.</span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a><span class="op">~~~</span> py</span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphviz</span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc <span class="im">import</span> model_to_graphviz</span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score, mean_absolute_error</span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm, rankdata</span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>save_dir <span class="op">=</span> <span class="st">&#39;../../images/slds/ch12/&#39;</span></span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. データ読み込み</span></span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(<span class="st">&#39;hierarchical_regression.csv&#39;</span></span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a>                ,dtype<span class="op">=</span>{<span class="st">&#39;GPA&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Scholarship&#39;</span>: <span class="bu">bool</span></span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Study_Hours&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Sports_hours&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;Part_time_Work&#39;</span>: <span class="bu">float</span></span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>                       ,<span class="st">&#39;StudentID&#39;</span>:<span class="bu">int</span>})</span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 数量化</span></span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.get_dummies(df, columns<span class="op">=</span>[<span class="st">&#39;Scholarship&#39;</span>], dtype<span class="op">=</span><span class="st">&#39;int&#39;</span>)</span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a>    <span class="co">#標準化</span></span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a>    df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a>       ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a>       ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a>       ,<span class="st">&#39;Sports_hours&#39;</span>]] <span class="op">=</span> scaler.fit_transform(df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="st">&#39;Sports_hours&#39;</span>]])</span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ２. 線形回帰</span></span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---------------------------</span></span>
<span id="cb16-423"><a href="#cb16-423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-424"><a href="#cb16-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 説明変数(X)と目的変数(y)に分割</span></span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[[<span class="st">&#39;Scholarship_True&#39;</span>, <span class="st">&#39;Study_Hours&#39;</span>]]</span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">&#39;GPA&#39;</span>]</span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 切片(定数項)を追加</span></span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a>    lm <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">[通常の線形回帰の結果]</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(lm.summary())</span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a>    lm_preds <span class="op">=</span> lm.predict(X)</span></code></pre></div>
<div class="warn">
<ul>
<li><code>if __name__ == "__main__":</code> の必要性</li>
</ul>
<p>このコードブロックでは,メインの処理を<code>if __name__ == "__main__":</code>の下に記述しています. これは以下の理由から重要です:</p>
<ul>
<li><p><strong>モジュールとしてのインポートを防ぐ</strong>: スクリプトを他のファイルからインポートした場合に,メイン処理が自動的に実行されることを防ぎます.</p></li>
<li><p><strong>PyMCの並列処理との互換性</strong>: PyMCはMCMCサンプリング時に並列処理を行うため,<code>multiprocessing</code>モジュールを使用します. <code>multiprocessing</code>は各プロセスでスクリプトを再インポートするため,<code>if __name__ == "__main__":</code>がないと,無限再帰や予期しない動作が発生する可能性があります.</p></li>
<li><p><strong>Windowsでの実行保証</strong>: 特にWindows環境では,<code>multiprocessing</code>を使用する際に<code>if __name__ == "__main__":</code>が必須です. これがないとエラーが発生します.</p></li>
</ul>
<p>そのため,ベイズ統計モデリングを行う際は,必ずメイン処理を<code>if __name__ == "__main__":</code>の下に記述するようにしてください.</p>
<p>以降のコードは全て<code>if __name__ == "__main__":</code>の下でインデントされている前提となりますので注意して下さい.</p>
</div>
<h2 data-number="5.1" id="座標設定"><span class="header-section-number">5.1</span> 座標設定</h2>
<p>まず,<code>PyMC</code>でデータを処理するに当たって,<strong>座標(coordinates)</strong>を定義します.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;student&quot;</span>: df[<span class="st">&quot;StudentID&quot;</span>].values,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;obs_id&quot;</span>: np.arange(<span class="bu">len</span>(df))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<div class="warn">
<ul>
<li>座標(coordinates)の意味</li>
</ul>
<p><code>coords</code>は,<code>PyMC</code>で多次元データや階層モデルを扱う際に使用する座標系の定義です. この辞書は以下のような役割を持ちます:</p>
<ul>
<li><p><strong><code>"student"</code></strong>: 学生のIDを表す座標軸です. <code>df["StudentID"].values</code>により,各データポイントがどの学生に対応するかを定義します. これにより,ランダム切片<span class="math inline">\alpha_i</span>を学生ごとに定義できるようになります.</p></li>
<li><p><strong><code>"obs_id"</code></strong>: 観測値のIDを表す座標軸です. <code>np.arange(len(df))</code>により,各観測値に連番のIDを割り当てます. これにより,データの順序を保持し,各観測値に対応するパラメータや変数を定義できます.</p></li>
</ul>
<p>この座標系により,<code>PyMC</code>は学生ごとのパラメータ(<span class="math inline">\alpha_i</span>など)を適切に管理し,階層モデルを構築することができます.</p>
</div>
<h2 data-number="5.2" id="モデル構築"><span class="header-section-number">5.2</span> モデル構築</h2>
<p>次にモデルを構築していきます. 以下,モデル全体像で定義した各要素とPyMCコードの対応関係を示しながら説明します.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords<span class="op">=</span>coords) <span class="im">as</span> model:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>        st <span class="op">=</span> pm.Data(<span class="st">&quot;st&quot;</span>, df[<span class="st">&quot;Study_Hours&quot;</span>])</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ptw = pm.Data(&quot;ptw&quot;, df[&quot;Part_time_Work&quot;])</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        ss <span class="op">=</span> pm.Data(<span class="st">&quot;ss&quot;</span>, df[<span class="st">&quot;Scholarship_True&quot;</span>])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        student_idx <span class="op">=</span> pm.Data(<span class="st">&quot;student_idx&quot;</span>, df[<span class="st">&quot;StudentID&quot;</span>])</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">#ランダム切片</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        z_alpha <span class="op">=</span> pm.Normal(<span class="st">&quot;z_alpha&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">&quot;student&quot;</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        mu_alpha <span class="op">=</span> pm.Normal(<span class="st">&quot;mu_alpha&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        sigma_alpha <span class="op">=</span> pm.HalfNormal(<span class="st">&quot;sigma_alpha&quot;</span>, <span class="dv">1</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> pm.Deterministic(<span class="st">&quot;alpha&quot;</span>, mu_alpha <span class="op">+</span> sigma_alpha <span class="op">*</span> z_alpha, dims<span class="op">=</span><span class="st">&quot;student&quot;</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 勉強時間の効果</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        beta_st <span class="op">=</span> pm.Normal(<span class="st">&quot;beta_st&quot;</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 奨学金の効果</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        beta_ss <span class="op">=</span> pm.Normal(<span class="st">&quot;beta_ss&quot;</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> alpha[student_idx] <span class="op">+</span> beta_st <span class="op">*</span> st <span class="op">+</span>  beta_ss <span class="op">*</span> ss</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#sigma = pm.HalfNormal(&quot;sigma&quot;, 1)</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        gpa_obs <span class="op">=</span> pm.Normal(<span class="st">&quot;GPA&quot;</span>,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                            mu<span class="op">=</span>mu,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>                            sigma<span class="op">=</span>sigma,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                            observed<span class="op">=</span>df[<span class="st">&quot;GPA&quot;</span>],</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>                            dims<span class="op">=</span><span class="st">&quot;obs_id&quot;</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        trace <span class="op">=</span> pm.sample(draws <span class="op">=</span><span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">2000</span>, chains<span class="op">=</span><span class="dv">4</span>, target_accept<span class="op">=</span><span class="fl">0.95</span>, return_inferencedata<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        posterior_predictive <span class="op">=</span> pm.sample_posterior_predictive(trace)</span></code></pre></div>
<h3 data-number="5.2.1" id="モデル全体像との対応関係"><span class="header-section-number">5.2.1</span> モデル全体像との対応関係</h3>
<table>
<colgroup>
<col style="width: 41%" />
<col style="width: 37%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>モデル全体像</th>
<th>PyMCコード</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">y_i \sim N(\mu_i, \sigma^2)</span></td>
<td><code>gpa_obs = pm.Normal("GPA", mu=mu, sigma=sigma, observed=df["GPA"])</code></td>
<td>目的変数の分布</td>
</tr>
<tr class="even">
<td><span class="math inline">\mu_i = \alpha_i + \beta_{st} \cdot S_t + \beta_{ss} \cdot S_s</span></td>
<td><code>mu = alpha[student_idx] + beta_st * st + beta_ss * ss</code></td>
<td>線形予測子</td>
</tr>
<tr class="odd">
<td><span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span></td>
<td><code>alpha = pm.Deterministic(..., mu_alpha + sigma_alpha * z_alpha, dims="student")</code></td>
<td>ランダム切片</td>
</tr>
<tr class="even">
<td><span class="math inline">\mu_{\alpha} \sim N(0, 1)</span>, <span class="math inline">\sigma_{\alpha} \sim HN(1)</span></td>
<td><code>mu_alpha = pm.Normal(0, 1)</code>, <code>sigma_alpha = pm.HalfNormal(1)</code></td>
<td>超事前分布(α)</td>
</tr>
<tr class="odd">
<td><span class="math inline">\beta_{st} \sim N(0, 1)</span></td>
<td><code>beta_st = pm.Normal("beta_st", 0, 1)</code></td>
<td>勉強時間の効果(固定効果)</td>
</tr>
<tr class="even">
<td><span class="math inline">\beta_{ss} \sim N(0, 1)</span></td>
<td><code>beta_ss = pm.Normal("beta_ss", 0, 1)</code></td>
<td>奨学金の効果(固定効果)</td>
</tr>
</tbody>
</table>
<div class="note">
<ul>
<li><p>コードの詳細説明</p></li>
<li><p><strong>非中心パラメータ化</strong>: <code>alpha = mu_alpha + sigma_alpha * z_alpha</code>という形式は,<strong>非中心パラメータ化(non-centered parameterization)</strong>と呼ばれます. これにより,<span class="math inline">z_{\alpha} \sim N(0, 1)</span>から<span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>を生成します. この方法は,MCMCサンプリングの効率を向上させることがあります.</p></li>
<li><p><strong><code>dims="student"</code></strong>: ランダム切片<span class="math inline">\alpha_i</span>は学生ごとに異なるため,<code>dims="student"</code>を指定して学生の座標軸に沿って定義します.</p></li>
<li><p><strong><code>alpha[student_idx]</code></strong>: 各観測値に対応する学生の切片を取得します. <code>student_idx</code>は各観測値がどの学生に対応するかを示すインデックスです.</p></li>
<li><p><strong><code>beta_st</code>と<code>beta_ss</code>は固定効果</strong>: 現在のモデルでは,<code>beta_st</code>と<code>beta_ss</code>は学生間で同じ値を持つ固定効果として扱われています. これらは階層構造を持たず,直接<span class="math inline">N(0, 1)</span>の事前分布から推定されます.</p></li>
<li><p><strong><code>observed=df["GPA"]</code></strong>: 観測データを指定することで,尤度関数が定義されます.</p></li>
</ul>
</div>
<h2 data-number="5.3" id="mcmc"><span class="header-section-number">5.3</span> MCMC</h2>
<p>続いて,作成したモデルをMCMCによって,推定します.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MCMCサンプリングの実行</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>        trace <span class="op">=</span> pm.sample(draws <span class="op">=</span><span class="dv">2000</span>, tune<span class="op">=</span><span class="dv">2000</span>, chains<span class="op">=</span><span class="dv">4</span>, target_accept<span class="op">=</span><span class="fl">0.95</span>, return_inferencedata<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 事後予測分布のサンプリング</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        posterior_predictive <span class="op">=</span> pm.sample_posterior_predictive(trace)</span></code></pre></div>
<div class="note">
<ul>
<li>MCMCサンプリングの仕組み</li>
</ul>
<ol type="1">
<li><p><strong>初期値の設定</strong>: 各チェーンは異なる初期値から開始します.</p></li>
<li><p><strong>ウォームアップ期間</strong>: <code>tune</code>期間中,サンプラーはパラメータ空間を探索し,効率的なサンプリングのために調整されます.</p></li>
<li><p><strong>サンプリング期間</strong>: <code>draws</code>期間中,事後分布からサンプルを取得します. 各ステップで,現在のパラメータ値から新しい値を提案し,受容/棄却を決定します.</p></li>
<li><p><strong>収束の確認</strong>: 複数のチェーンが同じ分布に収束しているか確認します. これにより,サンプリングが適切に行われたかを診断できます.</p></li>
</ol>
<ul>
<li>MCMCサンプリングの基本概念</li>
</ul>
<p><strong><code>pm.sample()</code></strong>は,MCMCサンプリングを実行し,パラメータの事後分布を推定します. 各パラメータの意味は以下の通りです.</p>
<ul>
<li><p><strong><code>draws=2000</code></strong>: 各チェーンから取得するサンプル数です. この例では,各チェーンから2000個のサンプルを取得します. 合計では<code>chains × draws = 4 × 2000 = 8000</code>個のサンプルが得られます.</p></li>
<li><p><strong><code>tune=2000</code></strong>: <strong>バーンイン期間(burn-in period)</strong>または<strong>ウォームアップ期間</strong>です. この期間中に取得されたサンプルは破棄されます. MCMCは初期値から開始するため,初期のサンプルは事後分布に収束していない可能性があります. この期間でサンプラーが適切に動作するよう調整されます.</p></li>
<li><p><strong><code>chains=4</code></strong>: 並列に実行する<strong>マルコフ連鎖</strong>の数です. 複数のチェーンを実行することで,収束の診断が可能になります. 通常は4つのチェーンを使用し,それぞれ異なる初期値から開始します. すべてのチェーンが同じ分布に収束すれば,適切にサンプリングできていると判断できます.</p></li>
<li><p><strong><code>target_accept=0.95</code></strong>: サンプリングアルゴリズムの<strong>受容率(acceptance rate)</strong>の目標値です. NUTS(No-U-Turn Sampler)などの適応型MCMCアルゴリズムでは,この受容率を調整しながらサンプリングを行います. 0.95は高い受容率で,より効率的なサンプリングを目指します.</p></li>
<li><p><strong><code>return_inferencedata=True</code></strong>: 結果を<code>arviz</code>の<code>InferenceData</code>形式で返します. これにより,可視化や診断が容易になります.</p></li>
</ul>
<p><strong><code>pm.sample_posterior_predictive(trace)</code></strong>は,推定された事後分布から新しいデータを生成します. これにより,モデルの予測性能を評価したり,予測区間を計算したりできます.</p>
</div>
<p>上記のサンプリングを実行することで,標準出力に以下のような表示がなされます.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Initializing</span> NUTS using jitter+adapt_diag...</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Multiprocess</span> sampling <span class="er">(</span><span class="ex">4</span> chains in 2 jobs<span class="kw">)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">NUTS:</span> [z_alpha, mu_alpha, sigma_alpha, beta_st, beta_ss]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Progress</span>                                   Draws   Divergences   Step size   Grad evals   Sampling Speed   Elapsed   Remaining</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>   4000    0             0.205       15           326.43 draws/s   0:00:12   0:00:00</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>   4000    0             0.222       31           340.23 draws/s   0:00:11   0:00:00</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>   4000    0             0.203       15           151.86 draws/s   0:00:26   0:00:00</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>   4000    0             0.182       15           158.16 draws/s   0:00:25   0:00:00</span></code></pre></div>
<h4 data-number="5.3.0.1" id="標準出力の解説"><span class="header-section-number">5.3.0.1</span> 標準出力の解説</h4>
<p>この出力は,MCMCサンプリングの実行状況を示しています. 各項目の意味は以下の通りです:</p>
<ul>
<li><p><strong><code>Initializing NUTS using jitter+adapt_diag...</code></strong>: NUTS(No-U-Turn Sampler)アルゴリズムを初期化しています. <code>jitter+adapt_diag</code>は初期値の設定方法と,ステップサイズの調整方法を表します.</p></li>
<li><p><strong><code>Multiprocess sampling (4 chains in 2 jobs)</code></strong>: 4つのチェーンを2つの並列ジョブで実行しています. これにより,計算時間を短縮できます.</p></li>
<li><p><strong><code>NUTS: [z_alpha, mu_alpha, ...]</code></strong>: NUTSアルゴリズムでサンプリングするパラメータのリストです. モデルで定義したすべての確率変数が表示されます.</p></li>
</ul>
<p><img src="/images/slds/ch12/mcmc.png" /></p>
<div class="note">
<ul>
<li>NUTSアルゴリズム</li>
</ul>
<p><strong>NUTS(No-U-Turn Sampler)</strong>は,ハミルトニアンモンテカルロ法(HMC)の一種で,PyMCでは,デフォルトでNUTSアルゴリズムが使用されるため,ユーザーはアルゴリズムの詳細を意識せずに,効率的なベイズ推定を行うことができます.</p>
<p>通常のMCMCアルゴリズム(メトロポリス法など)と比べて以下の特徴があります.</p>
<p><strong>通常のMCMC(メトロポリス法など):</strong></p>
<ul>
<li><strong>ランダムウォーク</strong>: 現在のパラメータ値からランダムに近くの値を提案します.</li>
<li><strong>ステップサイズの固定</strong>: ステップサイズを手動で設定する必要があります.</li>
<li><strong>効率の低さ</strong>: パラメータ空間をゆっくりと探索するため,多くのサンプルが必要です.</li>
<li><strong>高次元での非効率</strong>: パラメータ数が増えると,探索が非常に非効率になります.</li>
</ul>
<p><strong>NUTSアルゴリズム:</strong></p>
<ul>
<li><strong>勾配情報の利用</strong>: 尤度関数の勾配(微分)を計算して,パラメータ空間を効率的に探索します.</li>
<li><strong>適応的ステップサイズ</strong>: ステップサイズを自動的に調整します. これにより,手動での調整が不要になります.</li>
<li><strong>長距離の移動</strong>: 1ステップでパラメータ空間を大きく移動できるため,少ないサンプル数で効率的に探索できます.</li>
<li><strong>「Uターン」の回避</strong>: パラメータ空間を探索する際に,同じ方向に戻ることを避けます. これが「No-U-Turn」という名前の由来です.</li>
<li><strong>高次元での効率</strong>: 高次元のパラメータ空間でも効率的にサンプリングできます.</li>
</ul>
<p><strong>実用的な利点:</strong></p>
<ul>
<li><strong>自動調整</strong>: ステップサイズやサンプリングパスの長さを自動的に調整するため,ユーザーが手動で調整する必要がありません.</li>
<li><strong>高速な収束</strong>: 通常のMCMCと比べて,より少ないサンプル数で収束に到達できます.</li>
<li><strong>複雑なモデルに対応</strong>: 階層ベイズモデルのような複雑なモデルでも,効率的にサンプリングできます.</li>
</ul>
</div>
<p>各行は1つのチェーンの進捗状況を表します(この例では4つのチェーンが表示されています). 各列の意味は以下の通りです:</p>
<ul>
<li><p><strong><code>Progress</code></strong>: サンプリングの進捗状況を視覚的に表示します. <code>━</code>が表示されるほど,サンプリングが進んでいます.</p></li>
<li><p><strong><code>Draws</code></strong>: 現在までに取得したサンプル数です. <code>tune + draws = 2000 + 2000 = 4000</code>となるため,合計4000ステップが実行されます.</p></li>
<li><p><strong><code>Divergences</code></strong>: <strong>発散(divergence)</strong>の発生回数です. 発散は,サンプラーがパラメータ空間の困難な領域に遭遇した際に発生します. 発散が多い場合(通常は100を超える場合),モデルやサンプリング設定を見直す必要があります. この例では,すべてのチェーンで発散が0回となっており,良好なサンプリングが行われていることを示しています. これは,非中心パラメータ化により,パラメータ間の相関が低減され,効率的なサンプリングが実現された結果です.</p></li>
<li><p><strong><code>Step size</code></strong>: サンプリングの<strong>ステップサイズ</strong>です. これが大きいほど,1ステップで大きくパラメータ空間を移動します. NUTSアルゴリズムは,このステップサイズを自動的に調整します. この例では,0.182-0.222の範囲で調整されており,適切なステップサイズでサンプリングが行われています. 値はチェーンごとに異なる場合があります.</p></li>
<li><p><strong><code>Grad evals</code></strong>: 1ステップあたりの<strong>勾配評価回数</strong>です. NUTSアルゴリズムは,尤度関数の勾配を計算して効率的にサンプリングします. この値が大きいほど,より多くの探索を行っていることを意味します. この例では,15-31回となっており,効率的な探索が行われています.</p></li>
<li><p><strong><code>Sampling Speed</code></strong>: サンプリングの速度(1秒あたりのサンプル数)です. この値が大きいほど,高速にサンプリングできます. モデルの複雑さやパラメータ数によって大きく変わります. この例では,151.86-340.23 draws/sとなっており,比較的高速にサンプリングが行われています.</p></li>
</ul>
<div class="warn">
<ul>
<li><strong>発散について:</strong></li>
</ul>
<p>発散が多く発生している場合は,モデル等がデータに上手く適合していない状況を表しています.
今回は実施しませんが,そのような場合には以下の対処によって,サンプリング手法やモデルを修正する必要があります.</p>
<ul>
<li>モデルの再パラメータ化(非中心パラメータ化の使用)</li>
<li><code>target_accept</code>の調整(通常は0.8-0.9が推奨される)</li>
<li>事前分布の見直し</li>
<li>データの再検討</li>
</ul>
<p>ただし,発散が少ない場合でも,以下で行うモデル診断(トレースプロット)で収束を確認することが重要です.</p>
</div>
<h2 data-number="5.4" id="モデル診断と可視化"><span class="header-section-number">5.4</span> モデル診断と可視化</h2>
<p>まずは作成したモデルを確認します.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> model_to_graphviz(model)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    graph.render(filename<span class="op">=</span> save_dir <span class="op">+</span> <span class="st">&quot;hierarchical_bayes_model&quot;</span>, <span class="bu">format</span><span class="op">=</span><span class="st">&quot;pdf&quot;</span>)</span></code></pre></div>
<p>上記のコードで,モデルの全体像がpdfファイルとして保存されます.</p>
<p><img src="/images/slds/ch12/hierarchical_bayes_model.png" /></p>
<p>論文等に掲載することもできるので,コードとの対応関係を確認しましょう.</p>
<p>続いて,モデルの診断結果を確認します. <code>az.plot_trace()</code>を用いることで,指定した変数のサンプリング過程を可視化することができます.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>    az.plot_trace(trace</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                 ,var_names<span class="op">=</span>[<span class="st">&quot;sigma_alpha&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                            ,<span class="st">&quot;alpha&quot;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                            ,<span class="st">&quot;beta_st&quot;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                            ,<span class="st">&quot;beta_ss&quot;</span>])</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;trace.png&#39;</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    plt.close()</span></code></pre></div>
<p><img src="/images/slds/ch12/trace.png" /></p>
<p>この図では,左側に4つのサンプルごとに推定された分布の計上,右側にトレースの過程が表示されています.</p>
<p><img src="/images/slds/ch12/sampling_image.png" /></p>
<p>大まかには,</p>
<ul>
<li>左側の分布が全てのサンプルで概ね同じ形状になっている</li>
<li>右側のトレースが一箇所に収束している</li>
</ul>
<p>ことから,概ね良好に推定できていることが分かります.</p>
<p>ただし,alphaに関しては学生別の分布が異なる色で表示されている点に注意して下さい.
学生それぞれの基礎学力の分布が異なっている様が表現されています.</p>
<p>グラフでは大まかな印象しかわからないので更に,<code>az.summary()</code>を利用してサンプリング結果を数値で確認してみます.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(az.summary(trace</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                    ,var_names<span class="op">=</span>[<span class="st">&quot;sigma_alpha&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                               ,<span class="st">&quot;alpha&quot;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                               ,<span class="st">&quot;beta_st&quot;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                               ,<span class="st">&quot;beta_ss&quot;</span>]))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    summary_df <span class="op">=</span> az.summary(trace</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                           ,var_names<span class="op">=</span>[<span class="st">&quot;sigma_alpha&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                                      ,<span class="st">&quot;alpha&quot;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                                      ,<span class="st">&quot;beta_st&quot;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                                      ,<span class="st">&quot;beta_ss&quot;</span>])</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    summary_df.to_csv(<span class="st">&quot;bayesian_summary.csv&quot;</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                     ,encoding<span class="op">=</span><span class="st">&quot;utf-8-sig&quot;</span>)</span></code></pre></div>
<p>結果は学生別のalphaが出力されており非常に長いため,抜粋したものが以下になります.</p>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 7%" />
<col style="width: 4%" />
<col style="width: 9%" />
<col style="width: 10%" />
<col style="width: 12%" />
<col style="width: 10%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="header">
<th>パラメータ</th>
<th>mean</th>
<th>sd</th>
<th>hdi_3%</th>
<th>hdi_97%</th>
<th>mcse_mean</th>
<th>mcse_sd</th>
<th>ess_bulk</th>
<th>ess_tail</th>
<th>r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sigma_alpha</td>
<td>0.586</td>
<td>0.039</td>
<td>0.514</td>
<td>0.659</td>
<td>0.001</td>
<td>0.001</td>
<td>2193</td>
<td>4123</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[0]</td>
<td>1.337</td>
<td>0.276</td>
<td>0.826</td>
<td>1.851</td>
<td>0.003</td>
<td>0.002</td>
<td>9277</td>
<td>5519</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[1]</td>
<td>2.23</td>
<td>0.272</td>
<td>1.725</td>
<td>2.759</td>
<td>0.003</td>
<td>0.002</td>
<td>9863</td>
<td>6118</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[2]</td>
<td>2.044</td>
<td>0.267</td>
<td>1.541</td>
<td>2.543</td>
<td>0.003</td>
<td>0.002</td>
<td>9771</td>
<td>5823</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[3]</td>
<td>2.177</td>
<td>0.278</td>
<td>1.644</td>
<td>2.683</td>
<td>0.003</td>
<td>0.002</td>
<td>6533</td>
<td>5528</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[4]</td>
<td>3.02</td>
<td>0.27</td>
<td>2.506</td>
<td>3.512</td>
<td>0.003</td>
<td>0.002</td>
<td>10929</td>
<td>6162</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[5]</td>
<td>1.543</td>
<td>0.276</td>
<td>1.036</td>
<td>2.054</td>
<td>0.003</td>
<td>0.002</td>
<td>9980</td>
<td>5880</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[6]</td>
<td>1.709</td>
<td>0.275</td>
<td>1.184</td>
<td>2.22</td>
<td>0.003</td>
<td>0.002</td>
<td>7096</td>
<td>4980</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[7]</td>
<td>2.535</td>
<td>0.273</td>
<td>1.985</td>
<td>3.023</td>
<td>0.003</td>
<td>0.002</td>
<td>8866</td>
<td>5628</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[8]</td>
<td>2.003</td>
<td>0.265</td>
<td>1.503</td>
<td>2.498</td>
<td>0.003</td>
<td>0.002</td>
<td>8334</td>
<td>6208</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[9]</td>
<td>2.783</td>
<td>0.27</td>
<td>2.247</td>
<td>3.267</td>
<td>0.003</td>
<td>0.002</td>
<td>8919</td>
<td>4931</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[10]</td>
<td>2.443</td>
<td>0.271</td>
<td>1.944</td>
<td>2.977</td>
<td>0.003</td>
<td>0.002</td>
<td>8207</td>
<td>5363</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[180]</td>
<td>1.205</td>
<td>0.283</td>
<td>0.666</td>
<td>1.724</td>
<td>0.003</td>
<td>0.002</td>
<td>8038</td>
<td>5827</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[181]</td>
<td>1.952</td>
<td>0.274</td>
<td>1.443</td>
<td>2.463</td>
<td>0.003</td>
<td>0.002</td>
<td>7932</td>
<td>6444</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[182]</td>
<td>2.039</td>
<td>0.272</td>
<td>1.529</td>
<td>2.552</td>
<td>0.003</td>
<td>0.002</td>
<td>9013</td>
<td>5407</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[183]</td>
<td>2.503</td>
<td>0.265</td>
<td>2.018</td>
<td>3.006</td>
<td>0.003</td>
<td>0.002</td>
<td>10853</td>
<td>6100</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[184]</td>
<td>2.017</td>
<td>0.277</td>
<td>1.481</td>
<td>2.519</td>
<td>0.003</td>
<td>0.002</td>
<td>6437</td>
<td>5893</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[185]</td>
<td>1.985</td>
<td>0.274</td>
<td>1.483</td>
<td>2.521</td>
<td>0.003</td>
<td>0.002</td>
<td>7264</td>
<td>6106</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[186]</td>
<td>1.729</td>
<td>0.279</td>
<td>1.198</td>
<td>2.251</td>
<td>0.003</td>
<td>0.002</td>
<td>8657</td>
<td>5455</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[187]</td>
<td>1.153</td>
<td>0.274</td>
<td>0.65</td>
<td>1.68</td>
<td>0.003</td>
<td>0.002</td>
<td>11005</td>
<td>5637</td>
<td>1</td>
</tr>
<tr class="odd">
<td>alpha[188]</td>
<td>2.412</td>
<td>0.272</td>
<td>1.898</td>
<td>2.918</td>
<td>0.003</td>
<td>0.002</td>
<td>7896</td>
<td>5719</td>
<td>1</td>
</tr>
<tr class="even">
<td>alpha[189]</td>
<td>2.093</td>
<td>0.269</td>
<td>1.588</td>
<td>2.6</td>
<td>0.003</td>
<td>0.002</td>
<td>7705</td>
<td>5726</td>
<td>1</td>
</tr>
<tr class="odd">
<td>beta_st</td>
<td>0.559</td>
<td>0.048</td>
<td>0.473</td>
<td>0.651</td>
<td>0.001</td>
<td>0.001</td>
<td>1889</td>
<td>3833</td>
<td>1</td>
</tr>
<tr class="even">
<td>beta_ss</td>
<td>0.139</td>
<td>0.048</td>
<td>0.044</td>
<td>0.225</td>
<td>0.001</td>
<td>0.001</td>
<td>1957</td>
<td>3460</td>
<td>1</td>
</tr>
</tbody>
</table>
<div class="note">
<ul>
<li>MCMCサンプリング統計量</li>
</ul>
<p>この表には,MCMCサンプリングの結果を要約する統計量が含まれています.</p>
<ul>
<li><p><strong><code>mean</code></strong>: 事後分布の<strong>平均値</strong>です. パラメータの点推定値として使用されます.</p></li>
<li><p><strong><code>sd</code></strong>: 事後分布の<strong>標準偏差</strong>です. パラメータの不確実性を表します.</p></li>
<li><p><strong><code>hdi_3%</code>, <code>hdi_97%</code></strong>: <strong>最高密度区間(Highest Density Interval, HDI)</strong>の下限と上限です. 事後分布の94%が含まれる区間を表します. これは信頼区間のような概念で,この区間内に真のパラメータ値が含まれる確率が高いことを示します.</p></li>
<li><p><strong><code>mcse_mean</code>, <code>mcse_sd</code></strong>: <strong>モンテカルロ標準誤差(Monte Carlo Standard Error)</strong>です. MCMCサンプリングによる推定の不確実性を表します. この値が小さいほど,推定が安定しています.</p></li>
<li><p><strong><code>ess_bulk</code>, <code>ess_tail</code></strong>: <strong>有効サンプルサイズ(Effective Sample Size, ESS)</strong>です. MCMCサンプルには自己相関があるため,実際に独立な情報を含むサンプル数を表します. <code>ess_bulk</code>は分布の中心部分,<code>ess_tail</code>は分布の尾部の有効サンプルサイズです. 通常,400以上であることが推奨されます.</p></li>
<li><p><strong><code>r_hat</code></strong>: <strong><span class="math inline">\hat{R}</span>統計量(Gelman-Rubin統計量)</strong>です. 複数のチェーンが同じ分布に収束しているかを示す指標です. 1.0に近いほど良好で,通常1.01以下が推奨されます. 1.01を超える場合は,サンプリングが不十分である可能性があります.</p></li>
</ul>
</div>
<p><strong>収束の診断:</strong>
- すべてのパラメータで<code>r_hat = 1.0</code>となっており,良好な収束を示しています. これは,4つのチェーンがすべて同じ分布に収束していることを意味します.</p>
<ul>
<li>有効サンプルサイズ(<code>ess_bulk</code>)は,すべてのパラメータで400を大きく超えており,サンプリングは適切に行われています. 特に,<code>alpha[i]</code>の多くは6000-11000の範囲で,非常に良好なサンプリングが行われています. <code>beta_st</code>と<code>beta_ss</code>は1889と1957となっており,やや低めですが,推奨値(400)を大きく上回っており,問題ありません.</li>
</ul>
<p><strong>パラメータの推定値:</strong></p>
<ul>
<li><p><strong><code>sigma_alpha = 0.586</code></strong>: 学生間の基礎学力のばらつきの標準偏差です. この値が大きいほど,学生間の学力差が大きいことを示します. HDI区間[0.514, 0.659]は比較的狭く,推定の不確実性は小さいです.</p></li>
<li><p><strong><code>alpha[i]</code></strong>: 各学生の基礎学力です. 例えば,<code>alpha[4] = 3.02</code>は,学生4の基礎学力が高いことを示しています. 一方,<code>alpha[187] = 1.153</code>は,学生187の基礎学力が低いことを示しています. 学生間で基礎学力に大きなばらつきがあることが分かります.</p></li>
<li><p><strong><code>beta_st = 0.559</code></strong>: 勉強時間の効果です. この値は正で,勉強時間が1単位増加すると,GPAが平均的に0.559増加することを示しています. HDI区間[0.473, 0.651]は0を含まないため,統計的に有意な正の効果があります. この区間は比較的狭く,推定の不確実性は小さいです.</p></li>
<li><p><strong><code>beta_ss = 0.139</code></strong>: 奨学金の効果です. この値も正で,奨学金を受給している学生のGPAが平均的に0.139高いことを示しています. HDI区間[0.044, 0.225]は0を含まないため,統計的に有意な正の効果があります. この区間も比較的狭く,推定の不確実性は小さいです.</p></li>
</ul>
<h2 data-number="5.5" id="結果の可視化"><span class="header-section-number">5.5</span> 結果の可視化</h2>
<p>続いて今回のモデルの説明能力について可視化していきます.</p>
<h3 data-number="5.5.1" id="事後予測チェックposterior-predictive-check-ppc"><span class="header-section-number">5.5.1</span> 事後予測チェック(Posterior Predictive Check, PPC)</h3>
<p><strong>事後予測チェック</strong>は,推定されたモデルが実際のデータをどれだけよく説明できるかを確認するための手法です. 具体的には,推定された事後分布から新しいデータを生成し,その分布が実際の観測データとどの程度一致しているかを可視化します.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> trace.copy()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    idata.extend(posterior_predictive)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    az.plot_ppc(idata, data_pairs<span class="op">=</span>{<span class="st">&quot;GPA&quot;</span>: <span class="st">&quot;GPA&quot;</span>})</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;ppc.png&#39;</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    plt.close()</span></code></pre></div>
<ul>
<li><code>idata.extend(posterior_predictive)</code>: 事後予測分布のサンプルを<code>InferenceData</code>オブジェクトに追加します.</li>
<li><code>az.plot_ppc()</code>: 事後予測チェックの可視化を行います. 観測データと事後予測分布を比較します.</li>
</ul>
<p><img src="/images/slds/ch12/ppc.png" /></p>
<p>この図は,観測データ(黒い実線)と事後予測分布(青い領域)を比較しています.</p>
<ul>
<li><strong>黒い実線</strong>: 実際に観測されたGPAデータの分布です.</li>
<li><strong>青い領域</strong>: 推定されたモデルから生成された事後予測分布です. 複数のサンプルから生成された分布の範囲を示しています.</li>
<li><strong>オレンジの実践</strong>: 青い実線の平均値</li>
</ul>
<p>観測データの分布が事後予測分布の範囲内(青い線の範囲)に収まっている場合,モデルはデータを適切に説明していると判断できます. 一方,観測データの分布が事後予測分布から大きく外れている場合,モデルの仮定や構造を見直す必要があります.</p>
<p>この例では,観測データの分布が事後予測分布の範囲内に収まっており,モデルがデータを適切に説明していることが確認できます.</p>
<h3 data-number="5.5.2" id="予測値の確認"><span class="header-section-number">5.5.2</span> 予測値の確認</h3>
<p>つぎに,線形回帰と同様に予測値と実測値の関係とkdeプロットを見てみましょう. まずは予測値を取り出します.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 事後予測分布から予測値(平均)を取り出す</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    posterior_mean <span class="op">=</span> idata.posterior_predictive[<span class="st">&quot;GPA&quot;</span>].mean(dim<span class="op">=</span>(<span class="st">&quot;chain&quot;</span>, <span class="st">&quot;draw&quot;</span>)).values</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RMSEを計算</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    bayes_rmse <span class="op">=</span> mean_squared_error(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;[階層ベイズモデルのRMSE] </span><span class="sc">{</span>bayes_rmse<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">&quot;</span>)</span></code></pre></div>
<ul>
<li><p><strong><code>idata.posterior_predictive["GPA"]</code></strong>: 事後予測分布から生成されたGPAのサンプルです. このデータは,複数のチェーン(<code>chain</code>)と複数のドロー(<code>draw</code>)から構成される多次元配列です.</p></li>
<li><p><strong><code>.mean(dim=("chain", "draw"))</code></strong>: すべてのチェーンとドローにわたって平均を計算します. これにより,各観測値について,事後予測分布の平均値(期待値)を取得できます. つまり,各学生のGPAについて,モデルが予測する平均的な値を計算しています.</p></li>
<li><p><strong><code>.values</code></strong>: <code>xarray</code>のデータ配列をNumPy配列に変換します. これにより,後続の計算や可視化で使用しやすくなります.</p></li>
<li><p><strong><code>mean_squared_error(df["GPA"], posterior_mean)</code></strong>: 実測値(<code>df["GPA"]</code>)と予測値(<code>posterior_mean</code>)の間の平均二乗誤差(RMSE)を計算します. この値が小さいほど,モデルの予測精度が高いことを示します.</p></li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># プロット</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&#39;GPA&#39;</span>], posterior_mean, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">&quot;k&quot;</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted (Bayesian)&quot;</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Actual GPA&quot;</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Bayesian Actual vs. Predicted&quot;</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    plt.plot([df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()],</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>             [df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">min</span>(), df[<span class="st">&#39;GPA&#39;</span>].<span class="bu">max</span>()],</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linestyle<span class="op">=</span><span class="st">&quot;--&quot;</span>, label<span class="op">=</span><span class="st">&quot;Perfect prediction&quot;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    plt.grid()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;bayes.png&#39;</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(posterior_mean, label <span class="op">=</span> <span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(df[<span class="st">&#39;GPA&#39;</span>], label <span class="op">=</span> <span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;Actual/Predicted&#39;</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;GPA&#39;</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;Density&#39;</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&#39;bayes_kde.png&#39;</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    plt.close()</span></code></pre></div>
<p><img src="/images/slds/ch12/bayes.png" />
<img src="/images/slds/ch12/bayes_kde.png" /></p>
<p>予測値,分布共に大幅に改善されていることが分かります.</p>
<h3 data-number="5.5.3" id="予測範囲の可視化"><span class="header-section-number">5.5.3</span> 予測範囲の可視化</h3>
<p>線形モデルとは異なり,分布を推定しているため,勉強時間と奨学金の有無によるGPAの予測値と,その不確実性(94%予測区間)を可視化することが可能です.
奨学金の有無で異なる予測線を描画し,モデルの説明能力を確認します.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x軸用の study_hours の範囲（100点）</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    study_grid <span class="op">=</span> np.linspace(df[<span class="st">&quot;Study_Hours&quot;</span>].<span class="bu">min</span>(), df[<span class="st">&quot;Study_Hours&quot;</span>].<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金なしの予測</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    predict_df_0 <span class="op">=</span> pd.DataFrame({</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Study_Hours&quot;</span>: study_grid,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Scholarship_True&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;StudentID&quot;</span>: <span class="dv">0</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金ありの予測</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    predict_df_1 <span class="op">=</span> pd.DataFrame({</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Study_Hours&quot;</span>: study_grid,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Scholarship_True&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;StudentID&quot;</span>: <span class="dv">0</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># より簡単な方法：事後分布から直接予測</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 事後分布のサンプルを取得（新しいAPIを使用）</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    posterior_samples <span class="op">=</span> az.extract(trace)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測計算</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">len</span>(posterior_samples.draw)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    n_grid <span class="op">=</span> <span class="bu">len</span>(study_grid)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測値を格納する配列（奨学金なし・あり）</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    predictions_0 <span class="op">=</span> np.zeros((n_samples, n_grid))</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    predictions_1 <span class="op">=</span> np.zeros((n_samples, n_grid))</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータを一度に取得</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    mu_alpha_vals <span class="op">=</span> posterior_samples.mu_alpha.values</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    sigma_alpha_vals <span class="op">=</span> posterior_samples.sigma_alpha.values</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    z_alpha_vals <span class="op">=</span> posterior_samples.z_alpha.values  <span class="co"># 全学生のz_alpha    </span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    beta_st_vals <span class="op">=</span> posterior_samples.beta_st.values    </span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    beta_ss_vals <span class="op">=</span> posterior_samples.beta_ss.values</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 各サンプルでのパラメータ（学生0の切片を計算）</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        alpha_0 <span class="op">=</span> mu_alpha_vals[i] <span class="op">+</span> sigma_alpha_vals[i] <span class="op">*</span> z_alpha_vals[<span class="dv">0</span>, i]  <span class="co"># 学生0の切片</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 奨学金なしの予測値の計算</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        mu_pred_0 <span class="op">=</span> alpha_0 <span class="op">+</span> beta_st_vals[i] <span class="op">*</span> study_grid <span class="op">+</span> beta_ss_vals[i] <span class="op">*</span> predict_df_0[<span class="st">&quot;Scholarship_True&quot;</span>]</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>        predictions_0[i, :] <span class="op">=</span> np.random.normal(mu_pred_0, <span class="fl">0.3</span>)</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 奨学金ありの予測値の計算</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>        mu_pred_1 <span class="op">=</span> alpha_0 <span class="op">+</span> beta_st_vals[i] <span class="op">*</span> study_grid <span class="op">+</span> beta_ss_vals[i] <span class="op">*</span> predict_df_1[<span class="st">&quot;Scholarship_True&quot;</span>]</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>        predictions_1[i, :] <span class="op">=</span> np.random.normal(mu_pred_1, <span class="fl">0.3</span>)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 平均と予測区間（94%）</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    mean_pred_0 <span class="op">=</span> np.mean(predictions_0, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    lower_pred_0 <span class="op">=</span> np.percentile(predictions_0, <span class="dv">3</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    upper_pred_0 <span class="op">=</span> np.percentile(predictions_0, <span class="dv">97</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    mean_pred_1 <span class="op">=</span> np.mean(predictions_1, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    lower_pred_1 <span class="op">=</span> np.percentile(predictions_1, <span class="dv">3</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    upper_pred_1 <span class="op">=</span> np.percentile(predictions_1, <span class="dv">97</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 実データも合わせて表示（奨学金の有無で色分け）</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金なしの予測線</span></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>    plt.plot(study_grid, mean_pred_0, color<span class="op">=</span><span class="st">&quot;blue&quot;</span>, label<span class="op">=</span><span class="st">&quot;Bayesian prediction (Scholarship=0)&quot;</span>)</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(study_grid, lower_pred_0, upper_pred_0, color<span class="op">=</span><span class="st">&quot;blue&quot;</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">&quot;94% CI (Scholarship=0)&quot;</span>)</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金ありの予測線</span></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>    plt.plot(study_grid, mean_pred_1, color<span class="op">=</span><span class="st">&quot;green&quot;</span>, label<span class="op">=</span><span class="st">&quot;Bayesian prediction (Scholarship=1)&quot;</span>)</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(study_grid, lower_pred_1, upper_pred_1, color<span class="op">=</span><span class="st">&quot;green&quot;</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">&quot;94% CI (Scholarship=1)&quot;</span>)</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 奨学金の有無で実測値を色分け</span></span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>    scholarship_0 <span class="op">=</span> df[df[<span class="st">&quot;Scholarship_True&quot;</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>    scholarship_1 <span class="op">=</span> df[df[<span class="st">&quot;Scholarship_True&quot;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>    plt.scatter(scholarship_0[<span class="st">&quot;Study_Hours&quot;</span>], scholarship_0[<span class="st">&quot;GPA&quot;</span>], </span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">&quot;red&quot;</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&quot;Observed GPA (Scholarship=0)&quot;</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>    plt.scatter(scholarship_1[<span class="st">&quot;Study_Hours&quot;</span>], scholarship_1[<span class="st">&quot;GPA&quot;</span>], </span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">&quot;orange&quot;</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&quot;Observed GPA (Scholarship=1)&quot;</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Study Hours&quot;</span>)</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;GPA&quot;</span>)</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Bayesian Regression Lines with 94% Prediction Intervals&quot;</span>)</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&quot;bayes_prediction_band.png&quot;</span>)</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>    plt.close()</span></code></pre></div>
<p><img src="/images/slds/ch12/bayes_prediction_band.png" /></p>
<p>予測区間内に実測値が多く含まれており,モデルがデータを適切に説明していることが確認できます.
また,奨学金ありのグループの予測線が上に位置しており,奨学金の正の効果が可視化されています.</p>
<h3 data-number="5.5.4" id="その他の可視化手法"><span class="header-section-number">5.5.4</span> その他の可視化手法</h3>
<p>最後にその他によく利用される手法として,ランダム切片の可視化手法として学生の個別の能力値の分布,推定された分布の可視化手法として各パラメータの推定された分布,Regidual Plotなどをまとめて掲載します. 論文執筆などの際には,必要なものをピックアップしてグラフ化しましょう.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータの解釈可能性を向上</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">=== モデル結果の解釈 ===&quot;</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;勉強時間の効果 (beta_st): </span><span class="sc">{</span>np<span class="sc">.</span>mean(beta_st_vals)<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>np<span class="sc">.</span>std(beta_st_vals)<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;奨学金の効果 (beta_ss): </span><span class="sc">{</span>np<span class="sc">.</span>mean(beta_ss_vals)<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>np<span class="sc">.</span>std(beta_ss_vals)<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;学生間のばらつき (sigma_alpha): </span><span class="sc">{</span>np<span class="sc">.</span>mean(sigma_alpha_vals)<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>np<span class="sc">.</span>std(sigma_alpha_vals)<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## 効果量の計算</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    effect_size_study <span class="op">=</span> np.mean(beta_st_vals) <span class="op">/</span> np.mean(sigma_alpha_vals)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    effect_size_scholarship <span class="op">=</span> np.mean(beta_ss_vals) <span class="op">/</span> np.mean(sigma_alpha_vals)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;勉強時間の標準化効果量: </span><span class="sc">{</span>effect_size_study<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;奨学金の標準化効果量: </span><span class="sc">{</span>effect_size_scholarship<span class="sc">:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">## 予測精度の詳細評価</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">=== 予測精度 ===&quot;</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;R²: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;MAE: </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;RMSE: </span><span class="sc">{</span>bayes_rmse<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 階層効果の可視化</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 学生別の切片分布</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    alpha_means <span class="op">=</span> np.mean(posterior_samples.alpha.values, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    alpha_stds <span class="op">=</span> np.std(posterior_samples.alpha.values, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    plt.errorbar(<span class="bu">range</span>(<span class="bu">len</span>(alpha_means)), alpha_means, yerr<span class="op">=</span>alpha_stds, fmt<span class="op">=</span><span class="st">&#39;o&#39;</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Student ID&quot;</span>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Random Intercept (α)&quot;</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Student-specific Random Intercepts&quot;</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータの事後分布</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    plt.hist(beta_st_vals, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">&#39;Study Hours Effect&#39;</span>)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    plt.hist(beta_ss_vals, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">&#39;Scholarship Effect&#39;</span>)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Parameter Value&quot;</span>)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Frequency&quot;</span>)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Posterior Distributions of Effects&quot;</span>)</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測精度の比較</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&quot;GPA&quot;</span>], posterior_mean, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&#39;Bayesian&#39;</span>)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    plt.scatter(df[<span class="st">&quot;GPA&quot;</span>], lm_preds, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">&#39;Linear Regression&#39;</span>)</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    plt.plot([df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">min</span>(), df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">max</span>()], </span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>             [df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">min</span>(), df[<span class="st">&quot;GPA&quot;</span>].<span class="bu">max</span>()], <span class="st">&#39;r--&#39;</span>, label<span class="op">=</span><span class="st">&#39;Perfect&#39;</span>)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Actual GPA&quot;</span>)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Predicted GPA&quot;</span>)</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Prediction Accuracy Comparison&quot;</span>)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残差分析</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> df[<span class="st">&quot;GPA&quot;</span>] <span class="op">-</span> posterior_mean</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    plt.scatter(posterior_mean, residuals, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    plt.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">&#39;r&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>)</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted GPA&quot;</span>)</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Residuals&quot;</span>)</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Residual Plot&quot;</span>)</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    plt.savefig(save_dir <span class="op">+</span> <span class="st">&quot;comprehensive_results.png&quot;</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">&#39;tight&#39;</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 結果の要約をCSVに保存</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>    results_summary <span class="op">=</span> {</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Metric&#39;</span>: [<span class="st">&#39;R²&#39;</span>, <span class="st">&#39;MAE&#39;</span>, <span class="st">&#39;RMSE&#39;</span>, <span class="st">&#39;Study_Effect_Mean&#39;</span>, <span class="st">&#39;Study_Effect_Std&#39;</span>, </span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&#39;Scholarship_Effect_Mean&#39;</span>, <span class="st">&#39;Scholarship_Effect_Std&#39;</span>, <span class="st">&#39;Student_Variability&#39;</span>],</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Value&#39;</span>: [r2, mae, bayes_rmse, np.mean(beta_st_vals), np.std(beta_st_vals),</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>                 np.mean(beta_ss_vals), np.std(beta_ss_vals), np.mean(sigma_alpha_vals)]</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results_summary)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>    results_df.to_csv(<span class="st">&quot;model_results_summary.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8-sig&#39;</span>)</span></code></pre></div>
<p><img src="/images/slds/ch12/comprehensive_results.png" /></p>
<h1 data-number="6" id="まとめ-線形回帰-vs-ベイズモデリング"><span class="header-section-number">6</span> まとめ (線形回帰 VS ベイズモデリング)</h1>
<p>この章では,線形回帰分析とベイズ統計モデリングの違い,および固定効果モデルとランダム効果モデル(階層ベイズ)の違いについて学びました. 以下に,これらの手法の比較と特徴をまとめます.</p>
<h2 data-number="6.1" id="線形回帰頻度主義と統計モデリングベイズ主義の比較"><span class="header-section-number">6.1</span> 線形回帰(頻度主義)と統計モデリング(ベイズ主義)の比較</h2>
<p>頻度主義的な線形回帰分析とベイズ主義的な統計モデリングには,以下のような根本的な違いがあります.</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 35%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th>比較項目</th>
<th>線形回帰(頻度主義)</th>
<th>統計モデリング(ベイズ主義)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>分布の使い方</strong></td>
<td>誤差のみが正規分布に従うと仮定<br><span class="math inline">\epsilon_i \sim N(0, \sigma^2)</span></td>
<td>出力もパラメータも分布として扱う<br><span class="math inline">y_i \sim N(\mu_i, \sigma^2)</span><br><span class="math inline">\theta \sim F</span> (パラメータの事前分布)</td>
</tr>
<tr class="even">
<td><strong>制約</strong></td>
<td>誤差のみに制約がある</td>
<td>パラメータにも制約がある</td>
</tr>
<tr class="odd">
<td><strong>推定方法</strong></td>
<td>最小二乗法</td>
<td>ベイズ更新(MCMCなど)</td>
</tr>
<tr class="even">
<td><strong>結果の解釈</strong></td>
<td>点推定と検定(区間推定)</td>
<td>事後分布に基づく不確実性の推定</td>
</tr>
</tbody>
</table>
<h3 data-number="6.1.1" id="詳細な説明"><span class="header-section-number">6.1.1</span> 詳細な説明</h3>
<p><strong>分布の使い方:</strong></p>
<p>頻度主義的な線形回帰では,誤差項<span class="math inline">\epsilon_i</span>のみが正規分布に従うと仮定します. パラメータ(<span class="math inline">\beta_0, \beta_1</span>など)は固定値として扱われ,分布を持ちません.</p>
<p>一方,ベイズ統計モデリングでは,出力変数<span class="math inline">y_i</span>だけでなく,パラメータ自体も確率分布として扱います. 事前分布を設定し,データを観測した後の事後分布を推定することで,パラメータの不確実性を表現できます.</p>
<p><strong>制約:</strong></p>
<p>線形回帰では,誤差項に対してのみ分布の仮定(正規分布,等分散性など)が課されます. パラメータには特別な制約はありません.</p>
<p>ベイズ統計モデリングでは,パラメータに対して事前分布を設定することで,パラメータの取りうる範囲や値に制約を課すことができます. これにより,データが少ない場合でも,事前の知識を活用した推定が可能になります.</p>
<p><strong>推定方法:</strong></p>
<p>線形回帰では,最小二乗法により誤差の二乗和を最小化するパラメータを求めます. この方法は解析的に解を求めることができ,計算が比較的簡単です.</p>
<p>ベイズ統計モデリングでは,ベイズの定理に基づいて事後分布を計算します. 複雑なモデルでは解析的に解を求めることが困難なため,MCMC(マルコフ連鎖モンテカルロ法)などの数値計算手法を用いて事後分布をサンプリングします.</p>
<p><strong>結果の解釈:</strong></p>
<p>線形回帰では,推定されたパラメータの点推定値と,その信頼区間や検定結果を解釈します. 結果は「パラメータの真の値はこの区間に含まれる確率が95%」という頻度主義的な解釈になります.</p>
<p>ベイズ統計モデリングでは,事後分布全体を解釈します. パラメータの不確実性を確率分布として表現できるため,「パラメータがこの値である確率が95%」という主観的な解釈が可能になります. また,予測区間の計算も容易で,予測の不確実性も表現できます.</p>
<h2 data-number="6.2" id="固定効果ダミー変数とランダム効果階層ベイズの比較"><span class="header-section-number">6.2</span> 固定効果(ダミー変数)とランダム効果(階層ベイズ)の比較</h2>
<p>個体差を考慮する際に,固定効果モデルとランダム効果モデルでは,推定方法や結果の解釈が大きく異なります.</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 38%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="header">
<th>比較項目</th>
<th>ダミー変数(固定効果)</th>
<th>ランダム効果(階層ベイズ)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>各個体の推定値</strong></td>
<td>各個体は独立に自由に推定される(制約なし)</td>
<td>分布からのサンプルとして推定される(制約あり)</td>
</tr>
<tr class="even">
<td><strong>パラメータ数</strong></td>
<td>個体数分のパラメータが必要</td>
<td>分布の平均と分散のみ(+個体ごとの潜在変数)</td>
</tr>
<tr class="odd">
<td><strong>新しい個体の予測</strong></td>
<td>不可能(その個体のダミーがないため)</td>
<td>可能(分布からのサンプルとして扱えるため)</td>
</tr>
<tr class="even">
<td><strong>過学習のリスク</strong></td>
<td>高い(特にデータが少ない個体で顕著)</td>
<td>縮小推定により抑制される</td>
</tr>
<tr class="odd">
<td><strong>モデルの柔軟性</strong></td>
<td>高すぎる(過剰適合の可能性)</td>
<td>適度に制約された柔軟性</td>
</tr>
</tbody>
</table>
<h3 data-number="6.2.1" id="詳細な説明-1"><span class="header-section-number">6.2.1</span> 詳細な説明</h3>
<p><strong>各個体の推定値:</strong></p>
<p>固定効果モデルでは,各個体(例:学生)に対して独立したパラメータ(例:切片<span class="math inline">\alpha_i</span>)を推定します. 各パラメータには特別な制約がなく,データから直接推定されます.</p>
<p>ランダム効果モデルでは,各個体のパラメータが,より大きな分布(例:<span class="math inline">\alpha_i \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>)からサンプリングされると仮定します. この仮定により,個体間で情報を共有し,より安定した推定が可能になります.</p>
<p><strong>パラメータ数:</strong></p>
<p>固定効果モデルでは,個体数<span class="math inline">N</span>に対して<span class="math inline">N</span>個のパラメータを推定する必要があります. 個体数が増えると,パラメータ数も線形に増加します.</p>
<p>ランダム効果モデルでは,分布のパラメータ(平均<span class="math inline">\mu_{\alpha}</span>と分散<span class="math inline">\sigma_{\alpha}^2</span>)のみを推定すればよく,個体数に関わらずパラメータ数は一定です. これにより,個体数が多くても効率的に推定できます.</p>
<p><strong>新しい個体の予測:</strong></p>
<p>固定効果モデルでは,モデルに含まれていない新しい個体に対して予測を行うことはできません. その個体のダミー変数が存在しないため,パラメータを推定できないからです.</p>
<p>ランダム効果モデルでは,新しい個体も既存の分布からサンプリングされると仮定することで,予測が可能です. 推定された分布<span class="math inline">N(\mu_{\alpha}, \sigma_{\alpha}^2)</span>に基づいて,新しい個体のパラメータを推定できます.</p>
<p><strong>過学習のリスク:</strong></p>
<p>固定効果モデルでは,特に各個体のデータが少ない場合,過学習が発生しやすくなります. 各パラメータが個別に推定されるため,データに過度に適合してしまいます.</p>
<p>ランダム効果モデルでは,「縮小推定(shrinkage estimation)」が働きます. 各個体の推定値が,全体の平均<span class="math inline">\mu_{\alpha}</span>に向かって「縮小」されるため,過学習が抑制されます. データが少ない個体でも,他の個体の情報を活用して安定した推定が可能になります.</p>
<p><strong>モデルの柔軟性:</strong></p>
<p>固定効果モデルは,各個体に対して完全に独立したパラメータを許容するため,非常に柔軟です. しかし,この柔軟性が過剰適合を引き起こす可能性があります.</p>
<p>ランダム効果モデルは,分布の仮定により適度に制約された柔軟性を持ちます. 個体間で情報を共有しながらも,個体差を適切に表現できます.</p>
<h2 data-number="6.3" id="まとめ"><span class="header-section-number">6.3</span> まとめ</h2>
<p>ベイズ統計モデリングは,パラメータの不確実性を表現し,事前知識を活用できる点で,頻度主義的な線形回帰を一般化した手法といえます. 特に,階層ベイズモデル(ランダム効果モデル)は,個体差を考慮しながらも,過学習を抑制し,新しいデータに対する予測も可能にする優れた手法です.</p>
<p>ただし,ベイズ統計モデリングは計算コストが高く,モデルの設定や事前分布の選択が結果に影響を与えるため,適切な知識と経験が必要です. 研究の目的やデータの特性に応じて,適切な手法を選択することが重要です.</p>
]]></description>
    <pubDate>Tue, 04 Nov 2025 00:00:00 UT</pubDate>
    <guid>/lectures/slds12.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>特別講義DS Ch17 時系列分析(執筆中)</title>
    <link>/lectures/slds17.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#時系列回帰" id="toc-時系列回帰"><span class="toc-section-number">1</span> 時系列回帰</a>
<ul>
<li><a href="#データの準備" id="toc-データの準備"><span class="toc-section-number">1.1</span> データの準備</a></li>
<li><a href="#古典的時系列解析" id="toc-古典的時系列解析"><span class="toc-section-number">1.2</span> 古典的時系列解析</a></li>
</ul></li>
</ul>
</div>
<h1 data-number="1" id="時系列回帰"><span class="header-section-number">1</span> 時系列回帰</h1>
<p>前の節で質的データの処理を扱ったように,データの分析ではデータの種類に応じて手法を選択する必要があります.</p>
<div class="note">
<ul>
<li><h2 id="代表的な時間に関するデータ">代表的な時間に関するデータ</h2></li>
<li><h2 id="点過程データ">点過程データ</h2></li>
</ul>
<p>データの発生時刻が記録されたデータを<strong>点過程(Point Process)データ</strong>と言います. 代表的なものに購入された商品に関して,購入時点の日付とともに記録した<strong>POS(Point of Sales)</strong>データなどがあります.</p>
<ul>
<li>コンビニPOSデータの例</li>
</ul>
<table>
<thead>
<tr class="header">
<th>商品名</th>
<th>単価 (円)</th>
<th>個数</th>
<th>購入日時</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>おにぎり</td>
<td>120</td>
<td>2</td>
<td>2024-10-01 08:15</td>
</tr>
<tr class="even">
<td>サンドイッチ</td>
<td>350</td>
<td>1</td>
<td>2024-10-01 12:30</td>
</tr>
<tr class="odd">
<td>ペットボトル水</td>
<td>100</td>
<td>3</td>
<td>2024-10-01 14:45</td>
</tr>
<tr class="even">
<td>カップラーメン</td>
<td>220</td>
<td>1</td>
<td>2024-10-02 11:00</td>
</tr>
<tr class="odd">
<td>チョコレート</td>
<td>150</td>
<td>2</td>
<td>2024-10-02 15:20</td>
</tr>
</tbody>
</table>
<ul>
<li><h2 id="時系列データ">時系列データ</h2></li>
</ul>
<p>決まった時間単位毎に観測項目を集計したデータ<strong>時系列(Time Series)データ</strong>といいます.</p>
<p>例えば, 上の点過程データを日毎,月ごとなど決まった時間単位で集計することで下のような時系列データとなります.</p>
<ul>
<li>日ごとに集計した時系列データの例</li>
</ul>
<table>
<thead>
<tr class="header">
<th>日付</th>
<th>売上合計 (円)</th>
<th>購入点数</th>
<th>購入回数</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-10-01</td>
<td>1060</td>
<td>6</td>
<td>3</td>
</tr>
<tr class="even">
<td>2024-10-02</td>
<td>520</td>
<td>3</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
<h2 data-number="1.1" id="データの準備"><span class="header-section-number">1.1</span> データの準備</h2>
<p>以下,時系列回帰などの練習用データを準備します.</p>
<p>今回は,実データとして千葉商科大学の電力データを利用し,電力消費量から曜日や祝日を予測/判別してみましょう. 千葉商科大学では, 自然エネルギー100%大学の取り組みに関連して使用したエネルギーを電力の種別ごとに計測しています.
今回は2021年5月の1号館の<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/energy_may_1.csv">データ</a>を利用してみます.</p>
<p>ダウンロードしたデータを作業ディレクトリのデータフォルダに配置したら,いくつかの前処理を施します.
まず, 元のデータを確認してみましょう.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&#39;./data/energy_may_1.csv&#39;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">                 Date  1-1L-1-1-1F西/1(照明):kWh  ...  1号館動力盤1_T相/76_T(その他動力):kWh  1-太陽光発電量/82(発電):kWh</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">0     2021/05/01 0:00                   0.000  ...                    1.605610                  0.0</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">1     2021/05/01 1:00                   0.000  ...                    1.555380                  0.0</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">2     2021/05/01 2:00                   0.000  ...                    1.617734                  0.0</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">3     2021/05/01 3:00                   0.000  ...                    1.612538                  0.0</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">4     2021/05/01 4:00                   0.000  ...                    1.569237                  0.0</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">..                ...                     ...  ...                         ...                  ...</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">739  2021/05/31 19:00                   0.175  ...                    1.978000                  0.0</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">740  2021/05/31 20:00                   0.115  ...                    1.844633                  0.0</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">741  2021/05/31 21:00                   0.000  ...                    1.806529                  0.0</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">742  2021/05/31 22:00                   0.000  ...                    1.811724                  0.0</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">743  2021/05/31 23:00                   0.000  ...                    1.872346                  0.0</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>データが読み込めたようなのでまずは,列の情報を編集してみましょう. CSVファイルのヘッダーを確認してみると以下のようになっています.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#列を確認する</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> <span class="bu">list</span>(df.columns)[<span class="dv">1</span>:] <span class="co">#Dateを除外</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>[<span class="bu">print</span>(c) <span class="cf">for</span> c <span class="kw">in</span> cols]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-1-1F西/1(照明):kWh</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-2-1F西/2(照明):kWh</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-3-1F西/3(照明):kWh</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-4-1F西/4(照明):kWh</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-5-1F西/5(照明):kWh</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-6-1F西/6(照明):kWh</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-7-1F～3Fロビー/7(照明):kWh</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-8-1F西/8(照明):kWh</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-9-1F西/9(照明):kWh</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-1-10-1F西/10(照明):kWh</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-11-1F東/11(照明):kWh</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-12-1F東/12(照明):kWh</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-13-1F東/13(照明):kWh</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-14-1F東/14(照明):kWh</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-15-1F東/15(照明):kWh</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-16-1F東/16(照明):kWh</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-2-17-1F東/17(照明):kWh</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-11-18-1101教室/18(照明):kWh</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-11-19-1101教室/19(照明):kWh</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-11-20-1101教室/20(照明):kWh</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-11-21-1101教室/21(照明):kWh</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-11-22-1101教室/22(照明):kWh</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-11-23-1101教室/23(照明):kWh</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-12-24-1102教室/24(照明):kWh</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-12-25-1102教室/25(照明):kWh</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-13-26-1103教室/26(照明):kWh</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-13-27-1103教室/27(照明):kWh</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-14-28-1104教室/28(照明):kWh</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-14-29-1104教室/29(照明):kWh</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-14-30-1104教室/30(照明):kWh</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-14-31-1104教室/31(照明):kWh</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-14-32-1104教室/32(照明):kWh</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co">1-1L-14-33-1104教室/33(照明):kWh</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-34-2F西/34(照明):kWh</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-35-2F西/35(照明):kWh</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-36-2F西/36(照明):kWh</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-37-2F西/37(照明):kWh</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-38-2F西 1201共同研究室1_2照明/38(照明):kWh</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-39-2F西/39(照明):kWh</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-40-2F西/40(照明):kWh</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-1-41-2F西 共同研究室3～6照明/41(照明):kWh</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-42-2F東/42(照明):kWh</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-43-2F東/43(照明):kWh</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-44-2F東/44(照明):kWh</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-45-1202～1204照明/45(照明):kWh</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-46-2F東/46(照明):kWh</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-47-2F東/47(照明):kWh</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-2-48-1205～1207照明/48(照明):kWh</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-H-49-1208教室/49(照明):kWh</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-I-50-1209教室/50(照明):kWh</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-J-51-1210教室/51(照明):kWh</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-K-52-1211教室/52(照明):kWh</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="co">1-2L-L-53-1212教室/53(照明):kWh</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-54-3F東/54(照明):kWh</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-55-3F東/55(照明):kWh</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-56-3F東 ラボスクウェア1_2照明/56(照明):kWh</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-57 共同研究室7～9/57(照明):kWh</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-58 ラボスクウェア1_2照明/58(照明):kWh</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-59 3F東/59(照明):kWh</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-60 3F東/60(照明):kWh</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-1-61 共同研究室10～12/61(照明):kWh</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-62 3F西/62(照明):kWh</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-63 3F西/63(照明):kWh</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-64 3F西 ラボスクウェア3_4照明/64(照明):kWh</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-65 3F西/65(照明):kWh</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-66 共同研究室13西照明/66(照明):kWh</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-67 ラボスクウェア3_4照明/67(照明):kWh</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-68 3F西/68(照明):kWh</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-69 3F西/69(照明):kWh</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-70 3F西/70(照明):kWh</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="co">1-3L-2-71 3F西 共同研究室13東照明/71(照明):kWh</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a><span class="co">1号館電灯盤1_R相/73(主幹):kWh</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a><span class="co">1号館電灯盤2_R相/74(主幹):kWh</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a><span class="co">1号館電灯盤3_R相/75(主幹):kWh</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a><span class="co">1号館動力盤1_R相/76(その他動力):kWh</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="co">1-GHP-77/77GHP(空調熱源):m3</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="co">1号館電灯盤1_T相/73_T(照明等その他):kWh</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a><span class="co">1号館電灯盤2_T相/74_T(照明等その他):kWh</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="co">1号館電灯盤3_T相/75_T(照明等その他):kWh</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="co">1号館動力盤1_T相/76_T(その他動力):kWh</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a><span class="co">1-太陽光発電量/82(発電):kWh</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co">#利用対象部分の抽出</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(<span class="bu">set</span>([c[c.find(<span class="st">&#39;(&#39;</span>) : c.find(<span class="st">&#39;)&#39;</span>)<span class="op">+</span><span class="dv">1</span>] <span class="cf">for</span> c <span class="kw">in</span> cols])))</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt; [&#39;(発電)&#39;, &#39;(照明)&#39;, &#39;(空調熱源)&#39;, &#39;(照明等その他)&#39;, &#39;(その他動力)&#39;, &#39;(主幹)&#39;]</span></span></code></pre></div>
<p>このデータでは1号館を｢1F西/1,1F西/2｣など分電盤毎に分割し,かつ電力の利用対象を｢照明,主幹,空調熱源,照明等その他,その他動力,発電｣の5種類に分けて記録しています. このうち｢照明等その他｣はコンセントなどの電源の利用を表しています.
この分類は分析の練習用としては細かすぎるので,｢照明,電源,動力,空調｣の4つにまとめてみます.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 列の整形</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 場所は無視して,照明(Lighting),電源(Others),動力(Power),空調(Air),だけに分ける</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># &#39;照明&#39;を含む列の抽出</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Lighting&#39;</span>] <span class="op">=</span> <span class="bu">sum</span>([df[x] <span class="cf">for</span> x <span class="kw">in</span> df.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">&#39;(照明)&#39;</span>).columns])</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># &#39;&#39;を含む列の抽出</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Others&#39;</span>] <span class="op">=</span> <span class="bu">sum</span>([df[x] <span class="cf">for</span> x <span class="kw">in</span> df.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">&#39;(照明等その他)&#39;</span>).columns])</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># &#39;動力&#39;を含む列の抽出</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Power&#39;</span>] <span class="op">=</span> <span class="bu">sum</span>([df[x] <span class="cf">for</span> x <span class="kw">in</span> df.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">&#39;(その他動力)&#39;</span>).columns])</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ‘空調&#39;を含む列の抽出</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Air&#39;</span>] <span class="op">=</span> <span class="bu">sum</span>([df[x] <span class="cf">for</span> x <span class="kw">in</span> df.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">&#39;(空調熱源)&#39;</span>).columns])</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 結合した列以外を削除</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">&#39;Date&#39;</span>,<span class="st">&#39;Lighting&#39;</span>, <span class="st">&#39;Others&#39;</span>, <span class="st">&#39;Power&#39;</span>, <span class="st">&#39;Air&#39;</span>]]</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># totalを追加</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Total&#39;</span>] <span class="op">=</span> <span class="bu">sum</span>(df[x] <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">&#39;Lighting&#39;</span>, <span class="st">&#39;Others&#39;</span>, <span class="st">&#39;Power&#39;</span>, <span class="st">&#39;Air&#39;</span>])</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">                 Date  Lighting  Others     Power  Air      Total</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">0     2021/05/01 0:00     0.000   6.518  2.876935    0   9.394935</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">1     2021/05/01 1:00     0.000   6.490  2.835366    0   9.325366</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">2     2021/05/01 2:00     0.000   6.558  2.982589    0   9.540589</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">3     2021/05/01 3:00     0.000   6.444  2.932360    0   9.376360</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">4     2021/05/01 4:00     0.000   6.724  2.864810    0   9.588810</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">..                ...       ...     ...       ...  ...        ...</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">739  2021/05/31 19:00     6.773  10.792  3.574950    0  21.139950</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">740  2021/05/31 20:00     3.743   8.120  3.257986    0  15.120986</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">741  2021/05/31 21:00     0.118   6.636  3.230273    0   9.984273</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">742  2021/05/31 22:00     0.000   6.148  3.083049    0   9.231049</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">743  2021/05/31 23:00     0.000   6.854  3.183508    0  10.037508</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>一般的に,大学のイベントは時間割に沿って行われるため,電気使用量は曜日によって異なります.
そこで,曜日や祝日の情報を追加して情報量を増やしてみましょう.
<code>datetime</code>型は,<code>.weekday</code>属性で曜日が取得できます. <code>.weekday</code>は<code>0</code>が<code>月曜日</code>,<code>6</code>が<code>日曜日</code>の数値で返ってくるので,分かりやすく文字列に変更します.
また,土日を<code>Holiday</code>列で1とする,<code>Holiday</code>フラグも作成します.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 曜日の取得</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;曜日の取得&#39;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime <span class="im">as</span> dt</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 日付をインデックスに変更</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.index) <span class="co">#現在は,行数がインデックスになっている</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># RangeIndex(start=0, stop=744, step=1)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;-&#39;</span><span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#indexを日付に変更</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>df.set_index(<span class="st">&#39;Date&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.index) <span class="co"># インデックスが変更できたことが確認できる</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">Index([&#39;2021/05/01 0:00&#39;, &#39;2021/05/01 1:00&#39;, &#39;2021/05/01 2:00&#39;,</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/01 3:00&#39;, &#39;2021/05/01 4:00&#39;, &#39;2021/05/01 5:00&#39;,</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/01 6:00&#39;, &#39;2021/05/01 7:00&#39;, &#39;2021/05/01 8:00&#39;,</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/01 9:00&#39;,</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">       ...</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/31 14:00&#39;, &#39;2021/05/31 15:00&#39;, &#39;2021/05/31 16:00&#39;,</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/31 17:00&#39;, &#39;2021/05/31 18:00&#39;, &#39;2021/05/31 19:00&#39;,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/31 20:00&#39;, &#39;2021/05/31 21:00&#39;, &#39;2021/05/31 22:00&#39;,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;2021/05/31 23:00&#39;],</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">      dtype=&#39;object&#39;, name=&#39;Date&#39;, length=744)</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;-&#39;</span><span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 現在は日付と時間がただの文字列なので,datatime型に変換する</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>df.index <span class="op">=</span> pd.to_datetime(df.index)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.index)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co">DatetimeIndex([&#39;2021-05-01 00:00:00&#39;, &#39;2021-05-01 01:00:00&#39;,</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-01 02:00:00&#39;, &#39;2021-05-01 03:00:00&#39;,</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-01 04:00:00&#39;, &#39;2021-05-01 05:00:00&#39;,</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-01 06:00:00&#39;, &#39;2021-05-01 07:00:00&#39;,</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-01 08:00:00&#39;, &#39;2021-05-01 09:00:00&#39;,</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">               ...</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-31 14:00:00&#39;, &#39;2021-05-31 15:00:00&#39;,</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-31 16:00:00&#39;, &#39;2021-05-31 17:00:00&#39;,</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-31 18:00:00&#39;, &#39;2021-05-31 19:00:00&#39;,</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-31 20:00:00&#39;, &#39;2021-05-31 21:00:00&#39;,</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">               &#39;2021-05-31 22:00:00&#39;, &#39;2021-05-31 23:00:00&#39;],</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">              dtype=&#39;datetime64[ns]&#39;, name=&#39;Date&#39;, length=744, freq=None)</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;-&#39;</span><span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 曜日を入れる</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;weekday&#39;</span>] <span class="op">=</span> df.index.weekday</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>dayOfWeek <span class="op">=</span> { <span class="dv">0</span>:<span class="st">&#39;Mon&#39;</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            , <span class="dv">1</span>:<span class="st">&#39;Tue&#39;</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            , <span class="dv">2</span>:<span class="st">&#39;Wed&#39;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>            , <span class="dv">3</span>:<span class="st">&#39;Thu&#39;</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            , <span class="dv">4</span>:<span class="st">&#39;Fri&#39;</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            , <span class="dv">5</span>:<span class="st">&#39;Sat&#39;</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            , <span class="dv">6</span>:<span class="st">&#39;Sun&#39;</span>}</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;weekday&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;weekday&#39;</span>].<span class="bu">map</span>(dayOfWeek)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 曜日を平日かどうかで分ける</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Holiday&#39;</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> df.index:</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;Sat&#39;</span> <span class="op">==</span> df.at[i,<span class="st">&#39;weekday&#39;</span>]:</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        df.at[i,<span class="st">&#39;Holiday&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">&#39;Sun&#39;</span> <span class="op">==</span> df.at[i,<span class="st">&#39;weekday&#39;</span>]:</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        df.at[i,<span class="st">&#39;Holiday&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        df.at[i,<span class="st">&#39;Holiday&#39;</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co">                     Lighting  Others     Power  Air      Total weekday  Holiday</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="co">Date</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 00:00:00     0.000   6.518  2.876935    0   9.394935     Sat        1</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 01:00:00     0.000   6.490  2.835366    0   9.325366     Sat        1</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 02:00:00     0.000   6.558  2.982589    0   9.540589     Sat        1</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 03:00:00     0.000   6.444  2.932360    0   9.376360     Sat        1</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 04:00:00     0.000   6.724  2.864810    0   9.588810     Sat        1</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="co">...                       ...     ...       ...  ...        ...     ...      ...</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 19:00:00     6.773  10.792  3.574950    0  21.139950     Mon        0</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 20:00:00     3.743   8.120  3.257986    0  15.120986     Mon        0</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 21:00:00     0.118   6.636  3.230273    0   9.984273     Mon        0</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 22:00:00     0.000   6.148  3.083049    0   9.231049     Mon        0</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 23:00:00     0.000   6.854  3.183508    0  10.037508     Mon        0</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>1日の中でも授業時間とそうでない時間によって,消費電力の傾向は異なりそうです. 授業時間割を授業前(before_class),1~5時限,昼休み(break),授業後(after_class)として設定してみましょう.</p>
<p>ここまでの作業ができたら,<code>energy_may_hour.csv</code>として保存してみます.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#授業時間割の情報を追加する</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#2020年から</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#https://www.cuc.ac.jp/dpt_grad_sch/graduate_sch/accounting/hours/index.html</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#1時限    9:00～10:45</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#2時限    10:55～12:40</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#昼休み   12:40～13:30</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#3時限    13:30～15:15</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#4時限    15:25～17:10</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#5時限    17:20～19:05</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> time2CTime(x):</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>  <span class="dv">9</span> <span class="op">&lt;=</span> x.hour <span class="op">&lt;=</span> <span class="dv">11</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;1&#39;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">11</span> <span class="op">&lt;</span> x.hour <span class="op">&lt;=</span> <span class="dv">12</span>:</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;2&#39;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">12</span> <span class="op">&lt;</span> x.hour <span class="op">&lt;=</span> <span class="dv">13</span>:</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;break&#39;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">13</span> <span class="op">&lt;</span> x.hour <span class="op">&lt;=</span> <span class="dv">15</span>:</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;3&#39;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">15</span> <span class="op">&lt;</span> x.hour <span class="op">&lt;=</span> <span class="dv">17</span>:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;4&#39;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">17</span> <span class="op">&lt;</span> x.hour <span class="op">&lt;=</span> <span class="dv">20</span>:</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;5&#39;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;after_class&#39;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;period&#39;</span>] <span class="op">=</span> df.index.<span class="bu">map</span>(<span class="kw">lambda</span> x : time2CTime(x))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co">                     Lighting  Others     Power  Air      Total weekday  Holiday       period</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co">Date</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 00:00:00     0.000   6.518  2.876935    0   9.394935     Sat        1  after_class</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 01:00:00     0.000   6.490  2.835366    0   9.325366     Sat        1  after_class</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 02:00:00     0.000   6.558  2.982589    0   9.540589     Sat        1  after_class</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 03:00:00     0.000   6.444  2.932360    0   9.376360     Sat        1  after_class</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01 04:00:00     0.000   6.724  2.864810    0   9.588810     Sat        1  after_class</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co">...                       ...     ...       ...  ...        ...     ...      ...          ...</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 19:00:00     6.773  10.792  3.574950    0  21.139950     Mon        0            5</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 20:00:00     3.743   8.120  3.257986    0  15.120986     Mon        0            5</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 21:00:00     0.118   6.636  3.230273    0   9.984273     Mon        0  after_class</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 22:00:00     0.000   6.148  3.083049    0   9.231049     Mon        0  after_class</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31 23:00:00     0.000   6.854  3.183508    0  10.037508     Mon        0  after_class</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="co">#保存</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">&#39;data/energy_may_hour.csv&#39;</span>,encoding<span class="op">=</span><span class="st">&#39;utf-8-sig&#39;</span>)</span></code></pre></div>
<p>今回は1時間毎に集計したデータを時系列分析に用いますが,次の章などで日ごとに集計したデータを利用するので,日毎の集計データも作成しておきましょう.
<code>datetime</code>型では<code>date</code>によって日付が取得できます.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1時間ごとになっているので,一日ごとに集約</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Day&#39;</span>] <span class="op">=</span> df.index.date</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.set_index(df.index.date) <span class="co"># 時間の部分を削除</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">            Lighting  Others     Power  Air      Total         Day</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01     0.000   6.518  2.876935    0   9.394935  2021-05-01</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01     0.000   6.490  2.835366    0   9.325366  2021-05-01</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01     0.000   6.558  2.982589    0   9.540589  2021-05-01</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01     0.000   6.444  2.932360    0   9.376360  2021-05-01</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01     0.000   6.724  2.864810    0   9.588810  2021-05-01</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">...              ...     ...       ...  ...        ...         ...</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31     6.773  10.792  3.574950    0  21.139950  2021-05-31</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31     3.743   8.120  3.257986    0  15.120986  2021-05-31</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31     0.118   6.636  3.230273    0   9.984273  2021-05-31</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31     0.000   6.148  3.083049    0   9.231049  2021-05-31</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31     0.000   6.854  3.183508    0  10.037508  2021-05-31</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">[744 rows x 6 columns]</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>同じ日付によってまとめて集計するような作業は<code>for</code>文などでもできますが,<code>pandas</code>の<code>groupby</code>メソッドが便利です. <code>groupby('列名')</code>で指定した列名の同じデータごとにデータを区切ってくれます.</p>
<p>更に, <code>.agg({'列名':'処理方法'})</code>を追記することでグループごとにデータを集計します.</p>
<p>処理方法は文字列で指定し, <code>sum</code>(合計),<code>mean</code>(平均),<code>first</code>(最初の値)などが利用できます.</p>
<p>集計したデータは<code>energy_may_day.csv</code>として保存します.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 一日単位で集計</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.groupby(<span class="st">&#39;Day&#39;</span>).agg({<span class="st">&#39;Lighting&#39;</span>:<span class="st">&#39;sum&#39;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">&#39;Others&#39;</span>:<span class="st">&#39;sum&#39;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">&#39;Power&#39;</span>:<span class="st">&#39;sum&#39;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">&#39;Air&#39;</span>:<span class="st">&#39;sum&#39;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">&#39;Total&#39;</span>:<span class="st">&#39;sum&#39;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">&#39;weekday&#39;</span>:<span class="st">&#39;first&#39;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">&#39;Holiday&#39;</span>:<span class="st">&#39;first&#39;</span>})</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>df.index <span class="op">=</span> pd.to_datetime(df.index)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">            Lighting   Others       Power  Air       Total weekday  Holiday</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">Day</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-01   57.8590  164.026  150.925638    1  373.810638     Sat        1</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-02   61.3290  170.661  153.542773    0  385.532773     Sun        1</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-03   52.5590  153.860  162.455036    0  368.874036     Mon        0</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-04   27.1570  142.110  190.401666    0  359.668666     Tue        0</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-05   14.9370  141.365   96.532341    0  252.834341     Wed        0</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-06  151.5430  252.266  163.735893    0  567.544893     Thu        0</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-07  137.5760  265.376   90.321215    4  497.273215     Fri        0</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-08   96.8080  202.206  159.786805    4  462.800805     Sat        1</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-09   67.1230  173.335  181.672136    4  426.130136     Sun        1</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-10  124.4350  234.587  187.283113    1  547.305113     Mon        0</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-11  150.7050  271.478   85.611779    1  508.794779     Tue        0</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-12  115.1820  231.200  142.734788    1  490.116788     Wed        0</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-13  137.8290  283.480   80.014654    1  502.323654     Thu        0</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-14  125.5200  235.470  176.655242    4  541.645242     Fri        0</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-15  100.0060  207.944  174.805418    6  488.755418     Sat        1</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-16   62.9970  189.768  101.143069    1  354.908069     Sun        1</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-17  134.4200  253.678   85.963373    4  478.061373     Mon        0</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-18  139.2750  275.532   85.630823    6  506.437823     Tue        0</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-19  111.7410  254.229   79.302779    3  448.272779     Wed        0</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-20  134.6820  258.456   96.874422    0  490.012422     Thu        0</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-21  134.7470  270.402   91.587337   15  511.736337     Fri        0</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-22   85.1020  214.783   89.615409    6  395.500409     Sat        1</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-23   66.4360  176.641  140.140173    4  387.217173     Sun        1</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-24  140.0200  237.016  151.007045   11  539.043045     Mon        0</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-25  133.2290  239.769  183.644077   14  570.642077     Tue        0</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-26  111.7810  220.848  167.229426   11  510.858426     Wed        0</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-27  135.5230  265.379   79.695086    1  481.597086     Thu        0</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-28  132.4820  247.760  141.465190    4  525.707190     Fri        0</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-29  131.5140  226.797  129.222198   12  499.533198     Sat        1</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-30   70.8040  188.536  139.632687    5  403.972687     Sun        1</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="co">2021-05-31  123.7695  231.010  164.885098    6  525.664598     Mon        0</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">&#39;data/energy_may_day.csv&#39;</span>,encoding<span class="op">=</span><span class="st">&#39;utf-8-sig&#39;</span>)</span></code></pre></div>
<p>作成したデータは,それぞれ<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/energy_may_hour.csv">時間ごと</a>,<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/energy_may_day.csv">日ごと</a>となります.
以下,これらのデータを利用して,時系列解析を実施していきます.</p>
<h2 data-number="1.2" id="古典的時系列解析"><span class="header-section-number">1.2</span> 古典的時系列解析</h2>
]]></description>
    <pubDate>Thu, 30 Oct 2025 00:00:00 UT</pubDate>
    <guid>/lectures/slds17.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>特別講義DS Ch11 線形回帰分析</title>
    <link>/lectures/slds11.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#線形回帰分析" id="toc-線形回帰分析"><span class="toc-section-number">1</span> 線形回帰分析</a>
<ul>
<li><a href="#発展-回帰分析は何を行っているのか" id="toc-発展-回帰分析は何を行っているのか"><span class="toc-section-number">1.1</span> 発展: 回帰分析は何を行っているのか</a>
<ul>
<li><a href="#母回帰方程式" id="toc-母回帰方程式"><span class="toc-section-number">1.1.1</span> 母回帰方程式</a></li>
<li><a href="#誤差項撹乱項" id="toc-誤差項撹乱項"><span class="toc-section-number">1.1.2</span> 誤差項,撹乱項</a></li>
<li><a href="#最小二乗法" id="toc-最小二乗法"><span class="toc-section-number">1.1.3</span> 最小二乗法</a></li>
<li><a href="#回帰係数の検定" id="toc-回帰係数の検定"><span class="toc-section-number">1.1.4</span> 回帰係数の検定</a></li>
</ul></li>
<li><a href="#単回帰分析" id="toc-単回帰分析"><span class="toc-section-number">1.2</span> 単回帰分析</a>
<ul>
<li><a href="#データの準備" id="toc-データの準備"><span class="toc-section-number">1.2.1</span> データの準備</a></li>
<li><a href="#散布図の作成" id="toc-散布図の作成"><span class="toc-section-number">1.2.2</span> 散布図の作成</a></li>
<li><a href="#単回帰" id="toc-単回帰"><span class="toc-section-number">1.2.3</span> 単回帰</a></li>
<li><a href="#回帰係数p値区間推定値" id="toc-回帰係数p値区間推定値"><span class="toc-section-number">1.2.4</span> 回帰係数(P値,区間推定値)</a></li>
<li><a href="#式全体の評価指標r2f" id="toc-式全体の評価指標r2f"><span class="toc-section-number">1.2.5</span> 式全体の評価指標(<span class="math inline">R^2</span>,F)</a></li>
<li><a href="#結果の可視化" id="toc-結果の可視化"><span class="toc-section-number">1.2.6</span> 結果の可視化</a></li>
</ul></li>
<li><a href="#重回帰分析" id="toc-重回帰分析"><span class="toc-section-number">1.3</span> 重回帰分析</a>
<ul>
<li><a href="#データ準備" id="toc-データ準備"><span class="toc-section-number">1.3.1</span> データ準備</a></li>
<li><a href="#可視化散布図行列" id="toc-可視化散布図行列"><span class="toc-section-number">1.3.2</span> 可視化(散布図行列)</a></li>
<li><a href="#可視化ヒートマップ" id="toc-可視化ヒートマップ"><span class="toc-section-number">1.3.3</span> 可視化(ヒートマップ)</a></li>
<li><a href="#多重共線性完全な多重共線性" id="toc-多重共線性完全な多重共線性"><span class="toc-section-number">1.3.4</span> 多重共線性(完全な多重共線性)</a></li>
<li><a href="#多重共線性弱い多重共線性" id="toc-多重共線性弱い多重共線性"><span class="toc-section-number">1.3.5</span> 多重共線性(弱い多重共線性)</a></li>
<li><a href="#可視化層別とペアプロット" id="toc-可視化層別とペアプロット"><span class="toc-section-number">1.3.6</span> 可視化(層別とペアプロット)</a></li>
<li><a href="#可視化層別とジョイントプロット" id="toc-可視化層別とジョイントプロット"><span class="toc-section-number">1.3.7</span> 可視化(層別とジョイントプロット)</a></li>
<li><a href="#ダミー変数化数量化1類" id="toc-ダミー変数化数量化1類"><span class="toc-section-number">1.3.8</span> ダミー変数化(数量化1類)</a></li>
<li><a href="#正規化標準化" id="toc-正規化標準化"><span class="toc-section-number">1.3.9</span> 正規化・標準化</a></li>
<li><a href="#モデル選択" id="toc-モデル選択"><span class="toc-section-number">1.3.10</span> モデル選択</a></li>
<li><a href="#aicについて" id="toc-aicについて"><span class="toc-section-number">1.3.11</span> AICについて</a></li>
<li><a href="#結果の可視化-1" id="toc-結果の可視化-1"><span class="toc-section-number">1.3.12</span> 結果の可視化</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<h1 data-number="1" id="線形回帰分析"><span class="header-section-number">1</span> 線形回帰分析</h1>
<p>相関分析では,ある変数間に関係があることを示すことができました. しかし,相関分析で示せるのは,変数Aによって変数Bが増加するか,減少するかということのみです. 具体的に,どの程度変数Aが動くことで,変数Bがどの程度変動するかを式によって<strong>説明する</strong>手法に<strong>回帰分析(Regression Analysis)</strong>があります.</p>
<p>また,回帰分析は求められた式がどの程度信頼できるのかを検定によって確かめることも可能です.</p>
<div class="note">
<p>回帰分析では,データ</p>
<p><span class="math display">
y = \beta_0 + \beta_1 x
</span></p>
<p>のような式で変数yとxの関係を説明し,この式を<strong>回帰式,回帰方程式</strong>と呼びます. このとき,</p>
<ul>
<li><p>説明される変数yを <strong>被説明変数</strong>,<strong>目的変数</strong>などと呼びます.</p></li>
<li><p>説明する変数xを<strong>説明変数</strong>,<strong>従属変数</strong>などと呼びます.</p></li>
<li><p>回帰式における <strong><span class="math inline">\beta_0</span></strong>のような変数に乗じられていない値を<strong>切片</strong>といいます.</p>
<p>切片は, <span class="math inline">x = 0</span> のときのyの値を意味しています.</p></li>
<li><p>変数に乗じられている<strong><span class="math inline">\beta_1</span></strong>のような値を<strong>傾き</strong>といい,<span class="math inline">\beta_0,\beta_1</span> などを併せて<strong>回帰係数</strong>といいます.</p>
<p>傾きは,xが1変化した際のyの変化量を表しています.</p></li>
</ul>
<p><img src="/images/slds/ch11/regression-image.png" /></p>
<ul>
<li><p>説明変数が一つの回帰式を求める分析を<strong>単回帰分析</strong>, 2つ以上の説明変数を用いる場合を<strong>重回帰分析</strong>といいます.</p></li>
<li><p>yがxの線形関数である場合を <strong>線形回帰(Linear regression)</strong>,それ以外のものを<strong>非線形回帰(non-linear regression)</strong>といいます.</p></li>
</ul>
<p><img src="/images/slds/ch11/regression-image2.png" /></p>
</div>
<h2 data-number="1.1" id="発展-回帰分析は何を行っているのか"><span class="header-section-number">1.1</span> 発展: 回帰分析は何を行っているのか</h2>
<p>回帰分析が何を行っているのかについて,単回帰で行っている最小二乗法を事例に確認していきましょう.
重回帰に関しては, 線形計画問題など異なる学習が必要になるので,今回は扱いません. あくまで,回帰というものがどのような意味であるかに関して簡単に説明します.</p>
<p>なお,こちらの詳細は統計学に関する別講義で扱っていますので, この講義ではあまり深く扱いません. 興味のある方は統計学の講義を受講して下さい.</p>
<h3 data-number="1.1.1" id="母回帰方程式"><span class="header-section-number">1.1.1</span> 母回帰方程式</h3>
<p>体重<span class="math inline">y</span>を慎重<span class="math inline">x</span>によって説明する回帰方程式として, <span class="math inline">y = \beta_0 + \beta_1 x</span> を考えてみます.
しかし, 実際の体重は身長以外の要素によってばらつきます. そのような<strong>ばらつき</strong>を考慮して,データの<span class="math inline">i</span>人目の体重,身長をそれぞれ,<span class="math inline">Y_i,X_i</span>として,身長以外の要素によるばらつきを<span class="math inline">\epsilon_i</span>とすると,母集団において,以下のような式が立てられます.</p>
<p><span class="math display">
Y_i = \beta_0 + \beta_1 X_i + \epsilon_i ~(i=1,2,...,n)
</span></p>
<p>これを<strong>母回帰方程式(Population Regression Equation)</strong>と呼びます.
また, <span class="math inline">\beta_0, \beta_1</span>を<strong>母(偏)回帰係数</strong>といい,これを<strong>推定,検定すること</strong>を回帰分析といいます.</p>
<h3 data-number="1.1.2" id="誤差項撹乱項"><span class="header-section-number">1.1.2</span> 誤差項,撹乱項</h3>
<p>母回帰方程式</p>
<p><span class="math display">
Y_i = \beta_0 + \beta_1 X_i + \epsilon_i ~(i=1,2,...,n)
</span></p>
<p>における <span class="math inline">\epsilon_i</span>は<span class="math inline">X_i</span>で説明できない誤差を表す確率変数であり,<strong>誤差項</strong>,<strong>撹乱項</strong>といいます.</p>
<p><img src="/images/slds/ch11/regression-images3.png" /></p>
<p>回帰分析において,誤差項は以下の仮定をおいています.</p>
<div class="note">
<ul>
<li>期待値0: <span class="math inline">E(\epsilon_i) = 0 ~ (i=1,2,...,n)</span></li>
<li>分散一定: <span class="math inline">V(\epsilon_i) = \sigma^2 ~ (i=1,2,...,n)</span></li>
<li>無相関: <span class="math inline">i \neq j \Rightarrow Cov(\epsilon_i, \epsilon_j) = 0</span></li>
<li>正規分布: <span class="math inline">\epsilon_i \sim N(0,\sigma^2)</span></li>
</ul>
</div>
<p>これによって,</p>
<p><span class="math display">
E(Y_i) = \beta_1 + \beta_2 X_i
</span></p>
<p>が得られます.</p>
<h3 data-number="1.1.3" id="最小二乗法"><span class="header-section-number">1.1.3</span> 最小二乗法</h3>
<p>母回帰方程式</p>
<p><span class="math display">
Y_i = \beta_0 + \beta_1 X_i + \epsilon_i ~(i=1,2,...,n)
</span>
における母回帰係数<span class="math inline">\beta_0, \beta_1</span>は観測できないので,<strong>誤差項を最小化する母回帰係数</strong>を統計的推測することで求めます.</p>
<p>この誤差項を最小化する母回帰係数の推定方法を<strong>最小二乗法(least squares method)</strong>といいます.</p>
<p>母回帰方程式を変形して,</p>
<p><span class="math display">
\epsilon_i = Y_i - (\beta_0 + \beta_1 X_i)
</span></p>
<p>が少ないほど, <span class="math inline">X_i</span>による<span class="math inline">Y_i</span>の説明力が上がります(モデルによってよく関係が説明できている.)</p>
<p>なので,モデル全体で,<span class="math inline">\epsilon_i</span>を最小化することを考えてみます.</p>
<figure>
<img src="/images/least-squares-method1.png" alt="least squares method" />
<figcaption aria-hidden="true">least squares method</figcaption>
</figure>
<p>誤差の正負を打ち消すために,モデル全体の誤差項の二乗の和</p>
<p><span class="math display">
\begin{align*}
S &amp; = \sum_{i=1} \epsilon_{1}^{2} \\
&amp;= \sum_{i=1} \{Y_i - (\beta_0 + \beta_1 X_i)\}^2
\end{align*}
</span></p>
<p>Sを最小化する<strong>(最小二乗)推定量</strong> <span class="math inline">\hat{\beta_0},\hat{\beta_1}</span> を求める問題として整理できます.</p>
<p><span class="math inline">S</span>の偏微分を0とおいて,</p>
<p><span class="math display">
\frac{\partial S}{ \partial \beta_0} = -2 \sum (Y_i = \beta_0 - \beta_1 X_i) = 0 \\
\frac{\partial S}{ \partial \beta_1} = -2 \sum (Y_i = \beta_0 - \beta_1 X_i)X_i = 0 \\
</span></p>
<p>これを解いて,</p>
<p><span class="math display">
\hat{\beta_0} = \bar{Y} - \hat{\beta_1}\bar{X} \\
\hat{\beta_1} = \frac{\sum(X_i - \bar{X})(Y_i - \bar(Y))}{\sum(X_i - \bar{X})^2}
</span>
が得られます.</p>
<h3 data-number="1.1.4" id="回帰係数の検定"><span class="header-section-number">1.1.4</span> 回帰係数の検定</h3>
<p>最小二乗推定量によって得られた方程式</p>
<p><span class="math display">
Y = \hat{\beta_0} + \hat{\beta_1}X
</span></p>
<p>を<strong>標本回帰方程式</strong>といいます.</p>
<p>求めた標本回帰方程式が,XとYの関係を説明できているのかを考えます. XがYを全く説明できていない場合, <span class="math inline">\epsilon_i</span> だけで説明ができるため, <span class="math inline">\beta_1 \neq 0</span> と言えれば,統計的にXがYを説明できていると言えます.</p>
<p>そこで, 帰無仮説 <span class="math inline">H_0:\beta_1 = 0</span> として,偏回帰係数に関する統計的仮説検定を実施します.</p>
<p>母数 <span class="math inline">\beta_1</span> に関する仮説検定を行うために, <span class="math inline">\beta_1</span> の確率分布を考えます.</p>
<p>誤差項 <span class="math inline">\epsilon_i \sim N(o,\sigma^2)</span> として,</p>
<p><span class="math display">
\hat{\beta_0} = \bar{Y} - \hat{\beta_1}\bar{X} \\
\hat{\beta_1} = \frac{\sum(X_i - \bar{X})(Y_i - \bar(Y))}{\sum(X_i - \bar{X})^2}
</span>
であるから,</p>
<p><span class="math display">
V(\hat{\beta_0}) = \frac{\sigma^2 \sum X_i^2}{n\sum(X_i - \bar{X})^2} \\
E(\hat{\beta_0}) = \beta_0 \\
V(\hat{\beta_2}) = \frac{\sigma^2 }{\sum(X_i - \bar{X})^2} \\
E(\hat{\beta_1}) = \beta_1
</span>
なので,</p>
<p><span class="math display">
\hat{\beta_1} \sim N(\beta_1,\frac{\sigma^2}{\sum(X_i - \bar{X})^2})
</span></p>
<p>となる.</p>
<p>誤差項の母標準偏差 <span class="math inline">\sigma</span> が含まれるので,推定する.</p>
<p>標本回帰方程式 <span class="math inline">Y=\hat{\beta_0}+\hat{\beta_1}X</span> によって求められる各 <span class="math inline">i</span> の値(回帰値)</p>
<p><span class="math display">
\hat{Y_i} = \hat{\beta_0} + \hat{\beta_1}X_i
</span></p>
<p>と実際に観測された実測値 <span class="math inline">Y_i</span>との差を</p>
<p><span class="math display">
\hat{e_i} = Y_i - \hat{Y_i} = Y_i - \hat{\beta_0} - \hat{\beta_1}X_i
</span></p>
<p>を<strong>回帰残渣(residual)</strong>といい,Xで説明されなかった残渣を表す.</p>
<p>回帰残渣を母回帰方程式 <span class="math inline">Y_i = \beta_0 + \beta_1 X_i + \epsilon_i</span> における誤差項 <span class="math inline">\epsilon_i</span> の推定値として利用する.</p>
<p>求める必要があるのは,誤差項の分散の推定値としての分散</p>
<p><span class="math display">
V(\hat{e_i}) = E(\hat{e_i^2}) - (E(\hat{e_i}))^2
</span></p>
<p>であるが,</p>
<p><span class="math display">
\frac{\partial S}{\partial \beta_1} = -2 \sum (Y_i - \beta_0 - \beta_1 X_i)X_i = 0
</span>
なので,</p>
<p><span class="math display">
\sum (Y_i - \beta_0 - \beta_1 X_i) = \sum \hat{e_i} = 0
</span></p>
<p>となり,</p>
<p><span class="math display">
\bar{e_i} = \frac{1}{n} \sum \hat{e_i} = 0
</span></p>
<p>なので,</p>
<p><span class="math display">
\begin{align*}
V(\hat{e_i}) &amp;= E(\hat{eI^2}) \\
&amp;= \frac{1}{n-2}\sum (\hat{e_i}^2 - \bar{e_i}^2) \\
&amp;= \frac{\sum \hat{e_i}^2}{n-2}
\end{align*}
</span></p>
<p>となります.</p>
<p>これを誤差項の分散<span class="math inline">\sigma^2</span>の推定値</p>
<p><span class="math display">
S^2 = \frac{\sum \hat{e_i}^2}{n-2}
</span>
として利用します.</p>
<p>なお,この累乗根は回帰式がどの程度実測値に当てはまっているかを表す,<strong>推定値の標準誤差(standard error of estimates)</strong>と呼ばれます.</p>
<p><span class="math display">
s.e. = \sqrt{S^2} = \sqrt{\frac{\sum \hat{e_i}^2}{n-2}}
</span></p>
<p>これを誤差項の母標準偏差<span class="math inline">\sigma</span>の推定値として利用して,<span class="math inline">\hat{\beta_2}</span>の標準誤差の推定値は,</p>
<p><span class="math display">
V(\hat{\beta_1}) = \frac{\sigma^2 }{\sum(X_i - \bar{X})^2}
</span></p>
<p>から,</p>
<p><span class="math display">
s.e.(\hat{\beta_1}) = \frac{s.e.}{\sqrt{\sum(X_i - \bar{X})^2}}
</span></p>
<p>となり,<span class="math inline">s.e.(\hat{\beta_2})</span>を用いて標準化した値は, <span class="math inline">t(n-2)</span>に従うので,</p>
<p><span class="math display">
t_2 = \frac{\hat{\beta_1} - \beta_1}{s.e.(\hat{\beta_1})} \sim t(n-2)
</span></p>
<p>あとは得られた推定量を用いて,帰無仮説に関するt検定を実施する.</p>
<h2 data-number="1.2" id="単回帰分析"><span class="header-section-number">1.2</span> 単回帰分析</h2>
<p>それでは,実際に単回帰分析を実施してみる. 事例として,以下の分析にどのような問題点があるのかを考えてみよう.</p>
<blockquote class="twitter-tweet">
<p lang="ja" dir="ltr">
今回に限らず毎度毎度のことだけど、日本「経済」新聞を名乗りながら、お粗末な統計リテラシーだからな。。。<br>日経に限らず、本邦の大手紙は例外なく全てお粗末な統計リテラシー。<br>統計の基礎を勉強したい人はツッコミを入れると良いよ。ツッコミを入れるところだらけで勉強になるから。<a href="https://twitter.com/IsayaShimizu?ref_src=twsrc%5Etfw"><span class="citation" data-cites="IsayaShimizu">@IsayaShimizu</span></a> <a href="https://t.co/cxMAFDPRfM">https://t.co/cxMAFDPRfM</a>
</p>
— 糸石 浩司 (<span class="citation" data-cites="itoishi">@itoishi</span>) <a href="https://twitter.com/itoishi/status/1445026338885103618?ref_src=twsrc%5Etfw">October 4, 2021</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet">
<p lang="ja" dir="ltr">
相関があることを言いたいなら散布図を描くべきでは？ あと，この16カ国はどうやって選んだのか？ <a href="https://t.co/ncWWtQ8A8L">https://t.co/ncWWtQ8A8L</a>
</p>
— Haruhiko Okumura (<span class="citation" data-cites="h_okumura">@h_okumura</span>) <a href="https://twitter.com/h_okumura/status/1444983348862996485?ref_src=twsrc%5Etfw">October 4, 2021</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>これらのPOSTは何を懸念しているのでしょうか.</p>
<p>元POSTでは, 日本経済新聞が<a href="https://www.oecd.org/en/data/datasets/oecd-family-database.html">OECD Family Database</a>のデータから作成したグラフを用いて男性の育児・家事時間の少なさが日本の少子化の原因であると主張しています.</p>
<figure>
<img src="/images/slds/ch11/oecd-nikkei.png" alt="出典：日本経済新聞,「男性の育児・家事時間、出生率に影響　日本は女性の二割" />
<figcaption aria-hidden="true"><a href="https://www.nikkei.com/article/DGXZQOFE308UG0Q1A830C2000000/">出典：日本経済新聞,「男性の育児・家事時間、出生率に影響　日本は女性の二割</a></figcaption>
</figure>
<div class="note">
<p>この分析の問題点は主に以下の2つです.</p>
<ol type="1">
<li><p>元のPOSTの通り,この記事ではグラフを主張の根拠としていますが,棒グラフと散布図を組み合わせたような独自のグラフを作成しており,これを持って何が主張できるのかが明確ではありません. 2つの量的データの関係性を示す場合は散布図が適当です.</p></li>
<li><p>また,グラフが適当であったとしても,グラフはデータの概観の把握にや役立ちますが,グラフのみから明確な主張が主張できるわけではない場合が多いです.</p></li>
</ol>
</div>
<p>まずは,グラフに関して考えてみましょう. 実は,内閣府もこのデータを利用して同様の主張をしています. 内閣府のグラフでは,独自のグラフではなく,散布図が作成されています.</p>
<figure>
<img src="/images/slds/ch11/oecd-cabinet.png" alt="出典：内閣府　政策統括官（経済社会システム担当）第４回会議資料　選択する未来2.0, 資料２　参考資料②(事務局資料)" />
<figcaption aria-hidden="true"><a href="https://www5.cao.go.jp/keizai2/keizai-syakai/future2/20200409/shiryou2.pdf">出典：内閣府　政策統括官（経済社会システム担当）第４回会議資料　選択する未来2.0, 資料２　参考資料②(事務局資料)</a></figcaption>
</figure>
<p>内閣府の資料でも,同じデータを利用して,同じ主張をしています. しかし,こちらの資料では独自のグラフではなく,散布図を作成しており,追加的に回帰式(<span class="math inline">y=0.0132x + 1.2027</span>)及びR2も求めています.</p>
<div class="note">
<p>しかし,先程説明した通り,<strong>回帰分析</strong>とは回帰式に関する検定であり,回帰式のみをもって,y(合計特殊出生率)にx(育児・家事労働時間割合)が影響を及ぼしているとは<strong>言えません</strong>.</p>
</div>
<p>では,実際に回帰分析を実施してみるとどのような結果になるでしょうか?</p>
<h3 data-number="1.2.1" id="データの準備"><span class="header-section-number">1.2.1</span> データの準備</h3>
<p>まずはデータを準備する必要があります. <a href="https://www.oecd.org/en/data/datasets/oecd-family-database.html">OECD Family Database</a>から,<code>SF2.1 Fertility rates</code>及び<code>LMF2.5 Time used for work, care and daily household chores</code>のExcelファイルをダウンロードしました.
それぞれから<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/fertility_rates.csv"><code>fertility_rates.csv</code></a>及び,<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/time_used.csv"><code>time_used.csv</code></a>を作成しました.以下これらのデータをダウンロードして,作業を進めてください.</p>
<div class="warn">
<p>可能であれば,練習として以下のコードは見ないで,元の内閣府の資料から何をする必要があるのか,自分でどのように計算するかを考えて実行してみましょう.</p>
</div>
<p>まずはデータをそれぞれ読み込んでみましょう.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>df_f <span class="op">=</span> pd.read_csv(<span class="st">&#39;fertility_rates.csv&#39;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>df_t <span class="op">=</span> pd.read_csv(<span class="st">&#39;time_used.csv&#39;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_f)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_t)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">            Country  Fertility</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">0             Korea       0.92</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">1             Spain       1.23</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">2             Italy       1.27</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">3             Japan       1.36</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">4            Poland       1.42</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">5          Portugal       1.43</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">6         Lithuania       1.61</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">7        Luxembourg       1.34</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">8            Canada       1.47</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">9            Greece       1.34</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">10          Finland       1.35</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">11          Austria       1.46</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">12      Switzerland       1.48</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">13   United Kingdom       1.63</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">14       Costa Rica       1.63</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">15            Chile       1.55</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">16           Norway       1.53</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">17           Latvia       1.61</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">18          Germany       1.54</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">19     OECD average       1.60</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">20          Hungary       1.49</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">21          Belgium       1.60</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">22          Estonia       1.66</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">23      Netherlands       1.57</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">24  Slovak Republic       1.57</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">25      New Zealand       1.72</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">26         Slovenia       1.61</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">27    United States       1.71</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">28           Sweden       1.70</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">29        Australia       1.67</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co">30          Türkiye       1.88</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">31         Colombia       1.77</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">32          Ireland       1.70</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co">33          Denmark       1.70</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co">34           France       1.83</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co">35          Iceland       1.75</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co">36           Mexico       1.92</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co">37   Czech Republic       1.71</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co">38           Israel       3.01</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co">           Country  Paid  Unpaid  Care</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co">0        Australia  20.3    10.5   2.2</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co">1          Austria  22.5     9.4   1.5</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co">2          Belgium  15.6     9.7   0.8</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co">3           Canada  22.1    10.3   1.7</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co">4          Estonia  21.0    11.5   1.8</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co">5          Finland  15.4    11.2   1.0</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">6           France  14.5     9.7   1.0</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">7          Germany  17.4     9.8   1.4</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">8            Italy  14.5     8.2   1.2</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co">9            Japan  26.3     4.7   0.5</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co">10           Korea  26.5     3.0   0.8</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co">11          Latvia  24.2     8.8   1.2</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co">12          Mexico  30.0     4.4   3.5</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co">13     New Zealand  19.9    11.3   1.1</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="co">14          Norway  18.6    11.7   1.6</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co">15          Poland  21.7     6.2   1.5</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co">16        Slovenia  18.9    11.4   1.6</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co">17           Spain  14.8     8.9   2.0</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co">18          Sweden  20.1    10.0   1.8</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co">19          Turkey  20.2     2.6   3.5</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co">20  United Kingdom  20.1     9.5   1.6</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co">21   United States  20.4    10.2   1.6</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>確認してみると,政府のデータは国ごとに異なる年代を使用しており,年代も国の選択もOECDのデータベースで公開されているものとは異なるようです.実際に,日本経済新聞のデータとも値が異なっていることから,おそらく公開されていないデータを独自に集計しているようです.
今回は日本経済新聞で採用されている値から2019年の出生率及びデータベースで公開されている1999-2013年の家事・育児時間を採用します.</p>
<p>続いて,政府のグラフに合わせて男性の労働時間,家事及び育児の時間(Paid,Unpaid,Care)に占める家事及び育児(Unpaid, Care)の割合を計算します.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_t[<span class="st">&#39;r&#39;</span>] <span class="op">=</span> df_t[[<span class="st">&#39;Unpaid&#39;</span>,<span class="st">&#39;Care&#39;</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> df_t[[<span class="st">&#39;Paid&#39;</span>,<span class="st">&#39;Unpaid&#39;</span>,<span class="st">&#39;Care&#39;</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_t)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">           Country  Paid  Unpaid  Care         r</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">0        Australia  20.3    10.5   2.2  0.384848</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">1          Austria  22.5     9.4   1.5  0.326347</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">2          Belgium  15.6     9.7   0.8  0.402299</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">3           Canada  22.1    10.3   1.7  0.351906</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">4          Estonia  21.0    11.5   1.8  0.387755</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">5          Finland  15.4    11.2   1.0  0.442029</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">6           France  14.5     9.7   1.0  0.424603</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">7          Germany  17.4     9.8   1.4  0.391608</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">8            Italy  14.5     8.2   1.2  0.393305</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">9            Japan  26.3     4.7   0.5  0.165079</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">10           Korea  26.5     3.0   0.8  0.125413</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">11          Latvia  24.2     8.8   1.2  0.292398</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">12          Mexico  30.0     4.4   3.5  0.208443</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">13     New Zealand  19.9    11.3   1.1  0.383901</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">14          Norway  18.6    11.7   1.6  0.416928</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">15          Poland  21.7     6.2   1.5  0.261905</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">16        Slovenia  18.9    11.4   1.6  0.407524</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">17           Spain  14.8     8.9   2.0  0.424125</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">18          Sweden  20.1    10.0   1.8  0.369906</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">19          Turkey  20.2     2.6   3.5  0.231939</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">20  United Kingdom  20.1     9.5   1.6  0.355769</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">21   United States  20.4    10.2   1.6  0.366460</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p><code>df_t</code>と<code>df_f</code>は表示されている国が異なるので,<code>df_t</code>から情報を抽出します.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#照合のためにCountryをindexにします.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_t.set_index(<span class="st">&#39;Country&#39;</span>,inplace<span class="op">=</span><span class="va">True</span>,drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df_f.set_index(<span class="st">&#39;Country&#39;</span>,inplace<span class="op">=</span><span class="va">True</span>,drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df_f[<span class="st">&#39;r&#39;</span>] <span class="op">=</span> pd.NA</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> df_f.index:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        df_f.at[i,<span class="st">&#39;r&#39;</span>] <span class="op">=</span> df_t.at[i,<span class="st">&#39;r&#39;</span>]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_f)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">                 Fertility         r</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">Country</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">Korea                 0.92  0.125413</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">Spain                 1.23  0.424125</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">Italy                 1.27  0.393305</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">Japan                 1.36  0.165079</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">Poland                1.42  0.261905</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">Portugal              1.43      &lt;NA&gt;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">Lithuania             1.61      &lt;NA&gt;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">Luxembourg            1.34      &lt;NA&gt;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">Canada                1.47  0.351906</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">Greece                1.34      &lt;NA&gt;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">Finland               1.35  0.442029</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">Austria               1.46  0.326347</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">Switzerland           1.48      &lt;NA&gt;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">United Kingdom        1.63  0.355769</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">Costa Rica            1.63      &lt;NA&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">Chile                 1.55      &lt;NA&gt;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">Norway                1.53  0.416928</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">Latvia                1.61  0.292398</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">Germany               1.54  0.391608</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">OECD average          1.60      &lt;NA&gt;</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">Hungary               1.49      &lt;NA&gt;</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co">Belgium               1.60  0.402299</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co">Estonia               1.66  0.387755</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co">Netherlands           1.57      &lt;NA&gt;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">Slovak Republic       1.57      &lt;NA&gt;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co">New Zealand           1.72  0.383901</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co">Slovenia              1.61  0.407524</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co">United States         1.71   0.36646</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="co">Sweden                1.70  0.369906</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co">Australia             1.67  0.384848</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co">Türkiye               1.88      &lt;NA&gt;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co">Colombia              1.77      &lt;NA&gt;</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="co">Ireland               1.70      &lt;NA&gt;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co">Denmark               1.70      &lt;NA&gt;</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co">France                1.83  0.424603</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">Iceland               1.75      &lt;NA&gt;</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co">Mexico                1.92  0.208443</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co">Czech Republic        1.71      &lt;NA&gt;</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="co">Israel                3.01      &lt;NA&gt;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p><code>df_t</code>にデータの無い国を除外します.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#NAを削除</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_f.dropna(how<span class="op">=</span><span class="st">&#39;any&#39;</span>,inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_f)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">                Fertility         r</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">Country</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">Korea                0.92  0.125413</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">Spain                1.23  0.424125</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">Italy                1.27  0.393305</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">Japan                1.36  0.165079</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">Poland               1.42  0.261905</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">Canada               1.47  0.351906</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">Finland              1.35  0.442029</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">Austria              1.46  0.326347</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">United Kingdom       1.63  0.355769</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">Norway               1.53  0.416928</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">Latvia               1.61  0.292398</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">Germany              1.54  0.391608</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">Belgium              1.60  0.402299</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">Estonia              1.66  0.387755</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">New Zealand          1.72  0.383901</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">Slovenia             1.61  0.407524</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">United States        1.71   0.36646</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">Sweden               1.70  0.369906</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">Australia            1.67  0.384848</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">France               1.83  0.424603</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">Mexico               1.92  0.208443</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>全てのデータが揃った国はこの21ヵ国となりました.</p>
<div class="note">
<p>このとき問題となるのが,どの国を採用するかです.
元のPOSTにも指摘がありましたが,内閣府の計算ではなぜかメキシコが除外されていますので,それに従って実行してみます.</p>
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#メキシコを除外</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_f.drop(<span class="st">&#39;Mexico&#39;</span>,axis<span class="op">=</span><span class="dv">0</span>,inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_f)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">               Fertility         r</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">Country</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">Korea                0.92  0.125413</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">Spain                1.23  0.424125</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">Italy                1.27  0.393305</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">Japan                1.36  0.165079</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">Poland               1.42  0.261905</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">Canada               1.47  0.351906</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">Finland              1.35  0.442029</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">Austria              1.46  0.326347</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">United Kingdom       1.63  0.355769</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">Norway               1.53  0.416928</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">Latvia               1.61  0.292398</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">Germany              1.54  0.391608</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">Belgium              1.60  0.402299</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">Estonia              1.66  0.387755</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">New Zealand          1.72  0.383901</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">Slovenia             1.61  0.407524</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">United States        1.71   0.36646</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">Sweden               1.70  0.369906</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">Australia            1.67  0.384848</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">France               1.83  0.424603</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p><code>Fertility</code>は<code>%</code>になっているので単位を揃えて<code>r</code>も<code>%</code>表示にし,データ型も<code>float</code>にしておきます.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_f[<span class="st">&#39;r&#39;</span>] <span class="op">=</span> (df_f[<span class="st">&#39;r&#39;</span>] <span class="op">*</span> <span class="dv">100</span>).astype(<span class="st">&#39;float&#39;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_f)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">                Fertility          r</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">Country</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">Korea                0.92  12.541254</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">Spain                1.23  42.412451</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">Italy                1.27  39.330544</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">Japan                1.36  16.507937</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">Poland               1.42  26.190476</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">Canada               1.47  35.190616</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">Finland              1.35  44.202899</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">Austria              1.46  32.634731</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">United Kingdom       1.63  35.576923</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">Norway               1.53  41.692790</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">Latvia               1.61  29.239766</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">Germany              1.54  39.160839</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">Belgium              1.60  40.229885</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">Estonia              1.66  38.775510</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">New Zealand          1.72  38.390093</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co">Slovenia             1.61  40.752351</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">United States        1.71  36.645963</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co">Sweden               1.70  36.990596</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co">Australia            1.67  38.484848</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co">France               1.83  42.460317</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<h3 data-number="1.2.2" id="散布図の作成"><span class="header-section-number">1.2.2</span> 散布図の作成</h3>
<p>データが完成したので,散布図を作成してみます. ラベルを表示するためにライブラリ<code>adjustText</code>を利用しています. この方法で作成する場合は<code>pip install</code>してください.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adjustText <span class="im">import</span> adjust_text</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plt.scatter(df_f[<span class="st">&#39;r&#39;</span>],df_f[<span class="st">&#39;Fertility&#39;</span>])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> [plt.text(df_f.at[c,<span class="st">&#39;r&#39;</span>],df_f.at[c,<span class="st">&#39;Fertility&#39;</span>],c) <span class="cf">for</span> c <span class="kw">in</span> df_f.index]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>adjust_text(text, arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, lw<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>plt.xlim<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">50</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>plt.ylim<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">2</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Fertility&#39;</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Unpaid and Care Work&#39;</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Fertility vs Unpaid and Care Work with Country Labels&#39;</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/oecd_scatter_no_line.png" /></p>
<p>おおよそ政府と同じグラフが完成しました.</p>
<h3 data-number="1.2.3" id="単回帰"><span class="header-section-number">1.2.3</span> 単回帰</h3>
<p>つづいて,これらのデータを利用して単回帰分析を実施してみます. 回帰分析が可能なライブラリはいくつかありますが,ここでは<code>statsmodels.api</code>を利用してみます. <code>pip install statsmodels</code> をしておきましょう.</p>
<p>まずは,切片 <span class="math inline">\beta_0</span> として定数1をデータに追加します. <code>statsmodels</code>では <code>.add_constant()</code>メソッドで追加できます.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 説明変数(X)と目的変数(y)に分割</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df_f[[<span class="st">&#39;r&#39;</span>]]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df_f[<span class="st">&#39;Fertility&#39;</span>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 切片(定数項)を追加</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">                const          r</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">Country</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">Korea             1.0  12.541254</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">Spain             1.0  42.412451</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">Italy             1.0  39.330544</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">Japan             1.0  16.507937</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">Poland            1.0  26.190476</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">Canada            1.0  35.190616</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">Finland           1.0  44.202899</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">Austria           1.0  32.634731</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">United Kingdom    1.0  35.576923</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">Norway            1.0  41.692790</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">Latvia            1.0  29.239766</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">Germany           1.0  39.160839</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">Belgium           1.0  40.229885</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">Estonia           1.0  38.775510</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">New Zealand       1.0  38.390093</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">Slovenia          1.0  40.752351</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co">United States     1.0  36.645963</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">Sweden            1.0  36.990596</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">Australia         1.0  38.484848</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co">France            1.0  42.460317</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>回帰分析を実施するには <code>OLS(y,X).fit()</code>を利用します. <code>OLS</code>は<code>Ordinary Least Squares</code>の頭文字で最小二乗法を意味しています.</p>
<p>回帰分析の結果は<code>.result()</code>メソッドで確認します.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 回帰モデルを作成・フィット</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果を表示</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result.summary())</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">                            OLS Regression Results</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">Dep. Variable:              Fertility   R-squared:                       0.282</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">Model:                            OLS   Adj. R-squared:                  0.243</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">Method:                 Least Squares   F-statistic:                     7.085</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">Date:                Sat, 29 Mar 2025   Prob (F-statistic):             0.0159</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">Time:                        13:27:03   Log-Likelihood:                 6.4233</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">No. Observations:                  20   AIC:                            -8.847</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">Df Residuals:                      18   BIC:                            -6.855</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">Df Model:                           1</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">Covariance Type:            nonrobust</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">                 coef    std err          t      P&gt;|t|      [0.025      0.975]</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------------------------------------------------------------</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">const          1.0390      0.183      5.666      0.000       0.654       1.424</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">r              0.0134      0.005      2.662      0.016       0.003       0.024</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co">Omnibus:                        3.229   Durbin-Watson:                   0.868</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">Prob(Omnibus):                  0.199   Jarque-Bera (JB):                2.595</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co">Skew:                          -0.852   Prob(JB):                        0.273</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co">Kurtosis:                       2.539   Cond. No.                         161.</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>様々な数値が出てきましたが,単回帰において注目すべきは,<code>(Adj.)R-squared</code>,<code>Prob (F-statistic)</code>,<code>coef</code>,<code>P&gt;|t|</code>,<code>[0.025      0.975]</code>です.
それぞれ何を見ればよいのかを順に見ていきましょう.</p>
<h3 data-number="1.2.4" id="回帰係数p値区間推定値"><span class="header-section-number">1.2.4</span> 回帰係数(P値,区間推定値)</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">                coef    std err          t      P&gt;|t|      [0.025      0.975]</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------------------------------------------------------------</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">const          1.0390      0.183      5.666      0.000       0.654       1.424</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">r              0.0134      0.005      2.662      0.016       0.003       0.024</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>回帰係数から今回推定された標本回帰方程式(<span class="math inline">y=\hat{\beta}_0+\hat{\beta}_1x</span>)は</p>
<p><span class="math display">
y=1.0390+0.0134x
</span></p>
<p>となります.
この <span class="math inline">\hat{\beta}_0</span> と <span class="math inline">\hat{\beta}_1</span> に対して<span class="math inline">H_0: \beta_i =0,H_1: \beta_i \neq 0</span> で検定した結果が,<code>P&gt;|t|</code>として示されています.
また, <span class="math inline">\hat{\beta}_0</span> と <span class="math inline">\hat{\beta}_1</span> の下側信頼限界が<code>0.025</code>,上側信頼限界が<code>0.975</code>として示されています.
2つの値は基本的に同じことを違う方法で表しています.</p>
<div class="note">
<p>それぞれの説明変数のP値(<code>P&gt;|t|</code>)は,その説明変数に対する回帰係数が0である(影響がない)という仮説に対する仮説検定のP値を表しています. また, <code>[0.025      0.975]</code>はそれぞれ上側と下側の95%信頼区間を表しています.</p>
<p>有意水準5%の場合, <code>P値 &lt; 0.05</code>で有意となり, 信頼区間が0をまたぎません.
(ここで両側検定ですが,<code>P値 &lt; 0.025</code>とならないのは,両側の外側累積確率を合算した値が算出されるためです.)
したがって,これらの値はいずれも同じ判断の基準となりますが,最近は論文などには両方載せることが主流です.
(仮説検定や区間推定,P値の意味などに関しては,統計学入門で詳細を扱っています.分からない人はそちらを履修しましょう.)</p>
</div>
<p><strong>｢P値 &lt; 0.05｣ かつ ｢下側信頼限界と上側信頼限界が0をまたいでいない｣</strong>場合には,それぞれの回帰係数が有意となります.</p>
<p>したがって今回の回帰分析の結果としては, いずれの回帰係数も有意であり,出生率に影響を及ぼしていると考えることができます.</p>
<div class="note">
<p>あまり良くない回帰分析の方法として,有意な回帰係数のみを分析対象として,有意でない回帰係数を無視して分析している場合がしばしばあります.
基本的には, 式を構成するすべての回帰係数が有意である場合にはじめてその式は利用できます.</p>
<p>方針等は指導教員によって異なるのでそれぞれに従っていただくとして,<strong>この講義では</strong>基本的に<strong>一つでも有意でない式がある場合には,その回帰式は利用できない</strong>とみなしてください.</p>
</div>
<h3 data-number="1.2.5" id="式全体の評価指標r2f"><span class="header-section-number">1.2.5</span> 式全体の評価指標(<span class="math inline">R^2</span>,F)</h3>
<p>回帰係数のP値,区間推定値は<strong>回帰係数一つ一つ</strong>に関する検定の結果でした. 個別の係数が問題ないとしても,切片と傾きを合わせた<strong>式全体の評価</strong>はどうなのでしょうか. その判断に利用するのが,
<span class="math inline">R^2</span> と <strong>有意F</strong>です.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">R-squared:                       0.282</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">Adj. R-squared:                  0.243</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">F-statistic:                     7.085</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">Prob (F-statistic):             0.0159</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<div class="note">
<ul>
<li><h2 id="調整済決定係数adj.-r-squared"><strong>調整済決定係数(Adj. R-squared)</strong></h2></li>
</ul>
<p><strong>決定係数</strong> (<span class="math inline">R^2</span>) は,<strong>モデルがどの程度当てはまっているかの基準</strong>です. 決定係数は説明変数の数が多いほど1に近づく特徴があるので,説明変数が多い場合には説明変数の数を補正した <strong>自由度調整済み決定係数</strong> (𝐴𝑑𝑗.<span class="math inline">𝑅^2</span>)を用います.</p>
<p>基本的に <span class="math inline">0 \leq Adj R^2 \leq 1</span> の値をとり,目安として <span class="math inline">0.5 \leq Adj 𝑅^2</span> であればある程度予測できていると考えられます.</p>
<p>どんな散布図になっても回帰式自体は作成可能ですが,以下の左右どちらの予測値の方が信頼できそうでしょうか.</p>
<figure>
<img src="/images/regression14.png" alt="R2" />
<figcaption aria-hidden="true">R2</figcaption>
</figure>
<p>直感的には左の方が<strong>回帰直線が実際の値にフィットしており</strong>信頼できそうな気がしますね. <span class="math inline">R^2</span> はその感覚を数値化したものになります.</p>
<figure>
<img src="/images/regression15.png" alt="R2" />
<figcaption aria-hidden="true">R2</figcaption>
</figure>
<p><span class="math inline">R^2</span> は,式から作られた直線と,実際のデータの点の距離の和を変更したものです.
<span class="math inline">R^2</span> が1に近いほど, 式が点によく当てはまっていることを表します.</p>
<p>数値の解釈にも様々ありますが,この講義では</p>
<ul>
<li><p><strong>0.5以上</strong>で予測に利用できる.</p></li>
<li><p><strong>0.8以上</strong>でかなり正確に予測ができる という解釈を採用します.</p></li>
</ul>
</div>
<p>今回のモデルを見てみると,<code>Adj. R-squared:0.243</code>であり,予測精度が高くないことが分かります.</p>
<div class="note">
<ul>
<li><h2 id="有意f-prob-f-statistic"><strong>有意F (Prob (F-statistic))</strong></h2></li>
</ul>
<p>有意Fは求めた標本回帰式でどの程度データの散らばりを説明できるかを検定した結果です.
どのような意味であるか見ていきましょう.</p>
<p>求めた回帰式と,データそれぞれの散らばりは,<strong>全変動</strong>,<strong>回帰変動</strong>,<strong>残渣変動</strong>によって表現可能です.</p>
<p><img src="/images/slds/ch11/prob-f.png" /></p>
<ul>
<li>全変動:データと平均値の差の合計(の二乗和)</li>
</ul>
<p>データの散らばり具合</p>
<p><span class="math display">
\sum_{i=1}^n (y_i-y)^2
</span></p>
<ul>
<li>回帰変動:予測値とデータの平均値の差(の二乗和)</li>
</ul>
<p>データに対する回帰式の予測値の散らばり具合
<span class="math display">
\sum_{i=1}^n (\hat{y}_i-\bar{y})^2
</span></p>
<ul>
<li>残差変動:予測値とデータの差(の二乗和)</li>
</ul>
<p>回帰式とデータのズレの散らばり具合</p>
<p><span class="math display">
\sum_{i=1}^n (y_i-\hat{y})^2
</span></p>
<p>このとき</p>
<p><code>全変動 = 回帰変動+残差変動</code> すなわち,
<span class="math display">
\sum_{i=1}^n (y_i-y)^2 = \sum_{i=1}^n (\hat{y}_i-\bar{y})^2 + \sum_{i=1}^n (y_i-\hat{y})^2
</span>
がなりたちます.</p>
<p>これは言い換えると,</p>
<p><code>データの散らばり=回帰式で説明できる散らばり+回帰式で説明できない散らばり</code></p>
<p>を表しています.</p>
<p>回帰変動の平均と,残差変動の平均の比率を考えると,kを説明変数の数として,</p>
<p><span class="math display">
\begin{align*}
&amp;\frac{回帰変動の平均}{残差変動の平均}
&amp;=\frac{\sum_{i=1}^n (\hat{y}_i-\bar{y})^2 /𝑘}{\sum_{i=1}^n (y_i-\hat{y})^2/(n−k−1)}
\end{align*}
</span></p>
<p>すなわち</p>
<p><span class="math display">
\frac{回帰式で説明できる散らばり}{回帰式で説明できない散らばり}= 回帰式が説明できている割合
</span></p>
<p>が成り立ちます.</p>
<p><img src="/images/slds/ch11/prob-f2.png" /></p>
<p>また,この説明の割合はF分布に従うことが知られており,</p>
<p><span class="math display">
F = \frac{\sum_{i=1}^n (\hat{y}_i-\bar{y})^2 /𝑘}{\sum_{i=1}^n (y_i-\hat{y})^2/(n−k−1)} \sim F(k,n-k-1)
</span></p>
<p><span class="math inline">H_0:F=1</span>(回帰式が説明できる散らばりが説明できないものと等しい)</p>
<p><span class="math inline">H_1:F&gt;1</span> (説明できる量の方が大きい)</p>
<p>として検定した結果のP値が有意Fです.</p>
<p>したがって,有意水準5%のとき,
<code>有意F &lt; 0.05</code> であれば,回帰式全体はデータを説明しているとみなすことができます.</p>
</div>
<p>今回は<code>Prob (F-statistic):0.0159</code>であり,有意に説明できていると言えます.</p>
<div class="note">
<p>したがって今回の結果をまとめると,</p>
<ul>
<li><p><span class="math inline">y=1.03+0.01x</span></p>
<ul>
<li><p>男性の仕事時間に対する家事育児の割合が1%が増えると,出生率が0.01増える</p></li>
<li><p>切片,傾き,式全体は有意(回帰式でデータを説明できる)</p></li>
</ul></li>
<li><p>予測精度は低い(予測には使えない)</p></li>
</ul>
<p>という結果が得られます.</p>
<p>内閣府の分析では,回帰式と<span class="math inline">R^2</span>のみが記載されており,検定結果は載っていませんでしたが,概ね正しい推論と言えます.
ただし,<span class="math inline">Adj. R^2</span> が低いためこの結果をもって,日本の男性の家事育児参加時間をXに増やせば出生率がYになるというような<strong>予測</strong>はできません.</p>
</div>
<h3 data-number="1.2.6" id="結果の可視化"><span class="header-section-number">1.2.6</span> 結果の可視化</h3>
<p>最後に,このモデルを可視化してみましょう. まずは,内閣府の資料と同じ用に散布図に回帰直線を可視化してみます.
<code>OLS().fit()</code>で得られた予測モデルは,<code>.params[]</code>で値を得ることができます.回帰式をxの値と回帰係数から計算し,<code>plt.plot()</code>で直線を引いています.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 回帰直線のためのx軸データとy軸データ</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>x_vals <span class="op">=</span> np.linspace(df_f[<span class="st">&#39;r&#39;</span>].<span class="bu">min</span>(), df_f[<span class="st">&#39;r&#39;</span>].<span class="bu">max</span>(), <span class="dv">100</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_vals)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>y_vals <span class="op">=</span> result.params[<span class="st">&#39;const&#39;</span>] <span class="op">+</span> result.params[<span class="st">&#39;r&#39;</span>] <span class="op">*</span> x_vals</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 描画</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 散布図</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>plt.scatter(df_f[<span class="st">&#39;r&#39;</span>], df_f[<span class="st">&#39;Fertility&#39;</span>], color<span class="op">=</span><span class="st">&#39;blue&#39;</span>, label<span class="op">=</span><span class="st">&#39;Data Points&#39;</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ラベル付け</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>texts <span class="op">=</span> [plt.text(df_f.at[c, <span class="st">&#39;r&#39;</span>], df_f.at[c, <span class="st">&#39;Fertility&#39;</span>], c) <span class="cf">for</span> c <span class="kw">in</span> df_f.index]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>adjust_text(texts, arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, lw<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 回帰直線</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>plt.plot(x_vals, y_vals, color<span class="op">=</span><span class="st">&#39;red&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, label<span class="op">=</span><span class="st">&#39;Regression Line&#39;</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 軸・タイトル・その他</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>plt.xlim <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>plt.ylim <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Unpaid and Care Work&#39;</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Fertility&#39;</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Fertility vs Unpaid and Care Work with Regression Line&#39;</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/oecd_scatter_with_line.png" /></p>
<p>このようなグラフによって実測値に対する回帰直線の当てはまりを確認することもできますが,もう少しわかりやすい手法として,縦軸に実測値 <span class="math inline">Y</span> ,横軸に予測値 <span class="math inline">\hat{\beta}_0 + \sum \hat{\beta}_i X_i</span> をプロットした散布図もよく用いられます.</p>
<p>先ほどとは異なり, <code>.predict()</code>メソッドで元データから計算された予測値を求めています.ここにxの等差級数を渡すことで先程のように回帰直線の値を得ることも可能です.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> result.predict(X)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(y, pred, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">&quot;k&quot;</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Predicted&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Actual&quot;</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Actual vs. Predicted&quot;</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>plt.plot([y.<span class="bu">min</span>(), y.<span class="bu">max</span>()], [y.<span class="bu">min</span>(), y.<span class="bu">max</span>()], color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linestyle<span class="op">=</span><span class="st">&quot;--&quot;</span>)  <span class="co"># 完全一致のライン</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/oecd_pred_actual.png" /></p>
<p>実測値と予測値が一致していれば,この散布図はグラフの45度線(赤い点線)上に一直線になります.
<span class="math inline">R^2</span>の結果通り,あまり予測精度が高くないことがわかります.</p>
<p>実測値と予測値の<code>カーネル密度プロット(KDE; Karnel Densiti Estimation Plot)</code>を重ねたグラフもベイズモデルなどでよく利用される手法です.
実測値の分布と予測値の分布を見比べることで,値全体でどの部分が過大/過少に推測されているかモデルの想定する分布がデータの分布と近いかが視覚化されます.</p>
<p><code>kde</code>の描画には<code>seaborn</code>ライブラリが必要になるので<code>pip install</code>しておきましょう.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(pred, label <span class="op">=</span> <span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(y, label <span class="op">=</span> <span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Actual/Predicted&#39;</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Fertility&#39;</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Density&#39;</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code></pre></div>
<p><img src="/images/slds/ch11/oecd_density.png" /></p>
<p>実測値と予測値で大きく分布が異なることがわかり,やはりあまり良いモデルとはいえなさそうです.</p>
<div class="note">
<ul>
<li>演習問題</li>
</ul>
<p>内閣府の計算で何故か除外されていたMexicoのデータを加えて回帰分析を行い,その結果を解釈してください.</p>
</div>
<h2 data-number="1.3" id="重回帰分析"><span class="header-section-number">1.3</span> 重回帰分析</h2>
<p><span class="math display">
Y = \beta_0 + \beta_1 x_1 + \dots + \beta_n x_n
</span></p>
<p>のように複数の説明変数,回帰係数を利用して目的変数を説明する回帰分析を重回帰分析といいます.
基本的には,単回帰と同じように分析することが可能ですが,いくつかの注意点があります.</p>
<div class="note">
<ul>
<li><h2 id="注意点1-モデル選択">注意点1 : モデル選択</h2></li>
</ul>
<p>前節で扱った単回帰分析では,そもそもデータに説明変数が一つしかなかったためにどの変数を利用するかという選択が必要ありませんでした. しかし,多数の説明変数の存在を前提とする重回帰分析では,<strong>全ての変数をモデルに採用するのではなく</strong>,説明力の高い変数の組み合わせを選択する必要があります.</p>
<p>今回は線形重回帰分析のみを扱いますが,様々なモデルを比較して最適なモデルを選択することを<strong>モデル選択</strong>といいます.
モデル選択においては<strong>多重共線性</strong>などいくつかの判断基準に基づいて変数の選択を行います.</p>
<div class="warn">
<p>今回はモデル明らかに利用できない変数を除外するという処理のみを行いますが,より多くの変数を扱う場合には,<strong>ステップワイズ法</strong>などの手法を用いて機械的に最適な組み合わせを選択する場合があります. そのような手法に関しては次章において扱います.</p>
</div>
<ul>
<li><h2 id="注意点2-データの正規化">注意点2: データの正規化</h2></li>
</ul>
<p>重回帰分析では回帰係数毎に目的変数に対する説明変数の影響力が比較されます.
その場合,同一の基準で比較できるようにデータを正規化する必要があります</p>
</div>
<p>これらの注意点に関して,以下実例を通して概要を説明します.
手順が多く複雑ですが｢回帰分析ができる｣とはこの一連の手順を全て理解して,実行できることを意味しています.
作業を再現しつつ,どのような処理を何故行っているのかを把握するようにしましょう.</p>
<h3 data-number="1.3.1" id="データ準備"><span class="header-section-number">1.3.1</span> データ準備</h3>
<p>事例として<strong>架空の大学生のGPAに関するデータ</strong>を利用します.<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/multiple_regression.csv">こちら</a>からダウンロードして利用して下さい.</p>
<p>各変数とデータの形式は以下のとおりです.</p>
<div class="note">
<ul>
<li>目的変数: <code>GPA</code> (0-5) 量的変数</li>
<li>説明変数:
<ul>
<li><code>Scholarship</code> (TRUE/FALSE) 質的変数;奨学生か否か</li>
<li><code>Study_Hours</code> 量的変数; 1週間の平均勉強時間</li>
<li><code>Sports_hours</code> 量的変数; 1週間の平均運動時間</li>
<li><code>Part_time_Work</code> 量的変数; 1週間の平均バイト時間</li>
</ul></li>
</ul>
<table>
<thead>
<tr class="header">
<th>GPA</th>
<th>Scholarship</th>
<th>Study_Hours</th>
<th>Sports_hours</th>
<th>Part_time_Work</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3.527536588</td>
<td>TRUE</td>
<td>12.95386632</td>
<td>5.454919869</td>
<td>10.64263873</td>
</tr>
<tr class="even">
<td>2.40855012</td>
<td>FALSE</td>
<td>10.68547312</td>
<td>7.614285509</td>
<td>13.35924324</td>
</tr>
<tr class="odd">
<td>2.529088645</td>
<td>TRUE</td>
<td>9.53740687</td>
<td>1.785033531</td>
<td>15.28753044</td>
</tr>
<tr class="even">
<td>2.001397426</td>
<td>TRUE</td>
<td>8.795585218</td>
<td>5.369267717</td>
<td>16.45415926</td>
</tr>
<tr class="odd">
<td>0.965380522</td>
<td>TRUE</td>
<td>4.085912039</td>
<td>5.519765588</td>
<td>15.14785996</td>
</tr>
<tr class="even">
<td>1.34390841</td>
<td>FALSE</td>
<td>7.120623166</td>
<td>6.563645744</td>
<td>15.05862363</td>
</tr>
<tr class="odd">
<td>1.789371684</td>
<td>TRUE</td>
<td>8.157444916</td>
<td>2.526098578</td>
<td>14.15564243</td>
</tr>
<tr class="even">
<td>3.719258275</td>
<td>TRUE</td>
<td>14.2284889</td>
<td>2.359086774</td>
<td>10.15624819</td>
</tr>
<tr class="odd">
<td>2.557462565</td>
<td>TRUE</td>
<td>11.37447316</td>
<td>6.043883131</td>
<td>16.70622459</td>
</tr>
<tr class="even">
<td>0</td>
<td>FALSE</td>
<td>2.947839379</td>
<td>5.593969346</td>
<td>19.04125979</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
</div>
<p>こちらのデータを利用して,GPAに影響する時間の使い方に関して分析します.</p>
<h3 data-number="1.3.2" id="可視化散布図行列"><span class="header-section-number">1.3.2</span> 可視化(散布図行列)</h3>
<p>まずは散布図行列で組み合わせごとの特徴を把握します.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> japanize_matplotlib</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&#39;multiple_regression.csv&#39;</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 散布図行列の作成</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>pd.plotting.scatter_matrix(df[[<span class="st">&#39;GPA&#39;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>                              ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>                              ,<span class="st">&#39;Sports_hours&#39;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                              ,<span class="st">&#39;Part_time_Work&#39;</span>]], range_padding<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>散布図行列において各交点には,異なる変数の場合は散布図,同じ変数の場合はヒストグラムが表示されています.
Scholorshipは質的変数なので除外しています.</p>
<p><img src="/images/slds/ch11/multi-regression1.png" /></p>
<p>散布図行列を確認する場合は,散布図とヒストグラムそれぞれを確認する必要があります.それぞれの見方は可視化の章で説明したとおりです.</p>
<div class="note">
<p>散布図を見る際には,まず<strong>目的変数-説明変数の関係</strong>に注目します.
GPAに対して<code>Study_Hours</code>,<code>Part_time_Work</code>は相関がありそうに見えます.</p>
<p>続いて,<strong>説明変数同士の関係</strong>にも注意が必要です.これは後に扱う<strong>多重共線性</strong>を考慮するためにも重要です.
説明変数同士も<code>Study_Hours</code>と,<code>Part_time_Work</code>には相関がありそうです.</p>
<p>次に,ヒストグラムを見ると<code>Study_Hours</code>,<code>Sports_Hours</code>,<code>Part_time_Work</code>はいずれも単峰で左右対称な分布で,外れ値もありません
しかし,<code>GPA</code>は多峰な分布になっているので,層別の必要性があります.</p>
</div>
<h3 data-number="1.3.3" id="可視化ヒートマップ"><span class="header-section-number">1.3.3</span> 可視化(ヒートマップ)</h3>
<p>散布図では相関の有無は明確にならないので量的変数ごとに相関係数のヒートマップを作成し,より詳細に見てみます.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ヒートマップで確認</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df[[<span class="st">&#39;GPA&#39;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>               ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>               ,<span class="st">&#39;Sports_hours&#39;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>               ,<span class="st">&#39;Part_time_Work&#39;</span>]].corr()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>            ,vmax<span class="op">=</span><span class="dv">1</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            ,vmin<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>            ,annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/multi-regression3.png" /></p>
<p>注目する点は,基本的に散布図と同様です.</p>
<div class="note">
<ul>
<li><h2 id="目的変数-説明変数">目的変数-説明変数</h2>
<ul>
<li><code>GPA-Study_Hours</code>にかなり強い正の相関</li>
<li><code>GPA-Part_time_Work</code>に強い負の相関</li>
</ul></li>
</ul>
<p>目的変数-説明変数に相関がある場合には,回帰分析において有意になる可能性が高く,説明変数として採用する可能性が高いです.</p>
<ul>
<li><h2 id="説明変数-説明変数">説明変数-説明変数</h2>
<ul>
<li>Study_Hours-Part_time_Workにも強い負の相関</li>
</ul>
バイト時間が長いと勉強時間が少なくなるという関係.</li>
</ul>
<p>説明変数同士に相関が見られる場合は,多重共線性を避けるために,片方(基本的には目的変数と相関係数が低い方)の変数を除外する必要があります</p>
</div>
<h3 data-number="1.3.4" id="多重共線性完全な多重共線性"><span class="header-section-number">1.3.4</span> 多重共線性(完全な多重共線性)</h3>
<p><strong>多重共線性</strong>とは,説明変数間に強い相関関係があることで回帰係数の推定精度が落ちることを意味します.
多重共線性が見られる場合に推定された回帰係数は数値に根拠がないため利用できません.強い相関が見られる説明変数は,目的変数に対する相関係数が高い方を残して,片方を除外する必要があります.</p>
<p>説明変数<span class="math inline">x_1,x_2,...,x_n</span>において,特定の変数<span class="math inline">x_i</span>が他の変数によって</p>
<p><span class="math display"> x_i = \sum_{i \neq j} \alpha_j x_j </span></p>
<p>として,少なくとも1つが0でない定数<span class="math inline">\alpha_j</span>によって表すことができる場合に,｢説明変数に完全な多重共線性が成り立っている｣ といいます.</p>
<p>このとき,最小二乗法では,<span class="math inline">Y = \beta_0 + \beta_1 x_1 + \dots + \beta_n x_n</span>を解くことができなくなるため,解が得られなくなります.</p>
<p>完全な多重共線性は基本的に，特定の説明変数を変形して別の説明変数を追加した場合に生じるので，特定の変数を変形した変数はいれるべきではありません．</p>
<div class="note">
<p>例: <span class="math inline">x_1=\alpha_2 x_2</span>であるとすると,
<span class="math display"> y=\beta_0+(\beta_1+\alpha_2 \beta_2)x_2 + \beta_3 x_3 + \dots \beta_n x_n </span></p>
<p>推定値が <span class="math inline">\hat{\beta}_12 = \hat{\beta}_1 + \alpha_2 \hat{\beta}_2</span> であるとすると,<span class="math inline">\hat{\beta}_12</span> となる<span class="math inline">\hat{\beta}_1</span> と <span class="math inline">\hat{\beta}_2</span> の組み合わせは無数にあるため,具体的な値を特定できません.</p>
</div>
<h3 data-number="1.3.5" id="多重共線性弱い多重共線性"><span class="header-section-number">1.3.5</span> 多重共線性(弱い多重共線性)</h3>
<p><span class="math display">x_i \approx \sum_{i \neq j}\alpha_j x_j</span></p>
<p>で成り立つ <strong>(完全ではない/弱い) 多重共線性</strong>という概念もあります.
これは,説明変数間に完全相関以外の相関が成り立つ場合の多重共線性です.</p>
<p>変数間に相関がある場合</p>
<pre><code>-   サンプルサイズによって推定値が大きく変わる
-   標本によって推定値が大きく変わる</code></pre>
<p>など,推定値が不安定になります.</p>
<p>多重共線性を避けるために,変数間の相関が強い場合には片方を除外する必要があります.
どちらの変数を残すかに関する基準には数理的なものもありますが,</p>
<ul>
<li><p>検証したい仮説と関連の強いもの</p></li>
<li><p>目的変数に対する相関係数がより高い変数</p></li>
</ul>
<p>を残すようにしましょう.</p>
<div class="note">
<p>今回は,<code>Part_time_Work</code> を説明変数から除外します.</p>
</div>
<h3 data-number="1.3.6" id="可視化層別とペアプロット"><span class="header-section-number">1.3.6</span> 可視化(層別とペアプロット)</h3>
<p>散布図/ヒートマップを参考に多重共線性に関する示唆を得ることができました.
続いて,ヒストグラムについてもう少し深堀りしてみましょう.ヒストグラムが多峰になっていたので,試しに唯一の質的変数である,<code>Scholarship</code>でデータを層別した散布図行列を作成してみます.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sns.pairplot(df[[<span class="st">&#39;GPA&#39;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Sports_hours&#39;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Scholarship&#39;</span>]]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                , diag_kind<span class="op">=</span><span class="st">&quot;hist&quot;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                , hue<span class="op">=</span><span class="st">&quot;Scholarship&quot;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                , palette<span class="op">=</span><span class="st">&quot;Set2&quot;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                , diag_kws<span class="op">=</span><span class="bu">dict</span>(bins<span class="op">=</span><span class="dv">8</span>))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">&quot;Scatterplot Matrix with Scholarship&quot;</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/multi-regression2.png" /></p>
<p>奨学金をもらっている(True)の分布と,もらっていない(False)分布で<code>GPA</code>が異なることが分かります.
つまり,奨学生とそれ以外の影響を分析に追加するべきであることが分かります.
それ以外の変数はそれほど違いがありません.
奨学金あり/なしいずれも単峰ではありませんが,今回はこれ以上分割する情報がないのでこちらで分析を進めていきます</p>
<h3 data-number="1.3.7" id="可視化層別とジョイントプロット"><span class="header-section-number">1.3.7</span> 可視化(層別とジョイントプロット)</h3>
<p><code>GPA</code>に対して,<code>Study_Hours</code>の影響が最も強そうなので,この2変数に注目してもう少し詳細に見てみましょう.
この2変数のジョイントプロットを作成してみます.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#joinplotで男女別に密度プロットを表示</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> sns.jointplot(data <span class="op">=</span> df</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                   ,x <span class="op">=</span><span class="st">&quot;Study_Hours&quot;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                   ,y <span class="op">=</span><span class="st">&quot;GPA&quot;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                   ,hue<span class="op">=</span><span class="st">&#39;Scholarship&#39;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                   ,joint_kws <span class="op">=</span> <span class="bu">dict</span>(alpha<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/multi-regression4.png" /></p>
<p>基本的には勉強時間が上がるほど,GPAが高くなるという傾向が見られます.
また,奨学生の方が非奨学生よりも全体的に<code>GPA</code>が高いことが散布図,カーネル密度プロットの双方から分かります.</p>
<p>しかし,<code>Scholarships</code>は質的変数であり,そのままではこの影響を回帰分析に組み込むことができません.どのようにしたら良いのでしょうか?</p>
<h3 data-number="1.3.8" id="ダミー変数化数量化1類"><span class="header-section-number">1.3.8</span> ダミー変数化(数量化1類)</h3>
<p>説明変数に質的データを含める重回帰分析を<strong>数量化1類(Quantification Method Type I)</strong>といいます.</p>
<p>基本的に回帰分析における質的データは<code>0/1</code>からなる擬似的な量的変数である<strong>ダミー変数</strong>に変換して処理しますがこのような数への変換を総じて<strong>数量化</strong>といいます.</p>
<div class="warn">
<p>数量化にはこの他にも,目的変数と説明変数がともに質的データの場合の<strong>数量化2類(Quantification Method Type Ⅱ)</strong>, 説明変数に量的データが混ざっている場合の<strong>拡張型数量化2類</strong>などがあり,数量化3,4,5,6類なども存在します.</p>
<p>数量化2類に関してはロジスティック回帰,数量化3類に関しては主成分分析が同様の目的で利用されるため,これらに関しては本資料では扱いません.</p>
</div>
<p>例えば,以下のような身長と体重,性別,国籍からなるデータがあった場合,新たに性別,国籍の種別の列を設けて当てはまる行に1,当てはまらない行に0を入力する変換を行います.</p>
<ul>
<li>変換前のデータ</li>
</ul>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>体重</th>
<th>身長</th>
<th>性別</th>
<th>国籍</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>65</td>
<td>170</td>
<td>男</td>
<td>日本</td>
</tr>
<tr class="even">
<td>2</td>
<td>58</td>
<td>174</td>
<td>女</td>
<td>米国</td>
</tr>
<tr class="odd">
<td>3</td>
<td>78</td>
<td>189</td>
<td>男</td>
<td>オランダ</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<ul>
<li>ダミー変数に変換したデータ</li>
</ul>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>体重</th>
<th>身長</th>
<th>性別 男</th>
<th>日本</th>
<th>米国</th>
<th>オランダ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>65</td>
<td>170</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>2</td>
<td>58</td>
<td>174</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>78</td>
<td>189</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>それでは,<code>Scholarships</code>をダミー変数化してみましょう.pandasでは<code>get_dummies</code>関数で簡単に実装できます.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリカルデータのダミー変数化</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># get_dummies関数を使う(dtype=&#39;it&#39;で0/1の数値に変換)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.get_dummies(df,columns<span class="op">=</span>[<span class="st">&#39;Scholarship&#39;</span>],dtype<span class="op">=</span><span class="st">&#39;int&#39;</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Unnamed: 0       GPA  Study_Hours  Sports_hours  Part_time_Work  Scholarship_False  Scholarship_True</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">0            0  3.527537    12.953866      5.454920       10.642639                  0                 1</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">1            1  2.408550    10.685473      7.614286       13.359243                  1                 0</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">2            2  2.529089     9.537407      1.785034       15.287530                  0                 1</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">3            3  2.001397     8.795585      5.369268       16.454159                  0                 1</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">4            4  0.965381     4.085912      5.519766       15.147860                  0                 1</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">..         ...       ...          ...           ...             ...                ...               ...</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">95          95  4.000000    16.199738      6.267838        9.986043                  1                 0</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">96          96  1.782450     6.866987      0.949715       14.228814                  1                 0</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">97          97  1.350890     8.711754      5.372909       14.130176                  1                 0</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">98          98  2.515160    13.254069      3.676427       12.873422                  1                 0</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">99          99  1.269809     5.076543      6.704867       15.826625                  0                 1</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<h3 data-number="1.3.9" id="正規化標準化"><span class="header-section-number">1.3.9</span> 正規化・標準化</h3>
<p>重回帰分析では, 単回帰分析と異なり複数の変数の影響を比較します.その際に例えば, 値1の単位がmm, 値2の単位がm, 値3の単位が%などことなると正確に比較できません.
そこで, データの単位などを揃える操作として正規化か標準化を行う必要があります.</p>
<div class="note">
<ul>
<li>正規化</li>
</ul>
<p>最大値を1, 最小値を0にそろえること.</p>
<p><span class="math display">x{\prime}_i = \frac{x_i - \min(X)}{\max(X) - \min(X)}</span></p>
<ul>
<li>標準化</li>
</ul>
<p>標準得点を求めて, 平均0分散1に揃える.</p>
<p><span class="math display">z_i = \frac{x_i - \bar{x}}{\sigma}</span></p>
</div>
<p>正規化/標準化された値によって求められた回帰係数は目的変数に対するそれぞれの説明変数の影響力を表します.
ただし, 単位が元のデータとは異なるので注意が必要です.</p>
<p>基本的には標準化が推奨されますが明確な使い分けはなく,正規化のほうが直感的に影響力が理解されやすいため簡便な分析では利用される場合があります.</p>
<div class="warn">
<p>標準化は元のデータが正規分布であることを前提に実施されます.
分布が明らかに異なる場合は正規化が採用される場合もありますが,重回帰分析自体がそのような仮定のもとで実施されているため,今回の分析では暗黙に正規分布を仮定しています.</p>
</div>
<p>以下の分析では標準化を実施してみます. 標準化は,自分で標準偏差などを求めて計算することも可能ですが<code>sklearn.preprocessing</code> の<code>StandardScaler</code>を利用すると簡単に実装できます.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#標準化</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>   ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>   ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>   ,<span class="st">&#39;Sports_hours&#39;</span>]] <span class="op">=</span> scaler.fit_transform(df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Sports_hours&#39;</span>]])</span></code></pre></div>
<p>なお正規化も同様に<code>MinMaxScaler</code>を利用することができます.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#正規化</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 正規化（0〜1に変換）</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">&#39;Scholarship_True&#39;</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Study_Hours&#39;</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Part_time_Work&#39;</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Sports_hours&#39;</span>]] <span class="op">=</span> scaler.fit_transform(df[[<span class="st">&#39;Scholarship_True&#39;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Study_Hours&#39;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Part_time_Work&#39;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                                               ,<span class="st">&#39;Sports_hours&#39;</span>]])</span></code></pre></div>
<h3 data-number="1.3.10" id="モデル選択"><span class="header-section-number">1.3.10</span> モデル選択</h3>
<p>まずは, <code>Part_time_Work</code>を除外し,<code>Scholarship</code>のダミー変数<code>Scholarship_True</code>を含める<strong>標準化された</strong>説明変数で重回帰分析を実施してみます.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 説明変数(X)と目的変数(y)に分割</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[[<span class="st">&#39;Scholarship_True&#39;</span>, <span class="st">&#39;Study_Hours&#39;</span>,<span class="st">&#39;Sports_hours&#39;</span>]]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">&#39;GPA&#39;</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 切片(定数項)を追加</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 回帰モデルを作成・フィット</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果を表示</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result.summary())</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">                            OLS Regression Results</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">Dep. Variable:                    GPA   R-squared:                       0.944</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co">Model:                            OLS   Adj. R-squared:                  0.943</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co">Method:                 Least Squares   F-statistic:                     543.5</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co">Date:                Fri, 24 Oct 2025   Prob (F-statistic):           4.46e-60</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co">Time:                        12:48:46   Log-Likelihood:                -7.4041</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co">No. Observations:                 100   AIC:                             22.81</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co">Df Residuals:                      96   BIC:                             33.23</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co">Df Model:                           3</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co">Covariance Type:            nonrobust</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co">====================================================================================</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co">                       coef    std err          t      P&gt;|t|      [0.025      0.975]</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------------------------------------------------------------------</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co">const                1.8366      0.027     69.060      0.000       1.784       1.889</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co">Scholarship_True     0.2556      0.027      9.574      0.000       0.203       0.309</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co">Study_Hours          1.0213      0.027     38.262      0.000       0.968       1.074</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co">Sports_hours         0.0152      0.027      0.570      0.570      -0.038       0.068</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="co">Omnibus:                       22.718   Durbin-Watson:                   2.026</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="co">Prob(Omnibus):                  0.000   Jarque-Bera (JB):               62.615</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="co">Skew:                           0.732   Prob(JB):                     2.53e-14</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="co">Kurtosis:                       6.590   Cond. No.                         1.09</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>注目すべきポイントは基本的に単回帰分析と同様です.</p>
<div class="note">
<ul>
<li><p>自由度調整済み決定係数(0.943); 予測精度非常に高い</p></li>
<li><p>F値(4.46e-60); 説明力あり</p></li>
<li><p>回帰係数; 勉強時間が一番影響力が強い</p></li>
</ul>
<p>ただし,標準化されているため｢<code>Study_Hours</code>が1時間伸びると<code>GPA</code>が1.02増える｣といった解釈はできないことに注意してください.</p>
<ul>
<li><p>P値; Sports_Hours以外有意</p></li>
<li><p>区間推定値; Sports_Hours以外有意</p></li>
</ul>
</div>
<p>F値や <span class="math inline">R^2</span> が良く概ね良い結果が出たように思えますが,この結果をもってなにか結論を導くことは<strong>できません.</strong></p>
<div class="note">
<ul>
<li>できない理由</li>
</ul>
<p><strong>Sport_Hoursの回帰係数が有意ではない</strong></p>
<p>一部の社会科学では,有意ではない変数を含めて,有意である変数のみで結果を解釈するという方法論がしばしば用いられますが,モデル全体では有意ではない変数によってその他の変数の結果も影響を受けるため,この講義では有意ではない変数はモデルから除外することを推奨します.</p>
<p>その他,変数ごとのP値を比較して信頼度として解釈するようなことも行われがちですが,この講義ではそのような手法は行いません.</p>
</div>
<p>多重共線性とP値を考慮して, <code>Part_time_Work</code>を説明変数から除外したモデルでの分析を実施してみます.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sports_hours を除外し説明変数(X)と目的変数(y)に分割</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df[[<span class="st">&#39;Scholarship_True&#39;</span>, <span class="st">&#39;Study_Hours&#39;</span>]]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">&#39;GPA&#39;</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 切片(定数項)を追加</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 回帰モデルを作成・フィット</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果を表示</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result.summary())</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">                            OLS Regression Results</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">Dep. Variable:                    GPA   R-squared:                       0.944</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">Model:                            OLS   Adj. R-squared:                  0.943</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">Method:                 Least Squares   F-statistic:                     820.8</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">Date:                Fri, 24 Oct 2025   Prob (F-statistic):           1.62e-61</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">Time:                        12:48:49   Log-Likelihood:                -7.5729</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">No. Observations:                 100   AIC:                             21.15</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">Df Residuals:                      97   BIC:                             28.96</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">Df Model:                           2</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co">Covariance Type:            nonrobust</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co">====================================================================================</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co">                       coef    std err          t      P&gt;|t|      [0.025      0.975]</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------------------------------------------------------------------</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co">const                1.8366      0.027     69.301      0.000       1.784       1.889</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co">Scholarship_True     0.2557      0.027      9.613      0.000       0.203       0.308</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co">Study_Hours          1.0213      0.027     38.398      0.000       0.969       1.074</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co">Omnibus:                       23.472   Durbin-Watson:                   2.005</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="co">Prob(Omnibus):                  0.000   Jarque-Bera (JB):               63.596</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="co">Skew:                           0.769   Prob(JB):                     1.55e-14</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="co">Kurtosis:                       6.591   Cond. No.                         1.09</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================================</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<div class="note">
<ul>
<li><p>自由度調整済み決定係数(0.943); (変化無し)予測精度非常に高い</p></li>
<li><p>F値(1.62e-61); (改善) 説明力あり</p></li>
<li><p>回帰係数; 勉強時間が一番影響力が強い</p></li>
<li><p>P値; 全て有意</p></li>
<li><p>区間推定値; 全て有意</p></li>
</ul>
</div>
<p><code>Sports_hours</code>を除外したことで全ての変数が有意となり,F値等も問題がないため選択した説明変数によって,目的変数が説明するモデルが作成できたことになります.</p>
<div class="note">
<p>今回は有意ではないものを除外することで,信頼のおける回帰式を推論することができました.</p>
<p>この結果から,</p>
<ul>
<li><p>奨学生の方がGPAが良いこと</p></li>
<li><p>勉強時間が多いほどGPAが高いこと</p></li>
<li><p>勉強時間の方が奨学生であることよりもGPAには効果があること</p></li>
<li><p>｢奨学生であるか｣｢勉強時間｣からGPAが予測できること</p></li>
</ul>
<p>などが示されました.</p>
<p>なお,今回の結果から</p>
<ul>
<li><p>バイト時間が多いほどGPAが少ない</p></li>
<li><p>バイト時間や運動時間ではGPAを説明できない</p></li>
</ul>
<p>などの仮説がたてられますが,それが検証されたわけではないことに注意が必要です.
(仮説検定は,棄却されて初めて具体的な主張が可能です.)</p>
</div>
<h3 data-number="1.3.11" id="aicについて"><span class="header-section-number">1.3.11</span> AICについて</h3>
<p>今回は,有意ではない,かつ多重共線性のある説明変数を除外することで適当なモデルを選択することができました.</p>
<p>しかし,全ての変数が有意なモデル同士はどのように比較するのでしょうか.
例えば, <span class="math inline">Adj.R^2</span> や 𝑃𝑟𝑜𝑏(𝐹−𝑠𝑡𝑎𝑡𝑖𝑠𝑡𝑖𝑐)を比較してみると</p>
<ul>
<li><p>Sports_Hours あり <span class="math inline">Adj.R^2</span> : 0.943, 𝑃𝑟𝑜𝑏(𝐹−𝑠𝑡𝑎𝑡𝑖𝑠𝑡𝑖𝑐):4.46e-60</p></li>
<li><p>Sports_Hours なし <span class="math inline">Adj.R^2</span> : 0.943, 𝑃𝑟𝑜𝑏(𝐹−𝑠𝑡𝑎𝑡𝑖𝑠𝑡𝑖𝑐):1.62e-61</p></li>
</ul>
<p>とそれほどの差はありません.</p>
<p>モデルの比較を行う際には基本的にこれらの値を利用するのではなく, <strong>AIC (赤池情報量基準、Akaike‘s Information Criterion)</strong>や <strong>BIC(ベイズ情報量規準, Bayesian information criterion)</strong>を利用するのが一般的です.</p>
<p>詳細は次の章などで扱いますが,いずれも｢モデルの良さ｣を表す基準であり,値が小さいほど良いモデルとなります.
Sports_Hours あり/なしを比較すると,AIC(22.81→21.15),BIC(33.23→28.96)共にSports_Hoursを除外したモデルのほうが値が小さいことが分かります.</p>
<h3 data-number="1.3.12" id="結果の可視化-1"><span class="header-section-number">1.3.12</span> 結果の可視化</h3>
<p>回帰分析の結果を画像でも確認してみます.
最も単純な回帰の結果を表すグラフは,縦軸に実測値Y,横軸に予測値をプロットした散布図です.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(y, pred, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">&quot;k&quot;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Predicted&quot;</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Actual&quot;</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Actual vs. Predicted&quot;</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>plt.plot([y.<span class="bu">min</span>(), y.<span class="bu">max</span>()], [y.<span class="bu">min</span>(), y.<span class="bu">max</span>()], color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linestyle<span class="op">=</span><span class="st">&quot;--&quot;</span>)  <span class="co"># 完全一致のライン</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>実測値と予測値が一致していれば,この散布図はグラフの45度線(赤い点線)上に一直線になります.
殆どの点が45度線付近に集まっているからかなり正確に予測ができていることが分かります.</p>
<p><img src="/images/slds/ch11/multi-regression5.png" /></p>
<p>実測値と予測値の<strong>カーネル密度プロット (Karnel Densiti Estimation Plot)</strong>を重ねたグラフもベイズモデルなどでよく利用される手法です.
ここでは<code>seaborn</code>の<code>kdeplot</code>を利用してカーネル密度プロットを行ってみます.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#予測結果の作成</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> result.predict(X)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(pred, label <span class="op">=</span> <span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(y, label <span class="op">=</span> <span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Actual/Predicted&#39;</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;GPA&#39;</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Density&#39;</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/multi-regression6.png" /></p>
<p>実測値の分布と予測値の分布を見比べることで,値全体でどの部分が過大/過少に推測されているかモデルの想定する分布がデータの分布と近いかがが視覚化されます.</p>
<p>基本的には実測値の分布を正しく予測できていることが分かります.</p>
<p>その他によく用いられるグラフに<strong>Partial Regression Plot</strong>や<strong>Added-Variable Plot</strong>と呼ばれるグラフがあります..</p>
<ul>
<li><p>縦軸に <span class="math inline">X_i</span> 以外の変数で <span class="math inline">Y</span> を回帰した際の残差(他の変数の影響を取り除いたYの変動)</p></li>
<li><p>横軸に <span class="math inline">X_i</span> 以外の変数で<span class="math inline">X_i</span> を回帰した際の残差(他の変数の影響を取り除いた<span class="math inline">X_i</span> の変動)</p></li>
</ul>
<p>がプロットされています.</p>
<p><code>statsmodels</code>では,そのための<code>plot_partregress_grid</code>というメソッドが準備されています.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.regressionplots <span class="im">import</span> plot_partregress_grid</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>,<span class="dv">8</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>plot_partregress_grid(result, fig<span class="op">=</span>fig)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/slds/ch11/multi-regression7.png" /></p>
<p>このグラフでは他の変数の影響を取り除いた上でのYと<span class="math inline">X_i</span>の関係を可視化する手法であり,回帰直線の傾きが大きいほど他の変数の影響を取り除いた上での<span class="math inline">X_i</span>のYへの影響力が強いことが分かります.</p>
]]></description>
    <pubDate>Thu, 30 Oct 2025 00:00:00 UT</pubDate>
    <guid>/lectures/slds11.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>代数プログラミング入門 Ch6 代数的データ型2</title>
    <link>/lectures/iap6.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>

</div>
<p>データ型が対象(集合), 関数が射,圏と圏の関数が関手, クラスが(部分圏), 多相型が自然変換</p>
]]></description>
    <pubDate>Fri, 06 Jun 2025 00:00:00 UT</pubDate>
    <guid>/lectures/iap6.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>特別講義DS Ch3 Pythonと環境構築</title>
    <link>/lectures/slds3.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#イントロダクション" id="toc-イントロダクション"><span class="toc-section-number">1</span> イントロダクション</a>
<ul>
<li><a href="#プログラミング言語の種類" id="toc-プログラミング言語の種類"><span class="toc-section-number">1.1</span> プログラミング言語の種類</a></li>
<li><a href="#授業準備" id="toc-授業準備"><span class="toc-section-number">1.2</span> 授業準備</a>
<ul>
<li><a href="#テキストエディタ" id="toc-テキストエディタ"><span class="toc-section-number">1.2.1</span> テキストエディタ</a></li>
</ul></li>
<li><a href="#imeの設定" id="toc-imeの設定"><span class="toc-section-number">1.3</span> IMEの設定</a></li>
<li><a href="#cliの基本操作" id="toc-cliの基本操作"><span class="toc-section-number">1.4</span> CLIの基本操作</a>
<ul>
<li><a href="#エンコーディング" id="toc-エンコーディング"><span class="toc-section-number">1.4.1</span> エンコーディング</a></li>
<li><a href="#日本語表示" id="toc-日本語表示"><span class="toc-section-number">1.4.2</span> 日本語表示</a></li>
<li><a href="#ディレクトリ" id="toc-ディレクトリ"><span class="toc-section-number">1.4.3</span> ディレクトリ</a></li>
</ul></li>
<li><a href="#基礎的なコマンド" id="toc-基礎的なコマンド"><span class="toc-section-number">1.5</span> 基礎的なコマンド</a></li>
<li><a href="#環境構築" id="toc-環境構築"><span class="toc-section-number">1.6</span> 環境構築</a>
<ul>
<li><a href="#現状の開発環境の削除" id="toc-現状の開発環境の削除"><span class="toc-section-number">1.6.1</span> 現状の開発環境の削除</a></li>
<li><a href="#pyenvのインストール" id="toc-pyenvのインストール"><span class="toc-section-number">1.6.2</span> pyenvのインストール</a></li>
<li><a href="#pythonのインストール" id="toc-pythonのインストール"><span class="toc-section-number">1.6.3</span> Pythonのインストール</a></li>
</ul></li>
<li><a href="#hello-world" id="toc-hello-world"><span class="toc-section-number">1.7</span> Hello World</a></li>
<li><a href="#プログラミングの勉強の仕方" id="toc-プログラミングの勉強の仕方"><span class="toc-section-number">1.8</span> プログラミングの勉強の仕方</a></li>
</ul></li>
</ul>
</div>
<h1 data-number="1" id="イントロダクション"><span class="header-section-number">1</span> イントロダクション</h1>
<p>データサイエンスは,データを利用して現象を発見したり,予測をする科学の総称です. データの作成やデータを分析する前の処理,利用するコンピュータ関連の技術なども対象となります.</p>
<p>データサイエンスと関連の深い分野/用語として統計や機械学習,AIがありますが,それらもデータサイエンスの一部とみなすことができます.</p>
<p>統計は,データ自体の取得・作成・集計から,データの構造を分かりやすく分析・可視化する学問です.機械学習は,データから予測モデルを作り,意思決定などに応用する学問です. 統計や機械学習・AIは明確に分割することができるものではなく,かなりの部分が共通しています. 特に皆さんがこの講義の先修科目である統計学入門で学んだ,初歩的な統計は,機械学習やAI,データサイエンス全般を学ぶ上で,前提知識となります.この他,どちらかに分類できるわけではない,モデリング,AI,シミュレーション,最適化,次元削減,など様々なトピックが含まれています.</p>
<figure>
<img src="/images/data-science-and-components.png" alt="データサイエンス" />
<figcaption aria-hidden="true">データサイエンス</figcaption>
</figure>
<p>この講義では,統計学入門で学んだ,可視化,数値化,検定,回帰などの統計学の手法をPCを使って行う他,統計学入門の範囲を超えたより発展的な手法に関しても学習します.</p>
<p>しかし,このようにデータサイエンスは非常に広範な学問なので,統計学入門のように個別の手法に関して,細かく理解することはせず,それぞれの概要と利用方に関してのみを扱います.</p>
<h2 data-number="1.1" id="プログラミング言語の種類"><span class="header-section-number">1.1</span> プログラミング言語の種類</h2>
<p>データサイエンスは言葉の通り,データを扱います. 現在ではデータは基本的に,電子データとして収集,処理されるため,それらの編集,処理にはコンピュータを利用し,操作は基本的にはプログラムによってなされます. したがってプログラミングは,データサイエンスのための前提知識となります.</p>
<p>この講義では最終的には,学生それぞれに研究のためのプログラムを組んでもらいます.
データサイエンスや統計でよく使われる言語は, Python, Julia, R, SPSS, matlab などいくつかありますが, この授業では, 現在世界的に広く使われており,習得も容易なPythonを利用します.</p>
<p>プログラミング言語には沢山の種類がありますが,言語によって機能や得意なことが異なります.</p>
<figure>
<img src="/images/2024-04-08-lecture-DS-languages.png" alt="Langage icons" />
<figcaption aria-hidden="true">Langage icons</figcaption>
</figure>
<p>プログラミング言語は <strong>実行方式</strong>, <strong>書き方</strong>,<strong>検査の仕方</strong>などの特徴がそれぞれ異なり,大まかにはそれぞれ以下のような意味になります.</p>
<hr />
<p><strong>実行方式</strong></p>
<p>プログラミング言語は,人間にとって理解しやすくデータ構造やアルゴリズムを記述するための手段です.しかし,コンピュータはプログラミング言語を直接理解することはできません.そのため,書かれたプログラムはコンピュータが解釈できる形式,すなわち0と1のビット列である機械語に翻訳される必要があります.この翻訳プロセスは,プログラムの実行方式を以下の二つに分ける要因となります.</p>
<div class="note">
<ul>
<li>インタプリタ方式</li>
</ul>
<p>インタプリタ方式では,プログラムは逐次的に機械語に翻訳されながら実行されます.この方式の特徴は,コンパイルする必要がないため,翻訳と実行が同時に行われる点です.これにより,プログラムの変更がすぐに反映されるため,開発中のテストやデバッグが容易になります.しかし,実行のたびに翻訳を行う必要があるため,実行速度が遅くなることが欠点です.</p>
</div>
<div class="note">
<ul>
<li>コンパイラ方式</li>
</ul>
<p>コンパイラ方式では,プログラム全体が事前に機械語に翻訳され,その結果として得られる実行可能なプログラムが生成されます.コンパイラ方式の利点は,一度コンパイルされたプログラムは,何度も実行される際に追加の翻訳が不要であるため,実行速度が速いことです.また,コンパイル時にプログラム全体を分析できるため,エラーやバグの発見が早期に行え,より安全性が高まるという利点があります.</p>
</div>
<p>この二つの実行方式は,プログラムの性質や用途に応じて選択されます.インタプリタ方式は開発の柔軟性が求められる場合に適しており,コンパイラ方式は性能が重視される場合に好まれます.プログラマはこれらの特性を理解し,それぞれの場面で最適な選択をすることが求められます.</p>
<hr />
<p><strong>書き方</strong></p>
<p>プログラミングとは,基本的にコンピュータに対して実行してほしい命令を記述する作業です.現在主流のプログラミング言語には,大まかに<strong>手続き型言語</strong>と<strong>関数型言語</strong>の二つの記述方法が存在します.</p>
<div class="note">
<ul>
<li>手続き型言語</li>
</ul>
<p>この言語タイプでは,プログラムが｢何を,どうするか｣を順番に記述していきます. Python,Java,VBAなど多くの広く使われている言語がこの方法を採用しています. これにより,処理の流れが直観的に理解しやすくなります.</p>
</div>
<div class="note">
<ul>
<li>関数型言語</li>
</ul>
<p>関数型言語では,プログラムを実行によってユーザーが得たい結果を抽象化し,関数の組み合わせで記述します.このアプローチは,安全性の向上やデバッグのしやすさといったメリットを提供しますが. 概念の抽象化により理解が難しくなることがあります.</p>
</div>
<p>近年では,手続き型言語にも関数型の構文が取り入れられるようになり,手続き型言語内で関数型風に記述することや,その逆も可能になっています.</p>
<p>これらの違いについて更に詳しく知りたい方は,別の<a href="/lectures/2024-03-29-introduction-to-algebraic-programing.html">講義資料</a>で更に詳しく説明しています.</p>
<hr />
<p><strong>検査の仕方</strong></p>
<p>プログラミングは,データ構造とアルゴリズムを使用して命令を記述する作業です.ここではデータ型の詳細に深くは触れませんが,あらゆるプログラミング言語において,データはコンピュータのメモリ上に数値の羅列として存在します.それらの数値に意味を与えることでデータ型が形成されます.</p>
<p>プログラムは実行時に,これらのデータ型が適切に使用されているかを検査します.主な検査方法には<strong>動的型付け</strong>と<strong>静的型付け</strong>があります.動的型付けでは,プログラムの実行時にデータ型が決定され,静的型付けではコンパイル時にデータ型が固定されます.さらに,型付けには「弱い型付け」と「強い型付け」という区別も存在しますが,この講義ではその詳細には触れません.興味のある方は,このトピックについてさらに調査してみてください.</p>
<div class="note">
<ul>
<li>動的型付け
動的型付けのシステムでは,プログラマが変数の型を明示的に宣言する必要がありません.代わりに,コンピュータはプログラムの実行時に型を推論し,適切な型を自動で割り当てます.この柔軟性により,プログラマはより迅速に開発を進めることが可能になります.一方で,このシステムではコンパイル時の型チェックが行われないため,実行時に型関連のエラーが発生するリスクが高まります.そのため,安全性を確保するためには,プログラマ自身が型の整合性に注意を払い,エラー処理やテストにより問題を検出する必要があります.</li>
</ul>
</div>
<div class="note">
<ul>
<li>静的型付け</li>
</ul>
<p>静的型付けでは,プログラマが変数や関数の型をコード内で明示的に宣言し,これらはコンパイル時にチェックされます.この事前の型チェックにより,プログラムの安全性が向上し,実行時のエラーが減少します.また,コンパイラが型情報を利用して効率的なコード生成を行い,パフォーマンスが向上することがあります.静的型付けは特に,大規模プロジェクトや高い信頼性が求められる場合に適しています.</p>
</div>
<hr />
<p>プログラミング言語は,このような区分や,それ以外の様々な機能によって,用途の向き不向きが決まります(大雑把な目安です).</p>
<figure>
<img src="/images/2024-04-08-language-and-purpose.png" alt="Languages and usages" />
<figcaption aria-hidden="true">Languages and usages</figcaption>
</figure>
<p>ではこれらの特徴を踏まえて,Pythonとはどのような言語なのかを見てみましょう.</p>
<div class="note">
<p>Pythonは</p>
<ul>
<li>インタプリタ型言語で
<ul>
<li>機械語に翻訳しながら動く</li>
<li>手軽に書けて手軽に試せる</li>
<li>でも少し安全性が低く,遅い</li>
</ul></li>
<li>手続き型言語で
<ul>
<li>次に何をするかを順番に書く</li>
<li>(ただし関数型っぽい書き方もできる)</li>
</ul></li>
<li>動的型付け言語で
<ul>
<li>型検査を動かしながら実施</li>
<li>動かしてから型が違うと失敗する</li>
</ul></li>
</ul>
</div>
<p>これらは,プログラミング言語の大きな分類からみたPythonですが, Python固有の特徴として以下のようなものがあります.</p>
<div class="note">
<ul>
<li>とにかく読みやすく書きやすく覚えやすい
<ul>
<li>ABC言語という教育用言語が元になっている
<ul>
<li>予約語が少ない, → 覚えることが少ない</li>
<li>インデントでかき分け → 間違いが少ない</li>
<li>だれが書いても同じになる(と言われてはいる)</li>
</ul></li>
</ul></li>
<li>ライブラリが豊富
<ul>
<li>統計処理を全部0から自分で書くのは大変</li>
<li>他の人が作ったものを使えるようにするのがライブラリ</li>
<li>様々な大学や企業,研究者が膨大な量の統計処理,機械学習ライブラリを開発している</li>
</ul></li>
<li>遅いけど,Cなどと連携しやすい.
<ul>
<li>プログラミング言語ごとに速度は異なる.</li>
<li>Pythonは結構遅いので大きな計算に時間がかかる.
<ul>
<li>とても早い言語で遅い部分を書き換えやすい</li>
<li>ライブラリは基本的に早くなっている</li>
</ul></li>
</ul></li>
</ul>
</div>
<p>Pythonが教育用に良く使われるのは, インタプリタ方式の動的型付け言語であることから手軽に書けるだけではなく,もともと言語として簡単に書けるように作られていることが大きいです.</p>
<p>また, 統計,データサイエンス分野のライブラリが充実しており, これによって誰でも簡単に複雑な統計処理やデータサイエンスの技法が利用できることで,Pythonが広く普及しています.</p>
<p>簡単 → 教育用に → 多くの人が使う → ライブラリが充実 → もっと多くの人が使う</p>
<p>という流れがPythonの最大の強みと言えるでしょう.</p>
<p>実際にPythonはユーザー数が増え続けており,プログラムの共有サイトGitHubにおける2023年のすべての言語のなかで2番目にユーザ数が多い言語となっています.
<a href="https://github.blog/2023-11-08-the-state-of-open-source-and-ai/">Top 10 Programming languages on GitHub</a></p>
<figure>
<img src="/images/top-programming-languages-2023.png" alt="Top 10 Programming languages on GitHub" />
<figcaption aria-hidden="true">Top 10 Programming languages on GitHub</figcaption>
</figure>
<h2 data-number="1.2" id="授業準備"><span class="header-section-number">1.2</span> 授業準備</h2>
<p>この講義では,プログラムを自分で作成し,様々な演習をこなしてもらいますが,その前段階として,いくつかの準備が必要となります. このあたりはこの科目の先修科目の統計学入門でも扱っていますが,履修していない人もいますので,順番にやっていきましょう. 非常に基礎的な内容なので, 問題のない人は飛ばしましょう.</p>
<h3 data-number="1.2.1" id="テキストエディタ"><span class="header-section-number">1.2.1</span> テキストエディタ</h3>
<p>テキストエディタとは,プログラムを書くためのソフトウェアです.
プログラムを書くことをコーディング(Coding)といいます.</p>
<p>テキストエディタには沢山の種類があり,それぞれ独自の機能を持っています.
Windwosに最初から入っている｢メモ帳｣もテキストエディタですが,プログラムを書くために様々な機能が追加された高機能なテキストエディタも沢山あります.</p>
<p>例えば,シンタックスハイライト機能は,以下のプログラムのように,プログラムの記述を役割や意味に応じて色付けして見やすくしてくれます.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">## シンタックスハイライト</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greet_based_on_time():</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    now <span class="op">=</span> datetime.now()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    current_hour <span class="op">=</span> now.hour</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="dv">5</span> <span class="op">&lt;=</span> current_hour <span class="op">&lt;</span> <span class="dv">12</span>:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        greeting <span class="op">=</span> <span class="st">&quot;Good morning, world!&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">12</span> <span class="op">&lt;=</span> current_hour <span class="op">&lt;</span> <span class="dv">18</span>:</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        greeting <span class="op">=</span> <span class="st">&quot;Good afternoon, world!&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        greeting <span class="op">=</span> <span class="st">&quot;Good night, world!&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> greeting</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 関数を呼び出して結果を表示</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(greet_based_on_time())</span></code></pre></div>
<p>また,スペースをタブに変換するなどの機能も非常に便利です. 最近では生成AIを利用した自動補完機能がついたエディタなどもありますが,本講義における生成AIの利用に関しては第2回でコードを書き始めた際に説明します.</p>
<p>今までメモ帳以外のテキストエディタを利用したことが無い方には,シンプルなSublime Text 3をおすすめします(今世界的に人気があるのは VSCodeです.非常に便利ですが機能が多すぎて皆さんが混乱する可能性があるので,こちらを選びました).</p>
<p>既に何かしらのテキストエディタを利用している方は,現在使用しているエディタをそのまま利用して頂いても構いません.</p>
<p><a href="https://www.sublimetext.com/3">このURL</a>をクリックして,ページ上部にあるDownloadをクリックします. 自分のPCに合わせたインストール方法を選択しましょう.</p>
<figure>
<img src="/images/2024-04-08-lecture-DS-sublime-install.png" alt="Screenshot Sublime Text" />
<figcaption aria-hidden="true">Screenshot Sublime Text</figcaption>
</figure>
<div class="warn">
<p>SublimeTextもいろいろな機能を追加することができます.
｢SublimeText 設定｣などで調べて,好きなようにカスタマイズして構い舞いません.
カスタマイズをしなくても基本的な機能には問題ありません.</p>
</div>
<h2 data-number="1.3" id="imeの設定"><span class="header-section-number">1.3</span> IMEの設定</h2>
<p>プログラムは基本的に <strong>｢半角英数字｣</strong> で記述されます. プログラム中に全角の空白や記号が交じるとエラーの原因となる場合があります. そのため,プログラムを書く前に,そういったミスが起きないようにIMEの設定をしましょう.</p>
<p>タスクトレーからIMEの設定ができます．基本的に記号をすべて半角に設定しましょう（スペースは必ず半角にしましょう）．特に，句読点をコンマとピリオドに変更しましょう．</p>
<figure>
<img src="/images/2024-04-08-lecture-DS-IME.png" alt="IME" />
<figcaption aria-hidden="true">IME</figcaption>
</figure>
<h2 data-number="1.4" id="cliの基本操作"><span class="header-section-number">1.4</span> CLIの基本操作</h2>
<p>プログラムの開発環境にはマウスなどでクリックして操作するGUI(Graphical User Interface)をもったIDE(Integrated Development Environment)などもありますが,基本的には文字によってコンピュータに命令を送るCLI(Command Line Interface)を利用します. 映画やマンガなどで,ハッカーが黒い画面に文字を打っているあれのことです.</p>
<p>コンピュータのオペレーティングシステムとユーザー間のCLIを提供するプログラムをShellといい,Windowsでは,Command PromptやPowerShellなどがあります. MacなどのUnix系では,Bashやzshがあります. いずれも (Windows) Terminalというソフトウェアを介して利用します.</p>
<p>本講義では環境や好みによって好きな環境で開発して構いませんが,ここでは,PowerShellの利用法を解説します.</p>
<p>Windows11の検索バーで <code>Terminal</code>と検索して,出てきた <code>Terminal</code>をクリックしましょう.</p>
<figure>
<img src="/images/Terminal-launch.png" alt="Screenshot Terminal" />
<figcaption aria-hidden="true">Screenshot Terminal</figcaption>
</figure>
<p>自動的に<code>Windows PowerShell</code>が起動します. 立ち上がった,黒色の画面に文字でコマンド(命令)を入力して,コンピュータを操作します.</p>
<figure>
<img src="/images/Terminal-window.png" alt="Screenshot Terminal" />
<figcaption aria-hidden="true">Screenshot Terminal</figcaption>
</figure>
<h3 data-number="1.4.1" id="エンコーディング"><span class="header-section-number">1.4.1</span> エンコーディング</h3>
<p>実際にコマンドを入力する前に, 初心者がつまづきやすいポイントとして,Windowsのエンコーディングについて解説します.</p>
<p>PCは人間の使う文字（日本語，英語など）が理解できません.PCは機械語と呼ばれる言語で命令を受け付けます.一方で,人間は機械語を読むのが困難です.そこで,人間の使う文字と,機械語の間に変換ルールを設けて人間の文字でされた命令をPCにわかる文字に変換します.この変換ルールを文字エンコーディングと呼びます.</p>
<p>エンコーディングには複数の種類があります(日本語設定のWindowsはShift-JIS,Unix系はUnicodeが一般的です).
PythonはUTF-8という文字エンコーディングがデフォルトなので,Windowsにおいても可能な限りUTF-8を用いた方が良いです.</p>
<p>そこで,ターミナル上で利用するエンコーディングを変更します.
PowerShellを起動して, <code>chcp 65001</code> と打ち込み, PowerShell上で利用する文字エンコーディングをUTF-8に変更しましょう. <code>chcp</code>が利用する文字コードを変更するコマンド(change code page)で,その後に変更したい文字コードを入力します. <code>65001</code>は<code>UTF-8</code>のコードページ(Windows独自の文字エンコーディング)です. これはPowerShellを起動する度に行ってください．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">chcp</span> 65001</span></code></pre></div>
<p>と入力すると,</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Active</span> code page: 65001</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:<span class="dt">\U</span>sers<span class="dt">\u</span>ser<span class="op">&gt;</span></span></code></pre></div>
<p>のように表示されるはずです.</p>
<h3 data-number="1.4.2" id="日本語表示"><span class="header-section-number">1.4.2</span> 日本語表示</h3>
<p>Power Shellの設定によっては日本語が表示されず,日本語部分が <code>□</code> で置き換えられて表示されます.これは,使用しているフォントに日本語が含まれていないために発生します.</p>
<figure>
<img src="/images/powershell-tofu.png" alt="Screenshot PowerShell" />
<figcaption aria-hidden="true">Screenshot PowerShell</figcaption>
</figure>
<p>設定を変更してて日本語を表示可能にしましょう(
適当な日本語を入力してみて,問題なく表示されるようであれば,変更は必要ありません).</p>
<p>左上の<code>下向きの矢印 &gt; 既定値 &gt; 外観 &gt; フォントフェイス</code>の部分を日本語フォントに変更し<code>保存</code>をクリックすることで,日本語が表示されるようになります.</p>
<figure>
<img src="/images/Terminal-setting1.png" alt="Screenshot Terminal" />
<figcaption aria-hidden="true">Screenshot Terminal</figcaption>
</figure>
<figure>
<img src="/images/Terminal-setting2.png" alt="Screenshot Terminal" />
<figcaption aria-hidden="true">Screenshot Terminal</figcaption>
</figure>
<figure>
<img src="/images/Terminal-setting3.png" alt="Screenshot Terminal" />
<figcaption aria-hidden="true">Screenshot Terminal</figcaption>
</figure>
<p>その他色やサイズなど,好きな設定に変更できます. あとで,好みにカスタマイズしましょう.</p>
<h3 data-number="1.4.3" id="ディレクトリ"><span class="header-section-number">1.4.3</span> ディレクトリ</h3>
<p>基礎的なコマンドを学ぶ前に,ディレクトリに関して理解しておきましょう.
コンピュータの中のデータは,以下のような木構造になっています. このような木構造によるファイルの構造をディレクトリといいます.</p>
<pre><code>C: -- Users -- hoge
          |
            -- hoge2 -- Desktop
                   |
                     -- Downloads
                   |
                     -- Documents -- huga
                                |
                                  -- huga2</code></pre>
<p>CLIにおいて,ユーザはこの木構造のどこかに存在しており,この木構造を移動しながら様々な作業を行います. 現在いるディレクトリのことを <code>working directory</code>(以下wd)や<code>current directory</code>といいます.</p>
<h2 data-number="1.5" id="基礎的なコマンド"><span class="header-section-number">1.5</span> 基礎的なコマンド</h2>
<p>ここでは, この講義で必要となる最低限のコマンド,特にディレクトリの移動に関するコマンドを学習します.</p>
<p>wdは, CLIの左側に表示されていることが多いです.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2<span class="op">&gt;</span></span></code></pre></div>
<p>のように表示されていれば今<code>C:</code>ドライブ下の<code>Users</code>下の<code>hoge2</code>がwdとなります.</p>
<div class="warn">
<ul>
<li><p>Windowsでは,ディレクトリを区切る文字が<code>¥</code>あるいは<code>\</code>で表示されていると思います.</p></li>
<li><p>Macでは,<code>/</code>です.</p></li>
</ul>
<p>本資料では,<code>/</code>を利用しています. 自分の環境に併せて適宜読み替えてください.</p>
</div>
<p>CLIの左側に表示されていない場合にも<code>pwd</code>コマンド (print working directory)を入力すると,現在のディレクトリが表示されます.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2<span class="op">&gt;</span> pwd</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">PATH</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">----</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">C:/Users/hoge2</span></span></code></pre></div>
<p>wdの下に何があるかを調べるコマンドとして<code>ls</code>コマンド(list)があります.</p>
<div class="warn">
<p>以下, <code>PS C:\Users\hoge2</code>の部分は省略します.</p>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Desktop</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloads</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Documents</span></span></code></pre></div>
<p>※実際の画面では,もう少しいろいろな情報が書かれているかと思います.</p>
<p>ディレクトリ構造を確認するCommandとして<code>tree</code>があります. <code>tree</code>と入力してEnterすることで,wd以下のディレクトリ構成が確認できます.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> tree</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Folder</span> PATH listing</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Volume</span> serial number is 00000157 B8F4:6480</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">C:.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">├───Contacts</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">├───Desktop</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">├───Documents</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├───hoge</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └───slds</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>       └───program</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="ex">├───Downloads</span></span></code></pre></div>
<p><code>tree [PAHT]</code>と入力すると, wdではなく指定した<code>[PATH]</code>以下のディレクトリ構造が表示されます.
また, <code>/f</code> オプションを加えることでファイルも表示されます.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> tree <span class="bu">.</span><span class="dt">\D</span>ocuments\ /f</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Folder</span> PATH listing</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Volume</span> serial number is 000001D1 B8F4:6480</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\USERS\AKAGI\DOCUMENTS</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">├───hoge</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>       hello.py</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>       slds-2-10.py</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ex">└───slds</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">└───program</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            <span class="ex">hello.py</span></span></code></pre></div>
<div class="warn">
<p>Macの場合は,<code>tree</code>コマンドは入っていないので,<code>brew</code>などを利用してインストールする必要があります.
<code>brew</code>に関しては自分で調べてみましょう.</p>
<p>また,オプションもWindowsとは異なっています.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">コマンド</th>
<th style="text-align: center;">意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">-d</td>
<td style="text-align: center;">ディレクトリのみ表示</td>
</tr>
<tr class="even">
<td style="text-align: center;">-L N</td>
<td style="text-align: center;">N 階層まで表示</td>
</tr>
<tr class="odd">
<td style="text-align: center;">-P X</td>
<td style="text-align: center;">正規表現Xに従って表示</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> tree</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> hoge</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>      └── hoge.py</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> huga</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="ex">└──</span> huga.py</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> directories, 2 files</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> tree <span class="ex">-d</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> hoge</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> huga</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> directories</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> tree <span class="ex">-L</span> 1</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> hoge</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> huga</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> directories, 0 files</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> tree <span class="ex">-P</span> <span class="st">&quot;hoge*&quot;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> hoge</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>     └── hoge.py</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> huga</span></code></pre></div>
</div>
<p>wdから別のディレクトリに移動するコマンドとして <code>cd</code> コマンド(change directory)があります</p>
<p><code>cd [移動先]</code> と打つことで,lsコマンドで出てきた,ディレクトリに移動することができます.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Desktop</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloads</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Documents</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">Documents</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pwd</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2/Documents</span></code></pre></div>
<div class="warn">
<p>移動先のディレクトリ名はすべて自分で入力する必要はありません. 最初の数文字を入力して<code>Tab</code> Keyを押すと,自動で保管してくれます.</p>
</div>
<p><code>cd ..</code> と打つと一つ前のディレクトリ,<code>cd ~</code>と打つとホームディレクトリ(基本的には最初に開いた際にいた場所)に一挙に移動することができます.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pwd</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2/Documents</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">..</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pwd</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">Documents/huga</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pwd</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2/huga</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">~</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pwd</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2</span></code></pre></div>
<p><code>mkdir [作りたいディレクトリ名]</code> コマンド(make directory)で,新しいディレクトリを作成できます.</p>
<p><code>rmdir [消したいディレクトリ名]</code> コマンド(remove directory)で,ディレクトリを消すことができます.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pwd</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:/Users/hoge2</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Desktop</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloads</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Documents</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">Documents</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="ex">huga</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ex">huga2</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> mkdir <span class="ex">huga3</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="ex">huga</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="ex">huga2</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="ex">huga3</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> rmdir <span class="ex">huga3</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="ex">huga</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="ex">huga2</span></span></code></pre></div>
<p><code>rmdir</code> コマンドでは中身のあるディレクトリは消せません. オプションを追加することで消せますが,危険なのでここでは教えません.興味があったら自分で調べてみましょう.</p>
<div class="note">
<p><strong>練習:作業用ディレクトリを作ろう</strong></p>
<ul>
<li><p>これから,作業をするためのディレクトリをコマンドで作成しましょう.</p>
<ul>
<li>Documentsに移動</li>
<li>Programs というディレクトリを作成し移動</li>
<li>Python というディレクトリを作成し移動</li>
<li>slds というディレクトリを作成し移動
(名前は好きに設定して良いです. slds; special lecture data science)</li>
</ul></li>
</ul>
<p>これからこの講義で利用するプログラムなどはsldsに保存しましょう.</p>
</div>
<h2 data-number="1.6" id="環境構築"><span class="header-section-number">1.6</span> 環境構築</h2>
<p>自身の環境(PC)でプログラムが動くようにすることを<strong>環境構築</strong>といいます. Python自分のPCで動くように設定をしましょう.</p>
<p>Pythonの環境構築に関して説明します.Pythonを動かす方法は沢山あります.一つのソフトの中でプログラムの編集から実行まで全て完結するIDE(統合開発環境)やブラウザ上でSaaSを通じて実行する方法もありますが,ここではCLIを利用して実行する方法を準備します.Windowsを所有している学生が多いと思われるので,Windowsを前提に説明します. それ以外のOSの方は分からなければ教員に聞いて下さい.</p>
<p>Pythonの環境構築にもいくつかの手法がありますが,現在は <a href="https://github.com/pyenv/pyenv"><code>pyenv</code></a>や<a href="https://www.docker.com"><code>Docker</code></a>を利用した仮想環境でpythonのversionやライブラリをアプリケーションごとに分ける方法が主流です.</p>
<p>本講義では, <code>pyenv</code>を利用するため,以下<code>pyenv</code>環境の構築を行います.</p>
<h3 data-number="1.6.1" id="現状の開発環境の削除"><span class="header-section-number">1.6.1</span> 現状の開発環境の削除</h3>
<p>Terminalを開いて, <code>python --version</code>と入力しましょう. すでに<code>python</code> が入っている場合は,Pythonのversion情報が表示されます.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">--version</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Python</span> 3.11.9</span></code></pre></div>
<p>Pythonがインストールされていない場合は以下のような表示になります.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">--version</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">fha</span> : The term <span class="st">&#39;python&#39;</span> is not recognized as the name of a cmdlet, function, script file, or operable program. Check the s</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pelling</span> of the name, or if a path was included, verify that the path is correct and try again.</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">At</span> line:1 char:1</span></code></pre></div>
<p>Python の version情報が表示された場合は, <code>pyenv --version</code> と入力してすでに<code>pyenv</code>が入っていないか確認してください.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pyenv <span class="ex">--version</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pyenv</span> 3.1.1</span></code></pre></div>
<p>pyenv の version情報が表示されている場合はすでに環境構築が済んでいるので飛ばしてください. pyenvのversion情報が表示されない人はまず現行のPythonを削除しましょう.</p>
<p><code>設定 &gt; アプリ &gt; インストールされているアプリ</code>から <code>python</code>を検索して, <code>Python X.X</code> の形式のアプリと,<code>Python Luncher</code>などを<code>アンインストール</code>してください.</p>
<p>その他, <code>anaconda</code>などが入っていたらアンインストールしておいてください.</p>
<p><img src="/images/python-delete1.png" /></p>
<p><img src="/images/python-delete2.png" /></p>
<p><img src="/images/python-delete3.png" /></p>
<p>アンインストールが終わったら,terminal を一度開き直して, <code>python --version</code> コマンドで確認してみましょう.
(VSCodeなどTerminalにアクセスするアプリを開いている場合は,閉じておきましょう.)</p>
<h3 data-number="1.6.2" id="pyenvのインストール"><span class="header-section-number">1.6.2</span> pyenvのインストール</h3>
<p>続いて <a href="https://github.com/pyenv-win/pyenv-win/tree/master">pyenv for windows</a>を参考に<code>pyenv</code>環境を構築します.</p>
<p>Terminal を再度開き以下のコマンドをコピー,貼り付けしてEnterを押してください.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a> <span class="ex">Set-ExecutionPolicy</span> <span class="at">-ExecutionPolicy</span> RemoteSigned <span class="at">-Scope</span> CurrentUser</span></code></pre></div>
<p>Quick start 内のコマンドをコピーしてTerminalに貼り付け,Enterを押してください.</p>
<figure>
<img src="/images/pyenv-win1.png" alt="インストールコマンド" />
<figcaption aria-hidden="true">インストールコマンド</figcaption>
</figure>
<p>Terminalを再起動して,<code>pyenv --version</code>を入力し,version情報が表示されれば成功です.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pyenv <span class="ex">--version</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pyenv</span> 3.1.1</span></code></pre></div>
<h3 data-number="1.6.3" id="pythonのインストール"><span class="header-section-number">1.6.3</span> Pythonのインストール</h3>
<p>Pythonにはいくつかのversionがあり,必要に応じて切り替えて利用します.
まずはインストール可能なversionを <code>pyenv install --list</code>コマンドで確認してみましょう.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pyenv <span class="fu">install</span> <span class="at">--list</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> ::  Mirror: https://www.python.org/ftp/python</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> ::  Mirror: https://downloads.python.org/pypy/versions.json</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> ::  Mirror: https://api.github.com/repos/oracle/graalpython/releases</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="ex">2.4-win32</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="ex">2.4.1-win32</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">2.4.2-win32</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span></code></pre></div>
<p>この中から一つを選んでインストールします.
最新のものをインストールするとライブラリなどが対応していない場合があるので,<code>3.11.9</code>あたりをインストールしておきましょう.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pyenv <span class="fu">install</span> 3.11.9</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> ::  Mirror: https://www.python.org/ftp/python</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> ::  Mirror: https://downloads.python.org/pypy/versions.json</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> ::  Mirror: https://api.github.com/repos/oracle/graalpython/releases</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Downloading</span><span class="pp">]</span> ::  3.11.9 ...</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Downloading</span><span class="pp">]</span> ::  From https://www.python.org/ftp/python/3.11.9/python-3.11.9-amd64.exe</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Downloading</span><span class="pp">]</span> ::  To   C:<span class="dt">\U</span>sers<span class="dt">\a</span>kagi<span class="dt">\.</span>pyenv<span class="dt">\p</span>yenv-win<span class="dt">\i</span>nstall_cache<span class="dt">\p</span>ython-3.11.9-amd64.exe</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Installing</span><span class="pp">]</span> ::  3.11.9 ...</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="ex">::</span> <span class="pp">[</span><span class="ss">Info</span><span class="pp">]</span> :: completed! 3.11.9</span></code></pre></div>
<p><code>pyenv</code>はディレクトリごとに使用するPythonのバージョンなどを管理できます.
現行のディレクトリのみで,特定のversionのPythonを利用したい場合は</p>
<p><code>pyenv local &lt;使いたいPython&gt;</code>で設定します.</p>
<p><code>local</code>で設定されているディレクトリ以外全てで共通のPythonを使用したい場合は</p>
<p><code>pyenv global &lt;使いたいPython&gt;</code> で設定します.</p>
<p>今は,</p>
<p><code>pyenv global 3.11.9</code> で全体に<code>3.11.9</code>を設定しましょう.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> pyenv <span class="ex">global</span> 3.11.9</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">--version</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Python</span> 3.11.9</span></code></pre></div>
<p><code>python --version</code>で指定したversionのpythonが表示されればPythonの環境構築完了です.</p>
<h2 data-number="1.7" id="hello-world"><span class="header-section-number">1.7</span> Hello World</h2>
<p>初めて作成するプログラムとして標準出力(PowerShellなどの画面)に<code>Hello World</code>と出力するだけのプログラムを作成してみます.</p>
<p><code>PowerShell</code>を開いて,自分の作業用ディレクトリに移動します.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> chcp <span class="ex">65001</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">Documents/Programs/Python/slds</span></span></code></pre></div>
<p>テキストエディタで新しいファイルを開き,<strong>作業用ディレクトリ</strong>に<code>hello.py</code>という名前で保存しましょう.</p>
<p><code>.py</code>はPythonプログラムの拡張子です.</p>
<p>保存は,タブから<code>File &gt; save with encoding &gt; UTF-8</code>の順にクリックし<code>UTF-8</code>で保存しましょう.
それ以降は <code>Ctrl + s</code>などで上書き保存しても構いません.</p>
<p>作成したディレクトリに移動し, lsコマンドでファイルがあるか確認しましょう.
ょう.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">hello.py</span></span></code></pre></div>
<p>確認できたらhello.pyに以下の2行を書き足して上書き保存します.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding:utf-8 -*-</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(“Hello world<span class="op">!</span>”)</span></code></pre></div>
<p>保存できたら<code>python hello.py</code>コマンドでプログラムを実行します.</p>
<p>標準出力に<code>Hello World!</code>と表示されれば成功です.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">hello.py</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Hello</span> World!</span></code></pre></div>
<p>ここまでで，皆さんはPCでプログラムを書く準備が整いました．
あとはプログラムの書き方を学習すれば自身の環境で開発が行なえます．</p>
<h2 data-number="1.8" id="プログラミングの勉強の仕方"><span class="header-section-number">1.8</span> プログラミングの勉強の仕方</h2>
<p>プログラミング言語は,文字通り<strong>言語</strong>です. 英語などと同じ様に,使わないと身につきません.なので,大事なことは<strong>勉強するより使う</strong>ことです.</p>
<p>英語の勉強で,一つひとつ文法を覚えることは大切かもしれませんが,実際に英文を書いたり,会話しないと使えるようにはなりません. プログラミングの学習で,学習用の資料や教科書を一つ一つ<strong>読んだり,ノートに書き写す人</strong>がたまにいますが,かなり効率が悪い方法です. 何も分からなくてもいいので,取り敢えずプログラムを書いて実行するようにしましょう. 資料に載っている例はすべて,実際に書いて実行してみましょう.</p>
<p>一番いい方法は,何も分からなくても取り敢えず,プログラムをつかってしてみたいことを実行することです.1からすべての構文などを覚えようとしないで,自分がやりたい,しなければならないことを,書き始めましょう. <strong>分からないところだけを</strong>調べれば十分です.</p>
<p>その際に,新しく知ったことは,メモなどして,あとで参照できるようにしておきましょう. その資料が後々役に立ちます.</p>
<p>プログラミングは,すべて暗記する必要はありません. 覚えていなくても,それの調べ方や載っている資料を知っていれば十分です. 何回も使う機能であれば自然に覚えます.</p>
<p><strong>ただし,</strong> Pythonは非常に多くの人が利用しているので,みなさんがこの講義で習うレベルのことは検索すれば既に,完成したプログラムを参考にすることができます. また,ChatGPTなどの生成AIを利用すれば,皆さんの書いたプログラムよりかなりできの良いものをすぐに得ることができます. それらを見て勉強することは大切ですが,ただ,只管コピペしたり,生成AIの結果を利用しているだけでは,全く身につきません. 検索して出てきたコードや,生成AIによるコードを利用しても構いませんが, それをただ貼り付けるのではなく,<strong>自分で読んで,理解する</strong>ようにしましょう.</p>
<p>知らない部分,自分では書けない部分が見つかったらそれを理解するように勉強しましょう. ChatGPTに質問しても構いません. ただ,聞いたことを説明できるようにしましょう.</p>
<p>自分で説明できないものを使えるのは<strong>せいぜい学校の課題くらいです</strong>. 仕事や研究では,中身の良く分からないコードは利用できません. 最低限自分で理解したものだけを利用してください.</p>
<p>講義では,結果があっていればよいだけではなく,<strong>なぜそのように書いたのか</strong>,<strong>どのような意味か</strong>,<strong>なぜこうなるのか</strong>などを皆さんに聞きますので,理解に務めるようにしましょう.</p>
<div class="note">
<p><strong>演習</strong></p>
<ul>
<li><u>演習1 Shellコマンドの調査</u></li>
</ul>
<p>今回ならったいくつかのコマンド以外にも便利なコマンドが沢山あります. 3つ調べて,使い方を説明してください.</p>
<ul>
<li><u>演習2 チートシートの作成</u></li>
</ul>
<p>チートシートとは「それだけを見れば必要な情報が分かるメモ書き」のことです.
プログラミングの学習では, 自分でノートを取って,それさえ見ればなんとかできる資料を作る のは非常に有用です.</p>
<p><code>.ppt</code>でも<code>.txt</code>でも形態は何でも良いので, 自分だけのチートシートを作成して, 今日覚えたこと,調べたことなどをメモしていきましょう.</p>
<p>◦ CLI, Pythonの基礎, Pandasなど学習の区切りごとにシートを分けると便利です.</p>
<p>◦ スライドサイズを事前に大きく設定しておくと便利です</p>
<p>書き方は自由ですが, <a href="https://www.google.com/search?newwindow=1&amp;client=safari&amp;sca_esv=635483f0705dd420&amp;sca_upv=1&amp;q=python+%E3%83%81%E3%83%BC%E3%83%88%E3%82%B7%E3%83%BC%E3%83%88&amp;uds=AMwkrPtd7EXxieMQKehnHvZf8S6pNpVcJzQvmfSMfustdt5GVU4paqDezVS1KwRLLfnWdTPfRKqI2vio1swnpAMe65pQfFGqsLrhLm9FBruViqbu8gs83egRP5pID9cAUWbOoFAII8Bi4Sa9pC2nZB8uNY_Im_IVhSc-ISQJazoPJyS7Y5hq8j_wtxEDwusT0kav7Mhx_On2phc8rZKZ0rWb3f5AykS1iJlyMqAYBs5Ke8QgUSIasP6AkeP9P6DIKWQaXCglNYTRDcA_cLO0qv_MU45G2ng9BfipwmjcaL4l2EsY-TdRRazsTUowT__BAUHIv2lsEG32&amp;udm=2&amp;prmd=ivsnmbtz&amp;sa=X&amp;ved=2ahUKEwiA48qB-bOFAxU3aPUHHYJmBQsQtKgLegQICRAB&amp;biw=1147&amp;bih=1269&amp;dpr=1">検索して</a>有名なチートシートを参考にしてください.</p>
<p>このチートシートは後で紹介してもらいます.</p>
<ul>
<li><u>演習3 <code>print()</code>の利用</u></li>
</ul>
<p>今回作成した<code>hello.py</code>における
<code>print()</code> という関数は()内の文字(<code>""</code>で囲われている部分)を標準出力する関数です.
<code>print()</code>の括弧内の <code>Hello World!</code> 部分を好きな文字に書き換えて実行してみましょう.</p>
</div>
<div class="warn">
<p><strong>演習について</strong></p>
<p>この資料では,所々に演習が指定されています.
演習は自分で行い, どのようにやったのかを講義中に発表,あるいは宿題として提出してもらいます.</p>
<p>家で演習を進めた場合には,講義中にそれが再現できるように,</p>
<ul>
<li>どのようにやったのか</li>
<li>なぜやったのか</li>
</ul>
<p>などを人に説明できるように<strong>必ず作成したメモ,資料</strong>などを残しておきましょう.</p>
</div>
]]></description>
    <pubDate>Mon, 24 Mar 2025 00:00:00 UT</pubDate>
    <guid>/lectures/slds3.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>代数プログラミング入門 Ch3 Haskellを使ってみよう</title>
    <link>/lectures/iap3.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#haskellを使ってみよう" id="toc-haskellを使ってみよう"><span class="toc-section-number">1</span> Haskellを使ってみよう</a>
<ul>
<li><a href="#ghci" id="toc-ghci"><span class="toc-section-number">1.1</span> ghci</a></li>
<li><a href="#終了" id="toc-終了"><span class="toc-section-number">1.2</span> 終了</a></li>
<li><a href="#コメントアウト" id="toc-コメントアウト"><span class="toc-section-number">1.3</span> コメントアウト</a></li>
<li><a href="#複数行モード" id="toc-複数行モード"><span class="toc-section-number">1.4</span> 複数行モード</a></li>
<li><a href="#データ型" id="toc-データ型"><span class="toc-section-number">1.5</span> データ型</a>
<ul>
<li><a href="#数値型" id="toc-数値型"><span class="toc-section-number">1.5.1</span> 数値型</a></li>
<li><a href="#数値型の演算" id="toc-数値型の演算"><span class="toc-section-number">1.5.2</span> 数値型の演算</a></li>
<li><a href="#数値型の変換" id="toc-数値型の変換"><span class="toc-section-number">1.5.3</span> 数値型の変換</a></li>
<li><a href="#リスト" id="toc-リスト"><span class="toc-section-number">1.5.4</span> リスト</a></li>
<li><a href="#タプル" id="toc-タプル"><span class="toc-section-number">1.5.5</span> タプル</a></li>
<li><a href="#文字列型" id="toc-文字列型"><span class="toc-section-number">1.5.6</span> 文字列型</a></li>
</ul></li>
<li><a href="#論理型bool" id="toc-論理型bool"><span class="toc-section-number">1.6</span> 論理型(Bool)</a></li>
<li><a href="#スクリプトファイルの実行" id="toc-スクリプトファイルの実行"><span class="toc-section-number">1.7</span> スクリプトファイルの実行</a></li>
</ul></li>
</ul>
</div>
<h1 data-number="1" id="haskellを使ってみよう"><span class="header-section-number">1</span> Haskellを使ってみよう</h1>
<h2 data-number="1.1" id="ghci"><span class="header-section-number">1.1</span> ghci</h2>
<p>前節では, Stackを利用した,プロジェクトの作成と実行に関して扱いましたが, Haskellにも対話環境が存在します.
<code>stack ghci</code>コマンドを打つことで, Haskellの対話環境(<code>REPL</code>)が立ち上がります.</p>
<p>この節では,Haskellの基礎について学びますが,ghciの紹介も併せて,いくつかの基礎的な仕様については,ghci上で確認してみましょう.</p>
<h2 data-number="1.2" id="終了"><span class="header-section-number">1.2</span> 終了</h2>
<p>ghciではコマンドを<code>:</code>の後に入力します. ghciの終了コマンドは<code>:q</code>です.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> stack ghci</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span>:q</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Leaving</span> GHCi.</span></code></pre></div>
<h2 data-number="1.3" id="コメントアウト"><span class="header-section-number">1.3</span> コメントアウト</h2>
<p>Haslellではコメントアウトは <code>--</code> です. 複数行に渡る場合は <code>{- -}</code> で囲みます.</p>
<div class="warn">
<p>Haskellのプログラムを読んでいると <code>--|</code> や <code>--^</code> というタイプのコメントを良く見ますが, こちらはHaskellのドキュメント生成ライブラリにおいて, ドキュメント中に説明として記述するための記号です.
またコメント中に <code>&gt;&gt;&gt;</code> と記述することでテストが実装できるなどいろいろなものがありますが,本資料では扱いません.</p>
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="co">-- コメント</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="co">{- コメント-}</span></span></code></pre></div>
<h2 data-number="1.4" id="複数行モード"><span class="header-section-number">1.4</span> 複数行モード</h2>
<p>ghci上で複数行のプログラムを書く場合には <code>:{ :}</code> でプログラムを囲います. 例えば,先程のフィボナッチ数のプログラムをghci上で実行する場合,位置行ずつ定義すると,定義が更新されてき最後の <code>f n = f (n-1) + f (n-2)</code>のみが記憶されます. この場合,<code>n</code>は無限にマイナスに続いていくため,<code>Stack Overflow</code>エラーが表示されます.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> fib <span class="dv">0</span> <span class="ot">=</span> <span class="dv">1</span> <span class="co">-- fの定義が上書きされる</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> fib <span class="dv">1</span> <span class="ot">=</span> <span class="dv">1</span> <span class="co">-- fの定義が上書きされる</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> f n <span class="ot">=</span> f (n<span class="op">-</span><span class="dv">1</span>) <span class="op">+</span> f (n<span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> f <span class="dv">12</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="op">***</span> <span class="dt">Exception</span><span class="op">:</span> stack overflow</span></code></pre></div>
<p><code>:{ :}</code>で囲むことでひとまとまりの定義として認識されます.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>{</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span><span class="ot"> fib ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> fib <span class="dv">0</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> fib <span class="dv">1</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> fib n <span class="ot">=</span> fib (n<span class="op">-</span><span class="dv">1</span>) <span class="op">+</span> fib (n<span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> <span class="op">:</span>}</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> fib <span class="dv">12</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="dv">233</span></span></code></pre></div>
<p>なお,スクリプトの場合は,<code>:{ :}</code>なしでそのまま改行すれば問題ありません.</p>
<h2 data-number="1.5" id="データ型"><span class="header-section-number">1.5</span> データ型</h2>
<p>型に関しては,かなり奥が深い,というよりHaskellの面白さは自分で型を作っていくことにあります. ただ,いきなりそれをすると,わけがわからなくなるのでまずは代数的データ型などには触れず以下の基礎的な型に関して説明します.</p>
<div class="note">
<ul>
<li>数値型
<ul>
<li>整数 (Int, Integer)</li>
<li>実数 (Float,Double)</li>
</ul></li>
<li>タプル</li>
<li>リスト (List)</li>
<li>文字,文字列 (Char,String,Text)</li>
<li>論理型(Bool)</li>
</ul>
</div>
<p>Haskellにおいて,値のデータ型はある程度自動推論されますが,特定のデータ型を明示したい場合には,値の後ろに<code>:: データ型</code>をつけます.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Double</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fl">1.0</span></span></code></pre></div>
<p><code>ghci</code>において形の確認は<code>:t</code>あるいは<code>:type</code>コマンドの後ろに確認したいデータを入力することで行えます.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>t <span class="ch">&#39;c&#39;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ch">&#39;c&#39;</span><span class="ot"> ::</span> <span class="dt">Char</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span><span class="kw">type</span> (<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>)<span class="ot"> ::</span> <span class="dt">Int</span></span></code></pre></div>
<h3 data-number="1.5.1" id="数値型"><span class="header-section-number">1.5.1</span> 数値型</h3>
<p>Haskellの基本的な数値型には以下の4つがあります. クラスに関しては後に扱うので,今はデータ型の更に大きな分類程度に考えておいてください.</p>
<table>
<thead>
<tr class="header">
<th>クラス</th>
<th>データ型</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Integer (整数)</td>
<td><code>Int</code></td>
<td>固定長整数型</td>
</tr>
<tr class="even">
<td>Integer (整数)</td>
<td><code>Integer</code></td>
<td>多倍長整数型</td>
</tr>
<tr class="odd">
<td>Fractional (小数)</td>
<td><code>Float</code></td>
<td>単精度浮動小数型</td>
</tr>
<tr class="even">
<td>Fractional (小数)</td>
<td><code>Double</code></td>
<td>倍精度浮動小数型</td>
</tr>
</tbody>
</table>
<p><code>Int</code>と<code>Integer</code>は<code>整数</code>, <code>Float</code>と<code>Double</code>は<code>実数</code>を表しています.</p>
<div class="note">
<p><code>固定長/多倍長</code>, <code>単精度/倍精度</code> というのはどういう意味でしょうか?</p>
<p>コンピューターでは,データはすべて<code>0</code>と<code>1</code>のいずれかを表す<code>bit</code>の集まりによって表現されます. ちなみに<code>8bit</code>で<code>1byte</code>, <code>1024byte</code>で<code>1Kbyte</code>です.したがって,プログラミングで扱うデータに使用できるデータ量には制限があり,無限の長さの整数や少数を利用することはできません.</p>
<p>コンピューターの計算は主に中央演算処理装置(CPU)で行われますが,その計算過程でデータを一時的に記録するCPU内部の装置のことを汎用レジスタといい,現在では<code>64bit</code>以下の汎用レジスタを持った<code>64bit CPU</code>が良く利用されています.</p>
<p>現在一般的な<code>64bit CPU</code>においてHaskellは整数と小数を表すのに一般的に最大<code>64bit</code>の領域を確保します. したがって,整数では64bitで表せるデータ量(<code>-9223372036854775808 ~ 9223372036854775807</code>)を超えた整数を扱うことはできません.</p>
<p>ちなみにIntの最大値,最小値はghciで以下のように確認できます(
使用しているコンピューターによっては結果が変わる可能性があります).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span><span class="ot"> minBound ::</span> <span class="dt">Int</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">-</span><span class="dv">9223372036854775808</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span><span class="ot"> maxBound ::</span> <span class="dt">Int</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="dv">9223372036854775807</span></span></code></pre></div>
<p>最大(小)値を超えるとオーバーフローします.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">9223372036854775807</span><span class="ot"> ::</span> <span class="dt">Int</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="dv">9223372036854775807</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="dv">9223372036854775807</span> <span class="op">+</span> <span class="dv">1</span>)<span class="ot"> ::</span> <span class="dt">Int</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">-</span><span class="dv">9223372036854775808</span></span></code></pre></div>
</div>
<h3 data-number="1.5.2" id="数値型の演算"><span class="header-section-number">1.5.2</span> 数値型の演算</h3>
<p>Haskellにおける数値型の基本的な演算子は以下のように定義されています. 実数と整数で挙動が異なるものがあるので注意が必要です.</p>
<p>演算子には優先順位が設定されており,数字が大きいものから順に適用されます(最小0,最大9).
また,式を<code>()</code>で囲むことで,その内部が優先的に計算されます.</p>
<p><strong>また,<code>()</code>が式の最後に来る場合には<code>$</code>記号以下が<code>()</code>に囲まれているとみなすことができます.</strong></p>
<table>
<thead>
<tr class="header">
<th>計算</th>
<th>記号</th>
<th>優先順</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>足し算</td>
<td><code>+</code></td>
<td>6</td>
</tr>
<tr class="even">
<td>引き算</td>
<td><code>-</code></td>
<td>6</td>
</tr>
<tr class="odd">
<td>掛け算</td>
<td><code>*</code></td>
<td>7</td>
</tr>
<tr class="even">
<td>割り算</td>
<td><code>/</code></td>
<td>7</td>
</tr>
<tr class="odd">
<td>冪乗(整数)</td>
<td><code>^</code></td>
<td>8</td>
</tr>
<tr class="even">
<td>冪乗(実数)</td>
<td><code>**</code></td>
<td>8</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="dv">9</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">9</span> <span class="op">/</span> <span class="dv">3</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fl">3.0</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">3</span> <span class="op">^</span> <span class="dv">3</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="dv">27</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">3</span> <span class="op">**</span> <span class="dv">3</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fl">27.0</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">3</span> <span class="op">^</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="co">-- エラー</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">7</span><span class="op">:</span><span class="dv">3</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span> [<span class="dt">GHC</span><span class="op">-</span><span class="dv">39999</span>]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">3</span> <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="fl">1.7320508075688772</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="dv">8</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">*</span> <span class="op">$</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="dv">8</span></span></code></pre></div>
<p>これらは中置演算子として定義されていますが演算子を<code>()</code>で囲むことによって前置(逆ポーランド記法)で利用することができます.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="op">+</span>) <span class="dv">3</span> <span class="dv">4</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="op">*</span>) ((<span class="op">+</span>) <span class="dv">3</span> <span class="dv">4</span>) <span class="dv">2</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="dv">14</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="op">*</span>) <span class="dv">2</span> <span class="op">$</span> (<span class="op">+</span>) <span class="dv">3</span> <span class="dv">4</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="dv">14</span></span></code></pre></div>
<p>また, 2引数関数として定義された前置の演算子は <code>``</code> (バッククオート)で囲むことで, 中置演算子として利用できます.</p>
<table>
<thead>
<tr class="header">
<th>計算</th>
<th>記号</th>
<th>優先順</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>整数除算</td>
<td><code>div</code></td>
<td>7</td>
</tr>
<tr class="even">
<td>剰余</td>
<td><code>mod</code></td>
<td>6</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">5</span> <span class="op">/</span><span class="dv">2</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fl">2.5</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">div</span> <span class="dv">5</span> <span class="dv">2</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">5</span> <span class="ot">`div`</span> <span class="dv">2</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">5</span> <span class="ot">`mod`</span> <span class="dv">2</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span></code></pre></div>
<h3 data-number="1.5.3" id="数値型の変換"><span class="header-section-number">1.5.3</span> 数値型の変換</h3>
<p><code>Integral(整数)</code>から<code>Fractional(小数)</code>への変換は, <code>fromIntegral</code>を利用します.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> fromIntegral <span class="er">(</span><span class="ex">1</span> :: Int<span class="kw">)</span> <span class="ex">::</span> Double</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1.0</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> div 5 2</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> 2 <span class="pp">**</span> <span class="er">(</span><span class="ex">div</span> 5 2<span class="kw">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>interactive<span class="op">&gt;</span>:6:1: <span class="ex">error:</span> <span class="pp">[</span><span class="ss">GHC</span><span class="pp">-</span><span class="ss">39999</span><span class="pp">]</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">•</span> Ambiguous type variable ‘a0’ arising from a use of ‘print’</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">prevents</span> the constraint ‘<span class="er">(</span><span class="ex">Show</span> a0<span class="kw">)</span><span class="ex">’</span> from being solved.</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">Probable</span> fix: use a type annotation to specify what ‘a0’ should be.</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>      <span class="ex">Potentially</span> matching instances:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="ex">instance</span> <span class="pp">[</span><span class="ss">safe</span><span class="pp">]</span> Show Version <span class="at">--</span> Defined in ‘Data.Version’</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="ex">instance</span> Show Exception.ArithException</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>          <span class="ex">--</span> Defined in ‘GHC.Exception.Type’</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="ex">...plus</span> 39 others</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">...plus</span> 20 instances involving out-of-scope types</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">(</span><span class="ex">use</span> <span class="at">-fprint-potential-instances</span> to see them all<span class="kw">)</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">•</span> In a stmt of an interactive GHCi command: print it</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> 2 <span class="pp">**</span> <span class="er">(</span><span class="ex">fromIntegral</span> <span class="er">(</span><span class="ex">div</span> 5 2<span class="kw">))</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="ex">4.0</span></span></code></pre></div>
<p><code>Fractional(小数)</code>から<code>Integral(整数)</code>への変換は,基本的に何かしらの<strong>切り捨て</strong>を実施します.</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 35%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="header">
<th>切り捨て関数名</th>
<th>意味</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ceiling</td>
<td>小数点以下を切り上げる</td>
<td><code>ceiling 3.2 → 4</code>, <br> <code>ceiling (-3.2) → -3</code></td>
</tr>
<tr class="even">
<td>floor</td>
<td>小数点以下を切り下げる</td>
<td><code>floor 3.8 → 3</code>, <br><code>floor (-3.8) → -4</code></td>
</tr>
<tr class="odd">
<td>truncate</td>
<td>小数部分を単純に切り捨てる</td>
<td><code>truncate 3.8 → 3</code>, <br><code>truncate (-3.8) → -3</code></td>
</tr>
<tr class="even">
<td>round</td>
<td>最も近い整数に丸める</td>
<td><code>round 3.5 → 4</code>, <br><code>round 3.4 → 3</code>, <br><code>round (-3.5) → -4</code></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">^</span> (<span class="dv">2</span> <span class="op">/</span> <span class="dv">1</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">8</span><span class="op">:</span><span class="dv">3</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span> [<span class="dt">GHC</span><span class="op">-</span><span class="dv">39999</span>]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">Could</span> <span class="fu">not</span> deduce ‘<span class="dt">Integral</span> b0’ arising from a use <span class="kw">of</span> ‘<span class="op">^</span>’</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">--- 省略</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">^</span> (<span class="fu">truncate</span> (<span class="dv">2</span> <span class="op">/</span> <span class="dv">1</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span></span></code></pre></div>
<div class="note">
<p>練習問題</p>
<p>以下の問題をREPLを使って自分で解いてみましょう.
問題自体は小学生でも解けますが,重要なのはHaskellの挙動を確認することです.
どのように計算したかを併せて説明してください.</p>
<ul>
<li><p>飴が40個あります.7人で同じ数ずつ分けると1人分は何個で何個あまりますか?</p></li>
<li><p>底辺5cm,高さ4cmの三角形の面積はいくつですか?</p></li>
<li><p>2の8乗はいくつですか?</p></li>
<li><p>累乗と掛け算の計算順序を丸括弧を使った計算で確かめてください.</p></li>
</ul>
</div>
<h3 data-number="1.5.4" id="リスト"><span class="header-section-number">1.5.4</span> リスト</h3>
<p>複数のデータをまとめる方法はいくつかありますが,データを1列に並べた<code>List</code>型は代表的なデータ型です. Haskellには配列(<code>Array</code>や<code>Vector</code>)もありますが,まずは<code>List</code>について学習しましょう.
リストの操作にはここで扱う以外にも<code>リスト内包表記</code>や<code>高階関数</code>など様々なものがありますが,ここでは最も基本的ないくつかの機能のみに絞って,後ほど詳細を扱います.</p>
<p>Listは<strong>リストリテラル</strong><code>[]</code>の中に要素を記入して,<code>,</code>(コンマ)で区切ることで宣言できます.</p>
<div class="warn">
<p>Haskellにおいて,リテラルとは,<strong>特定のデータ型の値を直接記述する構文</strong>のことを指します.</p>
<ul>
<li><p>リストリテラル<code>[]</code>は,<code>[]</code>内の記述をリスト型として扱うリテラル</p></li>
<li><p>数値を記入するとそれは数値型として扱われる数値リテラル</p></li>
<li><p><code>""</code>で囲まれた記述は文字列型として扱われる文字列リテラル</p></li>
</ul>
<p>などがあります.</p>
<p>Haskellでは,自作したデータ型にリテラルを定めるなど様々な用法がありますが,ここでは扱いません.</p>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span></code></pre></div>
<p><code>[]</code>のみで空のリストが生成されます.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> []</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>[]</span></code></pre></div>
<p>注意点として,HaskellはPythonなどの言語のように<code>ダックタイピング</code>が許されていないため異なるデータを単一のリストの要素に含めることはできません.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="fl">2.0</span>,<span class="dv">3</span>]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>[<span class="fl">1.0</span>,<span class="fl">2.0</span>,<span class="fl">3.0</span>]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span><span class="ot">::</span><span class="dt">Int</span>,<span class="dv">2</span><span class="ot">::</span><span class="dt">Double</span>,<span class="dv">3</span><span class="ot">::</span><span class="dt">Int</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">22</span><span class="op">:</span><span class="dv">9</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span> [<span class="dt">GHC</span><span class="op">-</span><span class="dv">83865</span>]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">Couldn&#39;t</span> match expected <span class="kw">type</span> ‘<span class="dt">Int</span>’ with actual <span class="kw">type</span> ‘<span class="dt">Double</span>’</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">In</span> the expression<span class="op">:</span> <span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Double</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">In</span> the expression<span class="op">:</span> [<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>, <span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Double</span>, <span class="dv">3</span><span class="ot"> ::</span> <span class="dt">Int</span>]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">In</span> an equation for ‘it’<span class="op">:</span> it <span class="ot">=</span> [<span class="dv">1</span><span class="ot"> ::</span> <span class="dt">Int</span>, <span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Double</span>, <span class="dv">3</span><span class="ot"> ::</span> <span class="dt">Int</span>]</span></code></pre></div>
<p>リストのデータ型は,要素のデータ型をリストリテラル<code>[]</code>で囲んだ形で表されます.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span><span class="kw">type</span> ([<span class="dv">1</span><span class="ot">::</span><span class="dt">Int</span>,<span class="dv">2</span><span class="ot">::</span><span class="dt">Int</span>])</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>([<span class="dv">1</span><span class="ot">::</span><span class="dt">Int</span>,<span class="dv">2</span><span class="ot">::</span><span class="dt">Int</span>])<span class="ot"> ::</span> [<span class="dt">Int</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span><span class="kw">type</span> [<span class="ch">&#39;a&#39;</span>,<span class="ch">&#39;b&#39;</span>,<span class="ch">&#39;c&#39;</span>]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>[<span class="ch">&#39;a&#39;</span>,<span class="ch">&#39;b&#39;</span>,<span class="ch">&#39;c&#39;</span>]<span class="ot"> ::</span> [<span class="dt">Char</span>]</span></code></pre></div>
<p>また,リストは<code>先頭要素 : リスト</code> によって宣言することも可能です. <code>:</code>を<code>cons 構築子</code>といいます. 構築子の意味については後ほど<code>代数的データ型</code>の説明とともに扱います.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">:</span> []</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">:</span> [<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">2</span> <span class="op">:</span> [<span class="dv">3</span>]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span></code></pre></div>
<p>リストの要素のインデックスによる取得は <code>!!</code>演算子を用いて<code>xs !! インデックス</code>の形で行います. インデックスは0から始まります. インデックスが超過した場合はエラーとなります.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="op">!!</span> <span class="dv">0</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="op">!!</span> <span class="dv">1</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="op">!!</span> <span class="dv">2</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="op">!!</span> <span class="dv">3</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="op">***</span> <span class="dt">Exception</span><span class="op">:</span> <span class="op">Prelude.!!:</span> <span class="fu">index</span> too large</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="dt">CallStack</span> (from <span class="dt">HasCallStack</span>)<span class="op">:</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">error</span>, called at libraries<span class="op">/</span>base<span class="op">/</span><span class="dt">GHC</span><span class="op">/</span>List.hs<span class="op">:</span><span class="dv">1366</span><span class="op">:</span><span class="dv">14</span> <span class="kw">in</span> base<span class="op">:</span><span class="dt">GHC.List</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  tooLarge, called at libraries<span class="op">/</span>base<span class="op">/</span><span class="dt">GHC</span><span class="op">/</span>List.hs<span class="op">:</span><span class="dv">1376</span><span class="op">:</span><span class="dv">50</span> <span class="kw">in</span> base<span class="op">:</span><span class="dt">GHC.List</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">!!</span>, called at <span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">37</span><span class="op">:</span><span class="dv">9</span> <span class="kw">in</span> interactive<span class="op">:</span><span class="dt">Ghci15</span></span></code></pre></div>
<p><code>m~n</code>までの連続したリストを生成する場合には,<code>[m..n]</code>と記述します.これを<code>数列表記</code>といいます.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span> <span class="op">..</span> <span class="dv">10</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>]</span></code></pre></div>
<p>コンマと併用することで階差数列などを表現することも可能です.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">3</span><span class="op">..</span><span class="dv">10</span>]</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">9</span>]</span></code></pre></div>
<p><code>[x..]</code>と終わりを指定しないことで,無限数列も作成できます. ghciでそのまま実行すると永遠に表示が止まりません(<code>ctrl+C</code>で止まります). ここでは,<code>[1,3,5,...]</code>の10番目と100番目の値を取り出してみます.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">3</span><span class="op">..</span>] <span class="op">!!</span> <span class="dv">10</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dv">21</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>,<span class="dv">3</span><span class="op">..</span>] <span class="op">!!</span> <span class="dv">100</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="dv">201</span></span></code></pre></div>
<div class="warn">
<p>Pythonなど言語では,値が宣言/生成されたタイミングでコンピュータがその値を評価する<code>正格(strict)評価</code>が一般的です. 一方HaskellはDefaultでは,実際にその値が呼び出された際に評価される<code>遅延(lazy)評価</code>を採用しており,それによりこのような無限の値を実現することができます.
正格評価で無限に値が続くリストを生成した場合, 生成した時点で永遠に計算が終わりませんが,遅延評価では無限のリストの中の具体的な値を利用するさいにその値が利用されます.</p>
<p>この機能はHaskellの大きな特徴の一つですが,一方でメモリリークや,速度の低下の原因になることがあります. したがって,ある程度大きなプログラムを書く場合には,正格評価と,遅延評価を明示的に切り替えることが推奨されています.</p>
<p>最初は気にする必要はありませんが,パッケージなどの提供するHaskellのデータ型には,strictなものとlazyなものの両方が用意されていることが多いので,違いを覚えておくと後々役に立ちます.</p>
</div>
<p>Haskellでリストを扱う際には,暗黙に<code>x</code>などの単一のアルファベットが要素,<code>xs</code>などの複数形がリストを表している場合が多く<code>x:xs</code>などと記述してリストの最初の要素と残りのリストを表します.</p>
<p>詳細は後ほど扱いますが,<code>束縛</code>されたリストから<code>パターンマッチ</code>によって値を取り出す場合によく利用されます.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> x<span class="op">:</span>xs <span class="ot">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> x</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> xs</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>[<span class="dv">2</span>,<span class="dv">3</span>]</span></code></pre></div>
<p>リスト同士の結合は<code>++</code>演算子によって行います.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [<span class="dv">1</span>] <span class="op">++</span> [<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span></code></pre></div>
<p>リストの長さは<code>length</code> 関数で取得できます.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">length</span> []</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">length</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span></span></code></pre></div>
<h3 data-number="1.5.5" id="タプル"><span class="header-section-number">1.5.5</span> タプル</h3>
<p>Haskellではデータの組み合わせを表す方法として,後述の<code>直積型</code>がありますが,タプルも良く利用されます.タプルを利用するには要素を<code>()</code>(丸括弧)で囲い,<code>,</code>(コンマ)で区切ります. 要素数に制限はありません.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span></code></pre></div>
<p>リストと同様に要素数の異なるタプルや,要素のデータ型の異なるタプルは別のデータ型として区別され,同一のリストなどに入れることはできません.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> [(<span class="dv">1</span>,<span class="dv">2</span>),(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">60</span><span class="op">:</span><span class="dv">8</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span> [<span class="dt">GHC</span><span class="op">-</span><span class="dv">83865</span>]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">Couldn&#39;t</span> match expected <span class="kw">type</span><span class="op">:</span> (a, b)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                  with actual <span class="kw">type</span><span class="op">:</span> (a0, b0, c0)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">In</span> the expression<span class="op">:</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">In</span> the expression<span class="op">:</span> [(<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)]</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">In</span> an equation for ‘it’<span class="op">:</span> it <span class="ot">=</span> [(<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">Relevant</span> bindings include</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="ot">        it ::</span> [(a, b)] (bound at <span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">60</span><span class="op">:</span><span class="dv">1</span>)</span></code></pre></div>
<p>要素数が2つのリストに限定して,要素を取り出す関数 <code>fst</code>,<code>snd</code>が用意されていますが,値の取り出しはパターンマッチがよく利用されます.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">fst</span> (<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">snd</span> (<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> (x,y) <span class="ot">=</span> (<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> x</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> y</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span></span></code></pre></div>
<h3 data-number="1.5.6" id="文字列型"><span class="header-section-number">1.5.6</span> 文字列型</h3>
<p>Haskellの文字列型は歴史的に少し複雑な状況になっており,Preludeにおける<code>String</code>型の使い勝手があまり良くありません. なので, <code>text</code>パッケージの提供する<code>Text</code>型を利用するのが一般的です. なので,後ほどTextを導入しますが,一旦String型に関して見てみましょう.</p>
<p>Haskellでは1文字を表す <code>Char</code>型と文字列を表す<code>String</code>型を区別し,<code>Char</code>は<code>''</code>(シングルクォーテーション),<code>String</code>は<code>""</code>(ダブルクオーテーション)で囲みます.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="ch">&#39;c&#39;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ch">&#39;c&#39;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>t <span class="ch">&#39;c&#39;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ch">&#39;c&#39;</span><span class="ot"> ::</span> <span class="dt">Char</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="st">&quot;String&quot;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>t <span class="st">&quot;String&quot;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;String&quot;</span><span class="ot"> ::</span> <span class="dt">String</span></span></code></pre></div>
<p>Haskellにおける文字型<code>Char</code>のリスト<code>[Char]</code>の別名(<code>型シノニム</code>)です. <code>型シノニム</code>は型に別の名前をつけることで,用途などを区別する機能です.
型シノニムは,以下のように, <code>type 型シノニム = 元のデータ型</code>という形で定義します.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">String</span> <span class="ot">=</span> [<span class="dt">Char</span>]</span></code></pre></div>
<p>したがって,String型にはListの演算が適用できます.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="st">&quot;String&quot;</span> <span class="op">!!</span> <span class="dv">1</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ch">&#39;t&#39;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="ch">&#39;!&#39;</span> <span class="op">:</span> <span class="st">&quot;String&quot;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;!String&quot;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="st">&quot;!!&quot;</span> <span class="op">++</span>  <span class="st">&quot;String&quot;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;!!String&quot;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">length</span> <span class="st">&quot;String&quot;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span></span></code></pre></div>
<p>ただし,<code>String</code>型は非効率なため,現在ではあまり使われておらず,基本的に<code>text</code>パッケージの提供する <code>Data.Text</code>を利用することが推奨されています.</p>
<p><code>package.yaml</code>の<code>dependencies</code>に以下のように<code>text</code>を追加します.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> base &gt;= 4.7 &amp;&amp; &lt; 5</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> text</span></span></code></pre></div>
<p>スクリプトの最初に以下のように,記述することで文字列リテラル<code>""</code>が<code>Text</code>型に利用できるようになります.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Text</span></span></code></pre></div>
<p><code>{-# LANGUAGE OverloadedStrings #-}</code>は言語拡張を表しており,Haskellの処理系に機能を追加する宣言です. <code>OverloadedString</code>は文字列リテラルをTextなどの他の文字列を表すデータ型に適用できるようにする拡張です.</p>
<p><code>ghci</code>で言語拡張を導入するには,<code>:set</code>に続けて <code>-X言語拡張名</code>を記述します.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span><span class="kw">type</span> <span class="st">&quot;Text&quot;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Text&quot;</span><span class="ot"> ::</span> <span class="dt">String</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>set <span class="op">-</span><span class="dt">XOverloadedStrings</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">Data.Text</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span><span class="kw">type</span> <span class="st">&quot;Text&quot;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Text&quot;</span><span class="ot"> ::</span> <span class="dt">Data.String.IsString</span> a <span class="ot">=&gt;</span> a</span></code></pre></div>
<h2 data-number="1.6" id="論理型bool"><span class="header-section-number">1.6</span> 論理型(Bool)</h2>
<p>それが正しいか間違っているか判別できる文を<strong>命題</strong>といいます. 命題の結果を表すものとして真(正しい),偽(間違っている)という値を用います. 真と偽を併せて<strong>真偽値</strong>といいます.</p>
<p>例えば,<code>1は2より大きい</code>という命題は,間違っているので<strong>偽</strong>となります. <code>人間は必ず死ぬ</code>という命題は,今のところ不老不死の人間がいないので<strong>真</strong>です.</p>
<p>真偽値を表すデータ型として<code>Bool</code>があります. <code>Bool</code>は<code>True</code>(真),<code>False</code>(偽)のいずれかです.</p>
<p>Haskellには命題の判定を行う<code>関係演算子</code>として,以下のようなものが準備されています.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">記号</th>
<th style="text-align: center;">意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>&gt;</code></td>
<td style="text-align: center;">より大きい</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>&gt;=</code></td>
<td style="text-align: center;">以上</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>&lt;</code></td>
<td style="text-align: center;">より小さい</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>&lt;=</code></td>
<td style="text-align: center;">以下</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>==</code></td>
<td style="text-align: center;">等しい</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>/=</code></td>
<td style="text-align: center;">等しくない</td>
</tr>
</tbody>
</table>
<p>数値などの大小関係を調べるときには,比較演算子 <code>&gt;</code>,<code>&gt;=</code>.<code>&lt;</code>,<code>&lt;=</code>を利用します. 演算子の左右に数値を書くと,結果に応じて真偽値が帰ってきます.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">&gt;</span> <span class="dv">2</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="dt">False</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">&lt;</span> <span class="fl">1.5</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="dt">True</span></span></code></pre></div>
<p>値が等しいか/等しくないかを判定するには,<code>==</code>と<code>!=</code>を利用します.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">4</span> <span class="op">==</span> <span class="dv">4</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="dt">True</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="st">&quot;cat&quot;</span> <span class="op">/=</span> <span class="st">&quot;cat&quot;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="dt">False</span></span></code></pre></div>
<p><code>True</code> や <code>False</code>などの<code>Bool</code>値は, <code>AND</code>(かつ),<code>OR</code>(または),<code>NOT</code>という演算で計算することができます(<code>XOR</code>というのもあるが省略).
HaskellではAND は <code>&amp;&amp;</code>, OR は <code>||</code>, NOT は <code>not</code> という演算子が提供されています.</p>
<p>A,Bが命題だとして,<code>A &amp;&amp; B</code>は両方<code>True</code>のときに,<code>True</code>となります. <code>A || B</code>は片方どちらかが<code>True</code>のときに<code>True</code>となります.</p>
<p>例えば,</p>
<ul>
<li><p><code>1は2より大きい かつ 2は0より大きい</code> という命題は,<code>2は0より大きい</code>は正しいですが,<code>1は2より大きい</code>が間違っているので全体として,<code>False</code>です.</p></li>
<li><p><code>ネコは哺乳類である または ネコは鳥類である</code>という命題は <code>ネコは鳥類である</code>が間違っていますが全体としては<code>True</code>です.</p></li>
</ul>
<p>演算の結果は,それぞれ以下のようになります. これを真偽値表といいます. ここでは,最低限の例だけを紹介しますが,より深く理解したい人は論理学などの講義を受講しましょう.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">命題Aの値</th>
<th style="text-align: center;">Bの値</th>
<th style="text-align: center;"><code>A &amp;&amp; B</code></th>
<th style="text-align: center;"><code>A || B</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">True</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">True</td>
</tr>
<tr class="even">
<td style="text-align: center;">False</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">True</td>
</tr>
<tr class="odd">
<td style="text-align: center;">True</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">True</td>
</tr>
<tr class="even">
<td style="text-align: center;">False</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">True</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">&gt;</span> <span class="dv">2</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="dt">False</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">2</span> <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="dt">True</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">&gt;</span> <span class="dv">2</span> <span class="op">&amp;&amp;</span> <span class="dv">2</span> <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="dt">False</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">&gt;</span> <span class="dv">2</span> <span class="op">||</span> <span class="dv">2</span> <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="dt">True</span></span></code></pre></div>
<p><code>not</code> は命題の否定を表しており <code>True</code>が<code>False</code>,<code>False</code>が<code>True</code>になります.<code>not</code>は命題の前に書きます.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> 1 <span class="op">&gt;</span> 2</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">False</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> not <span class="er">(</span><span class="ex">1</span> <span class="op">&gt;</span> 2<span class="kw">)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="ex">True</span></span></code></pre></div>
<div class="note">
<p><strong>演習</strong></p>
<p>ある値が偶数かどうかは,2で割った余りが0かどうかを判定することで判定できます.
<code>x=101</code>,<code>y=202</code>として, 以下の命題の真偽を判定してください.</p>
<ul>
<li>xが偶数</li>
<li>yが偶数</li>
<li>xが偶数かつyが偶数</li>
<li>xが偶数またはyが偶数</li>
<li>x + y が奇数</li>
</ul>
</div>
<h2 data-number="1.7" id="スクリプトファイルの実行"><span class="header-section-number">1.7</span> スクリプトファイルの実行</h2>
<div class="warn">
<p>ここから先は,コードが複数行に渡ることが多くなるので,ghciの利用をやめてスクリプトを書きます.</p>
<p><code>app</code> フォルダ内に <code>practice.hs</code>を作成しそこで事例の勉強をしましょう.</p>
</div>
<p><code>practice.hs</code> ファイルを作成したら,ファイルを以下のように記述しましょう.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Text</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;practice&quot;</span></span></code></pre></div>
<div class="warn">
<p><code>module XXX () where</code></p>
<p>という記述は,他のファイルからインポート可能なmodule化を行うための宣言です.
また,Stackでは,<strong>大文字で始まる<code>*.hs</code>ファイルは,moduleとして認識されます.</strong></p>
<p>したがって,一つのプロジェクトに複数の実行可能ファイルを生成する場合には,</p>
<p><code>module XXX () where</code></p>
<p>の記述をなくし, ファイル名を小文字ではじめる必要があります.</p>
<p>これは,<code>Hello World</code>のために編集した<code>Main.hs</code>も同様であるため,<code>Main.hs</code>を<code>hello.hs</code>に名前を変更し,ファイル内の <code>module Main (main) where</code>の記述も削除し,以下のように変更しましょう.</p>
<p>cf. <a href="https://www.reddit.com/r/haskell/comments/capuz7/multiple_executable_in_project/">他にもいくつかの方法があるようです</a></p>
</div>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Lib</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> helloWorld</span></code></pre></div>
<p><code>package.yaml</code>の<code>executables:</code>を以下のように編集して<code>hello.hs</code>と<code>practice.hs</code>を実行可能ファイルとして登録します. <code>Data.Text</code>を利用するために,<code>dependencies:</code>以下に<code>- text</code>を追加しておきましょう.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> base &gt;= 4.7 &amp;&amp; &lt; 5</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> text</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">#ghc-options:</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span><span class="kw">:</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at"> src</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">executables</span><span class="kw">:</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hello</span><span class="kw">:</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">main</span><span class="kw">:</span><span class="at">                main.hs</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at">         app</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -threaded</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -rtsopts</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -with-rtsopts=-N</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> hello-world</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">practice</span><span class="kw">:</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">main</span><span class="kw">:</span><span class="at">                practice.hs</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at">         app</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -threaded</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -rtsopts</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -with-rtsopts=-N</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> hello-world</span></span></code></pre></div>
<p><code>stack run practice</code> で<code>practice!</code>と表示されれば成功です.</p>
<p>これからスクリプトで実行していくにあたって,<code>practice.hs</code>の中身をもう少し詳しく見てみましょう.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Lib</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;practice!!&quot;</span></span></code></pre></div>
<p>haskellのプログラムを実行すると, <code>main関数</code>のみが実行されます.</p>
<p>Haskellは関数型言語なので,これから<code>import Lib</code>と<code>main</code>の間に関数を定義していき,<code>main</code>の中で実行していくことになります.</p>
<p>main 関数で行うことは関数として実行することになりますが,これから学習する通常の関数の定義で記述するのは今は難しいので,<code>do</code>記法を紹介します. main 関数の=以下に<code>do</code>と書くことで,do以下のインデントブロックに記述された内容が手続き型的に1行ずつ実行されます.</p>
<p>以下のプログラムでは, <code>"practice1"</code>,<code>"practice2"</code>,<code>"practice3"</code>の順に標準出力されます.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Lib</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;practice1&quot;</span> <span class="co">-- &quot;practice1&quot;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;practice2&quot;</span> <span class="co">-- &quot;practice2&quot;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">putStrLn</span> <span class="st">&quot;practice3&quot;</span> <span class="co">-- &quot;practice3&quot;</span></span></code></pre></div>
<p><code>stack run practice</code>の結果を確認すると以下のようになります.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> stack <span class="ex">run</span> practice</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;practice1&quot;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;practice2&quot;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;practice3&quot;</span></span></code></pre></div>
<p>また,ghciと異なって,出力結果が同じ画面に現れないので,
以降のコード例では, その行の結果をコメントで書くこととします. コメント部分は,記述しなくても結果は変わらないので,省略しても構いません.</p>
]]></description>
    <pubDate>Mon, 24 Mar 2025 00:00:00 UT</pubDate>
    <guid>/lectures/iap3.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>特別講義DS Ch15 自然言語処理</title>
    <link>/lectures/slds15.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#自然言語処理" id="toc-自然言語処理"><span class="toc-section-number">1</span> 自然言語処理</a></li>
<li><a href="#トークン化と形態素解析" id="toc-トークン化と形態素解析"><span class="toc-section-number">2</span> トークン化と形態素解析</a></li>
<li><a href="#wordcloud" id="toc-wordcloud"><span class="toc-section-number">3</span> WordCloud</a></li>
<li><a href="#トピックモデル" id="toc-トピックモデル"><span class="toc-section-number">4</span> トピックモデル</a>
<ul>
<li><a href="#xtwitter-apiを用いたデータの取得" id="toc-xtwitter-apiを用いたデータの取得"><span class="toc-section-number">4.1</span> X(Twitter) APIを用いたデータの取得</a></li>
<li><a href="#トピックモデル実践" id="toc-トピックモデル実践"><span class="toc-section-number">4.2</span> トピックモデル実践</a></li>
</ul></li>
<li><a href="#ニューラル言語モデル" id="toc-ニューラル言語モデル"><span class="toc-section-number">5</span> ニューラル言語モデル</a>
<ul>
<li><a href="#マルチラベル分類" id="toc-マルチラベル分類"><span class="toc-section-number">5.1</span> マルチラベル分類</a></li>
</ul></li>
<li><a href="#自然言語ベクトル抽出によるデータ可視化と類似度評価" id="toc-自然言語ベクトル抽出によるデータ可視化と類似度評価"><span class="toc-section-number">6</span> 自然言語ベクトル抽出によるデータ可視化と類似度評価</a></li>
</ul>
</div>
<h1 data-number="1" id="自然言語処理"><span class="header-section-number">1</span> 自然言語処理</h1>
<p>非構造化データの分析手法として,前章では画像データを扱いました. 本章では, テキストデータを分析する手法である<strong>自然言語処理 (NPL; Natural Language Processing)</strong>について解説します.</p>
<h1 data-number="2" id="トークン化と形態素解析"><span class="header-section-number">2</span> トークン化と形態素解析</h1>
<p>自然言語処理にも様々な手法がありますが,基本的には元の文章データをそのまま使うことはなく,文章を適切な単位に分割するなどの前処理を施します. これを<strong>トークン化</strong>といい,代表的な手法としては<strong>単語分割</strong>,<strong>品詞分割</strong>,<strong>文字分割</strong>,<strong>サブワード分割</strong>などがあります.</p>
<p>単語分割に関して元の文章が英語などの単語ごとに区切られている文章であれば</p>
<p><code>"This is a pen"</code> → <code>"This","is","a","pen"</code></p>
<p>という風に簡単に分割できますが,日本語のように単語間に空白などがない言語では特別な処理が必要になります.</p>
<p>また,英語であっても, 代名詞 <code>'This'</code>, 動詞 <code>is</code>, 冠詞 <code>"a"</code>, 名詞 <code>"pen"</code>などのように品詞分割するためには特別な処理が必要になります.</p>
<p>このような処理を施すために文章を最小の意味を持つ言語単位(<strong>形態素</strong>)に分割し,それぞれの品詞を識別処理を
<strong>形態素解析(Morphological Analysis)</strong>といいます.</p>
<div class="note">
<p>形態素解析の基本的な手順は以下のようになります.</p>
<ul>
<li><h2 id="データの作成">データの作成</h2></li>
</ul>
<p>PDFやホームページなどから直接処理することも可能ですが, <code>.txt</code>や<code>.csv</code>,<code>.xlm</code>などの構造化データに変換しておくと処理が楽になります.</p>
<p>入力例文: <code>"太陽が昇る東の空が美しい"</code></p>
<ul>
<li><h2 id="テキストの前処理">テキストの前処理</h2></li>
</ul>
<p>不要なスペースや記号を除去しテキストを処理しやすい形に整理します.</p>
<ul>
<li><h2 id="形態素への分割">形態素への分割</h2></li>
</ul>
<p>文章を形態素と呼ばれる最小単位に分割します.</p>
<p><code>"太陽","が","昇る","東","の","空","が","美しい"</code></p>
<ul>
<li><h2 id="品詞のタグ付け">品詞のタグ付け</h2></li>
</ul>
<p>分割された形態素に品詞情報を付与します.</p>
<p><code>"太陽"</code>: 名詞</p>
<p><code>"が"</code>: 助詞</p>
<p><code>"昇る"</code>: 動詞</p>
<p><code>"東"</code>: 名詞</p>
<p><code>"の"</code>: 助詞</p>
<p><code>"空"</code>: 名詞</p>
<p><code>"が"</code>: 助詞</p>
<p><code>"美しい"</code>: 形容詞</p>
</div>
<p>日本語の形態素解析用のPythonパッケージとして有名なものには,<code>Mecab</code>や<code>Janome</code>があります.</p>
<div class="note">
<ul>
<li><code>Mecab</code>
<ul>
<li>日本語のオープンソース形態素解析システム</li>
<li>pythonのライブラリとしてはmecab-python3</li>
</ul></li>
<li><code>janome</code>
<ul>
<li>Pythonで書かれた日本語形態素解析器</li>
<li>MecabよりインストールなどがPythonに最適化されており,インストールなどが楽</li>
<li>ただし,遅いので大規模な処理では余り使われない</li>
</ul></li>
</ul>
<p>本資料では,以下形態素解析用ライブラリとして<code>Mecab</code>を利用するので</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install mecab-python3</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install unidic-lite</span></code></pre></div>
<p>を実行してインストールしておきましょう(<code>unidic-lite</code>は形態素解析用の日本語の辞書です.)</p>
</div>
<p>形態素解析の練習用のデータとして<a href="https://www.cuc.ac.jp/about_cuc/outline/spirits/index.html">千葉商科大学のHPに掲載されている理念</a>を利用してみます. テキスト部分をコピーして,<code>UTF-8</code>の<code>cuc.txt</code>ファイルを作成し,<code>data</code>フォルダに保存しましょう.</p>
<p><img src="/images/Ch15-WordCloud1.png" /></p>
<p>まずは,テキストデータを読み込んでみます. <code>pandas</code>などを利用して読み込むこともできますが,ここではPythonの組み込みメソッドである,<code>open()</code>でファイルを開き,<code>read()</code>で読み込み,<code>close()</code>でファイルを閉じます.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ファイルを開く</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;data/cuc.txt&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ファイルを読み込む</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> f.read()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ファイルを閉じる</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>f.close()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raw)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">建学の精神と理念:有用の学術と商業道徳の涵養</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">巣鴨高等商業学校を創設した文学博士遠藤隆吉は、自らの志とする学府創立に当たり、「建学の趣旨」を次のように述べています。</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">創設者 文学博士 遠藤 隆吉</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">...</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p><code>pandas</code>などではこれらの手順を一度にまとめて行ってくれていましたが,この手法で行う場合は<code>close()</code>を利用してファイルを閉じることを忘れないようにしましょう. 忘れた場合,システムのリソースが無駄に占有され,他のプログラムやソフトがファイルにアクセスできなくなるなどの問題が生じる可能性があります. 今回はファイルを読み込むだけですが,間に適用される処理が多くなるほど,<code>open()</code>と<code>close()</code>の間の対応関係が分かりづらくなります.</p>
<p>そこでこのように手動で<code>close()</code>を呼ぶ代わりに,Pythonでは<code>with文</code>を使うことで,インデントブロックを抜けた時に自動的にファイルを閉じるようにできます.<code>with文</code>を使うことでコードがよりシンプルかつエラーに強くなりますので,一般的にはwith文の使用が推奨されます.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/cuc.txt&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> f.read()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raw)</span></code></pre></div>
<p>続いて形態素解析の前の前処理を行います.
(以下の形態素解析のコードなどは<a href="https://rinsaka.com/python/nltk/05-wordcloud.html">神戸学院大学 林坂ゼミの資料</a>を参考にしました.)</p>
<p>前処理として, テキストファイルの改行,タブ,などを削除するための関数を用意します.
文字列を正規表現操作するための標準ライブラリ<code>re</code>を<code>import</code>する必要があるので注意して下さい.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re <span class="co">#正規表現操作のための標準ライブラリ</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_CRLF_from_Text(text):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;テキストファイルの改行,タブを削除し,形態素解析を実行</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    改行前後が日本語文字の場合は改行を削除する．</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    それ以外はスペースに置換する．</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 改行前後の文字が日本語文字の場合は改行を削除する</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> re.sub(<span class="st">&#39;([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)(</span><span class="ch">\n</span><span class="st">)([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)&#39;</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                       <span class="vs">r&#39;\1\3&#39;</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                       text)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残った改行とタブ記号はスペースに置換する</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> plaintext.replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plaintext</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> strip_CRLF_from_Text(raw)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(text)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">建学の精神と理念:有用の学術と商業道徳の涵養  巣鴨高等商業学校を創設した文学博士遠藤隆吉は...</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>改行やタブが消えて, 文毎にスペースで区切られた文章が作成されました. 日本語の文章の途中で改行がある場合には,改行前後を結合して1文としてまとめられていることを確認しましょう.</p>
<p>続いて,前処理が施された文章を<code>mecab</code>を利用して形態素解析を実施してみます.</p>
<p>抽出する品詞は<code>word_types</code>に<code>[String]</code>で指定します.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MeCab <span class="im">as</span> mc</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mecab_wakati(text,word_types <span class="op">=</span> [<span class="st">&quot;名詞&quot;</span>,<span class="st">&quot;動詞&quot;</span>,<span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#分かち書き</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> mc.Tagger()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#word_types = [String]で指定 (&quot;名詞&quot;,&quot;動詞&quot;,&quot;形容詞&quot;,&quot;副詞&quot;)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> t.parseToNode(text)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    sent <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    noun <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;名詞&quot;</span>]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="kw">in</span> [ <span class="st">&quot;動詞&quot;</span>, <span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(node):</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.surface <span class="op">!=</span> <span class="st">&quot;&quot;</span>:  <span class="co"># ヘッダとフッタを除外</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            word_type <span class="op">=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">0</span>]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> noun:</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                 sent <span class="op">+=</span> node.surface <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.surface は「表層形」</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> others:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                sent <span class="op">+=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">6</span>] <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.feature.split(&quot;,&quot;)[6] は形態素解析結果の「原型」</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> node.<span class="bu">next</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sent</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>sent <span class="op">=</span> mecab_wakati(text)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sent)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">建学 精神 理念 有用 学術 商業 道徳 涵養 巣鴨 商業 学校 創設 し...</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co">#動詞だけ抽出</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>sent <span class="op">=</span> mecab_wakati(text,[<span class="st">&#39;動詞&#39;</span>])</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;-&#39;</span><span class="op">*</span><span class="dv">10</span> <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, sent)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co"> スル スル アタル ノベル イル マサル</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>以上で文章の形態素解析は完了です.</p>
<h1 data-number="3" id="wordcloud"><span class="header-section-number">3</span> WordCloud</h1>
<p>広く使われる文章の可視化手法として,文章中に利用されている単語の頻度などを基準に文字の色や大きさを変える<code>WordCloud</code>があります. 先ほど形態素解析した文章を利用して,<code>WordCloud</code>を作成してみましょう.</p>
<p>まず日本語を表示するためにフォントの設定を行います.</p>
<p><code>Windwos</code>と<code>Mac</code>で異なりますので,自身の環境に併せて<code>コメントアウト</code>を外して下さい.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># フォントの保存先を指定する（環境によって書き換えてください）</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>font_path <span class="op">=</span> <span class="st">&quot;C:</span><span class="ch">\\</span><span class="st">WINDOWS</span><span class="ch">\\</span><span class="st">FONTS</span><span class="ch">\\</span><span class="st">MEIRYO.TTC&quot;</span>    <span class="co">## Windows 版はこちら</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># font_path = &quot;/System/Library/Fonts/ヒラギノ角ゴシック W3.ttc&quot;  ## Mac 版はこちら</span></span></code></pre></div>
<p><code>wordcloud</code>を<code>import</code>して,画像を生成します.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install wordcloud</span></code></pre></div>
<p>をしてから以下を実行しましょう.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> wordcloud <span class="im">import</span> WordCloud</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>wc <span class="op">=</span> WordCloud(width<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>              ,height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>              ,background_color<span class="op">=</span><span class="st">&#39;white&#39;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>              , regexp<span class="op">=</span><span class="vs">r&quot;[\w&#39;]+&quot;</span> <span class="co">#一文字を表示</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>              ,font_path<span class="op">=</span>font_path).generate(sent)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>wc.to_file(<span class="st">&quot;result/fig/cuc.png&quot;</span>)</span></code></pre></div>
<p>指定した保存先(<code>"result/fig/cuc.png"</code>)に以下の画像が保存されているはずです.</p>
<p><img src="/images/ch15-WordCloud2.png" /></p>
<p>WordCloudでは登場する用語の頻度で大きさや色などが強調されています. 千葉商科大学の理念では,実業,道徳,などが強調されていることが分かります.</p>
<p>WordCloudを作成する場合<code>'こと'</code>,<code>'もの'</code>などどのような文章にも頻出する用語は削除した方が望ましいです.
その場合,<code>stopwords</code>に記述した単語が除外されるので,除外しましょう.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>stopwords <span class="op">=</span> [<span class="st">&#39;こと&#39;</span>,<span class="st">&#39;もの&#39;</span>,<span class="st">&#39;ため&#39;</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>wc <span class="op">=</span> WordCloud(width<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              ,height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>              ,background_color<span class="op">=</span><span class="st">&#39;white&#39;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>              , regexp<span class="op">=</span><span class="vs">r&quot;[\w&#39;]+&quot;</span> <span class="co">#一文字を表示</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>              ,font_path<span class="op">=</span>font_path</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>              ,stopwords<span class="op">=</span>stopwords).generate(sent)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>wc.to_file(<span class="st">&quot;result/fig/cuc2.png&quot;</span>)</span></code></pre></div>
<p><img src="/images/ch15-WordCloud3.png" /></p>
<p>これまでのコードを整理すると以下のようになります.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> wordcloud <span class="im">import</span> WordCloud</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re <span class="co">#正規表現操作のための標準ライブラリ</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MeCab <span class="im">as</span> mc</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_CRLF_from_Text(text):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;テキストファイルの改行,タブを削除し,形態素解析を実行</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    改行前後が日本語文字の場合は改行を削除する．</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    それ以外はスペースに置換する．</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 改行前後の文字が日本語文字の場合は改行を削除する</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> re.sub(<span class="st">&#39;([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)(</span><span class="ch">\n</span><span class="st">)([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)&#39;</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                       <span class="vs">r&#39;\1\3&#39;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                       text)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残った改行とタブ記号はスペースに置換する</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> plaintext.replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plaintext</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mecab_wakati(text,word_types <span class="op">=</span> [<span class="st">&quot;名詞&quot;</span>,<span class="st">&quot;動詞&quot;</span>,<span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]):</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#分かち書き</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> mc.Tagger()</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#word_types = [String]で指定 (&quot;名詞&quot;,&quot;動詞&quot;,&quot;形容詞&quot;,&quot;副詞&quot;)</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> t.parseToNode(text)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    sent <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    noun <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;名詞&quot;</span>]</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="kw">in</span> [ <span class="st">&quot;動詞&quot;</span>, <span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(node):</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.surface <span class="op">!=</span> <span class="st">&quot;&quot;</span>:  <span class="co"># ヘッダとフッタを除外</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            word_type <span class="op">=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">0</span>]</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> noun:</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                 sent <span class="op">+=</span> node.surface <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.surface は「表層形」</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> others:</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                sent <span class="op">+=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">6</span>] <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.feature.split(&quot;,&quot;)[6] は形態素解析結果の「原型」</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> node.<span class="bu">next</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sent</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/cuc.txt&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> f.read()</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> strip_CRLF_from_Text(raw)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co">#名詞だけ抽出</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>sent <span class="op">=</span> mecab_wakati(text,[<span class="st">&#39;名詞&#39;</span>])</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="co"># WordCloud</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="co"># フォントの保存先を指定する（環境によって書き換えてください）</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>font_path <span class="op">=</span> <span class="st">&quot;C:</span><span class="ch">\\</span><span class="st">WINDOWS</span><span class="ch">\\</span><span class="st">FONTS</span><span class="ch">\\</span><span class="st">MEIRYO.TTC&quot;</span>    <span class="co">## Windows 版はこちら</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="co">#font_path = &quot;/System/Library/Fonts/ヒラギノ角ゴシック W3.ttc&quot;  ## Mac 版はこちら</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>stopwords <span class="op">=</span> [<span class="st">&#39;こと&#39;</span>,<span class="st">&#39;もの&#39;</span>,<span class="st">&#39;ため&#39;</span>]</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>wc <span class="op">=</span> WordCloud(width<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>              ,height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>              ,background_color<span class="op">=</span><span class="st">&#39;white&#39;</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>              , regexp<span class="op">=</span><span class="vs">r&quot;[\w&#39;]+&quot;</span> <span class="co">#一文字を表示</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>              ,font_path<span class="op">=</span>font_path</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>              ,stopwords<span class="op">=</span>stopwords).generate(sent)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>wc.to_file(<span class="st">&quot;result/fig/cuc2.png&quot;</span>)</span></code></pre></div>
<h1 data-number="4" id="トピックモデル"><span class="header-section-number">4</span> トピックモデル</h1>
<p>続いて, テキスト文書の集合から潜在的なトピック(話題)を抽出するために広く利用される古典的手法である,トピックモデルを利用してみましょう.</p>
<p>トピックモデルでは単語の分布を使って,文章が何について話しているかを抽出します.ただし,出力は単語の集合で表されるため,そのトピックが何に関する話題かは利用者が判断する必要があります.</p>
<pre><code>- 例: トピックA: ｢経済｣｢市場｣｢投資｣ ← 経済に関するトピック
- 例: トピックB: ｢ねこ｣｢いぬ｣｢ペット｣ ← ペットに関するトピック と解釈できる</code></pre>
<p>トピックモデルにもいくつかの手法がありますが,最も一般的な実装手法の一つにLDA（Latent Dirichlet Allocation: 潜在的ディリクレ配分法）があります. LDA以外にもPLSA（Probabilistic Latent Semantic Analysis）などがあります.</p>
<p>LDAでは各文章をトピックの混合分布として表現します.</p>
<pre><code>-   例: 文章1: トピックA 0.5, トピックB 0.4, トピックD 0.1
-   例: 文章2: トピックA 0.6, トピックE 0.3</code></pre>
<p>LDAでは,各文書のトピック分布と各トピックの単語分布にディリクレ分布を使用します.ディリクレ分布は,確率の分布に対する分布（事前分布）として使われ,特にトピックの混合率が異なる多様な文書集合に対応できます.この過程では「ギブスサンプリング」や「変分ベイズ法」といった推論手法を使い,文書全体のトピックと単語の分布が収束するまで反復的に計算されます.ギブスサンプリングや事後分布,事前分布などに関しては, 一般化線形モデルの章で扱っています.</p>
<h2 data-number="4.1" id="xtwitter-apiを用いたデータの取得"><span class="header-section-number">4.1</span> X(Twitter) APIを用いたデータの取得</h2>
<p>自然言語解析では,ワードクラウドの事例のように,まとまった文章を分析する場合もありますが,X(旧:Twitter)のつぶやきのように,短い文章の集合を扱う場合もあります. ここでは, TwitterのAPIを利用して,つぶやきを取得し,そのつぶやきに関して分析してみましょう.</p>
<div class="note">
<p><code>API（Application Programming Interface）</code>とは,ソフトウェア同士がデータや機能をやりとりするための「窓口」のようなものです.開発者はAPIを通じて,他のサービスやアプリケーションの機能を利用できるため,複雑な処理を簡単に実行したり,他のサービスと連携することができます.</p>
<p>APIの利用に関わる主な通信技術には, <code>HTTP/HTTPSプロトコル</code>, <code>REST（Representational State Transfer）</code>, <code>SOAP（Simple Object Access Protocol）</code>,および<code>WebSocket</code>などがあり,それぞれ異なる目的や特徴を持っています.</p>
</div>
<p><code>X.API</code>は<code>REST</code>アーキテクチャで提供されて降りその概要は以下のとおりです.</p>
<div class="note">
<ul>
<li><code>HTTP/HTTPSプロトコル</code></li>
</ul>
<p>APIの通信は通常,ウェブブラウザと同様にHTTPやHTTPSプロトコルを使って行われます.HTTPSは通信を暗号化し,セキュリティを確保するため,多くのAPIで推奨されます.</p>
<ul>
<li><code>REST（Representational State Transfer）</code></li>
</ul>
<p>RESTは,HTTPを利用してリソース（データや機能）にアクセスするための設計原則で,最も広く使われるAPI通信の形式です.REST APIでは,<code>GET</code>,<code>POST</code>,<code>PUT</code>,<code>DELETE</code>などのHTTPメソッドを使ってデータを取得,作成,更新,削除します.シンプルかつ軽量なため,モバイルアプリやWebサービスでの利用に適しています.</p>
<ul>
<li><code>GET</code></li>
</ul>
<p>概要: リソース（データ）の取得に使用される.</p>
<p>例: ユーザー情報を取得する場合,GET /users/123のように送信すると,ユーザーIDが123のデータが返されます.</p>
<p>特徴: サーバー上のデータを変更しない「読み取り専用」操作.</p>
<ul>
<li><code>POST</code></li>
</ul>
<p>概要: 新しいリソースを作成するために使用される.</p>
<p>例: 新しい記事を投稿する場合,POST /articlesで記事データをサーバーに送信すると,新しい記事が作成されます.</p>
<p>特徴: サーバーにデータを送信して新しいエントリを追加する操作.</p>
<ul>
<li><code>PUT</code></li>
</ul>
<p>概要: 既存のリソースを更新するために使用される.</p>
<p>例: 記事の内容を変更する場合,PUT /articles/456で新しいデータを送信し,記事ID456の内容を更新します.</p>
<p>特徴: 指定されたリソース全体を置き換える操作.</p>
<ul>
<li><code>DELETE</code></li>
</ul>
<p>概要: リソースの削除に使用される.</p>
<p>例: 記事を削除する場合,DELETE /articles/456を実行すると,記事ID456が削除されます.</p>
<p>特徴: サーバーからリソースを取り除く操作.</p>
</div>
<p>REST APIでデータをやりとりする際のデータ形式として,<strong><code>JSON（JavaScript Object Notation）</code></strong>が一般的に使用されます.JSONはシンプルで軽量なテキスト形式で,読みやすく,プログラミング言語間の互換性も高いため,多くのAPIで標準的なフォーマットとして採用されています.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">123</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;John Doe&quot;</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;johndoe@example.com&quot;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>これから,<code>X.API</code>にGETメソッドを利用し呟きを取得します.APIから返答されるデータはjsonですが,今回はJSONを直接触らず,これまでに扱ってきた<code>CSV</code>に変換します. APIを操作するためのライブラリ<code>requests</code>をinstallしておきましょう.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install requests</span></code></pre></div>
<p>以下の処理はX APIの無料の範囲で行っていますので,誰でも再現できますが, アカウントの登録など手間が多く,また無料版のAPIでは15分に一回しかリクエストが送れないため,データの取得には最低でも15分かかります.
社長と社名が変わってからAPI機能が物凄く使いにくくなっており,値段も高額になっています.まともに研究で利用しようと思うと月5000ドルのAPI使用料を払う必要があります.2000ドルはこの講義のために払うのが難しいので,月200ドルのBasicプランであれば利用できるアカウントは準備しますが,Basicプランでは<strong>過去7日間の呟きしか取得できない</strong>ので注意しましょう.</p>
<p><img src="/images/ch15-XAPIV2Products.png" /></p>
<p>研究で利用する人以外は完成した<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/tweets.csv">こちらのデータ</a>をダウンロードして利用しましょう.</p>
<p>XのAPIを利用するには,認証トークン(<code>Bearer Token</code>)を発行する必要があります.認証トークンとは<code>X.API</code>にアクセスするための認証情報です.</p>
<p><a href="https://x.com/i/flow/login?input_flow_data=%7B%22requested_variant%22%3A%22eyJyZWRpcmVjdF9hZnRlcl9sb2dpbiI6Imh0dHBzOi8vZGV2ZWxvcGVyLnguY29tL2VuL3BvcnRhbC9wcm9qZWN0cy1hbmQtYXBwcyJ9%22%7D">Xのデベロッパー用ページ</a>からまずはサインアップします.</p>
<p>今回は無料版を利用するので, <code>Sign up for Free Account</code>をクリックしましょう.</p>
<p><img src="/images/ch15-X-sign-up.png" /></p>
<p>利用目的を尋ねられるので,<strong>250文字以上の英文で</strong>回答しましょう. その他のチェックを入れて,次に進みます.</p>
<p><img src="/images/ch15-X-reason.png" /></p>
<p>左のメニューの<code>Dashboard</code>に表示されている<code>Project APP</code>の<code>Keys and Tokens</code>(鍵)ボタンを押します.</p>
<p><img src="/images/ch15-XAPI-Dashbooard.png" /></p>
<p><code>Bearer Token</code>の<code>Regenerate</code>をクリックすると<code>Bearer Token</code>が表示されます. クリップボードにコピーしてどこかに保存しましょう.このトークンは一度しか表示されません.忘れた場合は別のトークンを再生成する必要があるので注意しましょう.</p>
<p><img src="/images/ch15-XAPI-Token.png" /></p>
<p>取得したトークンを利用してプログラムを書いていきます.</p>
<p>まずは認証トークンを設定します.先ほど取得した認証トークンを<code>bearer_token</code>という変数に格納し,API呼び出し時に利用します(<code>YOUR_BEARER_TOKEN</code>の部分を書き換えましょう.)</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests <span class="co">#HTTPリクエストを送るためのライブラリです.このライブラリを使ってAPIにアクセスします.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 認証トークン</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>bearer_token <span class="op">=</span> <span class="st">&#39;YOUR_BEARER_TOKEN&#39;</span></span></code></pre></div>
<p><code>X.API</code>の「検索」機能にアクセスするためのURLを指定します. ここでは,最近のツイートを取得するエンドポイント<code>search/recent</code>を指定しています. <code>search/recent</code>では直近7日間のつぶやきを取得できます. それ以上過去のつぶやきは<code>Pro</code>アカウントでしか取得することができません.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Twitter APIのエンドポイントURL</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>search_url <span class="op">=</span> <span class="st">&quot;https://api.x.com/2/tweets/search/recent&quot;</span></span></code></pre></div>
<p>取得対象のキーワード（検索ワード）を指定します.このコードでは「国民民主党」に関するツイートを検索します.一つのプログラムで複数のワードを取得することも可能ですが,<code>X.API</code>の無料版では,<strong>15分に1回しかリクエストが送れない</strong>ため,複数のワードで検索するにはコード内で15分間待機する機能を入れる必要があるので今回は一つだけ検索してみましょう.</p>
<p><code>tweet_count</code>で各検索で取得するツイート数の上限です.無料版のAPI機能では, <strong>1ヶ月あたり100ツイートのみアクセスできる</strong>ので,50にすると1ヶ月に2回アクセスできます. 1度失敗すると数を大幅に減らすか,1ヶ月待つか,課金する必要があるので注意して下さい.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 検索ワード</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>word <span class="op">=</span> <span class="st">&quot;国民民主党&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>tweet_count <span class="op">=</span> <span class="dv">50</span></span></code></pre></div>
<p>認証トークンをリクエストヘッダーに追加するための関数<code>bearer_oauth()</code>を作成します.この関数で設定されたヘッダーを使って,<code>X.API</code>へのリクエストが認証されます.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bearer_oauth(r):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    r.headers[<span class="st">&quot;Authorization&quot;</span>] <span class="op">=</span> <span class="ss">f&quot;Bearer </span><span class="sc">{</span>bearer_token<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    r.headers[<span class="st">&quot;User-Agent&quot;</span>] <span class="op">=</span> <span class="st">&quot;v2RecentSearchPython&quot;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r</span></code></pre></div>
<p>指定されたURLにGETリクエストを送信し,APIのレスポンスを取得します.<code>response.status_code != 200</code>でAPIからエラーが返された場合,例外を発生させます.正常なレスポンスを受け取った場合,JSON形式でデータを返します.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_endpoint(url, params):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url, auth<span class="op">=</span>bearer_oauth, params<span class="op">=</span>params)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    response.encoding <span class="op">=</span> response.apparent_encoding</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(response.status_code, response.text)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.json()</span></code></pre></div>
<p>特定の検索ワードに関するツイートを取得します. 検索パラメータを<code>lang:ja</code>に設定し,日本語のツイートに限定しています.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_tweets_for_party(party):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    query_params <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span>: <span class="ss">f&quot;</span><span class="sc">{</span>party<span class="sc">}</span><span class="ss"> lang:ja&quot;</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;max_results&quot;</span>: tweet_count</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    json_response <span class="op">=</span> connect_to_endpoint(search_url, query_params)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    tweets_data <span class="op">=</span> json_response.get(<span class="st">&quot;data&quot;</span>, [])</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [tweet[<span class="st">&quot;text&quot;</span>] <span class="cf">for</span> tweet <span class="kw">in</span> tweets_data]</span></code></pre></div>
<p>作成した関数を利用して,つぶやきを取得します.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    all_tweets <span class="op">=</span> []</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>word<span class="sc">}</span><span class="ss">のツイートを取得中...&quot;</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    tweets <span class="op">=</span> fetch_tweets_for_party(word)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tweet <span class="kw">in</span> tweets:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        all_tweets.append({<span class="st">&quot;Word&quot;</span>: word, <span class="st">&quot;Tweet&quot;</span>: tweet})</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_tweets:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(all_tweets)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        df.to_csv(<span class="st">&quot;tweets.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">&quot;utf-8-sig&quot;</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;tweets.csvにデータを書き出しました。&quot;</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;取得したデータがありません。&quot;</span>)</span></code></pre></div>
<p>コード全体は以下のようになります.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 認証トークン</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>bearer_token <span class="op">=</span> <span class="st">&#39;YOUR_BEARER_TOKEN&#39;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Twitter APIのエンドポイントURL</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>search_url <span class="op">=</span> <span class="st">&quot;https://api.x.com/2/tweets/search/recent&quot;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 検索ワード</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>word <span class="op">=</span> <span class="st">&quot;国民民主党&quot;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 各政党ごとに取得する件数</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>tweet_count <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bearer_oauth(r):</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Method required by bearer token authentication.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    r.headers[<span class="st">&quot;Authorization&quot;</span>] <span class="op">=</span> <span class="ss">f&quot;Bearer </span><span class="sc">{</span>bearer_token<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    r.headers[<span class="st">&quot;User-Agent&quot;</span>] <span class="op">=</span> <span class="st">&quot;v2RecentSearchPython&quot;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_endpoint(url, params):</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url, auth<span class="op">=</span>bearer_oauth, params<span class="op">=</span>params)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    response.encoding <span class="op">=</span> response.apparent_encoding</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(response.status_code, response.text)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.json()</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_tweets_for_party(party):</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># パラメータの設定</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    query_params <span class="op">=</span> {</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;query&quot;</span>: <span class="ss">f&quot;</span><span class="sc">{</span>party<span class="sc">}</span><span class="ss"> lang:ja&quot;</span>,</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;max_results&quot;</span>: tweet_count  <span class="co"># APIの制限で一度に取得できるのは最大100件まで</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># エンドポイントに接続してデータを取得</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    json_response <span class="op">=</span> connect_to_endpoint(search_url, query_params)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    tweets_data <span class="op">=</span> json_response.get(<span class="st">&quot;data&quot;</span>, [])</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [tweet[<span class="st">&quot;text&quot;</span>] <span class="cf">for</span> tweet <span class="kw">in</span> tweets_data]</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    all_tweets <span class="op">=</span> []</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 各政党ごとのツイートを取得してデータを集約</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>word<span class="sc">}</span><span class="ss">のツイートを取得中...&quot;</span>)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    tweets <span class="op">=</span> fetch_tweets_for_party(party)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tweet <span class="kw">in</span> tweets:</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        all_tweets.append({<span class="st">&quot;Word&quot;</span>: party, <span class="st">&quot;Tweet&quot;</span>: tweet})</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># データをDataFrameに変換してCSVに書き出し</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_tweets:</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(all_tweets)</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        df.to_csv(<span class="st">&quot;tweets.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">&quot;utf-8-sig&quot;</span>)</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;tweets.csvにデータを書き出しました。&quot;</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;取得したデータがありません。&quot;</span>)</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<p>このコードで取得した50件の呟きをまとめたデータが<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/tweets.csv">こちら</a>になります.</p>
<p>以下,このデータを利用して分析を行ってみましょう.</p>
<h2 data-number="4.2" id="トピックモデル実践"><span class="header-section-number">4.2</span> トピックモデル実践</h2>
<p>LDAによるトピックモデルを利用するためにライブラリ<code>gensim</code>と,LDAの可視化用のライブラリ<code>pyLDAvis</code>をインストールしましょう.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install gensim pyLDAvis</span></code></pre></div>
<p><code>import</code>と形態素解析のための関数を定義しておきます.
URLは上手く形態素解析できないので,URLを削除する関数も新たに定義しています.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MeCab <span class="im">as</span> mc</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gensim.corpora.dictionary <span class="im">import</span> Dictionary</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gensim.models <span class="im">import</span> LdaModel</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyLDAvis</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyLDAvis.gensim_models <span class="im">as</span> gensimvis</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyLDAvis.gensim</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_CRLF_from_Text(text):</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;テキストファイルの改行,タブを削除し,形態素解析を実行</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">    改行前後が日本語文字の場合は改行を削除する．</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">    それ以外はスペースに置換する．</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 改行前後の文字が日本語文字の場合は改行を削除する</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> re.sub(<span class="st">&#39;([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)(</span><span class="ch">\n</span><span class="st">)([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)&#39;</span>,</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>                       <span class="vs">r&#39;\1\3&#39;</span>,</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>                       text)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残った改行とタブ記号はスペースに置換する</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> plaintext.replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plaintext</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mecab_wakati(text,word_types <span class="op">=</span> [<span class="st">&quot;名詞&quot;</span>,<span class="st">&quot;動詞&quot;</span>,<span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]):</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#分かち書き</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> mc.Tagger()</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#word_types = [String]で指定 (&quot;名詞&quot;,&quot;動詞&quot;,&quot;形容詞&quot;,&quot;副詞&quot;)</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> t.parseToNode(text)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    sent <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    noun <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;名詞&quot;</span>]</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="kw">in</span> [ <span class="st">&quot;動詞&quot;</span>, <span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]]</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(node):</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.surface <span class="op">!=</span> <span class="st">&quot;&quot;</span>:  <span class="co"># ヘッダとフッタを除外</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>            word_type <span class="op">=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">0</span>]</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> noun:</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>                 sent <span class="op">+=</span> node.surface <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.surface は「表層形」</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> others:</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>                sent <span class="op">+=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">6</span>] <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.feature.split(&quot;,&quot;)[6] は形態素解析結果の「原型」</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> node.<span class="bu">next</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sent</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_urls(text):</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># URLを検出する正規表現パターン</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    url_pattern <span class="op">=</span> <span class="vs">r&#39;http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+&#39;</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># URLを空文字に置換して除外</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(url_pattern, <span class="st">&#39;&#39;</span>, text)</span></code></pre></div>
<p>データを読み込みます(このデータを取得した次の日に国民民主党の党首の不倫騒動があったので,そのつぶやきが取れていれば面白かったのですが,残念です.)</p>
<p>トークナイズ(形態素解析),と削除文字の指定,削除までをまとめて行います. ここで,指定している削除文字は一度結果を見たあとで追加したものです.実際の分析では,結果とコードを何往復かして,調整する作業が必要になります.</p>
<p>形態素解析の前に<code>remove_urls()</code>を適用していることに注意して下さい.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#データの読み込み</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/tweets.csv&#39;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#国民民主党のリアクションシートだけのデータを作る</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>akagi <span class="op">=</span> df[<span class="st">&#39;Tweet&#39;</span>]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#トークナイズ</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> [mecab_wakati(strip_CRLF_from_Text(remove_urls(x)),[<span class="st">&quot;名詞&quot;</span>,<span class="st">&quot;動詞&quot;</span>]).split(<span class="st">&#39; &#39;</span>) <span class="cf">for</span> x <span class="kw">in</span> akagi]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#削除文字の指定</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>stopwords <span class="op">=</span> [<span class="st">&#39;オモウ&#39;</span>,<span class="st">&#39;イウ&#39;</span>,<span class="st">&#39;イル&#39;</span>,<span class="st">&#39;アル&#39;</span>,<span class="st">&#39;こと&#39;</span>]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> [[x <span class="cf">for</span> x <span class="kw">in</span> t <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> stopwords] <span class="cf">for</span> t <span class="kw">in</span> txt]</span></code></pre></div>
<p>前回扱った｢千葉商科大学の理念｣は単一のテキストデータでしたが,今回の分析の対象は50件のつぶやきです. このような複数のテキストを扱う際には,前処理として<strong>出現頻度による単語の削除</strong>がよく用いられます. 殆ど全てのテキストに出てくるような単語(数字や副詞などが多い)は特徴を抽出する際には役に立たないので削除したほうが良い場合があります. また,反対に出現が非常に稀な単語,造語や個人名なども削除したほうがいい場合があります.</p>
<p>実際の分析では,どの程度の頻度を基準とするかを結果を見ながら調整する必要がありますが,今回は練習なので<code>2文書未満にしか出現しない単語</code>と,<code>全体の50%以上に出現する単語</code>を削除しています.</p>
<p>実装は<code>dictionary</code>クラスの<code>filter_extremes()</code>メソッドを利用しています.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#辞書の作成</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>dictionary <span class="op">=</span> Dictionary(txt)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">#出現がx文書に満たない単語と、y%以上の文書に出現する単語を極端と見做し削除する</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span><span class="dv">2</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>dictionary.filter_extremes(no_below<span class="op">=</span>x,no_above<span class="op">=</span>y)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># LdaModelが読み込めるBoW形式に変換</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>corpus <span class="op">=</span> [dictionary.doc2bow(x) <span class="cf">for</span> x <span class="kw">in</span> txt]</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of unique tokens: </span><span class="sc">{</span><span class="bu">len</span>(dictionary)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of documents: </span><span class="sc">{</span><span class="bu">len</span>(corpus)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">Number of unique tokens: 200</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">Number of documents: 50</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>LDAでは,事前に抽出するトピック数を決めることができます.こちらも実際には調整が必要ですが,今回は決め打ちで<code>3</code>としています.</p>
<p><code>LDA</code>の結果は<code>pyLDAvis</code>によって<code>html</code>形式で出力されます.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#3トピックを抽出</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>num_topics <span class="op">=</span><span class="dv">3</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>lda <span class="op">=</span> LdaModel(corpus, id2word <span class="op">=</span>dictionary, num_topics<span class="op">=</span>num_topics, alpha<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#トピックごとに上位5単語を表示</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span>pd.DataFrame()</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(num_topics):</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    word<span class="op">=</span>[]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, prob <span class="kw">in</span> lda.get_topic_terms(t, topn<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        word.append(dictionary.id2token[<span class="bu">int</span>(i)])</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> pd.DataFrame([word],index<span class="op">=</span>[<span class="ss">f&#39;topic</span><span class="sc">{</span>t<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">&#39;</span>])</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df._append(_)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.T)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">  topic1 topic2 topic3</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co">0      金      万     増税</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co">1     立憲      円      壁</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co">2      案      壁   メディア</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co">3     給付    103     自民</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="co">4     経済      話     結果</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co">#可視化</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="co">#PyLDAvisの実装</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>visualisation <span class="op">=</span> pyLDAvis.gensim.prepare(lda, corpus, dictionary)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>pyLDAvis.save_html(visualisation, <span class="st">&#39;result/LDA_Visualization.html&#39;</span>)</span></code></pre></div>
<p>今回は3つのトピックではいずれも103万円の壁の話をしていますが<code>topic1</code>では立憲民主党の対案としての低所得者への給付の話題,<code>topic3</code>ではメディアや自民党に対する批判などの話題
が抽出されました. あまりはっきりしていませんが,もう少しつぶやきの数を増やすと分かりやすくなるかもしれません.</p>
<p>出力された<code>LDA_Visualization.html</code>をクリックするとブラウザ上で確認することができます.</p>
<p><img src="/images/ch15-LDA-result1.png" /></p>
<p>左側には主成分分析による第1主成分,第2主成分上にマッピングされたトピックの集合が可視化されており,右側には全体のトピックにおける単語の分布が表示されています.</p>
<p>それぞれのトピックをクリックすることでトピックごとの単語の分布が表示されます.</p>
<p><img src="/images/ch15-LDA-result2.png" />
<img src="/images/ch15-LDA-result3.png" /></p>
<p>右上のバーで調整できるラムダは,トピックモデルの結果を調整するためのパラメータです.ラムダの値が大きいほど,他のトピックにも出現する一般的な単語を除外し,トピック内の単語の特徴を強調します. 値を変化させてどのようにトピックの分布が変わるかを確認してみましょう.</p>
<p>コード全体は以下のようになっています.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MeCab <span class="im">as</span> mc</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gensim.corpora.dictionary <span class="im">import</span> Dictionary</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gensim.models <span class="im">import</span> LdaModel</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyLDAvis</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyLDAvis.gensim_models <span class="im">as</span> gensimvis</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyLDAvis.gensim</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_CRLF_from_Text(text):</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;テキストファイルの改行,タブを削除し,形態素解析を実行</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">    改行前後が日本語文字の場合は改行を削除する．</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">    それ以外はスペースに置換する．</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 改行前後の文字が日本語文字の場合は改行を削除する</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> re.sub(<span class="st">&#39;([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)(</span><span class="ch">\n</span><span class="st">)([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)&#39;</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                       <span class="vs">r&#39;\1\3&#39;</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>                       text)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残った改行とタブ記号はスペースに置換する</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> plaintext.replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plaintext</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mecab_wakati(text,word_types <span class="op">=</span> [<span class="st">&quot;名詞&quot;</span>,<span class="st">&quot;動詞&quot;</span>,<span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]):</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#分かち書き</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> mc.Tagger()</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#word_types = [String]で指定 (&quot;名詞&quot;,&quot;動詞&quot;,&quot;形容詞&quot;,&quot;副詞&quot;)</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> t.parseToNode(text)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    sent <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    noun <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;名詞&quot;</span>]</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> word_types <span class="cf">if</span> x <span class="kw">in</span> [ <span class="st">&quot;動詞&quot;</span>, <span class="st">&quot;形容詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>]]</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(node):</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.surface <span class="op">!=</span> <span class="st">&quot;&quot;</span>:  <span class="co"># ヘッダとフッタを除外</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            word_type <span class="op">=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">0</span>]</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> noun:</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                 sent <span class="op">+=</span> node.surface <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.surface は「表層形」</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> others:</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>                sent <span class="op">+=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">6</span>] <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.feature.split(&quot;,&quot;)[6] は形態素解析結果の「原型」</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> node.<span class="bu">next</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sent</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_urls(text):</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># URLを検出する正規表現パターン</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    url_pattern <span class="op">=</span> <span class="vs">r&#39;http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+&#39;</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># URLを空文字に置換して除外</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(url_pattern, <span class="st">&#39;&#39;</span>, text)</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="co"># ↑ ここまで,関数定義</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ↓ ここから,データ処理</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="co">#データの読み込み</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/tweets.csv&#39;</span>)</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="co">#国民民主党のリアクションシートだけのデータを作る</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>akagi <span class="op">=</span> df[df[<span class="st">&#39;Word&#39;</span>] <span class="op">==</span> <span class="st">&#39;自民党&#39;</span>][<span class="st">&#39;Tweet&#39;</span>]</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="co">#トークナイズ</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> [mecab_wakati(strip_CRLF_from_Text(remove_urls(x)),[<span class="st">&quot;名詞&quot;</span>,<span class="st">&quot;動詞&quot;</span>]).split(<span class="st">&#39; &#39;</span>) <span class="cf">for</span> x <span class="kw">in</span> akagi]</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="co">#削除文字の指定</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>stopwords <span class="op">=</span> [<span class="st">&#39;オモウ&#39;</span>,<span class="st">&#39;イウ&#39;</span>,<span class="st">&#39;イル&#39;</span>,<span class="st">&#39;アル&#39;</span>,<span class="st">&#39;こと&#39;</span>]</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> [[x <span class="cf">for</span> x <span class="kw">in</span> t <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> stopwords] <span class="cf">for</span> t <span class="kw">in</span> txt]</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="co">#辞書の作成</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>dictionary <span class="op">=</span> Dictionary(txt)</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="co">#出現がx文書に満たない単語と、y%以上の文書に出現する単語を極端と見做し削除する</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span><span class="dv">2</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>dictionary.filter_extremes(no_below<span class="op">=</span>x,no_above<span class="op">=</span>y)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="co"># LdaModelが読み込めるBoW形式に変換</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>corpus <span class="op">=</span> [dictionary.doc2bow(x) <span class="cf">for</span> x <span class="kw">in</span> txt]</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of unique tokens: </span><span class="sc">{</span><span class="bu">len</span>(dictionary)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of documents: </span><span class="sc">{</span><span class="bu">len</span>(corpus)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a><span class="co">#3トピックを抽出</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>num_topics <span class="op">=</span><span class="dv">3</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>lda <span class="op">=</span> LdaModel(corpus, id2word <span class="op">=</span>dictionary, num_topics<span class="op">=</span>num_topics, alpha<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="co">#トピックごとに上位5単語を表示</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span>pd.DataFrame()</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(num_topics):</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>    word<span class="op">=</span>[]</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, prob <span class="kw">in</span> lda.get_topic_terms(t, topn<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>        word.append(dictionary.id2token[<span class="bu">int</span>(i)])</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> pd.DataFrame([word],index<span class="op">=</span>[<span class="ss">f&#39;topic</span><span class="sc">{</span>t<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">&#39;</span>])</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df._append(_)</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.T)</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="co">#可視化</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="co">#PyLDAvisの実装</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>visualisation <span class="op">=</span> pyLDAvis.gensim.prepare(lda, corpus, dictionary)</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>pyLDAvis.save_html(visualisation, <span class="st">&#39;result/LDA_Visualization.html&#39;</span>)</span></code></pre></div>
<h1 data-number="5" id="ニューラル言語モデル"><span class="header-section-number">5</span> ニューラル言語モデル</h1>
<p>トピックモデルでは,単語の分布を解釈していましたが,文章自体の意味を扱っているわけでは有りません. 文章や単語の意味を利用した分析手法について見てみましょう.</p>
<p>本節では, 2018年にGoogleが発表したニューラル言語モデルのである<strong><code>BERT(Bidirectional Encoder Representations from Transformers)</code></strong>を利用して見ましょう(なお,BERTの後継に<code>ELECTRA</code>がありますが,資料の更新ができていません.)</p>
<p>BERTはなどのニューラル言語モデルは<strong>事前学習</strong>と<strong>ファインチューニング</strong>という二段階の学習を行うのが一般的です.</p>
<div class="note">
<ul>
<li>事前学習</li>
</ul>
<p>(日本語など)言語全般に関して大規模なテキストコーパス(Wikipediaなど)で学習
こちらのモデルがGoogleによって公開されている(ライブラリとして利用可能)</p>
<ul>
<li>ファインチューニング</li>
</ul>
<p>事前学習済みのBERTモデルをタスク(穴埋め,ラベリング,校正などの用途)によって追加学習させる.
タスクに関連した新たなデータセットが必要
ラベリングをするのであれば,ラベル付けされた教師データが必要</p>
</div>
<p>BERTはコーパスを用いてどのような学習を行っているのでしょうか. 基本的にBERTが行っているのは文章の穴埋め精度を高めるための学習です.</p>
<ul>
<li>私はりんごを【MASK】</li>
</ul>
<p>という一部が隠れた文章があったとき, 【MASK】の部分に入る文字列の確率計算をしています.
通常,文章の【MASK】部分に入る文章は,それぞれ確率が異なります.</p>
<p>例えば,上の文章では【MASK】部分に｢行う｣｢走る｣などの動詞が続く確率よりも｢食べる｣｢買う｣｢調理する｣などの動詞が続く確率が高いと考えられます.</p>
<ul>
<li>私はりんごを行った ← 確率低い</li>
<li>私はりんごを食べた ← 確率高い</li>
</ul>
<p>人間は過去の学習から,このような確率をなんとなく判断できますが,BERTはコーパスから教師あり学習をして,あらゆる語彙の連なりやすさの確率を計算しています.</p>
<p><span class="math display">𝑃(食べた│私はりんごを)=\frac{(コーパス中の頻度(私はりんごを食べた))}{(コーパス中の頻度(私はりんごを))}</span></p>
<p><span class="math display">𝑃(食べた│私はりんごを)= \frac{(コーパス中の頻度(私はりんごを行った))}{(コーパス中の頻度(私はりんごを))}</span></p>
<p>大抵はすでにこのような事前学習が行われたモデルを利用し,必要があればファインチューニングをそれぞれの利用者が行います. 日本語で有名な学習済みモデルには東北大がWikipediaの日本語記事ので学習したモデル(<code>'tohoku-nlp/bert-base-japanese-whole-word-masking</code>)などがあります.</p>
<p>BERTのファインチューニングのためには,目的に応じたデータセットが必要となります.このデータは,トピックモデルなどで扱ってきたような分析用のデータではなく,学習用のデータです.</p>
<div class="note">
<ul>
<li>データセット</li>
</ul>
<p>日本語データセットとして良く利用されるものは以下のとおりです.</p>
<ul>
<li><h2 id="twitter日本語評判分析データセット"><a href="http://www.cl.ecei.tohoku.ac.jp/resources/twitter_target_review/">Twitter日本語評判分析データセット</a></h2></li>
</ul>
<p>Twitterの商品に関するポジティブ,ネガティブ,ニュートラルのラベリングデータ</p>
<ul>
<li><h2 id="snow-d18日本語感情表現辞書"><a href="https://www.jnlp.org/GengoHouse/snow/d18">SNOW D18日本語感情表現辞書</a></h2></li>
</ul>
<p>日本語を48の勘定に分類</p>
<blockquote>
<p>安らぎ、楽しさ親しみ、尊敬・尊さ、感謝、気持ちが良い、誇らしい、感動、喜び、悲しさ、寂しさ不満、切なさ、苦しさ、不安、憂鬱、辛さ、好き、嫌悪、恥ずかしい、焦り、驚き、怒り、幸福感、恨み、恐れ（恐縮等の意味で）、恐怖、悔しさ、祝う気持ち、困惑、きまずさ、興奮、悩み、願望、失望、あわれみ、見下し、謝罪、ためらい、不快、怠さ、あきれ、心配、緊張、妬み、憎い、残念、情けない、穏やか</p>
</blockquote>
<ul>
<li><h2 id="livedorニュースコーパス"><a href="https://www.rondhuit.com/download.html#news%20corpus">livedorニュースコーパス</a></h2></li>
</ul>
<p>ニュース記事をサイト別/ジャンル別に分類</p>
<ul>
<li><p><a href="http://news.livedoor.com/category/vender/news/">トピックニュース</a> - <a href="http://news.livedoor.com/category/vender/208/">Sports Watch</a> - <a href="http://news.livedoor.com/category/vender/223/">ITライフハック</a> - <a href="http://news.livedoor.com/category/vender/kadench/">家電チャンネル</a> - <a href="http://news.livedoor.com/category/vender/movie_enter/">MOVIE ENTER</a> - <a href="http://news.livedoor.com/category/vender/90/">独女通信</a> - <a href="http://news.livedoor.com/category/vender/smax/">エスマックス</a> - <a href="http://news.livedoor.com/category/vender/homme/">livedoor HOMME</a> - <a href="http://news.livedoor.com/category/vender/ldgirls/">Peachy</a></p></li>
<li><h2 id="有価証券報告書ネガポジデータセット"><a href="https://github.com/chakki-works/chABSA-dataset">有価証券報告書ネガポジデータセット</a></h2></li>
</ul>
<p>TIS株式会社が公開している上場企業の有価証券報告書を用いて作成されたマルチラベルのネガポジデータセット</p>
<p>ネガティブ, ポジティブ, ニュートラルの3ラベル</p>
</div>
<p>BERTをどのように利用するかは,様々な応用がありえますが, 良く利用される事例は以下のようなものです.</p>
<div class="note">
<ul>
<li><h2 id="bertの利用例">BERTの利用例</h2></li>
</ul>
<ol type="1">
<li><p><strong>文章の穴埋め（Masked Language Model, MLM）</strong></p>
<p>トークンを利用して文中の一部を隠し,その隠れた部分を予測します.たとえば「今日は【MASK】に行く」という文が与えられた場合,BERTは文脈に基づいて【MASK】部分が「学校」「会社」などになると予測します.この機能により,文章の補完やオートコンプリート機能に利用できます.</p></li>
<li><p><strong>文章分類</strong></p>
<p>BERTは感情分析や話題の分類などの文章分類タスクで広く使われています.例えば,商品レビューやSNSの投稿をポジティブ・ネガティブといった感情ラベルに分類することで,マーケティング分析やレコメンドシステムの精度を向上させます.また,ニュース記事をカテゴリに分けるなど,文書分類にも応用されています.</p></li>
<li><p><strong>マルチラベル文章分類</strong></p>
<p>一部の文章は,複数の感情やカテゴリに属することがあり,BERTは「ポジティブかつネガティブ」のように複数のラベルを付与するマルチラベル分類も可能です.これにより,特定のジャンルに限らない複数の特徴や感情を同時に判別し,より高度な文章分析を可能にします.たとえば,レビューが「高評価だが高価」といった異なる側面を含む場合も,それぞれの特徴を捉えることができます.</p></li>
<li><p><strong>固有表現抽出（Named Entity Recognition, NER）</strong></p>
<p>BERTを用いて文章から特定の固有名詞を抽出できます.例えば,文中の「人名」「組織名」「地名」などの固有表現を検出し,ビジネスや医療,自然言語処理の分野で多用されます.ニュース記事から企業名や国名を抽出して情報整理を行ったり,顧客対応で企業名や製品名を抽出して対応を迅速化するなどの応用が可能です.</p></li>
<li><p><strong>文章校正</strong></p>
<p>BERTを使った校正機能は,文法チェックやスペルチェックに利用され,Grammarlyのようなサービスに応用できます.文脈を考慮した校正が可能なため,単なる誤字脱字の修正だけでなく,不自然な表現を検知し,より適切な言い回しに修正することも可能です.</p></li>
<li><p><strong>データの可視化と類似文章検索</strong></p>
<p>BERTのエンコーディング機能を使うと,文章をベクトル化し,意味の似た文章を数値的に比較できるようになります.これにより,多次元空間における文章の類似性が計算でき,例えばPCAやt-SNEで次元を減らし,クラスタリングを行ってデータを可視化できます.類似した内容の文書を自動でグループ分けしたり,ユーザーが検索したい文に近い内容の文書を瞬時に探すといった検索機能にも利用されます.</p></li>
</ol>
</div>
<h2 data-number="5.1" id="マルチラベル分類"><span class="header-section-number">5.1</span> マルチラベル分類</h2>
<p>マルチラベル分類とは選択肢の中から復数のカテゴリーを選ぶ分類手法です.
今回は有価証券報告書データを利用して<code>[ネガティブ,ニュートラル,ポジティブ]</code>に分類します.
ネガティブと判定されると<code>[1,0,0]</code>,ニュートラルと判定されると<code>[0,1,0]</code>のようなベクトルが返ってきます.
また,一つの文章にネガティブな内容とポジティブな内容両方が含まれている場合には<code>[1,0,1]</code>のような結果となります.</p>
<div class="note">
<ul>
<li><h2 id="gpu計算とcpu計算">GPU計算とCPU計算</h2>
PCにおける計算は通常CPUによって行われます.
これまでに実行してきたPythonプログラムは全てCPUを用いた計算を行っていました(画像処理ではGPU計算も可能なプログラムになっていました.)
一方でGPU(Graphics Processing Unit,画像処理装置,いわゆるグラボ)を利用してプログラムを計算することも可能です.
ニューラルネットワークモデルは,その特性から単純な計算を大量に行うためGPUを用いた並列計算が行われることが多いです.</li>
</ul>
<p><img src="/images/ch15-cpu-gpu.png" /></p>
</div>
<p>これからBERTを利用してマルチラベル分類を実施してみます. ただし,ニューラルモデルを利用するにあたって,学生それぞれのノートPCでGPU計算の環境を構築することが困難なので, Googleの提供するオンライン上のPythonの実行環境である<code>Colaboratory</code>を利用します.</p>
<p>まずは,<a href="https://www.google.com">Google</a>のサービスを利用するためのGoogleアカウントを作成しましょう(既にある人はスキップ)</p>
<p><img src="/images/ch15-google.png" /></p>
<p>プログラムやデータなどはGoogleのクラウドストレージであるGoogle Driveに保存されます.
Google Drive上に作業用ディレクトリを作りましょう.</p>
<p><img src="/images/ch15-google2.png" /></p>
<p>新規作成からフォルダを作成し,適当な名前をつけましょう. フォルダ内にはデータを保存するフォルダ<code>data</code>を作成しておきましょう.
<img src="/images/ch15-google3.png" /></p>
<p>作成したフォルダにプログラムやデータをドラッグアンドドロップすることでアップロードできます.</p>
<p>実際にコードやデータを利用する前にGoogle Drive上で<code>Colaboratory</code>のファイルを扱えるようにしましょう.</p>
<p>右下<code>+</code>ボタンをクリックして,<code>Colaboratory</code>のアドオンを検索し,インストールしましょう.</p>
<p><img src="/images/ch15-google4.png" /></p>
<div class="warn">
<p>インストールが完了したら一度ページを再読み込みしましょう.</p>
</div>
<p>今回はマルチラベル用のプログラムを新規作成します. フォルダの何もない部分を右クリックして,その他から,Colaboratoryのファイル(拡張子<code>.ipynb</code>)を作成しましょう.</p>
<p><img src="/images/ch15-google5.png" /></p>
<p>作成したファイルをダブルクリックするとColaboratoryが起動します.
まずは,右上の設定からGPU計算が可能なように設定を変更しましょう.</p>
<p><img src="/images/ch15-colab.png" /></p>
<p>Colaboratoryは対話型環境になっており, プログラムを書いてブロックごとに実行します. 各ブロックの左側にある再生ボタンを押すか,<code>Runtime</code>から実行方法を選択して実行します. <code>Run all</code>をクリックすると全てのブロックが上から順に実行されます.</p>
<p><img src="/images/ch15-colab1.png" /></p>
<p><img src="/images/ch15-colab2.png" /></p>
<p><code>!</code>に続けて入力することでシェルコマンドも実行可能です.</p>
<p>最初に,今回のプログラムで必要となるライブラリをインストールしてみましょう.なお,以下のマルチラベル文章分類に関するコードは,<strong><a href="https://www.ohmsha.co.jp/book/9784274227264/">BERTによる自然言語処理入門 オーム社</a></strong>を参考にしています.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ライブラリのインストール</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install transformers fugashi ipadic pytorch_lightning</span></code></pre></div>
<p>まずは,学習済みのモデルを読み込みます. ニューラルモデルに関するこれらのコードは全て理解しようと思うと,膨大な時間が必要になります.
なので,ここでは取り敢えずそれぞれの部分で何をやっているのかを大雑把に把握するようにしましょう.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> BertJapaneseTokenizer, BertModel</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytorch_lightning <span class="im">as</span> pl</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 日本語の学習モデル</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">&#39;tohoku-nlp/bert-base-japanese-whole-word-masking&#39;</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># マルチラベル文章分類用のクラス</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BertForSequenceClassificationMultiLabel(torch.nn.Module):</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name, num_labels):</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># BertModelのロード</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bert <span class="op">=</span> BertModel.from_pretrained(model_name)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 線形変換を初期化しておく</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear <span class="op">=</span> torch.nn.Linear(</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.bert.config.hidden_size, num_labels</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        input_ids<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        attention_mask<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        token_type_ids<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span><span class="va">None</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># データを入力しBERTの最終層の出力を得る。</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        bert_output <span class="op">=</span> <span class="va">self</span>.bert(</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>            input_ids<span class="op">=</span>input_ids,</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>            attention_mask<span class="op">=</span>attention_mask,</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>            token_type_ids<span class="op">=</span>token_type_ids)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        last_hidden_state <span class="op">=</span> bert_output.last_hidden_state</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [PAD]以外のトークンで隠れ状態の平均をとる</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>        averaged_hidden_state <span class="op">=</span> <span class="op">\</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>            (last_hidden_state<span class="op">*</span>attention_mask.unsqueeze(<span class="op">-</span><span class="dv">1</span>)).<span class="bu">sum</span>(<span class="dv">1</span>) <span class="op">\</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> attention_mask.<span class="bu">sum</span>(<span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 線形変換</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> <span class="va">self</span>.linear(averaged_hidden_state)</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 出力の形式を整える。</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> {<span class="st">&#39;logits&#39;</span>: scores}</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># labelsが入力に含まれていたら、損失を計算し出力する。</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> labels <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> torch.nn.BCEWithLogitsLoss()(scores, labels.<span class="bu">float</span>())</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>            output[<span class="st">&#39;loss&#39;</span>] <span class="op">=</span> loss</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 属性でアクセスできるようにする。</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="bu">type</span>(<span class="st">&#39;bert_output&#39;</span>, (<span class="bu">object</span>,), output)</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルとトークナイザのロード</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a><span class="co"># num_label:カテゴリー数</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> BertJapaneseTokenizer.from_pretrained(MODEL_NAME)</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>bert_scml <span class="op">=</span> BertForSequenceClassificationMultiLabel(</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>    MODEL_NAME, num_labels<span class="op">=</span><span class="dv">2</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>bert_scml <span class="op">=</span> bert_scml.cuda()</span></code></pre></div>
<p>これでBertのマルチラベル変換用のモデルが利用できるようになりました. 続いて,ファインチューニングを実施します.
今回は先述のTIS株式会社による上場企業の有価証券報告書を用いて作成されたマルチラベルのネガポジデータセット <a href="https://www.tis.co.jp/news/2018/tis_news/20180410_1.html"><code>chABSA-dataset</code></a>を利用します.</p>
<p>データとしては<code>json</code>でそれぞれの文章が,ネガティブなのか,ポジティブなのかが記録されています.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># データのダウンロード</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget https:<span class="op">//</span>s3<span class="op">-</span>ap<span class="op">-</span>northeast<span class="op">-</span><span class="fl">1.</span><span class="er">amazonaws</span>.com<span class="op">/</span>dev.tech<span class="op">-</span>sketch.jp<span class="op">/</span>chakki<span class="op">/</span>public<span class="op">/</span>chABSA<span class="op">-</span>dataset.<span class="bu">zip</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># データの解凍</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>unzip chABSA<span class="op">-</span>dataset.<span class="bu">zip</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># chABSA-dataset</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     - xxx.json</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># の形で保存</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">&#39;chABSA-dataset/e00030_ann.json&#39;</span>))</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( data[<span class="st">&#39;sentences&#39;</span>][<span class="dv">0</span>] )</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">#データから文章とカテゴリーを抜き出して整形しておく</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>category_id <span class="op">=</span> {<span class="st">&#39;negative&#39;</span>:<span class="dv">0</span>, <span class="st">&#39;neutral&#39;</span>:<span class="dv">1</span> , <span class="st">&#39;positive&#39;</span>:<span class="dv">2</span>}</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> []</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> glob.glob(<span class="st">&#39;chABSA-dataset/*.json&#39;</span>):</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="bu">file</span>))</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 各データから文章（text）を抜き出し、ラベル（&#39;labels&#39;）を作成</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sentence <span class="kw">in</span> data[<span class="st">&#39;sentences&#39;</span>]:</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> sentence[<span class="st">&#39;sentence&#39;</span>]</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> opinion <span class="kw">in</span> sentence[<span class="st">&#39;opinions&#39;</span>]:</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            labels[category_id[opinion[<span class="st">&#39;polarity&#39;</span>]]] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        sample <span class="op">=</span> {<span class="st">&#39;text&#39;</span>: text, <span class="st">&#39;labels&#39;</span>: labels}</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        dataset.append(sample)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dataset[<span class="dv">0</span>])</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="co">{&#39;text&#39;: &#39;当連結会計年度（平成28年１月１日から平成29年３月31日まで）におけるわが国経済は...</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p><code>print</code>による表示結果は省略していますが,もとのデータセットが表示されているかと思います.</p>
<p>続いて,文章をトークン化した後,学習用(60%),検証用(20%),テスト用(20%)にそれぞれ分割します.
文章のトークン化には,Bertのトークナイザを利用します.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># トークナイザのロード</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> BertJapaneseTokenizer.from_pretrained(MODEL_NAME)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 各データの形式を整える</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>max_length <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>dataset_for_loader <span class="op">=</span> []</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sample <span class="kw">in</span> dataset:</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> sample[<span class="st">&#39;text&#39;</span>]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> sample[<span class="st">&#39;labels&#39;</span>]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    encoding <span class="op">=</span> tokenizer(</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        text,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        max_length<span class="op">=</span>max_length,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        padding<span class="op">=</span><span class="st">&#39;max_length&#39;</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        truncation<span class="op">=</span><span class="va">True</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    encoding[<span class="st">&#39;labels&#39;</span>] <span class="op">=</span> labels</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    encoding <span class="op">=</span> { k: torch.tensor(v) <span class="cf">for</span> k, v <span class="kw">in</span> encoding.items() }</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    dataset_for_loader.append(encoding)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットの分割</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>random.shuffle(dataset_for_loader)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(dataset_for_loader)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.6</span><span class="op">*</span>n)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.2</span><span class="op">*</span>n)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>dataset_train <span class="op">=</span> dataset_for_loader[:n_train] <span class="co"># 学習データ</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>dataset_val <span class="op">=</span> dataset_for_loader[n_train:n_train<span class="op">+</span>n_val] <span class="co"># 検証データ</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>dataset_test <span class="op">=</span> dataset_for_loader[n_train<span class="op">+</span>n_val:] <span class="co"># テストデータ</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットからデータローダを作成</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>dataloader_train <span class="op">=</span> DataLoader(</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    dataset_train, batch_size<span class="op">=</span><span class="dv">32</span>, shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>dataloader_val <span class="op">=</span> DataLoader(dataset_val, batch_size<span class="op">=</span><span class="dv">256</span>)</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>dataloader_test <span class="op">=</span> DataLoader(dataset_test, batch_size<span class="op">=</span><span class="dv">256</span>)</span></code></pre></div>
<p>データの準備が整ったので,ファインチューニングを行います. 今回はエポック数を5として,決め打ちで行っていますが,
実際に研究等で使用する場合には前章に習って過学習の確認や学習率(<code>lr</code>)の調整などを行いましょう.</p>
<p>以下の処理は,およそ10分程度かかるので,時間的に余裕のあるときに実行して下さい.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BertForSequenceClassificationMultiLabel_pl(pl.LightningModule):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name, num_labels, lr):</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.save_hyperparameters()</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bert_scml <span class="op">=</span> BertForSequenceClassificationMultiLabel(</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>            model_name, num_labels<span class="op">=</span>num_labels</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> training_step(<span class="va">self</span>, batch, batch_idx):</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.bert_scml(<span class="op">**</span>batch)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> output.loss</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">&#39;train_loss&#39;</span>, loss)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validation_step(<span class="va">self</span>, batch, batch_idx):</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.bert_scml(<span class="op">**</span>batch)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">=</span> output.loss</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">&#39;val_loss&#39;</span>, val_loss)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> test_step(<span class="va">self</span>, batch, batch_idx):</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> batch.pop(<span class="st">&#39;labels&#39;</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.bert_scml(<span class="op">**</span>batch)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> output.logits</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        labels_predicted <span class="op">=</span> ( scores <span class="op">&gt;</span> <span class="dv">0</span> ).<span class="bu">int</span>()</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        num_correct <span class="op">=</span> ( labels_predicted <span class="op">==</span> labels ).<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>).<span class="bu">sum</span>().item()</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> num_correct<span class="op">/</span>scores.size(<span class="dv">0</span>)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log(<span class="st">&#39;accuracy&#39;</span>, accuracy)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> configure_optimizers(<span class="va">self</span>):</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.optim.Adam(<span class="va">self</span>.parameters(), lr<span class="op">=</span><span class="va">self</span>.hparams.lr)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> pl.callbacks.ModelCheckpoint(</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">&#39;min&#39;</span>,</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    save_top_k<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    save_weights_only<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    dirpath<span class="op">=</span><span class="st">&#39;model/&#39;</span>,</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> pl.Trainer(</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    callbacks <span class="op">=</span> [checkpoint]</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> BertForSequenceClassificationMultiLabel_pl(</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    MODEL_NAME,</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    num_labels<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">1e-5</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>trainer.fit(model, dataloader_train, dataloader_val)</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> trainer.test(dataloaders<span class="op">=</span>dataloader_test)</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy: </span><span class="sc">{</span>test[<span class="dv">0</span>][<span class="st">&quot;accuracy&quot;</span>]<span class="sc">:.2f}</span><span class="ss">&#39;</span>)</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Accuracy: 0.90</span></span></code></pre></div>
<p>テストデータに対する正確率は90%程を確保できているようです.</p>
<p>それではファインチューニングしたモデルを利用して,マルチラベル分類を行ってみます.</p>
<p>最初の<code>text_list</code>部分に適当に作成した文章をリスト形式で与えます. 研究などではここにCSVなどで取得した外部のデータを指定します. それぞれのネガティブ,ニュートラル,ポジティブの判定結果を見てみましょう.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力する文章</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果はネガティブ,ニュートラル,ポジティブの順</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>text_list <span class="op">=</span> [<span class="st">&quot;当連結会計年度の売上高は前期比5.8%増加し、業績は堅調に推移しました。&quot;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;海外市場での需要拡大が寄与し、売上および営業利益が過去最高を記録しました。&quot;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;一部事業における原材料価格の高騰の影響を受け、収益性が低下しました。&quot;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;国内景気は緩やかな回復基調を維持したものの、インフレ率の上昇が購買力に影響を及ぼしました。&quot;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;新興市場における競争激化により、当社製品のシェアは微減しましたが、全体的な市場拡大により売上は増加しました。&quot;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;為替変動が利益にプラスの影響を与えた一方で、サプライチェーンの遅延が一部事業の成長を抑制しました。&quot;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;2025年度に向けて、成長市場への積極的な投資と新規事業の開発に注力する予定です。&quot;</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;業界全体の需要鈍化が予想される中で、コスト構造の見直しにより安定的な収益を確保していきます。&quot;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;カーボンニュートラル達成を目指し、再生可能エネルギーへのシフトを加速させます。&quot;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;当社は、デジタル化の遅れが競争力に与える影響を認識しており、ITシステムへの投資を増強する方針です。&quot;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;地政学的リスクの高まりにより、一部の輸出取引に不確実性が生じています。&quot;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            ,<span class="st">&quot;半導体不足の影響を受け、特定製品の納期が遅延する可能性があります。&quot;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルのロード</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>best_model_path <span class="op">=</span> checkpoint.best_model_path</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> BertForSequenceClassificationMultiLabel_pl.load_from_checkpoint(best_model_path)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>bert_scml <span class="op">=</span> model.bert_scml.cuda()</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co"># データの符号化</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>encoding <span class="op">=</span> tokenizer(</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    text_list,</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    padding <span class="op">=</span> <span class="st">&#39;longest&#39;</span>,</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    return_tensors<span class="op">=</span><span class="st">&#39;pt&#39;</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>encoding <span class="op">=</span> { k: v.cuda() <span class="cf">for</span> k, v <span class="kw">in</span> encoding.items() }</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="co"># BERTへデータを入力し分類スコアを得る。</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> bert_scml(<span class="op">**</span>encoding)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> output.logits</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>labels_predicted <span class="op">=</span> ( scores <span class="op">&gt;</span> <span class="dv">0</span> ).<span class="bu">int</span>().cpu().numpy().tolist()</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果を表示</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> text, label <span class="kw">in</span> <span class="bu">zip</span>(text_list, labels_predicted):</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;--&#39;</span>)</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&#39;入力：</span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&#39;出力：</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a><span class="co">入力：当連結会計年度の売上高は前期比5.8%増加し、業績は堅調に推移しました。</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[0, 0, 1]</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="co">入力：海外市場での需要拡大が寄与し、売上および営業利益が過去最高を記録しました。</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[0, 0, 1]</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a><span class="co">入力：一部事業における原材料価格の高騰の影響を受け、収益性が低下しました。</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[1, 0, 0]</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a><span class="co">入力：国内景気は緩やかな回復基調を維持したものの、インフレ率の上昇が購買力に影響を及ぼしました。</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[1, 0, 1]</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a><span class="co">入力：新興市場における競争激化により、当社製品のシェアは微減しましたが、全体的な市場拡大により売上は増加しました。</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[1, 0, 1]</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a><span class="co">入力：為替変動が利益にプラスの影響を与えた一方で、サプライチェーンの遅延が一部事業の成長を抑制しました。</span></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[1, 0, 1]</span></span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a><span class="co">入力：2025年度に向けて、成長市場への積極的な投資と新規事業の開発に注力する予定です。</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[0, 0, 0]</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a><span class="co">入力：業界全体の需要鈍化が予想される中で、コスト構造の見直しにより安定的な収益を確保していきます。</span></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[0, 0, 1]</span></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a><span class="co">入力：カーボンニュートラル達成を目指し、再生可能エネルギーへのシフトを加速させます。</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[0, 0, 0]</span></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a><span class="co">入力：当社は、デジタル化の遅れが競争力に与える影響を認識しており、ITシステムへの投資を増強する方針です。</span></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[0, 0, 0]</span></span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a><span class="co">入力：地政学的リスクの高まりにより、一部の輸出取引に不確実性が生じています。</span></span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[1, 0, 0]</span></span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a><span class="co">入力：半導体不足の影響を受け、特定製品の納期が遅延する可能性があります。</span></span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a><span class="co">出力：[1, 0, 0]</span></span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>結果を見てみるとかなり正確に文章のネガティブポジティブ判定ができていることが分かります.
文章を変える,外部からデータを取り込むなどして,これ以外の事例でも試してみましょう.</p>
<h1 data-number="6" id="自然言語ベクトル抽出によるデータ可視化と類似度評価"><span class="header-section-number">6</span> 自然言語ベクトル抽出によるデータ可視化と類似度評価</h1>
<p>続いて,BERTを利用して文章をベクトルに変換しクラスタリングや類似度の評価を行ってみます.
事例として,異なる言語(アラビア語,中国語,英語,フランス語,ドイツ度,ヒンディー語,インドネシア語,イタリア語,日本語,韓国語,ポルトガル語,ロシア語,スペイン語,トルコ語,)でのWikipediaにおけるLGBTQに関する記事の類似度を評価してみます.</p>
<p><a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/LGBTWiki.csv"><code>こちら</code></a>の各言語の記事を日本語に翻訳したデータをダウンロードして,Google Driveの作業用ディレクトリの<code>Data</code>フォルダ内に配置しましょう. 本来は, 英語に翻訳したほうが翻訳精度の関係から望ましいですが,ここでは分かりやすいように日本語に翻訳してあります.</p>
<p>また,<code>Colaboratory</code>上で日本語のワードクラウドなどを作成するために,日本語のフォントをGoogle Driveにアップロードしておく必要があります. <a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/fonts-japanese-gothic.ttf"><code>こちら</code></a>の日本語フォントをダウンロードして,<code>Data</code>フォルダ内に配置してきましょう.</p>
<p>まずは,Google Driveのマウントと必要なライブラリのインストールを行います.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Google Drive上のデータを利用できるようにする</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">#ディレクトリの移動</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">#ここを自分のディレクトリにすればデータが利用可能</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>cd <span class="op">/</span>content<span class="op">/</span>drive<span class="op">/</span>My Drive<span class="op">/</span>slds</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install transformers<span class="op">==</span><span class="fl">4.18.0</span> fugashi<span class="op">==</span><span class="fl">1.1.0</span> ipadic<span class="op">==</span><span class="fl">1.0.0</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install japanize_matplotlib</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install adjustText</span></code></pre></div>
<p>続いて各種インポートと,設定を行います.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.manifold <span class="im">import</span> TSNE</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> japanize_matplotlib</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> BertJapaneseTokenizer, BertModel</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adjustText <span class="im">import</span> adjust_text</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co">#グラフの設定</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">&#39;ggplot&#39;</span>) <span class="co">#グラフスタイル</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&#39;figure.figsize&#39;</span>] <span class="op">=</span> [<span class="dv">20</span>, <span class="dv">15</span>] <span class="co">#グラフサイズ</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&#39;font.size&#39;</span>] <span class="op">=</span> <span class="dv">14</span> <span class="co">#フォントサイズ</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="co"># BERTの日本語モデル</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">&#39;tohoku-nlp/bert-base-japanese-whole-word-masking&#39;</span></span></code></pre></div>
<p>データを読み込み,ベクトル化します. 今回はファインチューニングは行わず日本語Wikipediaで学習したBERTのモデルをそのまま利用します.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ベクトルを作成するデータの読み込み</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df_wiki <span class="op">=</span> pd.read_csv(<span class="st">&#39;./data/LGBTWiki.csv&#39;</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>category_list <span class="op">=</span> [<span class="st">&#39;Arabic&#39;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Chinese&#39;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;English&#39;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;France&#39;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;German&#39;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Hindi&#39;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Indonesian&#39;</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Italian&#39;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Japanese&#39;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Korean&#39;</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Portuguese&#39;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Russian&#39;</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Spanish&#39;</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                ,<span class="st">&#39;Turkish&#39;</span>]</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_wiki)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_wiki[<span class="st">&#39;Text&#39;</span>][<span class="dv">0</span>])</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>df_wiki[<span class="st">&#39;Text&#39;</span>] <span class="op">=</span> df_wiki[<span class="st">&#39;Text&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co"># トークナイザとモデルのロード</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> BertJapaneseTokenizer.from_pretrained(MODEL_NAME)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> BertModel.from_pretrained(MODEL_NAME)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.cuda()</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 各データの形式を整える</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>max_length <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>sentence_vectors <span class="op">=</span> [] <span class="co"># 文章ベクトルを追加していく。</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [] <span class="co"># ラベルを追加していく。</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> tqdm(df_wiki.index):</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    encoding <span class="op">=</span> tokenizer(</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>        df_wiki.at[i,<span class="st">&#39;Text&#39;</span>],</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>        max_length<span class="op">=</span>max_length,</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>        padding<span class="op">=</span><span class="st">&#39;max_length&#39;</span>,</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>        truncation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>        return_tensors<span class="op">=</span><span class="st">&#39;pt&#39;</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    encoding <span class="op">=</span> { k: v.cuda() <span class="cf">for</span> k, v <span class="kw">in</span> encoding.items() }</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    attention_mask <span class="op">=</span> encoding[<span class="st">&#39;attention_mask&#39;</span>]</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 文章ベクトルを計算</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># BERTの最終層の出力を平均を計算する。（ただし、[PAD]は除く。）</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> model(<span class="op">**</span>encoding)</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>        last_hidden_state <span class="op">=</span> output.last_hidden_state</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>        averaged_hidden_state <span class="op">=</span> <span class="op">\</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>            (last_hidden_state<span class="op">*</span>attention_mask.unsqueeze(<span class="op">-</span><span class="dv">1</span>)).<span class="bu">sum</span>(<span class="dv">1</span>) <span class="op">\</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> attention_mask.<span class="bu">sum</span>(<span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 文章ベクトルとラベルを追加</span></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>    sentence_vectors.append(averaged_hidden_state[<span class="dv">0</span>].cpu().numpy())</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>    labels.append(df_wiki.at[i,<span class="st">&#39;Country&#39;</span>])</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a><span class="co"># それぞれをnumpy.ndarrayにする。</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>sentence_vectors <span class="op">=</span> np.vstack(sentence_vectors)</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sentence_vectors)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.array(labels)</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(labels)</span></code></pre></div>
<p>各Wikipediaの記事がベクトル化されたので,それぞれのコサイン距離を計算します.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_vector <span class="op">=</span> pd.DataFrame(data<span class="op">=</span>sentence_vectors.T,columns<span class="op">=</span>labels)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_vector)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>df_vector.to_csv(<span class="st">&#39;data/vector.csv&#39;</span>,encoding<span class="op">=</span><span class="st">&#39;utf-8-sig&#39;</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">#コサイン類似度の計算</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cos(x,y):</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> np.dot(x,y) <span class="op">/</span> (np.linalg.norm(x)<span class="op">*</span>np.linalg.norm(y))</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">#全組み合わせのコサイン距離</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>df_cos <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> labels]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                      ,index<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> labels])</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> df_cos.index:</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> c <span class="kw">in</span> df_cos.columns:</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    df_cos.at[i,c] <span class="op">=</span> cos(df_vector[i],df_vector[c])</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>df_cos <span class="op">=</span> df_cos[labels].astype(<span class="bu">float</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_cos.dtypes)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>df_cos.sort_values(inplace<span class="op">=</span><span class="va">True</span>, by<span class="op">=</span>[<span class="st">&#39;German&#39;</span>],ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>df_cos <span class="op">=</span> df_cos.reindex(columns<span class="op">=</span>df_cos.index)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;コサイン距離------&#39;</span>)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_cos)</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cos)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>df_cos.to_csv(<span class="st">&#39;data/cos.csv&#39;</span>,encoding<span class="op">=</span><span class="st">&#39;utf-8-sig&#39;</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co">#ドイツとの距離を測る</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="co">コサイン距離------</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="co">              German   Spanish  Portuguese    France   Italian   Russian  </span><span class="ch">\</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="co">German      1.000000  0.979876    0.977262  0.972203  0.971380  0.969898</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="co">Spanish     0.979876  1.000000    0.982863  0.978872  0.979864  0.978996</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="co">Portuguese  0.977262  0.982863    1.000000  0.976089  0.981436  0.982457</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="co">France      0.972203  0.978872    0.976089  1.000000  0.976741  0.970900</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="co">Italian     0.971380  0.979864    0.981436  0.976741  1.000000  0.976250</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="co">Russian     0.969898  0.978996    0.982457  0.970900  0.976250  1.000000</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="co">Hindi       0.968832  0.973127    0.980610  0.963404  0.976204  0.975082</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="co">Arabic      0.967984  0.970234    0.980389  0.958874  0.968162  0.975689</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="co">Japanese    0.956910  0.962005    0.955607  0.964237  0.967997  0.953722</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="co">Turkish     0.940751  0.944137    0.937296  0.952527  0.953905  0.943392</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="co">Chinise     0.933739  0.952394    0.945277  0.935895  0.951706  0.941210</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="co">Korean      0.927201  0.927902    0.905628  0.919758  0.928268  0.904069</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="co">English     0.912216  0.912019    0.890923  0.910977  0.916483  0.889809</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="co">Indonesian  0.882634  0.879143    0.856105  0.877627  0.882631  0.857904</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="co">               Hindi    Arabic  Japanese   Turkish   Chinise    Korean  </span><span class="ch">\</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a><span class="co">German      0.968832  0.967984  0.956910  0.940751  0.933739  0.927201</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="co">Spanish     0.973127  0.970234  0.962005  0.944137  0.952394  0.927902</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="co">Portuguese  0.980610  0.980389  0.955607  0.937296  0.945277  0.905628</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="co">France      0.963404  0.958874  0.964237  0.952527  0.935895  0.919758</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="co">Italian     0.976204  0.968162  0.967997  0.953905  0.951706  0.928268</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a><span class="co">Russian     0.975082  0.975689  0.953722  0.943392  0.941210  0.904069</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a><span class="co">Hindi       1.000000  0.976721  0.962024  0.939230  0.945298  0.889991</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a><span class="co">Arabic      0.976721  1.000000  0.944017  0.932226  0.924914  0.881642</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a><span class="co">Japanese    0.962024  0.944017  1.000000  0.952746  0.918798  0.903691</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a><span class="co">Turkish     0.939230  0.932226  0.952746  1.000000  0.902123  0.894593</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a><span class="co">Chinise     0.945298  0.924914  0.918798  0.902123  1.000000  0.927152</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a><span class="co">Korean      0.889991  0.881642  0.903691  0.894593  0.927152  1.000000</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a><span class="co">English     0.875571  0.867936  0.895869  0.893318  0.898600  0.978736</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a><span class="co">Indonesian  0.837501  0.831484  0.856639  0.860593  0.869281  0.970492</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a><span class="co">             English  Indonesian</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a><span class="co">German      0.912216    0.882634</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a><span class="co">Spanish     0.912019    0.879143</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a><span class="co">Portuguese  0.890923    0.856105</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a><span class="co">France      0.910977    0.877627</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a><span class="co">Italian     0.916483    0.882631</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="co">Russian     0.889809    0.857904</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a><span class="co">Hindi       0.875571    0.837501</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a><span class="co">Arabic      0.867936    0.831484</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a><span class="co">Japanese    0.895869    0.856639</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a><span class="co">Turkish     0.893318    0.860593</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a><span class="co">Chinise     0.898600    0.869281</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a><span class="co">Korean      0.978736    0.970492</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a><span class="co">English     1.000000    0.972170</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a><span class="co">Indonesian  0.972170    1.000000</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>各言語間の記事の内容のコサイン類似度をヒートマップで表現すると以下のようになりました.</p>
<p><img src="/images/ch15-wiki-cos.png" /></p>
<p>今回はドイツ語からの距離を基準にソートされていますが,ドイツ語と類似度が高いヨーロッパ言語圏のクラスタ,韓国語,インドネシア語,英語のクラスタがあることが見受けられます.</p>
<p>続いて,各言語のベクトルをPCAとt-sneによって次元削減して,2次元上に配置してみます.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#PCAとtsneの比較</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">#PCAによる次元削減</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> sentence_vectors_pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>).fit_transform(sentence_vectors)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(pca[:,<span class="dv">0</span>],pca[:,<span class="dv">1</span>])</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> [plt.text(pca[i,<span class="dv">0</span>],pca[i,<span class="dv">1</span>],l) <span class="cf">for</span> i,l <span class="kw">in</span> <span class="bu">enumerate</span>(labels)]</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;PCA&#39;</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>adjust_text(text, arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, lw<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># t-sneによる次元削減 pの適正値を探す</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co">for p in range(5,14):</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co">  tsne = sentence_vectors_tsne = TSNE(n_components=2,perplexity=p).fit_transform(sentence_vectors)</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co">  plt.scatter(tsne[:,0],tsne[:,1])</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co">  for i,l in enumerate(labels):</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co">    plt.text(tsne[i,0],tsne[i,1],l)</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co">  plt.title(&#39;TSNE p = &#39;+ str(p))</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="co">  plt.show()</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co">#距離と整合的なのでp=5で決め打ち</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>tsne <span class="op">=</span> sentence_vectors_tsne <span class="op">=</span> TSNE(n_components<span class="op">=</span><span class="dv">2</span>,perplexity<span class="op">=</span><span class="dv">5</span>).fit_transform(sentence_vectors)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>plt.scatter(tsne[:,<span class="dv">0</span>],tsne[:,<span class="dv">1</span>])</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> [plt.text(tsne[i,<span class="dv">0</span>],tsne[i,<span class="dv">1</span>],l) <span class="cf">for</span> i,l <span class="kw">in</span> <span class="bu">enumerate</span>(labels)]</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;TSNE&#39;</span>)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>adjust_text(text, arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, lw<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>結果は以下のようになりました. いずれの次元削減手法でも,韓国語,インドネシア語,英語のクラスタが見て取れますが,PCAではトルコ語,日本語,中国語などが離れた位置に配置され,それ以外の言語が固まっています.</p>
<p><img src="/images/ch15-wiki-pca.png" /></p>
<p><img src="/images/ch15-wiki-tsne.png" /></p>
<p>ここではよりクラスタに特徴が見られる,PCAを利用してクラスタリングを行ってみましょう.
教師なし学習なので,階層クラスタリングを行ってみます.
研究では,中心や距離を適切に設定する必要がありますが,ここではWard法を用いてみます.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 階層クラスタリングで決め打ちする.</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.cluster.hierarchy <span class="im">import</span> dendrogram, linkage, fcluster</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#ward法で分類</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">&#39;x&#39;</span>:pca[:,<span class="dv">0</span>]</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                  ,<span class="st">&#39;y&#39;</span>:pca[:,<span class="dv">1</span>]}</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                  ,index<span class="op">=</span>labels)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> linkage(df[[<span class="st">&#39;x&#39;</span>,<span class="st">&#39;y&#39;</span>]]</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>             , method <span class="op">=</span> <span class="st">&#39;ward&#39;</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co"># デンドログラムの図示</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>dendrogram(res,labels<span class="op">=</span>labels)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Dedrogram&quot;</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Threshold&quot;</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/ch15-wiki-dendrogram.png" /></p>
<p>階層クラスタリングで得られた結果を散布図上に色で表現してみます.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> fcluster(res, t<span class="op">=</span><span class="dv">5</span>, criterion<span class="op">=</span><span class="st">&#39;maxclust&#39;</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span>   [<span class="st">&quot;orange&quot;</span>, <span class="st">&quot;pink&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;brown&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;grey&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;green&quot;</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(clusters)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;c&#39;</span>] <span class="op">=</span> clusters</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">list</span>(<span class="bu">set</span>(clusters)):</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> df[df[<span class="st">&#39;c&#39;</span>]<span class="op">==</span>i][<span class="st">&#39;x&#39;</span>]</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> df[df[<span class="st">&#39;c&#39;</span>]<span class="op">==</span>i][<span class="st">&#39;y&#39;</span>]</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  plt.scatter( x</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>             , y</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>             , alpha<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>             , label <span class="op">=</span> i</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>             , c<span class="op">=</span>colors[i])</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> [plt.text(pca[i,<span class="dv">0</span>],pca[i,<span class="dv">1</span>],l) <span class="cf">for</span> i,l <span class="kw">in</span> <span class="bu">enumerate</span>(labels)]</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>adjust_text(text, arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, lw<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;x&#39;</span>)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;y&#39;</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img src="/images/ch15-wiki-cluster.png" /></p>
<p>英語,韓国語,インドネシア語の<code>クラスタ1</code>,日本語,トルコ語の<code>クラスタ2</code>,アラビア語,ヒンディー語,ポルトガル語,ロシア語の<code>クラスタ3</code>,フランス語,ドイツ語,スペイン語,イタリア語の<code>クラスタ4</code>,中国語単体の<code>クラスタ5</code>になりました.
研究で行う場合には,それぞれのクラスタの背景などを考察する必要があります.例えば,ここではLGBTQに関する各言語圏での考え方がWikipediaの記事に反映されていると想定して, 各国の法制度や世界価値観調査などと比較すると面白いかもしれません.</p>
<p>続いて,それぞれのクラスタごとの特徴をワードクラウドで確認してみましょう.</p>
<p>ワードクラウドの作成に必要なライブラリをインストールします.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install mecab<span class="op">-</span>python3 unidic<span class="op">-</span>lite wordcloud gensim</span></code></pre></div>
<p>各クラスタごとにワードクラウドを作成してみます.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#クラスタごとの中身を見てみる</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> wordcloud <span class="im">import</span> WordCloud</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MeCab <span class="im">as</span> mc</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gensim.corpora.dictionary <span class="im">import</span> Dictionary</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gensim.models <span class="im">import</span> LdaModel</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>df_wiki[<span class="st">&#39;c&#39;</span>] <span class="op">=</span> clusters</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_wiki[<span class="st">&#39;c&#39;</span>])</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> strip_CRLF_from_Text(text):</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;テキストファイルの改行，タブを削除し，形態素解析を実行する．</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">    改行前後が日本語文字の場合は改行を削除する．</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">    それ以外はスペースに置換する．</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 改行前後の文字が日本語文字の場合は改行を削除する</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> re.sub(<span class="st">&#39;([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)(</span><span class="ch">\n</span><span class="st">)([ぁ-んー]+|[ァ-ンー]+|[</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+|[ぁ-んァ-ンー</span><span class="ch">\\</span><span class="st">u4e00-</span><span class="ch">\\</span><span class="st">u9FFF]+)&#39;</span>,</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>                       <span class="vs">r&#39;\1\3&#39;</span>,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>                       text)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 残った改行とタブ記号はスペースに置換する</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    plaintext <span class="op">=</span> plaintext.replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plaintext</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mecab_wakati(text):</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="co">    MeCabで分かち書き．</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="co">    ただし品詞は名詞だけに限定．</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> mc.Tagger()</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># t = mc.Tagger(&#39;-d /usr/local/lib/mecab/dic/mecab-ipadic-neologd/&#39;)</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> t.parseToNode(text)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    sent <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(node):</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.surface <span class="op">!=</span> <span class="st">&quot;&quot;</span>:  <span class="co"># ヘッダとフッタを除外</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>            word_type <span class="op">=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">0</span>]</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 名詞だけをリストに追加する</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> [<span class="st">&quot;名詞&quot;</span>]:</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>                sent <span class="op">+=</span> node.surface <span class="op">+</span> <span class="st">&quot; &quot;</span>  <span class="co"># node.surface は「表層形」</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 動詞（の原型），形容詞，副詞もリストに加えたい場合は次の２行を有効にする</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>            <span class="co">#if word_type in [ &quot;動詞&quot;, &quot;形容詞&quot;,&quot;副詞&quot;]:</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word_type <span class="kw">in</span> [ <span class="st">&quot;動詞&quot;</span>,<span class="st">&quot;副詞&quot;</span>,<span class="st">&quot;形容詞&quot;</span>]:</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>                sent <span class="op">+=</span> node.feature.split(<span class="st">&quot;,&quot;</span>)[<span class="dv">6</span>] <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="co"># node.feature.split(&quot;,&quot;)[6] は形態素解析結果の「原型」</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> node.<span class="bu">next</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sent</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ids_to_words(dictionary: Dictionary, ids):</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [dictionary[idx] <span class="cf">for</span> idx <span class="kw">in</span> ids]</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> most_frequent_words_rate(dictionary: Dictionary, threshold: <span class="bu">float</span>):</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    threshold_abs <span class="op">=</span> <span class="bu">int</span>(threshold <span class="op">*</span> dictionary.num_docs)</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    ids <span class="op">=</span> [ v <span class="cf">for</span> v <span class="kw">in</span> dictionary.token2id.values() <span class="cf">if</span> threshold <span class="op">&lt;=</span> dictionary.dfs.get(v, <span class="dv">0</span>) <span class="op">&gt;</span> threshold_abs]</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ids_to_words(dictionary, ids)</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a><span class="co">#クラスタごとにテキストをまとめてワードクラウドを作ってみる</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>font_path_gothic <span class="op">=</span> <span class="st">&#39;./data/fonts-japanese-gothic.ttf&#39;</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>stop_words <span class="op">=</span> [<span class="st">&#39;こと&#39;</span>,<span class="st">&#39;繁体&#39;</span>,<span class="st">&#39;簡体&#39;</span>,<span class="st">&#39;日本&#39;</span>,<span class="st">&#39;ブラジル&#39;</span>,<span class="st">&#39;ポルトガル&#39;</span>]</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>txts <span class="op">=</span> []</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> <span class="bu">list</span>(df_wiki[<span class="st">&#39;c&#39;</span>].unique()):</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>  txt <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>  df_t <span class="op">=</span> df_wiki[df_wiki[<span class="st">&#39;c&#39;</span>] <span class="op">==</span> c]</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> j <span class="kw">in</span> df_t[<span class="st">&#39;Text&#39;</span>]:</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    txt <span class="op">+=</span> j <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>  txt <span class="op">=</span> strip_CRLF_from_Text(txt)</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>  txt <span class="op">=</span> mecab_wakati(txt)</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>  txts.append(txt)</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txts)</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>dictionary <span class="op">=</span> Dictionary([x.split(<span class="st">&#39; &#39;</span>) <span class="cf">for</span> x <span class="kw">in</span> txts])</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(most_frequent_words_rate(dictionary, <span class="fl">0.5</span>))</span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>stop_words <span class="op">+=</span> most_frequent_words_rate(dictionary, <span class="fl">0.5</span>)</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(stop_words)</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c,txt <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">list</span>(df_wiki[<span class="st">&#39;c&#39;</span>].unique()),txts):</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> WordCloud( width<span class="op">=</span><span class="dv">1000</span>,height<span class="op">=</span><span class="dv">400</span>,background_color<span class="op">=</span><span class="st">&#39;white&#39;</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>                    , font_path<span class="op">=</span>font_path_gothic</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>                    , regexp<span class="op">=</span><span class="vs">r&quot;[\w&#39;]+&quot;</span> <span class="co">#一文字を表示</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>                    , stopwords<span class="op">=</span>stop_words).generate(txt)</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>  plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">10</span>))</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>  plt.imshow(result)</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>  plt.title(<span class="bu">str</span>(c))</span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>  plt.axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>  plt.show()</span></code></pre></div>
<p><img src="/images/ch15-wiki-c1.png" alt="クラスタ1(英語,韓国語,インドネシア語)" />
<img src="/images/ch15-wiki-c2.png" alt="クラスタ2(日本語,トルコ語)" />
<img src="/images/ch15-wiki-c3.png" alt="クラスタ3(アラビア語,ヒンディー語,ポルトガル語,ロシア語)" />
<img src="/images/ch15-wiki-c4.png" alt="クラスタ4(フランス語,ドイツ語,スペイン語,イタリア語)" />
<img src="/images/ch15-wiki-c5.png" alt="クラスタ5(中国語)" /></p>
<p>それぞれ異なる単語が表れており興味深いです. 研究の場合は,それぞれの特徴やその理由に関して考察すると面白いでしょう.</p>
]]></description>
    <pubDate>Tue, 12 Nov 2024 00:00:00 UT</pubDate>
    <guid>/lectures/slds15.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>特別講義DS Ch16 カテゴリーデータ処理</title>
    <link>/lectures/slds16.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#質問紙調査" id="toc-質問紙調査"><span class="toc-section-number">1</span> 質問紙調査</a>
<ul>
<li><a href="#社会的態度の操作的な定義" id="toc-社会的態度の操作的な定義"><span class="toc-section-number">1.1</span> 社会的態度の操作的な定義</a></li>
<li><a href="#心理尺度psychological-scale" id="toc-心理尺度psychological-scale"><span class="toc-section-number">1.2</span> 心理尺度(Psychological scale)</a></li>
<li><a href="#因子潜在変数" id="toc-因子潜在変数"><span class="toc-section-number">1.3</span> 因子(潜在変数)</a></li>
<li><a href="#質問紙の構成" id="toc-質問紙の構成"><span class="toc-section-number">1.4</span> 質問紙の構成</a>
<ul>
<li><a href="#測りたい態度について設定する" id="toc-測りたい態度について設定する"><span class="toc-section-number">1.4.1</span> 測りたい態度について設定する</a></li>
<li><a href="#概念の構造を考える" id="toc-概念の構造を考える"><span class="toc-section-number">1.4.2</span> 概念の構造を考える</a></li>
<li><a href="#項目の作成" id="toc-項目の作成"><span class="toc-section-number">1.4.3</span> 項目の作成</a></li>
</ul></li>
</ul></li>
<li><a href="#利用データ" id="toc-利用データ"><span class="toc-section-number">2</span> 利用データ</a></li>
<li><a href="#データ処理" id="toc-データ処理"><span class="toc-section-number">3</span> データ処理</a></li>
<li><a href="#ヒストグラム" id="toc-ヒストグラム"><span class="toc-section-number">4</span> ヒストグラム</a></li>
<li><a href="#相関係数" id="toc-相関係数"><span class="toc-section-number">5</span> 相関係数</a></li>
<li><a href="#同時度数分布表" id="toc-同時度数分布表"><span class="toc-section-number">6</span> 同時度数分布表</a></li>
<li><a href="#独立性の検定" id="toc-独立性の検定"><span class="toc-section-number">7</span> 独立性の検定</a></li>
<li><a href="#残渣分析" id="toc-残渣分析"><span class="toc-section-number">8</span> 残渣分析</a></li>
<li><a href="#次元削減" id="toc-次元削減"><span class="toc-section-number">9</span> 次元削減</a></li>
<li><a href="#共分散構造分析" id="toc-共分散構造分析"><span class="toc-section-number">10</span> 共分散構造分析</a></li>
</ul>
</div>
<p>本章は,カテゴリーデータの処理手法に関するまとめの章となります. 学生の研究ではアンケートデータが非常によく利用されますが, アンケートでは5段階評価などの質問項目がよく利用されるため,得られたデータの大部分がカテゴリーデータとなります. この章では,アンケートデータを事例に,よく行われる分析手法をいくつか紹介・実践してみます.
なお,本稿で紹介される手法は既にほかの章で説明されているものも含まれており, 内容の重複があります.</p>
<h1 data-number="1" id="質問紙調査"><span class="header-section-number">1</span> 質問紙調査</h1>
<p>本章はアンケート調査,質問紙調査によって集められるデータを分析するための事例を紹介することを目的としています. 質問紙調査によるデータの収集は,質問紙の設計や,倫理的な課題などにおいて留意すべき課題がいくつもあります. 本講義では学生自身が,データを収集することになるので,まずはそれらの内容に関して学習してみましょう. なお,本節の内容は, 教育・心理分野がご専門の江草遼平先生に監修いただきましたが,資料に含まれる誤りは筆者の責任に依るものです.</p>
<h2 data-number="1.1" id="社会的態度の操作的な定義"><span class="header-section-number">1.1</span> 社会的態度の操作的な定義</h2>
<p>質問紙調査を行う研究では,人の行動を説明・予測するための概念として,人の行動の背後に<strong>社会的態度</strong>があると仮定します. <strong>社会的態度</strong>とはオールポートの定義によれば,</p>
<ul>
<li>経験によって構築された心理・神経生理的な準備状態</li>
<li>人が関わる対象に対する行動を,方向づけたり変えたりするもの</li>
</ul>
<p>とされています.</p>
<p>これらの態度は直接観察することができません.そこで,態度の測定には,行動の測定を行い類推する手法を用います.</p>
<h2 data-number="1.2" id="心理尺度psychological-scale"><span class="header-section-number">1.2</span> 心理尺度(Psychological scale)</h2>
<p>実際の行動を測定するのには実験環境,参加者などの制約があり難しいことがあります.そこで,心理尺度による測定方法がよく用いられます.心理尺度とは態度に関する質問によって行動を測るもので,普段目にするアンケートで用いられている手法がそれに当たります(英語で検索する際には”Questionnaire”や”Scale”のキーワードを含めるとヒットしやすい).</p>
<p>厳密な心理尺度の構成は,それだけで1つの研究となるものです.「心理尺度を使って何かを明らかにしたい」が目的の場合には,可能であれば先行研究から心理尺度を援用して用いるか,そこに1つ2つ測定可能な指標を持ち込んで,それについて分析するのが望ましいです.例えば,共に先行研究がある”自尊感情の評価”と”大学生の恋愛観”の関係,あるいは”自尊感情の評価”と容易に測定可能な”100ます計算でケアレスミスが何回起こるか”の関係などが挙げられます.</p>
<p>既存の尺度を援用する際には,ものによって使用料金や著者の許諾を必要とする場合があるので,これらのチェックを忘れないようにする必要があります.</p>
<p>心理尺度における質問手法にはいくつかの種類がありますが,ここでは代表的なものを2つ見てみましょう.</p>
<div class="note">
<ul>
<li><h2 id="リッカート法-likert-scale-method">リッカート法 (Likert scale method)</h2></li>
</ul>
<p>リッカート法は質問項目について「とても当てはまる」,「やや当てはまる」,「どちらとも言えない」,「ほとんど当てはまらない」,「全く当てはまらない」などの段階化された回答を得る手法です.</p>
<p>各回答の間は等間隔とは限らず,測定が粗いため同じことについて複数の質問を集めることで測定誤差を小さくすることを試みます.</p>
<p>例えば,「授業における英語への関心」を測定するために,「分からないときでも英語を聞こうとする」,「分からないときでも英語を読もうとする」,「英語で話すのが楽しい」など複数の項目を立てます.</p>
<div class="warn">
<p>リッカート法で得られたデータは厳密には順序尺度にあたりますが,心理学分野では便宜的に間隔尺度として扱うことがあります.これは,複数の項目の得点の合計や平均点を用いるための処置ですが,他分野からは批判もあるので,その後の統計検定手法の選択などには注意する必要があります.</p>
</div>
</div>
<div class="note">
<ul>
<li><h2 id="sd法semantic-differential-scale-method">SD法(Semantic Differential Scale Method)</h2></li>
</ul>
<p>SD法は,文章での質問ではなく形容詞対を用いる方法です.例えば,ステンレスのコップを見たときの印象について,「温かい」-「冷たい」,「硬い」-「柔らかい」といった項目のどちらにより近いかを5段階,7段階の尺度で尋ねます.SD法は感情や印象に関する評価に向いており,デザインやサービスなどの評価によく用いられます.</p>
<p>SD法は適当な形容詞対をリストアップするのに苦労があるので,リッカート法と比べると作成が難しいですが,質問紙では異なる文章を用いる必要がありそうな複数の対象でも,同じ質問紙で評価ができる場合があり,比較が容易になるメリットがあります.</p>
</div>
<h2 data-number="1.3" id="因子潜在変数"><span class="header-section-number">1.3</span> 因子(潜在変数)</h2>
<p>ある態度を説明する際に,複数の側面を必要とする場合があります.例えば,対人認知(人に対する印象,ある人が好ましいかどうか)に関する研究では<a href="https://doi.org/10.1037/h0026086" title="https://doi.org/10.1037/h0026086">Rosenberg et al.(1968)</a>が,対人的な印象を形成する認知次元として<strong>社会的望ましさ</strong>と<strong>知的望ましさ</strong>の2次元を見出しています.</p>
<p><img src="/images/ch16-rosenberg.png" /></p>
<p>この説に基づけば,対人認知の傾向を問うアンケートを行うには「社会的望ましさ」と「知的望ましさ」のどちらか一方でなく,2つの次元を持つ尺度が望ましいこととなります.
このような概念構成の構造を知るには,構成する因子（上の例でいえば２つの望ましさ）を探索する必要があります.
そのような複数の変数の中から少数の次元を探索する分析手法として<strong>因子分析</strong>があります.
10項目の7段階であるリッカート尺度によるアンケートがあったとしたとき,このアンケートの10個の項目がすべて1つのことについて測定しているのであれば,ある項目への回答が中間の「４：どちらでもない」であったとき,ほかの回答も「４：どちらでもない」かそれに近い回答が選ばれる傾向がみられるはずです.そうなっていないなら,その質問は他のことについて尋ねている可能性が高いとみなされます.
アンケートの10個の項目が複数の次元について訊ねるものであるとき,いくつかの項目がほかの項目とは関係なく,まとまって高く反応する,反対に低く反応するなどのケースが見受けられます.このまとまった項目が共通して持つ部分を因子とみなします.</p>
<p><img src="/images/ch16-food.png" /></p>
<p>因子分析では直接観測できる質問項目（下位尺度）への反応から,直接観測できない「食べ物への態度」を構成する因子を測定し,それによって全体の概念を説明します.
各質問項目が因子につながる共通の部分を持っているかどうかは,質問項目間の相関係数から求められます.
質問項目によっては,2つ以上の因子にかかわることがあります.例えば,わさびが寿司につきものであるなら,多少は辛い物への態度が影響している可能性が考えられます.このようなケースでは,下位尺度のグループ化において,相関係数をもとに判断をする必要があります.</p>
<p><img src="/images/ch16-hot.png" /></p>
<p>質問項目には,尺度の全体に関わる部分があります.これを<strong>共通性</strong>といい,逆に,尺度に関わらない質問項目独自の要素を<strong>独自性</strong>と呼びます.
例えば寿司が好きという行動は尺度全体における「食べ物への態度」と高く関わっているかもしれません.この場合にはこれが共通性とみなされます.
しかし寿司が好きな人の中には「形がかわいいから好き」など食べ物に直接かかわらない要素があるかもしれません.
このような時,寿司が好きかという質問項目には独自性があるといえます.
共通性と独自性は足して１になるようになっており,共通性があまりに低い項目がある場合は共通因子を探るのに役に立たないことがあります.このような場合,その質問項目を除外して考えることもあります. 一方で,そのような質問項目から新しい因子が作成されたり,回答者グループの属性に影響を受けているなど,データ全体の解釈において有用である場合もあるので慎重に考える必要であります</p>
<p><img src="/images/ch16-sushi.png" /></p>
<p><img src="/images/ch16-carpaccio.png" /></p>
<ul>
<li>項目が持つ共通性（青）と独自性（白）
<ul>
<li>寿司のほうがより尺度全体への共通性が高いイメージ</li>
</ul></li>
</ul>
<p>各項目が因子から受ける影響の強さを因子負荷量と呼び,これが大きい項目が因子を解釈する際の中心となります.</p>
<p>この授業では因子分析自体は扱わず,共分散構造分析を扱いますが,これらの概念は解釈に必要なので忘れたら戻ってきてください.</p>
<div class="warn">
<ul>
<li><h2 id="信頼性と妥当性">信頼性と妥当性</h2></li>
</ul>
<p>尺度は態度を測るためのものさしにあたるものです.よって,測るたびに大きく数値が変わったり,対象を図るのに十分な長さがないとなれば役に立ちません.</p>
<p>そのような尺度の有用度を判断する基準として<strong>信頼性</strong>があります.信頼性は,尺度の測定誤差について吟味することです.一貫性の測定として,クロンバッハのα係数がよく用いられますが,ここでは深く扱いません. 興味のある方は調べてみる,教員に質問してみましょう.</p>
<p>作成者の意図通りに尺度を測定できているかを表す<strong>妥当性</strong>という概念もよく利用されます.妥当性の判断としては,より詳細には基準関連妥当性,内容的妥当性,構成概念妥当性を吟味することが求められますが,こちらも詳細は割愛します.</p>
</div>
<h2 data-number="1.4" id="質問紙の構成"><span class="header-section-number">1.4</span> 質問紙の構成</h2>
<h3 data-number="1.4.1" id="測りたい態度について設定する"><span class="header-section-number">1.4.1</span> 測りたい態度について設定する</h3>
<p>質問紙を構成する目的は,<strong>ある態度について類推することができる行動を計測すること</strong>です.したがって,まずその<strong>態度</strong>について明良化する必要があります.</p>
<p>例えば「人の一生」のような巨大すぎる概念を対象にするのは相当無理があります.「寝起き時の感情について」だとより限定されていて望ましいですが,例えば少年と老人,日本人と外国人では大きく異なるかもしれません.これらを比較することも一つの研究テーマとして面白いですが,まずは手におえる範囲までそれを訊ねる対象と扱う概念について小さくすることをおすすめします.</p>
<p>このようなときに重要なのは先行研究です.これまで研究されてこなかった概念を１から作るにしても,類似の研究について追試するにあたっても,先行研究から大きなヒントを得ることが近道となります. 先行研究の調べ方に関しては,講義で別の機会に扱いますので,参考にして先行研究を集めてみましょう.</p>
<h3 data-number="1.4.2" id="概念の構造を考える"><span class="header-section-number">1.4.2</span> 概念の構造を考える</h3>
<p>概念を構成する下位概念とについて,事前にイメージすることも重要です.これらは,アンケートを回収した結果修正を要することもありますが,ひとまず質問項目をまんべんなくそろえるために重要なステップです.</p>
<p>概念の構造には多様な種類がありますが,やはり先行研究から自分の知りたい概念についてどのような構造が適当であるかを吟味する必要があります.</p>
<figure>
<img src="/images/ch16-image-structure.png" alt="上位・下位の構造,並列構造,類型的構造の例" />
<figcaption aria-hidden="true">上位・下位の構造,並列構造,類型的構造の例</figcaption>
</figure>
<h3 data-number="1.4.3" id="項目の作成"><span class="header-section-number">1.4.3</span> 項目の作成</h3>
<p>心理尺度の項で先駆けてリッカート法とSD法については示しています.これらの方法は得点化して計算することを考慮したものですが,それ以外の方法でもデータを補強したり,集めることができます. いくつかの方法に関して概観してみましょう.</p>
<div class="note">
<ul>
<li><h2 id="順位法">順位法</h2>
順位法は提示された選択肢に順位をつけさせるものです.例えば,「カレー,ラーメン,とんかつの３つについて好きな順番をつけてください」のような質問項目が考えられます.この方法では,順序尺度のデータを得ることができます.</li>
</ul>
</div>
<div class="note">
<ul>
<li><h2 id="多肢選択法">多肢選択法</h2>
多肢選択法は質問項目について,複数の回答選択をさせるものです.「以下の中から,好きな授業名を１つ選べ」という質問では1つしか回答が得られませんが,「好きなだけ選べ」とすれば複数の情報が手に入ります.十分に設計された選択肢があれば傾向を得ることができます.</li>
</ul>
</div>
<div class="note">
<ul>
<li><h2 id="自由記述法">自由記述法</h2>
自由記述法は質問に対して,自由に文章を書かせる方法です.構造化されたデータを手に入れることができないが,見逃していた要素,想像もしていない要素が情報として得られる可能性があります.カテゴリー分類や自然言語処理によって解釈に寄与するデータを得ることができるかもしれません. 自然言語処理に関しては他の章で扱っていますので,参考にしてください.</li>
</ul>
</div>
<div class="warn">
<ul>
<li><h2 id="項目作成の際の注意">項目作成の際の注意</h2>
いずれの方法でも,質問項目の作成においては以下の点に注意を払う必要があります. それぞれの詳細に関しては,実際に質問紙を構成する中で,個別に解説しますので,必要に応じて対応していきましょう.</li>
</ul>
<p>１）項目が適切に構成概念を反映していること</p>
<p>２）項目がわかりやすいこと</p>
<p>３）回答を誘導しないこと</p>
<p>４）項目数が適切であること</p>
<p>５）選択肢が適切であること</p>
<p>６）逆転項目をいれるかどうか</p>
<p>７）回答者に社会通念上許されない負担を与えないこと</p>
</div>
<h1 data-number="2" id="利用データ"><span class="header-section-number">2</span> 利用データ</h1>
<p>本章では,仮想のアンケートデータとして,情報入門で利用されている理解度アンケートを利用します. なお,こちらのアンケートの質問形式は実際に利用しているものですが, 解答に関して仮想のものであり,得られた結果も実際の講義とは無関係であることに注意して下さい.</p>
<p>データは<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/questionnaire_sample_original.csv">こちら</a>からダウンロードできます.</p>
<p>こちらのデータは,Microsoft Formsで取得したアンケートデータになります. 自由回答や量的データを回答する質問項目はなく, 5段階の順序尺度及び複数選択式の質問項目からなります.</p>
<p>質問項目は以下の通りです.</p>
<div class="note">
<ul>
<li>あなたの「スマートフォン」に対する印象について、どれくらいあてはまるかを教えてください。</li>
<li>あなたの「スマートフォン」に対する操作や知識について、どれくらい自信があるかを教えてください。</li>
<li>あなたの「パソコン」に対する印象について、どれくらいあてはまるかを教えてください。</li>
<li>あなたの「パソコン」に対する操作や知識について、どれくらい自信があるかを教えてください。</li>
<li>あなたの「SNS（FacebookやInstagramなど）」に対する印象について、どれくらいあてはまるかを教えてください。</li>
<li>あなたの「SNS（FacebookやInstagramなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。</li>
<li>あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する印象について、どれくらいあてはまるかを教えてください。</li>
<li>あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。</li>
<li>次の「IT用語」について「知っている」という言葉にチェックをしてください（知っているものすべてにチェック）。</li>
<li>Windowsの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>電子メールの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>WWW(ウェブ)の操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>Wordの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>Excelの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>PowerPointの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>Officeの応用的な操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。</li>
<li>情報倫理について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。’</li>
</ul>
</div>
<h1 data-number="3" id="データ処理"><span class="header-section-number">3</span> データ処理</h1>
<p>Microsoft Formsによるデータは,複数選択可能な質問項目への解答が一つのセルに｢<code>;</code>｣を用いて区切られて記入されるなど特徴があります.</p>
<figure>
<img src="/images/ch16-data-sample.png" alt="データの形式" />
<figcaption aria-hidden="true">データの形式</figcaption>
</figure>
<p>分析の際には,これらの情報を利用しやすいように変形する必要があります. ここでは,練習も兼ねて一通りの処理を体験してみましょう.</p>
<p>加工後のデータは<a href="https://github.com/yakagika/yakagika.github.io/blob/main/slds_data/questionnaire_sample_edited.csv">こちら</a>で配布しているので,内容を確認して自力でできると感じた方はこの節は飛ばしていただいて構いません.</p>
<p>まずはデータの形式を確認してみましょう.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> japanize_matplotlib</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> st</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#グラフの保存場所</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>dir_fig <span class="op">=</span> <span class="st">&#39;./result/fig/&#39;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#グラフの設定</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">&#39;ggplot&#39;</span>) <span class="co">#グラフスタイル</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&#39;figure.figsize&#39;</span>] <span class="op">=</span> [<span class="dv">12</span>, <span class="dv">9</span>] <span class="co">#グラフサイズ</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&#39;font.size&#39;</span>] <span class="op">=</span> <span class="dv">14</span> <span class="co">#フォントサイズ</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#データの読み込み</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&#39;./data/questionnaire_sample_original.csv&#39;</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.columns)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">Index([&#39;あなたの「スマートフォン」に対する印象について、どれくらいあてはまるかを教えてください。&#39;,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「スマートフォン」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「パソコン」に対する印象について、どれくらいあてはまるかを教えてください。&#39;,</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「パソコン」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「SNS（FacebookやInstagramなど）」に対する印象について、どれくらいあてはまるかを教えてください。&#39;,</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「SNS（FacebookやInstagramなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;,</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する印象について、どれくらいあてはまるかを教えてください。&#39;,</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;,</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;次の「IT用語」について「知っている」という言葉にチェックをしてください（知っているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;Windowsの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;電子メールの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;WWW(ウェブ)の操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;Wordの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;Excelの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;PowerPointの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;Officeの応用的な操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;,</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">       &#39;情報倫理について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;],</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co">      dtype=&#39;object&#39;)</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>このままでは列名が長すぎてプログラムが書きにくいので,列名を順に<code>Q1~Q17</code>の連番に変更します.
今回は辞書型で連番を作成するために,組み込み関数の<code>enumerate()</code>を利用しています.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>new_columns <span class="op">=</span> <span class="bu">dict</span>([(t,<span class="st">&#39;Q&#39;</span><span class="op">+</span><span class="bu">str</span>(n <span class="op">+</span> <span class="dv">1</span>))<span class="cf">for</span> (n,t) <span class="kw">in</span>  <span class="bu">enumerate</span>(df.columns)])</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">一つ一つ手書きすると以下のようになる.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">new_columns = {&#39;あなたの「スマートフォン」に対する印象について、どれくらいあてはまるかを教えてください。&#39;:&#39;Q1&#39;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「スマートフォン」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;:&#39;Q2&#39;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「パソコン」に対する印象について、どれくらいあてはまるかを教えてください。&#39;:&#39;Q3&#39;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「パソコン」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;:&#39;Q4&#39;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「SNS（FacebookやInstagramなど）」に対する印象について、どれくらいあてはまるかを教えてください。&#39;:&#39;Q5&#39;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「SNS（FacebookやInstagramなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;:&#39;Q6&#39;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する印象について、どれくらいあてはまるかを教えてください。&#39;:&#39;Q7&#39;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;:&#39;Q8&#39;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;次の「IT用語」について「知っている」という言葉にチェックをしてください（知っているものすべてにチェック）。&#39;:&#39;Q9&#39;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;Windowsの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q10&#39;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;電子メールの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q11&#39;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;WWW(ウェブ)の操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q12&#39;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;Wordの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q13&#39;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;Excelの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q14&#39;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;PowerPointの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q15&#39;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;Officeの応用的な操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q16&#39;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">              ,&#39;情報倫理について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;:&#39;Q17&#39;}</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_columns)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">{&#39;あなたの「スマートフォン」に対する印象について、どれくらいあてはまるかを教えてください。&#39;: &#39;Q1&#39;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「スマートフォン」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;: &#39;Q2&#39;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「パソコン」に対する印象について、どれくらいあてはまるかを教えてください。&#39;: &#39;Q3&#39;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「パソコン」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;: &#39;Q4&#39;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「SNS（FacebookやInstagramなど）」に対する印象について、どれくらいあてはまるかを教えてください。&#39;: &#39;Q5&#39;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「SNS（FacebookやInstagramなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;: &#39;Q6&#39;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する印象について、どれくらいあてはまるかを教えてください。&#39;: &#39;Q7&#39;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;あなたの「ネットを使ったコミュニケーション（LINEやTwitterなど）」に対する操作や知識について、どれくらい自信があるかを教えてください。&#39;: &#39;Q8&#39;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;次の「IT用語」について「知っている」という言葉にチェックをしてください（知っているものすべてにチェック）。&#39;: &#39;Q9&#39;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;Windowsの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q10&#39;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;電子メールの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q11&#39;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;WWW(ウェブ)の操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q12&#39;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;Wordの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q13&#39;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;Excelの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q14&#39;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;PowerPointの操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q15&#39;</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;Officeの応用的な操作や事柄について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q16&#39;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co">, &#39;情報倫理について「身に付いている」ものにチェックをしてください（身に付いているものすべてにチェック）。&#39;: &#39;Q17&#39;}</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>df.rename(new_columns, inplace<span class="op">=</span><span class="va">True</span>,axis<span class="op">=</span><span class="st">&#39;columns&#39;</span>)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co">             Q1         Q2         Q3  ...                                                Q15                         Q16                                                Q17</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="co">0     まあまあ興味がある    どちらでもない    どちらでもない  ...           スライドマスターを活用することができる;SmartArtを挿入することができる;  学内PCで作成したファイルを自宅のPCに持ち運べる;                                       どれも身についていない;</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="co">1      すごく興味がある  まあまあ自信がある   すごく興味がある  ...                                新しいスライドを追加することができる;    学術的文章の規則を踏まえてレポートを作成できる;  学内PCでログアウトせずに帰る危険性を理解している;マルウェア（不正ソフト）について理解して...</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co">2      すごく興味がある   あまり自信がない  まあまあ興味がある  ...                                       どれも身についていない;                どれも身に付いていない;                                       どれも身についていない;</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co">3       どちらでもない   あまり自信がない    全く興味がない  ...                                新しいスライドを追加することができる;                どれも身に付いていない;                         学内PCでログアウトせずに帰る危険性を理解している;</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="co">4     まあまあ興味がある  まあまあ自信がある   すごく興味がある  ...                                新しいスライドを追加することができる;                どれも身に付いていない;                                       どれも身についていない;</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co">...         ...        ...        ...  ...                                                ...                         ...                                                ...</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="co">1347  まあまあ興味がある   あまり自信がない  まあまあ興味がある  ...  新しいスライドを追加することができる;スライドにページ番号を挿入することができる;スライドマ...                どれも身に付いていない;  学内PCでログアウトせずに帰る危険性を理解している;フィッシング詐欺について理解している;ウ...</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="co">1348  まあまあ興味がある   あまり自信がない  まあまあ興味がある  ...                                新しいスライドを追加することができる;                どれも身に付いていない;                         学内PCでログアウトせずに帰る危険性を理解している;</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="co">1349  まあまあ興味がある    全く自信がない    全く興味がない  ...                                新しいスライドを追加することができる;                どれも身に付いていない;                                       どれも身についていない;</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co">1350  まあまあ興味がある  まあまあ自信がある  まあまあ興味がある  ...             アニメーション機能を使うことができる;新しいスライドを追加することができる;                どれも身に付いていない;  学内PCでログアウトせずに帰る危険性を理解している;ウェブ上の画像に関する著作権について理解...</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">1351  まあまあ興味がある   あまり自信がない  まあまあ興味がある  ...          新しいスライドを追加することができる;スライドにページ番号を挿入することができる;                どれも身に付いていない;  フィッシング詐欺について理解している;ウェブ上の画像に関する著作権について理解している;学内...</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>続いて,質問項目を利用しやすいように変換します. このアンケートでは,<code>Q1~Q8</code>では,ITに関連する事柄に関する興味の強さと自信を5段階評価で聞いています.そのままでも使えますが,後の処理のために整数に変換します.
もとの列も残して置くために,数値変換した列は <code>QX_num</code>の形で新しい列を作成しています.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>kyomi <span class="op">=</span> {<span class="st">&#39;すごく興味がある&#39;</span>:<span class="dv">5</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>        ,<span class="st">&#39;まあまあ興味がある&#39;</span>:<span class="dv">4</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        ,<span class="st">&#39;どちらでもない&#39;</span>:<span class="dv">3</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        ,<span class="st">&#39;あまり興味がない&#39;</span>:<span class="dv">2</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        ,<span class="st">&#39;全く興味がない&#39;</span>:<span class="dv">1</span>}</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>zishin <span class="op">=</span> {<span class="st">&#39;すごく自信がある&#39;</span>:<span class="dv">5</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>         ,<span class="st">&#39;まあまあ自信がある&#39;</span>:<span class="dv">4</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>         ,<span class="st">&#39;どちらでもない&#39;</span>:<span class="dv">3</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>         ,<span class="st">&#39;あまり自信がない&#39;</span>:<span class="dv">2</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>         ,<span class="st">&#39;全く自信がない&#39;</span>:<span class="dv">1</span>}</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>]:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="op">+</span> <span class="st">&#39;_num&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i)].<span class="bu">apply</span>(<span class="kw">lambda</span> x : kyomi[x])</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>]:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="op">+</span> <span class="st">&#39;_num&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i)].<span class="bu">apply</span>(<span class="kw">lambda</span> x : zishin[x])</span></code></pre></div>
<p><code>Q9~Q17</code>では,身についているスキルを複数選択形式で尋ねています. 複数選択された項目は,セミコロン(<code>;</code>)で区切られています. 各質問項目で選択されたスキルの数に変換してみます.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#｢身についているもの｣の数の列を作る</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_list(x):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &#39;;&#39;で区切ったリストにする</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &#39;どれも身についていない&#39;がある場合は空の列を返す</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> x.split(<span class="st">&#39;;&#39;</span>)[<span class="dv">0</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;どれも身についていない&#39;</span> <span class="kw">in</span> xs:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">&#39;どれも知らない&#39;</span> <span class="kw">in</span> xs:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> xs</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#テスト</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.at[<span class="dv">100</span>,<span class="st">&#39;Q13&#39;</span>])</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(to_list(df.at[<span class="dv">100</span>,<span class="st">&#39;Q13&#39;</span>]))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt; フォントの種類やサイズを変更することができる;中央揃えや右揃えを設定することができる;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt; [&#39;フォントの種類やサイズを変更することができる&#39;, &#39;中央揃えや右揃えを設定することができる&#39;]</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>,<span class="dv">18</span>,<span class="dv">1</span>):</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="op">+</span> <span class="st">&#39;_num&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i)].<span class="bu">apply</span>(<span class="kw">lambda</span> x : <span class="bu">len</span>(to_list(x)))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df[<span class="st">&#39;Q17_num&#39;</span>])</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">0       0</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">1       3</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">2       0</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">3       1</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">4       0</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">       ..</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co">1347    3</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">1348    1</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">1349    0</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">1350    2</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">1351    3</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">Name: Q17_num, Length: 1352, dtype: int64</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>num_columns <span class="op">=</span> [<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(x) <span class="op">+</span> <span class="st">&#39;_num&#39;</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">18</span>,<span class="dv">1</span>)]</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(num_columns)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">[&#39;Q1_num&#39;, &#39;Q2_num&#39;, &#39;Q3_num&#39;, &#39;Q4_num&#39;, &#39;Q5_num&#39;, &#39;Q6_num&#39;, &#39;Q7_num&#39;, &#39;Q8_num&#39;, &#39;Q9_num&#39;, &#39;Q10_num&#39;, &#39;Q11_num&#39;, &#39;Q12_num&#39;, &#39;Q13_num&#39;, &#39;Q14_num&#39;, &#39;Q15_num&#39;, &#39;Q16_num&#39;, &#39;Q17_num&#39;]</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<h1 data-number="4" id="ヒストグラム"><span class="header-section-number">4</span> ヒストグラム</h1>
<p>続いて<strong>データ分析のファーストステップ</strong>であるヒストグラムを作成して<strong>個別の質問項目ごとのデータの特徴を</strong>みてみましょう. ヒストグラムの作成方法などに関しては,<a href="slds8.html">データの可視化の章</a>を参照して下さい.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ヒストグラムを作る</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">## Q1~Q6</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                      ,ncols <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                      ,tight_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i <span class="op">+</span> <span class="dv">1</span>) <span class="op">+</span> <span class="st">&#39;_num&#39;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> df[col].value_counts().sort_index()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    ax[i].bar(xs.index,xs.values, width <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(col)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;Q1_6_histgram.png&#39;</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">##Q6~Q12</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                      ,ncols <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                      ,tight_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i <span class="op">+</span> <span class="dv">6</span>) <span class="op">+</span> <span class="st">&#39;_num&#39;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> df[col].value_counts().sort_index()</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    ax[i].bar(xs.index,xs.values, width <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(col)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;Q7_12_histgram.png&#39;</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co">##Q13~Q17</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                      ,ncols <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>                      ,tight_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(i <span class="op">+</span> <span class="dv">13</span>) <span class="op">+</span> <span class="st">&#39;_num&#39;</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> df[col].value_counts().sort_index()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    ax[i].bar(xs.index,xs.values, width <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    ax[i].set_title(col)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;Q13_17_histgram.png&#39;</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span></code></pre></div>
<p>以下のようなグラフが最初に設定したグラフの保存場所 <code>./result/fig</code>に保存されているはずです.
ここでは,ヒストグラムの分析の仕方については細かく扱いませんが,多くの示唆が得られます.
<img src="/images/Ch16_Q13_17_histgram.png" alt="アンケートデータヒストグラム" /></p>
<h1 data-number="5" id="相関係数"><span class="header-section-number">5</span> 相関係数</h1>
<p>ヒストグラムで質問項目ごとのデータの特徴を把握したので,相関係数を求めて,データ間の関係性を可視化してみましょう. 今回のデータは<strong>順序尺度</strong>なので,<strong>スピアマンの順位相関係数</strong>を利用します. 相関に関する説明は,<a href="slds9.html">データの数値化に関する章</a>を参照してください.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#順位相関係数を求める</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df[num_columns].corr(method<span class="op">=</span><span class="st">&#39;spearman&#39;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>           ,cmap<span class="op">=</span>plt.get_cmap(<span class="st">&#39;bwr&#39;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>           ,vmax<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>           ,center <span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>           ,vmin<span class="op">=-</span><span class="fl">1.0</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>           ,xticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>           ,yticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>           ,linewidths<span class="op">=</span><span class="fl">.5</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>           ,annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;spearman&#39;</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;spearman.png&#39;</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code></pre></div>
<p>以下のような相関係数のヒートマップが作成されます. 細かな分析は行いませんが,<code>Q1~Q8</code>までの興味関心に関する質問項目間,<code>Q9~Q17</code>のスキルに関する質問間の相関が強いことなどが視覚的に表現されています.</p>
<figure>
<img src="/images/ch16_spearman.png" alt="スピアマンの順位相関係数" />
<figcaption aria-hidden="true">スピアマンの順位相関係数</figcaption>
</figure>
<p>こちらの相関係数は,後に行う<strong>共分散構造分析(SEM)</strong>におけるモデル作成のためにも利用されます.</p>
<h1 data-number="6" id="同時度数分布表"><span class="header-section-number">6</span> 同時度数分布表</h1>
<p>相関係数によって相関が高い質問項目の組み合わせがいくつか把握されましたがこれは質問項目全体の関係性です. 解釈を行うには,相関係数の高い質問項目の組み合わせごとに更に詳細に,どの回答とどの回答がどのような関係にあるのか,といった分析が必要になります. そのような,<strong>質的データ</strong>に関してそのような分析に利用できるのが<strong>同時度数分布表</strong>です. 詳細は,<a href="slds8.html">可視化の章</a>を参照して下さい.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#クロス表</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#質問項目の区分間にどのような関係があるのかを検定する</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#今回はスマホの自信(Q2)と,PCの自信(Q4)だけ(自分の仮説に応じて色々ためす)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 作業手順</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">## クロス表を作成する</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">## 独立性の検定(お互いに影響があるか)を検定する</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">## 検定が有意であれば,どの項目が具体的にどの項目に影響しているかを残渣分析で明らかにする.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">#クロス表の作成</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">## 列と行に指定する質問項目</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>target_row <span class="op">=</span> <span class="st">&#39;Q4&#39;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>target_col <span class="op">=</span> <span class="st">&#39;Q2&#39;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">## 選択肢の順序(指定しないとデータの出てきた順になる)</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> {target_row:[<span class="st">&#39;すごく自信がある&#39;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;まあまあ自信がある&#39;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;どちらでもない&#39;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;あまり自信がない&#39;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;全く自信がない&#39;</span>]</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        ,target_col:[<span class="st">&#39;すごく自信がある&#39;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;まあまあ自信がある&#39;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;どちらでもない&#39;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;あまり自信がない&#39;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                    ,<span class="st">&#39;全く自信がない&#39;</span>]}</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>crosstab <span class="op">=</span> pd.crosstab(df[target_row],df[target_col])</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>crosstab <span class="op">=</span> crosstab.reindex(order[target_row],axis<span class="op">=</span><span class="st">&#39;index&#39;</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>crosstab <span class="op">=</span> crosstab.reindex(order[target_col],axis<span class="op">=</span><span class="st">&#39;columns&#39;</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>sns.heatmap( crosstab</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>           , cmap<span class="op">=</span>plt.get_cmap(<span class="st">&#39;Reds&#39;</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>           , yticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>           , xticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>           , linewidths<span class="op">=</span><span class="fl">.5</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>           , annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;クロステーブル:&#39;</span> <span class="op">+</span> target_row <span class="op">+</span> <span class="st">&#39;×&#39;</span> <span class="op">+</span> target_col)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">70</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;cross_table_&#39;</span><span class="op">+</span> target_row <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> target_col <span class="op">+</span><span class="st">&#39;.png&#39;</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code></pre></div>
<p>作成された度数分布表を確認してみると,<code>Q2</code>と<code>Q2</code>の間に全体的に右肩下がりの関係性があること,それぞれの分布が分かります. 今回は一つの組み合わせについて注目してみましたが,様々な組み合わせについて分析してみましょう.</p>
<figure>
<img src="/images/ch16-cross.png" alt="同時度数分布表" />
<figcaption aria-hidden="true">同時度数分布表</figcaption>
</figure>
<h1 data-number="7" id="独立性の検定"><span class="header-section-number">7</span> 独立性の検定</h1>
<p>同時度数分布表によって,質問項目間の細かな関係性が分析されましたが,実際に2つの変数間に関係があるとは判断できていません. そのような判断のためには,<strong>検定</strong>を行う必要がありますが, 質的データの場合にしばしば用いられるのが,<strong>独立性の検定(Χ二乗検定)</strong>です. 詳細は<a href="slds9.html">数値化の章</a>を参照して下さい.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#独立性の検定</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>x2, p, dof, e <span class="op">=</span> st.chi2_contingency(crosstab,correction<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(p)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt; 2.2871064452593352e-84</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> p <span class="op">&lt;=</span> <span class="fl">0.025</span>:</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;有意&#39;</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;有意でない&#39;</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;&gt;&gt; 有意</span></span></code></pre></div>
<h1 data-number="8" id="残渣分析"><span class="header-section-number">8</span> 残渣分析</h1>
<p>2つの質問項目間に期待値に対する偏りがあることが分かりました. 偏りが確認された場合には, 相関係数の場合と同様に,質問項目のどの回答同士が偏っているのかを把握するためには<strong>残渣分析</strong>が利用できます. 詳細は<a href="slds9.html">数値化の章</a>を参照して下さい.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#有意であれば,残渣分析を行う</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">##期待値表の計算</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>expect <span class="op">=</span> pd.DataFrame(e)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>expect.columns <span class="op">=</span> crosstab.columns</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>expect.index   <span class="op">=</span> crosstab.index</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#残渣の計算</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>residual <span class="op">=</span> crosstab <span class="op">-</span> expect</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#標準化残渣の計算</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>col_sum <span class="op">=</span> crosstab.<span class="bu">sum</span>()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>row_sum <span class="op">=</span> crosstab.transpose().<span class="bu">sum</span>()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>total   <span class="op">=</span> col_sum.<span class="bu">sum</span>()</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>stdres  <span class="op">=</span> residual</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> stdres.columns:</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> stdres.index:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        stdres.at[r,c]    <span class="op">=</span> stdres.at[r,c] <span class="op">\</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                         <span class="op">/</span> np.sqrt( expect.at[r,c]</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                                  <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> col_sum[c] <span class="op">/</span> total)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> row_sum[r] <span class="op">/</span> total))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">#ヒートマップの作成</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>sns.heatmap(stdres</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>           ,cmap<span class="op">=</span>plt.get_cmap(<span class="st">&#39;bwr&#39;</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>           ,vmax<span class="op">=</span><span class="fl">1.96</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>           ,vmin<span class="op">=-</span><span class="fl">1.96</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>           ,center<span class="op">=</span><span class="dv">0</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>           ,xticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>           ,linewidths<span class="op">=</span><span class="fl">.5</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>           ,annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;標準化残渣:&#39;</span><span class="op">+</span> target_row <span class="op">+</span> <span class="st">&#39;×&#39;</span> <span class="op">+</span> target_col)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">70</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;stdres_&#39;</span> <span class="op">+</span> target_row <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> target_col <span class="op">+</span> <span class="st">&#39;.png&#39;</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code></pre></div>
<p>作成された標準化残渣を確認すると, 全体的に右肩下がりの偏りがあることが統計的に判断されました.</p>
<figure>
<img src="/images/ch16-regit.png" alt="標準化残渣" />
<figcaption aria-hidden="true">標準化残渣</figcaption>
</figure>
<h1 data-number="9" id="次元削減"><span class="header-section-number">9</span> 次元削減</h1>
<p>これまでは一つ一つの質問項目及び質問項目間の関係に注目してきましたが, いくつかの質問項目をまとめてどのような関係があるのか,あるいは全体の質問をまとめてどのようなことが言えるのかという着眼点もあります.
そのような場合に使える手法の一つが, <strong>次元削減</strong>です. 次元削減は,多数の変数がある場合にいくつかの変数を要約した一つの<strong>合成変数</strong>を作成する手法になります.</p>
<p>例えば, 以下のような各科目の成績データを考えた場合に,個別の科目の成績を見ると,国語は高いが,数学は低い人と社会は高いが,英語は低い人のどちらが学力が高いのかというような判断は困難です.</p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>国語 (x₁)</th>
<th>英語 (x₂)</th>
<th>社会 (x₃)</th>
<th>物理 (x₄)</th>
<th>化学 (x₅)</th>
<th>数学 (x₆)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>78</td>
<td>80</td>
<td>49</td>
<td>76</td>
<td>70</td>
<td>35</td>
</tr>
<tr class="even">
<td>2</td>
<td>66</td>
<td>90</td>
<td>68</td>
<td>47</td>
<td>60</td>
<td>55</td>
</tr>
<tr class="odd">
<td>3</td>
<td>55</td>
<td>89</td>
<td>90</td>
<td>88</td>
<td>82</td>
<td>78</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>そこで, 以下のように文系の科目をまとめた文系力やすべての科目を合成した総合学力のような変数を作成することで全体的な傾向が判断できます.
<span class="math display">
z_1 = \beta_{11}u_1 + \beta_{12}u_2 + \beta_{13}u_3 + \beta_{14}u_4 + \beta_{15}u_5 + \beta_{16}u_6 \implies 総合学力
</span>
<span class="math display">
z_2 = \beta_{21}u_1 + \beta_{22}u_2 + \beta_{23}u_3  \implies 文系力
</span>
<span class="math display">
z_3 =  \beta_{34}u_4 + \beta_{35}u_5 + \beta_{36}u_6 \implies 理系力
</span></p>
<p>ここで,<span class="math inline">u_i</span> は <span class="math inline">x_i</span> を標準化したものです.</p>
<p>このようにそれぞれの点数をまとめて,要約した変数に変換することで,文系力が高いグループを文系に分類するなど全体的な解釈を行うことが可能になります. 変数の要約は,上の用に回帰式を用いて分析者が独自に設計することも可能ですが, まとめられる以前の情報の情報をできるだけ損なわずに自動的に合成変数を作成する<strong>次元削減</strong>手法を利用することが一般的です.</p>
<p>次元削減手法にはいくつかありますが,ここでは代表的な手法である<strong>主成分分析(Principle component analysis)</strong>を利用してみましょう.</p>
<div class="note">
<ul>
<li>主成分分析(PCA;Principle component analysis)</li>
</ul>
<p>主成分分析は,多数の変数の持つ情報を損なわずに圧縮する技術(次数削減)であり,予測モデル構築の前処理としてもよく使われます.
主成分分析では,主成分の分散が最大になる軸(主成分)を探しその軸に直行する軸の中で分散が最大になる主成分を順に探していく手法です. 最も分散の大きい主成分を<strong>第1主成分</strong>,次に大きいものを<strong>第2主成分</strong>といい,以下順に数字が増えていきます.</p>
<p>通常は人間が把握できない多次元(多変数)を要約するために利用されますが,ここでは理解のために,二次元の場合のイメージを考えてみましょう.</p>
<figure>
<img src="/images/ch16-pca.png" alt="PCA" />
<figcaption aria-hidden="true">PCA</figcaption>
</figure>
<p>第1主成分を軸としてみると,第2主成分の情報は失われますが,情報の損失が最も少なく2次元から1次元に情報を圧縮できます. これは,<span class="math inline">[x,y]</span>を<span class="math inline">\theta</span>だけ回転させて,<span class="math inline">[x,y][cos(\theta),sin(\theta)]^t</span>を計算していることになります.</p>
</div>
<p>ここでは,アンケートデータの興味に関する質問<code>Q1,Q3,Q5,Q7</code>,自信に関する質問<code>Q2,Q4,Q6,Q8</code>,知識に関する質問<code>Q9~Q17</code>をそれぞれ要約して合成変数を作成してみます.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#次元削減</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#興味,自信,知識を統合して3変数にする</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>interest    <span class="op">=</span> df[[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(x) <span class="op">+</span> <span class="st">&#39;_num&#39;</span> <span class="cf">for</span> x <span class="kw">in</span> [<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>]]]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>confidence  <span class="op">=</span> df[[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(x) <span class="op">+</span> <span class="st">&#39;_num&#39;</span> <span class="cf">for</span> x <span class="kw">in</span> [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>]]]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>knowledge   <span class="op">=</span>  df[[<span class="st">&#39;Q&#39;</span> <span class="op">+</span> <span class="bu">str</span>(x) <span class="op">+</span> <span class="st">&#39;_num&#39;</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>,<span class="dv">18</span>,<span class="dv">1</span>)]]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#普通に平均値を出して,正規化するパターン</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">def min_max_scaling(x):</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">    return (x - x.min())/(x.max() - x.min())</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">interest = min_max_scaling(interest.mean(axis=1))</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">confidence = min_max_scaling(confidence.mean(axis=1))</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">knowledge = min_max_scaling(knowledge.mean(axis=1))</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">print(interest)</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">#PCAやt-sneでやってみるパターン(ただし,解釈が難しい)</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition  <span class="im">import</span> PCA</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> PCA()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>pca.fit(interest)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>interest <span class="op">=</span> pca.transform(interest)[:,<span class="dv">0</span>]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;interest:&#39;</span>, pca.explained_variance_ratio_[<span class="dv">0</span>])</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>pca.fit(confidence)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>confidence <span class="op">=</span> pca.transform(confidence)[:,<span class="dv">0</span>]</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;confidence:&#39;</span>, pca.explained_variance_ratio_[<span class="dv">0</span>])</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>pca.fit(knowledge)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>knowledge <span class="op">=</span> pca.transform(knowledge)[:,<span class="dv">0</span>]</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;knowledge:&#39;</span>, pca.explained_variance_ratio_[<span class="dv">0</span>])</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co">#図示してみる</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co">## interest-confidence</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>plt.scatter(y<span class="op">=</span>interest,x<span class="op">=</span>confidence)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;interest-confidence&#39;</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;interest&#39;</span>)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;confidence&#39;</span>)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;interest-confidence.png&#39;</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="co">## interest-knowledge</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>plt.scatter(y<span class="op">=</span>interest,x<span class="op">=</span>knowledge)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;interest-knowledge&#39;</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;interest&#39;</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;knowledge&#39;</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;interest-knowledge.png&#39;</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="co">## confidence-knowledge</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>plt.scatter(y<span class="op">=</span>confidence,x<span class="op">=</span>knowledge)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;confidence-knowledge&#39;</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;confidence&#39;</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;knowledge&#39;</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;confidence-knowledge.png&#39;</span>)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="co">##3変数</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(projection<span class="op">=</span><span class="st">&#39;3d&#39;</span>)</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>ax.scatter(interest,confidence,knowledge)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;pca3d.png&#39;</span>)</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co">#それぞれの相関係数を確認する</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;interest&#39;</span>]      <span class="op">=</span> interest</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;confidence&#39;</span>]    <span class="op">=</span> confidence</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;knowledge&#39;</span>]     <span class="op">=</span> knowledge</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df[[<span class="st">&#39;interest&#39;</span>,<span class="st">&#39;confidence&#39;</span>,<span class="st">&#39;knowledge&#39;</span>]].corr(method<span class="op">=</span><span class="st">&#39;spearman&#39;</span>)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>           ,cmap<span class="op">=</span>plt.get_cmap(<span class="st">&#39;bwr&#39;</span>)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>           ,vmax<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>           ,center <span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>           ,vmin<span class="op">=-</span><span class="fl">1.0</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>           ,xticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>           ,yticklabels<span class="op">=</span><span class="dv">1</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>           ,linewidths<span class="op">=</span><span class="fl">.5</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>           ,annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;pca_spearman&#39;</span>)</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>plt.savefig(dir_fig <span class="op">+</span> <span class="st">&#39;pca_spearman.png&#39;</span>)</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="co">#このあとクラスタリングしてみることで,学生の分類ができるかもしれない</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a><span class="co">#(けど今回はやらない)</span></span></code></pre></div>
<p>PCAによる合成変数の関係を散布図で確認し,それぞれの合成変数間の関係性を見てみることで個別にはわからなかった特徴が見えることがあります. 今回は,これ以上は扱いませんが,可視化によって特徴が見えた場合にはこのあと作成した変数を利用した解析,クラスタリングなどでデータの解釈を進めることになります.</p>
<figure>
<img src="/images/ch16-pca-graph.png" alt="次元削減の結果確認" />
<figcaption aria-hidden="true">次元削減の結果確認</figcaption>
</figure>
<figure>
<img src="/images/ch16-pca-corr.png" alt="合成変数の相関係数" />
<figcaption aria-hidden="true">合成変数の相関係数</figcaption>
</figure>
<h1 data-number="10" id="共分散構造分析"><span class="header-section-number">10</span> 共分散構造分析</h1>
<p>これまでに残渣分析などで2変数間の関係性を確かめてきました. しかし,アンケート調査のように多数の項目がある場合には, より複雑な多数の変数間の関係性を知りたい場合があります.
そのような場合に利用できるのが<strong>共分散構造分析(SEM;Covariance Structure Analysis, Structural Equation Modeling）</strong>です.
SEMは社会科学,心理学,マーケティング,教育研究などの分野でよく用いられる複数の変数間の関係をモデル化し分析する統計的手法です.
SEMはこれまでの分析手法のように2つのデータの関係を対等に分析するのではなく, 先に理論や仮説に基づいたモデルを構築し,そのモデルの適合性をデータを通じて検証します. したがって,事前にモデルを構築する必要があり,その点が難しいポイントとなります.</p>
<p>SEMに関して説明する前に,SEMと関連が深い<strong>因子分析</strong>に関して説明しておきます.</p>
<div class="note">
<ul>
<li>因子分析
観測された複数の変数の背景にある因子を想定して,その因子を明らかにする分析手法を<strong>因子分析</strong>といいます.
例として,学生別の｢100M走のタイム｣と｢走り幅跳びの飛距離｣は,背景にデータとして観測されていないである｢脚力｣という共通の<strong>潜在変数</strong>を持つと仮定します. その場合に,</li>
</ul>
<p><span class="math display">脚力=100M + 走り幅跳び + ... </span></p>
<p>のような形で,背景にある因子を説明するのが因子分析です.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">ID</th>
<th style="text-align: center;">100M</th>
<th style="text-align: center;">走り幅跳び</th>
<th style="text-align: center;">遠投</th>
<th style="text-align: center;">懸垂</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">14.5</td>
<td style="text-align: center;">2.2</td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">12</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">15.2</td>
<td style="text-align: center;">1.7</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">7</td>
</tr>
<tr class="odd">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p><img src="/images/ch16-sem-1.png" /></p>
</div>
<div class="note">
<ul>
<li>共分散構造分析</li>
</ul>
<p>SEMで適合度を検討するモデルは<strong>構造モデル</strong>と呼ばれます. 構造モデルは,<strong>観測変数(直接測定される変数)</strong>と<strong>潜在変数(直接測定はできないが,観測変数を通じて推定される変数)</strong>によって構成される複数の方程式からなります.</p>
<p>SEMでは以下のような観測変数と潜在変数からなる回帰モデルによって<strong>因果関係</strong>を表します.</p>
<p><span class="math display"> 体育大学合格率(観測) = 脚力(潜在) + 腕力(潜在) + 筆記テスト成績(観測)  </span></p>
<p>更に, 変数間の双方向の相関関係も同時に検討します.</p>
<p>まとめると,SEMはモデルを構築するための,回帰分析と因子分析を同時に行う分析手法になります.</p>
<p>SEMにおける構造モデルは,複数の観測変数からなる潜在変数,観測変数と潜在変数からなる因果関係から構成され,非常に複雑な構造を持ちます. そのようなモデルの全体像を視覚的に把握できるように図にしたものを<strong>パス図</strong>といい,SEMを利用するためにはこの図を最初に仮説として作成する必要があります.</p>
<p>パス図では,モデル内の変数間の因果関係を矢印として表し, p値と偏回帰係数によってそれぞれの因果関係の検定と影響力が示されます.</p>
<p><img src="/images/ch16-sem2.png" /></p>
<p>データによってモデルはその適合性が確認されますが,確認すべき結果は以下の表のようになります.</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 56%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>評価指標</th>
<th>意味</th>
<th>目安</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>カイ二乗適合度検定 (Chi-Square Goodness-of-Fit Test)</td>
<td>モデルによって生成された共分散行列とサンプルデータの共分散行列との誤差を評価</td>
<td>p値 &lt; 0.05</td>
</tr>
<tr class="even">
<td>ルート平均二乗誤差の近似 (RMSEA: Root Mean Square Error of Approximation)</td>
<td>一人一人の観測値に対してモデルの適合度がどれだけ良いか</td>
<td>0.05以下であれば良い 0.05〜0.08であれば許可範囲 0.08〜0.10は許可 それ以上であれば不適切</td>
</tr>
<tr class="odd">
<td>標準化平均二乗残差 (SRMR: Standardized Root Mean Square Residual)</td>
<td>モデルとデータの間の差異の平均</td>
<td>SRMR値が0.05以下であれば,モデルの適合度は良い</td>
</tr>
<tr class="even">
<td>比較適合指数 (CFI: Comparative Fit Index)</td>
<td>モデルの適合度を、無制約のベースラインモデル（すべての観測変数が独立しているモデル）と比較して評価</td>
<td>CFI値は0.9から1の範囲 0.95以上であれば非常に良い適合度 0.9以上であれば可</td>
</tr>
<tr class="odd">
<td>GFI (Goodness of Fit Index)</td>
<td>モデルによって再現された共分散および共分散の割合</td>
<td>GFI値が1から0の範囲、0.95以上であれば非常に良い適合度 0.9以上であれば可</td>
</tr>
<tr class="even">
<td>AGFI (Adjusted Goodness of Fit Index)</td>
<td>GFIをモデルの複雑さ（モデルに含まれるパラメータの数）で調整したもの</td>
<td>0.95以上であれば非常に良い適合度 0.9以上であれば可</td>
</tr>
<tr class="odd">
<td>NFI (Normed Fit Index)</td>
<td>モデルの適合度を独立している無制約の帰無仮説モデル（null model）と比較して評価し,モデルがモデルにどれだけ適合度を示しているかを測定</td>
<td>0.95以上であれば非常に良い適合度 0.9以上であれば可</td>
</tr>
</tbody>
</table>
</div>
<p>それでは,アンケートデータを利用してSEMを実際に行ってみましょう. 今回は以下のパス図によって表される図を検証します.</p>
<p><img src="/images/ch16-sem-4.png" /></p>
<p>今回はあくまで仮想データを利用した練習なので,このモデルは深く考えられたものではありませんが,実際にSEMを利用する場合には事前に仮説を立てて, アンケートの質問の設計自体を仮説が検証できるような形にしておく必要があります.</p>
<p>今回は, 潜在因子として, Word,Excel,PowerPointのスキルによって構成される<strong>情報作成志向</strong>,情報倫理,IT用語に関する知識によって構成される<strong>情報探求志向</strong>,SNSやネットのコミュニケーション能力によって構成される<strong>情報消費志向</strong>によって,パソコンとスマートフォンに対する自信が決まるという因果関係を表しています. また,情報作成志向を構成する観測変数は,Office操作技能によって影響を受けるという構造になっています.</p>
<p>Pythonでは,共分散構造分析用のライブラリ<code>semopy</code>を利用してSEMを実施できます.
<code>semopy</code>では,モデルを文字列で指定します.</p>
<p>指定される,潜在変数,因果関係,相関関係は記号を用いてそれぞれ以下のように表現されます.</p>
<ul>
<li><strong>潜在因子</strong></li>
</ul>
<p><code>潜在変数 =~ 観測変数1 + 観測変数2 + ...</code></p>
<ul>
<li><strong>因果関係</strong></li>
</ul>
<p><code>目的変数 ~ 説明変数1 + 説明変数2 + ...</code></p>
<ul>
<li><strong>相関関係</strong></li>
</ul>
<p><code>変数 ~ 変数</code></p>
<p>それでは,モデルを構築し,実際のデータで検証してみましょう.
SEMは,回帰分析を行うので回帰係数の解釈のために事前に変数を標準化しておくことを忘れないようにしましょう.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#共分散構造分析</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#変数間の因果関係をモデル化する.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> semopy</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> semopy <span class="im">import</span> Model</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#標準化する</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>df[num_columns] <span class="op">=</span> stats.zscore(df[num_columns])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#データ型の変換</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">## すべてfloatでないとだめ.</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>df_sem <span class="op">=</span> df[num_columns].astype(<span class="st">&#39;float64&#39;</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#わかりにくいから名前を変える</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>df_sem.rename({<span class="st">&#39;Q2_num&#39;</span>:<span class="st">&#39;Smartphone&#39;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q4_num&#39;</span>:<span class="st">&#39;PC&#39;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q13_num&#39;</span>:<span class="st">&#39;Word&#39;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q14_num&#39;</span>:<span class="st">&#39;Excel&#39;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q15_num&#39;</span>:<span class="st">&#39;PowerPoint&#39;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q10_num&#39;</span>:<span class="st">&#39;Windows&#39;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q16_num&#39;</span>:<span class="st">&#39;Office&#39;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q17_num&#39;</span>:<span class="st">&#39;Info&#39;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q9_num&#39;</span>:<span class="st">&#39;IT&#39;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q8_num&#39;</span>:<span class="st">&#39;Communication&#39;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>              ,<span class="st">&#39;Q6_num&#39;</span>:<span class="st">&#39;SNS&#39;</span>}</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>              ,inplace<span class="op">=</span><span class="va">True</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>              ,axis<span class="op">=</span><span class="st">&#39;columns&#39;</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_sem)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 仮説(割と適当です)</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 文字列で指定する</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>desc <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="st">    # (潜在因子) 潜在変数=~観測変数</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="st">    ##隠れた因子を作成する</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="st">    creation =~ Word + Excel + PowerPoint + Windows</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="st">    knowledge =~ Info + IT</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="st">    consumption =~ Communication + SNS</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="st">    # (因果関係) 目的変数 ~ 説明変数</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="st">    ## 変数の間の因果関係の仮説(潜在,観測どちらでも)</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="st">    PC ~ creation + knowledge + consumption</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="st">    Smartphone ~ creation + knowledge + consumption</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="st">    # (相関関係 双方向)</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="st">    ## 向きはどちらでも良い</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="st">    ### 面倒なので1つだけ</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="st">    PC ~~ Smartphone</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;&#39;</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習器を用意</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>mod <span class="op">=</span> Model(desc)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習結果をresに代入する</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> mod.fit(df_sem)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習結果のパラメータ一覧を表示する</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="co">#CFI、GFI、AGFI、NFI &gt;= 0.95非常に良い &lt;0.9 悪い</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>inspect <span class="op">=</span> mod.inspect()</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(inspect)</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルの評価指標を表示</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> semopy.calc_stats(mod)</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 転置して表示</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(stats.T)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="co">#偏回帰係数(因果の大きさ+p値(0.05以下で有意))</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_covs=True で共分散を表示</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="co">#engine=</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="co">## &#39;circo&#39; 円形</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="co">## &#39;dot&#39; 階層型のグラフ</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>pass_graph <span class="op">=</span> semopy.semplot(mod</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>                           ,dir_fig <span class="op">+</span> <span class="st">&#39;SEM.png&#39;</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                           ,plot_covs<span class="op">=</span><span class="va">True</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                           ,engine<span class="op">=</span><span class="st">&#39;dot&#39;</span>)</span></code></pre></div>
<p><code>semopy</code>では以下のような形でパス図におけるそれぞれの矢印毎にp値を求めてくれます.</p>
<p><img src="/images/ch16-sem-5.png" /></p>
<p>また,パス図として結果を表示してくれる機能もあります.</p>
<p><img src="/images/ch16-sem6.png" /></p>
<p>今回は,スマートフォンに関する興味関心から情報作成志向に対するパス以外は有意でした.また,モデル全体を評価する指標も概ね問題なく,データによってモデルの適合性が確認されました.</p>
]]></description>
    <pubDate>Sat, 19 Oct 2024 00:00:00 UT</pubDate>
    <guid>/lectures/slds16.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>代数プログラミング入門 Ch5 代数的データ型1</title>
    <link>/lectures/iap5.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#代数的データ型集合論的解釈" id="toc-代数的データ型集合論的解釈"><span class="toc-section-number">1</span> 代数的データ型(集合論的解釈)</a>
<ul>
<li><a href="#命題と条件式" id="toc-命題と条件式"><span class="toc-section-number">1.1</span> 命題と条件式</a></li>
<li><a href="#集合" id="toc-集合"><span class="toc-section-number">1.2</span> 集合</a></li>
<li><a href="#型注釈と関数" id="toc-型注釈と関数"><span class="toc-section-number">1.3</span> 型注釈と関数</a>
<ul>
<li><a href="#内包表記" id="toc-内包表記"><span class="toc-section-number">1.3.1</span> 内包表記</a></li>
</ul></li>
<li><a href="#包含" id="toc-包含"><span class="toc-section-number">1.4</span> 包含</a></li>
<li><a href="#積と和" id="toc-積と和"><span class="toc-section-number">1.5</span> 積と和</a></li>
</ul></li>
<li><a href="#代数とクラス" id="toc-代数とクラス"><span class="toc-section-number">2</span> 代数とクラス</a>
<ul>
<li><a href="#マグマ" id="toc-マグマ"><span class="toc-section-number">2.1</span> マグマ</a></li>
<li><a href="#半群" id="toc-半群"><span class="toc-section-number">2.2</span> 半群</a></li>
<li><a href="#モノイド" id="toc-モノイド"><span class="toc-section-number">2.3</span> モノイド</a></li>
<li><a href="#群" id="toc-群"><span class="toc-section-number">2.4</span> 群</a></li>
<li><a href="#リスト" id="toc-リスト"><span class="toc-section-number">2.5</span> リスト</a></li>
<li><a href="#ツリー" id="toc-ツリー"><span class="toc-section-number">2.6</span> ツリー</a></li>
<li><a href="#ネットワーク" id="toc-ネットワーク"><span class="toc-section-number">2.7</span> ネットワーク</a></li>
</ul></li>
<li><a href="#発展交換代数" id="toc-発展交換代数"><span class="toc-section-number">3</span> 発展:交換代数</a></li>
</ul>
</div>
<h1 data-number="1" id="代数的データ型集合論的解釈"><span class="header-section-number">1</span> 代数的データ型(集合論的解釈)</h1>
<p>Haskellのデータ型はすべて<strong>代数的データ型</strong>です. 代数的データ型には, <strong>列挙型</strong>,<strong>直積型</strong>,<strong>直和型</strong>があり,構文として<strong>レコード構文</strong>などが存在します.</p>
<p>代数的データ型は文字通り, 数学における代数の構造を参照にしたデータ型であり,代数的な定義と対応させることで様々なことが可能となります. 代数学を理解するためにはまず,集合論の基礎を理解している必要があります.ここでは,集合論と対応させる形で,代数的データ型とは何であるかを理解することを目指します.</p>
<div class="warn">
<p>Haskellは代数学の一部である<strong>圏論</strong>と強い結びつきがあり,プログラムのデータ構造は圏論的に解釈することも可能となります. 特にHaskellの高度な機能, 多相型(ポリモーフィズム),モナド,状態系などは集合論的な理解よりも圏論的な理解のほうが適しています.
そこで,ここでは一旦集合論的に概要を把握し,後の章で圏論的な解釈を試みます.</p>
</div>
<h2 data-number="1.1" id="命題と条件式"><span class="header-section-number">1.1</span> 命題と条件式</h2>
<p>集合論的に代数的データ型を解釈するにあたって,数理的な定義の記法に用いる演算子を導入します. 数理的な定義の内,そこで述べられた言説が,「真か偽のいずれかに分類可能とされるもの」を<strong>命題</strong>といい,条件が与えられた命題を<strong>条件式</strong>といいいます.</p>
<p><code>x</code>に関する条件式を
<span class="math inline">P(x)≔***</span> や <span class="math inline">Q(x)≔***</span>
と書き，<code>***</code>の部分に,命題が記述されます．</p>
<p>命題の記述には以下の論理演算子が用いられます．</p>
<ul>
<li><p><span class="math inline">\neg p(x):p(x)</span> の否定</p></li>
<li><p><span class="math inline">P(x) \lor Q(x)</span>： <span class="math inline">P(x)</span>または<span class="math inline">Q(x)</span></p></li>
<li><p><span class="math inline">P(x) \land Q(x)</span>：P(x)かつQ(x)</p></li>
<li><p><span class="math inline">P(x) \Rightarrow Q(x)</span>：<span class="math inline">P(x)</span>ならば<span class="math inline">Q(x)</span></p></li>
<li><p><span class="math inline">P(x) \Leftrightarrow Q(x) ∶</span> <span class="math inline">P(x)</span>ならば <span class="math inline">Q(x)</span> かつ <span class="math inline">P(x)</span> ならば <span class="math inline">Q(x)</span></p></li>
</ul>
<p>このとき,
<span class="math inline">p(x) \Rightarrow q(x) \Leftrightarrow \neg p(x) \lor q(x)</span> となります.</p>
<p>memo: 全称命題と存在命題 (あとで出てきたときに書く)</p>
<h2 data-number="1.2" id="集合"><span class="header-section-number">1.2</span> 集合</h2>
<p>Haskellではデータ型を集合と<strong>みなすこと</strong>ができます. Haskellの型はあくまで型であり,厳密には集合ではありません. また,このあと出てくるリストを使った<code>内包表記</code>などの<strong>集合論的な書き方</strong>も数学における集合ではありません.
あくまで類似したものです.</p>
<p>しかし,Haskellを集合とみなすことで,関数型プログラミングや,代数的データ型の意味がより直感的に理解できるようになります. しばらく,集合論とHaskellの対応について考えてみましょう.</p>
<div class="note">
<p>特定のモノがそこに｢属するか判定可能なモノの集まり｣を｢集合｣という．</p>
</div>
<p>集合の細かな定義は置いておいて,この講義では取り敢えずこのくらいの認識で問題ありません. しかし,ただのモノの集まりではなく,特定のモノがそこに属するかどうかを判定できる必要があるので注意が必要です.</p>
<p>例えば, ｢頭の良い人の集合｣のようなものは,｢頭が良い基準｣が人によって異なるので,集合とはみなせません.</p>
<p>ノーベル賞受賞者の集合,フィールズ賞受賞者の集合,メンサ会員の集合,XX模試の偏差値が70以上の人の集合,特定の科目で85点以上取った人の集合,など,誰でも判別可能な定義が必要です.</p>
<p>私が過去に飼ったことのある犬の種類の集合を<code>MyDogs</code>という名前で呼ぶと,<code>MyDogs</code>に属するモノたちを<code>{ }</code>を使って以下のように書くことができます.</p>
<p><span class="math display">\begin{align*}
MyDogs = &amp; \{ GoldenRetriever \\
         &amp;, BlackRetriever    \\
         &amp;, ShetlandSheepdog \\
         &amp;, StandardPoodle \\
         &amp;, StandardPoodle \}
\end{align*}</span></p>
<p>このとき,<code>GoldenRetriever</code>や,<code>ShetlandSheepdog</code>は<code>MyDogs</code>の<code>要素</code>であるといい,要素が特定の集合に属するとき,</p>
<p><span class="math display"> GoldenRetriever \in MyDogs </span> の様に書きます. 要素に属さないことは <span class="math inline">Chihuahua \notin MyDogs</span>と書きます.</p>
<p>Haskellにおいて,このようなデータ型を以下の様に定義することが可能です.
データ型の宣言は, <code>data</code>のあとに続いて,<code>データ型の名前(型構築子)</code>を書き,<code>=</code>の後ろにその<code>中身(コンストラクタ/データ構築子)</code>を書きます.
型構築子やデータ構築子は,大文字の英字で始めるのが規則です.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">MyDogs</span> <span class="ot">=</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">BlackRetriever</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">ShetlandSheepdog</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">StandardPoodle</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">StandardPoodle</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">deriving</span> <span class="dt">Show</span></span></code></pre></div>
<p>この様にそこに属する要素をすべて書き出す(列挙する)データ型を<code>列挙型</code>といいます.</p>
<div class="warn">
<p>ちなみに,大文字の英字で始まってさえいればUTF-8の文字や絵文字,記号は使用できるので,以下のような記述も可能ですが,あまりおすすめしません.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">My</span>🐶   <span class="ot">=</span> <span class="dt">P</span>ゴールデンレトリーバー</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">P</span>ブラックレトリーバー</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">P</span>シェットランドシープドッグ</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">P</span>スタンダードプードル</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">|</span> <span class="dt">P</span>ビーグル</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">deriving</span> <span class="dt">Show</span></span></code></pre></div>
</div>
<p><code>deriving Show</code>はコンストラクタを文字列に変換する関する<code>show</code>を自動で導入するための記法です. 自分で定義することも可能ですが,詳細に関しては後ほど扱います.</p>
<p><code>deriving Show</code>を入れていない状態で</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span> <span class="dt">GoldenRetriever</span></span></code></pre></div>
<p>などを実行すると,以下のエラーがでますが,<code>deriving Show</code>を追加することで,表示することが可能となります.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>{</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> <span class="kw">data</span> <span class="dt">MyDogs</span> <span class="ot">=</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span>             <span class="op">|</span> <span class="dt">BlackRetriever</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> <span class="op">:</span>}</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">print</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">17</span><span class="op">:</span><span class="dv">1</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span> [<span class="dt">GHC</span><span class="op">-</span><span class="dv">39999</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">No</span> <span class="kw">instance</span> for ‘<span class="dt">Show</span> <span class="dt">MyDogs</span>’ arising from a use <span class="kw">of</span> ‘print’</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    • <span class="dt">In</span> the expression<span class="op">:</span> <span class="fu">print</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">In</span> an equation for ‘it’<span class="op">:</span> it <span class="ot">=</span> <span class="fu">print</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>{</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> <span class="kw">data</span> <span class="dt">MyDogs</span> <span class="ot">=</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span>             <span class="op">|</span> <span class="dt">BlackRetriever</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span>             <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">|</span> <span class="op">:</span>}</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="fu">print</span> <span class="dt">GoldenRetriever</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="dt">GoldenRetriever</span></span></code></pre></div>
<p>なお, <code>print</code>の<a href="https://hackage.haskell.org/package/base-4.19.1.0/docs/src/System.IO.html#print">実装</a>は</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="ot"> ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span> x <span class="ot">=</span> <span class="fu">putStrLn</span> (<span class="fu">show</span> x)</span></code></pre></div>
<p>となっています.</p>
<p>要素が一つも属さない集合を<code>空集合</code>といい,記号<span class="math inline">\phi</span> または<span class="math inline">｛｝</span>によって表されます．
Haskellでは空集合を表すデータ型として<code>Data.Void</code>に定義された<code>Void</code>が存在します. データ型として<code>ボトム型</code>,記号では<code>⊥</code>で表される場合もあります.</p>
<p><code>Void</code>と同じ値を持たないデータ型は,コンストラクタを記述しないことで自分で実装することもできます. 例えば私が犬を今までに一匹もかったことがなければ, <span class="math display"> MyPet = \phi </span> となり,データ型としては以下のように定義されます. 値が存在しない空集合と対応していることが分かります.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Mypet</span></span></code></pre></div>
<p><code>Void</code>型は値が存在しないため実行することはできませんが,コンパイルを通すことはできます. ただし,あまり実用する機会はないので,以下の部分は興味がある人だけ開いて読んでください.</p>
<div class="note">
<ul>
<li>Voidの利用例 開く/閉じる</li>
</ul>
<p><code>Void</code>型を利用したコードを記述する方法はいくつかありますが, <code>undefined</code>した実装などが良く用いられます.
<code>undefined</code>は遅延評価を利用した値で,具体的な値や式の記述を省略することができます.
未実装の部分を含めたコードを取り敢えず部分的にコンパイルしてみたい場合や, エラー処理などで利用されます.</p>
<p>以下のコードはコンパイルは通りますが,実行時には<code>undefined, called</code>エラーが発生します.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ot">somFunc ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>someFunc <span class="ot">=</span> <span class="fu">undefined</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="fu">print</span> <span class="op">$</span> someFunc <span class="dv">1</span></span></code></pre></div>
<p><code>Void</code>型を利用するケースは非常に限定的ですが,値が無いことを明示的に示したい場合などに利用されます.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE EmptyCase #-}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE EmptyDataDeriving #-}</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Empty</span> <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ot">head&#39; ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Empty</span> <span class="ot">-&gt;</span>  a</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>head&#39; []     e <span class="ot">=</span> <span class="kw">case</span> e <span class="kw">of</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>head&#39; (x<span class="op">:</span>[]) _ <span class="ot">=</span> x</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>head&#39; (x<span class="op">:</span>xs) _ <span class="ot">=</span> x</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="fu">print</span> <span class="op">$</span> head&#39; ([]<span class="ot">::</span>[<span class="dt">Int</span>]) <span class="fu">undefined</span> <span class="co">-- &gt;&gt;&gt; undefined, called at</span></span></code></pre></div>
<p>このコードでは, 明示的に<code>先頭の値</code>が存在しないことを<code>Empty</code>で表し,<code>EmptyDataDeriving</code>拡張で<code>undefined</code>を評価することでエラーを発生させています.</p>
<p>しかし,こういったパターンでは,以下の<code>error</code>による実装や,後に説明する<code>Maybe型</code>を利用するほうが一般的です.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">head&#39;&#39; ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span>  a</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>head&#39;&#39; []     <span class="ot">=</span> <span class="fu">error</span> <span class="st">&quot;Empty List&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>head&#39;&#39; (x<span class="op">:</span>[]) <span class="ot">=</span> x</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>head&#39;&#39; (x<span class="op">:</span>xs) <span class="ot">=</span> x</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="fu">print</span> <span class="op">$</span> head&#39;&#39; ([]<span class="ot">::</span>[<span class="dt">Int</span>]) <span class="co">-- practice: Empty List error, called at</span></span></code></pre></div>
</div>
<p>単一の要素だけが存在するデータ型として<code>Unit</code>型も準備されており,<code>()</code>のような空のタプルとして表されます.</p>
<p>集合の表記法には，外延的表記及び内包的表記という2通りが存在する．外延的表記とは，集合Sに含まれる要素を全て記述する方法で，x,yを要素とする集合を，
S={x,y}
と書く．集合には順番は関係ないため，{x,y}={y,z}である．また，一つの集合に同じ要素は2つ以上属することができず，{x,x}のような集合は定義できない．</p>
<p>内包的表記とは，その集合に何が属するのかを定義する方法で集合Sに属する要素の集合をｘとすると，ｘがどの集合の要素であるか，どのような条件を持つかなどによって表記する．xの属する集合をX，条件式p(x)とすると，内包的表記では
S={x│x∈ X,p(x)}
と書かれる．また，内包表記において，関数や定数を定義することも許されており，
関数をf[x]で表すと，
S={f(x)|x∈X,f(x)=x+1}
のように表記される．
条件の例として，R<sup>+を非負の実数としたとき，R</sup>+５以下の非負の実数を，以下のように書く．
{x|x∈R^+,x≤5}
集合には，集合が属することも可能で，集合SがTに属するときS∈ Tが成り立つ．
また，集合Sの要素を幾つか取り出した集合TをSの部分集合といい，
T⊂S
と表記される．
S={x,y,z}のとき，Sの部分集合は
{x},{x,y},{x,z},{z,y},{x,y,z},ϕ
となる．任意の集合Sに対して
ϕ⊂S
は成り立つ．
また，集合Sの部分集合全体の集合を冪集合といい，pow[S]または2^S と書く．
pow[{x,y,z}]={{x},{x,y},{x,z},{z,y},{x,y,z},ϕ}</p>
<h2 data-number="1.3" id="型注釈と関数"><span class="header-section-number">1.3</span> 型注釈と関数</h2>
<h3 data-number="1.3.1" id="内包表記"><span class="header-section-number">1.3.1</span> 内包表記</h3>
<h2 data-number="1.4" id="包含"><span class="header-section-number">1.4</span> 包含</h2>
<h2 data-number="1.5" id="積と和"><span class="header-section-number">1.5</span> 積と和</h2>
<h1 data-number="2" id="代数とクラス"><span class="header-section-number">2</span> 代数とクラス</h1>
<h2 data-number="2.1" id="マグマ"><span class="header-section-number">2.1</span> マグマ</h2>
<h2 data-number="2.2" id="半群"><span class="header-section-number">2.2</span> 半群</h2>
<h2 data-number="2.3" id="モノイド"><span class="header-section-number">2.3</span> モノイド</h2>
<h2 data-number="2.4" id="群"><span class="header-section-number">2.4</span> 群</h2>
<h2 data-number="2.5" id="リスト"><span class="header-section-number">2.5</span> リスト</h2>
<h2 data-number="2.6" id="ツリー"><span class="header-section-number">2.6</span> ツリー</h2>
<h2 data-number="2.7" id="ネットワーク"><span class="header-section-number">2.7</span> ネットワーク</h2>
<h1 data-number="3" id="発展交換代数"><span class="header-section-number">3</span> 発展:交換代数</h1>
<p>yakagika</p>
]]></description>
    <pubDate>Fri, 18 Oct 2024 00:00:00 UT</pubDate>
    <guid>/lectures/iap5.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>
<item>
    <title>代数プログラミング入門 Ch2 環境構築</title>
    <link>/lectures/iap2.html</link>
    <description><![CDATA[<div class="toc"><div class="header">Table of Contents</div>
<ul>
<li><a href="#haskellセットアップ" id="toc-haskellセットアップ"><span class="toc-section-number">1</span> Haskellセットアップ</a>
<ul>
<li><a href="#環境構築" id="toc-環境構築"><span class="toc-section-number">1.1</span> 環境構築</a></li>
<li><a href="#hello-world" id="toc-hello-world"><span class="toc-section-number">1.2</span> Hello World</a></li>
</ul></li>
</ul>
</div>
<h1 data-number="1" id="haskellセットアップ"><span class="header-section-number">1</span> Haskellセットアップ</h1>
<p>言語の特徴や意味を色々と説明してきましたが,習うより慣れろということで,そろそろHaskellを利用してみましょう.Haskellの開発環境には様々なものがありますが,現在良く使われているものとして<a href="https://www.haskell.org/cabal/"><code>Cabal</code></a> + <a href="https://www.haskell.org/ghcup/"><code>GHCup</code></a>あるいは<a href="https://docs.haskellstack.org/en/stable/"><code>Stack</code></a>の2つがあります. CabalとStackはプロジェクトのビルドを行うためのアーキテクチャであり,GHCupは周辺環境のインストーラーです. どちらで開発を行ってもいいのですが,本稿では<code>Stack</code>を用います.</p>
<p>Stackは現在のHaskellの標準的なコンパイラである,<code>Glasgow Haskell Compiler（GHC）</code>に基づいたビルド環境です(cabalもGHCですが). 他の言語と同様にHaskellでも様々なpackage(ライブラリ)を利用するのですが,package毎に他のpackageや,GHC(Haskellのコンパイラ)との依存関係があります.それらを使用するpackage事に調整することが人間には至難の業であり, 特定のpackageの依存関係を満たせば他のpackageの依存関係が満たされなくなるという試行錯誤を永遠と繰り返すことを<code>cabal hell</code>などと呼びます.</p>
<p>Stackにはそのようなpackage間の依存関係を満たすバージョンの組み合わせ(<code>resolver</code>)を利用して,自動で解決してくれる機能があり,Haskellでのブロジェクトの開発を容易にしてくれます. resolverの集まりを<a href="https://www.stackage.org"><code>Stackage</code></a>といい, resolverで扱われるpackageをまとめて管理するレポジトリのことを<a href="https://hackage.haskell.org"><code>Hackage</code></a>といいます.</p>
<h2 data-number="1.1" id="環境構築"><span class="header-section-number">1.1</span> 環境構築</h2>
<p>Stackの環境構築の方法は基本的には,<a href="https://docs.haskellstack.org/en/stable/">公式サイト</a>に従ってください. 使用しているOS毎にインストール方法が異なるので注意しましょう特にMacユーザーはIntel Mac と Apple silliconでインストール方法が異なるので正しい方を選択するようにしてください.</p>
<p>インストールが終わったら,以下のコマンドでstackを最新版にupgradeします.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> upgrade</span></code></pre></div>
<p>次に,開発用のディレクトリに移動して,開発用のプロジェクトを作成していきます. Stackでは,新しいプロジェクトの作成は<code>stack new [project-name]</code> コマンドで行われます. <code>stack new [project-name]</code>コマンドで新しいプロジェクトを作成すると,必要なファイルが含まれた<code>[project-name]</code>という名前のディレクトリが作成されます. 作成されたディレクトリに移動しましょう.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> stack <span class="ex">new</span> hello-world</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ls</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">hello-world</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> cd <span class="ex">hello-world</span></span></code></pre></div>
<p>作成されたディレクトリの構成は以下のようになっています.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> tree</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> CHANGELOG.md</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> LICENSE</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> README.md</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> Setup.hs</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> app</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> ├── hello.hs</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> hello-world.cabal</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> package.yaml</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> src</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="ex">│  </span> └── Lib.hs</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> stack.yaml</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> test</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">└──</span> Spec.hs</span></code></pre></div>
<p>それぞれの用途と意味は以下のとおりです.</p>
<div class="note">
<ul>
<li><p><code>app</code>フォルダの中には,実行可能ファイル用のプログラム</p>
<ul>
<li><p>プロジェクトをbuildすると,<code>Main.hs</code>から実行可能ファイル(executable)が生成されます</p></li>
<li><p>この後,<code>Main.hs</code>の中身を編集して<code>Hello World</code>用のプログラムを作成します.</p></li>
</ul></li>
</ul>
<hr />
<ul>
<li><p><code>src</code>フォルダ内には,実行可能ファイルで利用するライブラリが格納されます.</p>
<ul>
<li>ここに自分で開発したライブラリを含めることも可能です.</li>
</ul></li>
</ul>
<hr />
<ul>
<li><p><code>package.yaml</code>ファイルはプロジェクトの設定を記入するファイルです.</p>
<ul>
<li><p>Hackageなどの外部のライブラリを利用する場合には,<code>package.yaml</code>内の<code>dependencies:</code>部分に,使用したいライブラリを記述します.</p></li>
<li><p>Stackは<code>stack setup</code>コマンドによって,package.yaml内に記述されたライブラリの依存関係を解決するresolverを自動で選択しますが,
自分で使いたいresolverを<code>package.yaml</code>内の<code>resolver:</code>に続けて書くことで,指定することも可能です.</p></li>
<li><p>その他実行可能ファイルの設定や,コンパイルオプションなどを指定することができます.</p></li>
<li><p><code>package.yaml</code> の設定に従って,プロジェクトの設定ファイル <code>test.cabal</code>が自動で作成されます.
基本的にstackを使っている範囲では<code>.cabal</code>ファイルを自分で編集することはありません.</p></li>
</ul></li>
</ul>
<hr />
<ul>
<li><p><code>stack.yaml</code>ファイルは,stackの設定を記入します</p>
<ul>
<li>resolverに含まれないライブラリ(自分のGitHub上にあるライブラリなど)を指定する,あるいはあえてresolverとは異なるバージョンを利用するときなどには
<code>extra-deps:</code>に続けて,使用したいライブラリのレポジトリやバージョンを明示します.</li>
</ul></li>
</ul>
</div>
<p>これらの利用法は,今後ライブラリを使用し始めたときに改めて学習すれば大丈夫なので,取り敢えずプログラムを作成してきましょう.</p>
<h2 data-number="1.2" id="hello-world"><span class="header-section-number">1.2</span> Hello World</h2>
<p>環境構築が上手くできているかを確認するために,<code>Hello World</code>用のプログラムを作成してみましょう.</p>
<p>まずは,<code>app/Main.hs</code>をテキストエディタで開いて編集します.</p>
<p><code>app/Main.hs</code>を開くと,以下のようなファイルになっているかと思います. Haskellのプログラムをコンパイルした実行可能ファイルでは,<code>main =</code> 内の記述が実行されます.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> (main) <span class="kw">where</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Lib</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> someFunc</span></code></pre></div>
<p>現在は<code>sumFunc</code>という関数が実行されます. <code>sumFunc</code>は <code>import Lib</code> の記述によって, <code>src/Lib.hs</code>からimportされています. <code>src/Lib.hs</code>を開くと,</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Lib</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    ( someFunc</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">where</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ot">someFunc ::</span> <span class="dt">IO</span> ()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>someFunc <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;someFunc&quot;</span></span></code></pre></div>
<p>という風に<code>someFunc</code>が定義されています. プログラム内の <code>someFunc :: IO ()</code> は<code>someFunc</code>の型注釈です. <code>IO ()</code> というのは,標準入出力 <code>IO</code> において, アクション <code>()</code> を実行するという意味ですが,ここではそれぞれの詳細は省きます. <code>putStrLn</code> は文字列を引数にとり,標準入出力<code>IO</code>に受け取った文字列を出力するというアクション<code>()</code>を返す関数であり,ここでは,<code>"someFunc"</code>という文字列が出力されます. この<code>"someFunc"</code> 部分を <code>"Hello World"</code>に書き換えれば,Hello Worldは実行できます.関数の定義はこのあと徐々に扱いますが, someFuncは,引数を取らないので関数というよりは実際には値です.</p>
<p><code>Lib.hs</code> に<code>helloWorld</code>と出力する値<code>helloWorld</code>を追加し,全体を以下のように書き換えましょう.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Lib</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    ( someFunc</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    , helloWorld</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">where</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ot">someFunc ::</span> <span class="dt">IO</span> ()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>someFunc <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;someFunc&quot;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="ot">helloWorld ::</span> <span class="dt">IO</span> ()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>helloWorld <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;Hello World&quot;</span></span></code></pre></div>
<p><code>module Lib () where</code> はモジュール宣言で,他のプログラムから<code>import Lib</code>で,<code>src/Lib.hs</code>内に定義された関数や値などの内 <code>()</code>内に記述されたものを読み込むことができるようにします.
作成した値<code>helloWorld</code>を<code>()</code>内に<code>helloWorld</code>を追加することを忘れないようにしましょう.</p>
<p>併せて <code>app/Main.hs</code> を書き換えて,作成した<code>helloWorld</code>を実行しましょう.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> (main) <span class="kw">where</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Lib</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> helloWorld</span></code></pre></div>
<p>このプログラムをコンパイルして得られる実行可能ファイルの名前などは,<code>package.yaml</code>内で定義されています.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wall</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wcompat</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Widentities</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wincomplete-record-updates</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wincomplete-uni-patterns</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wmissing-export-lists</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wmissing-home-modules</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wpartial-fields</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> -Wredundant-constraints</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span><span class="kw">:</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at"> src</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">executables</span><span class="kw">:</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hello-world-exe</span><span class="kw">:</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">main</span><span class="kw">:</span><span class="at">                Main.hs</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at">         app</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -threaded</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -rtsopts</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -with-rtsopts=-N</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> hello-world</span></span></code></pre></div>
<p><code>ghc-options:</code> 以下の項目はghcのコンパイルオプションであり,<code>W</code>で始まるいずれのオプションもコンパイル時の<code>Warning</code>を追加するものです. これらのコンパイルオプションがあると,プログラムの品質を高めることができますが, 利用していてWarningが邪魔に感じた場合は,すべて削除しても問題ありません(
その場合は以下のように,<code>ghc-options:</code>部分を<code>#</code>でコメントアウトしてください.)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ghc-options:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at"> src</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">executables</span><span class="kw">:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hello-world-exe</span><span class="kw">:</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">main</span><span class="kw">:</span><span class="at">                Main.hs</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">source-dirs</span><span class="kw">:</span><span class="at">         app</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -threaded</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -rtsopts</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> -with-rtsopts=-N</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> hello-world</span></span></code></pre></div>
<p>特に,本講義資料では,品質よりも分かりやすさを優先してできるだけシンプルな実装を紹介する他,事例としてあえて間違ったコードを入力する場面も存在します. そのままサンプルを入力すると多数のWarningが表示されることになるので,以下の説明中で登場する出力結果ではこれらのオプションはすべて切った状態のものとなっている点に留意してください.</p>
<p><code>library:</code>以下の記述で,利用するライブラリのPATH,<code>executables:</code>以下の記述で実行可能ファイルについて記述されています. ここでは, executableとして’app’フォルダ内にある’Main.hs’が’hello-world-exe’という名称でコンパイルされることが書かれています.<code>ghc-options:</code>以下は,コンパイル時のオプションを設定していますが,ここでは詳細は省略します.</p>
<p><code>Main.hs</code>以外のファイルをここに追加すれば,いくらでも実行可能ファイルは増やすことができます.</p>
<p><code>hello-world-exe</code>部分をもっと短い名前に変更することも可能です.なお生成される実行可能ファイルはMacでは<code>hello-world-exe</code>,Windowsでは<code>hello-world-exe.exe</code>になるので注意してください.</p>
<p>それでは,以下のコマンドでこのプロジェクトをbuildして,実行してみましょう.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> build</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> exec hello-world-exe</span></code></pre></div>
<p><code>stack build</code>のあと,プログラムにミスがなければ以下のように出力されるはずです(一部省略しています).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> stack build</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">hello-world</span><span class="op">&gt;</span> build <span class="er">(</span><span class="ex">lib</span> + exe<span class="kw">)</span> <span class="ex">with</span> ghc-9.6.4</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Preprocessing</span> library for hello-world-0.1.0.0..</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> library for hello-world-0.1.0.0..</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">[1</span> of 2] Compiling Lib [Source file changed]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Preprocessing</span> executable <span class="st">&#39;hello-world-exe&#39;</span> for hello-world-0.1.0.0..</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> executable <span class="st">&#39;hello-world-exe&#39;</span> for hello-world-0.1.0.0..</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[1</span> of 2] Compiling Main [Source file changed]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ex">[3</span> of 3] Linking .stack-work/dist/x86_64-osx/ghc-9.6.4/build/hello-world-exe/hello-world-exe [Objects changed]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="ex">hello-world</span><span class="op">&gt;</span> copy/register</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Registering</span> library for hello-world-0.1.0.0..</span></code></pre></div>
<p>どこかで,タイプミスなどがあると例えば以下のようなエラーが表示される可能性もあります(一部省略しています).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hello-world</span><span class="op">&gt;</span> build <span class="er">(</span><span class="ex">lib</span> + exe<span class="kw">)</span> <span class="ex">with</span> ghc-9.6.4</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Preprocessing</span> library for hello-world-0.1.0.0..</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> library for hello-world-0.1.0.0..</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Preprocessing</span> executable <span class="st">&#39;hello-world-exe&#39;</span> for hello-world-0.1.0.0..</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> executable <span class="st">&#39;hello-world-exe&#39;</span> for hello-world-0.1.0.0..</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[1</span> of 2] Compiling Main [Source file changed]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="ex">/Users/akagi/Documents/Programs/Haskell/blog/hello-world/app/Main.hs:6:8:</span> error: <span class="pp">[</span><span class="ss">GHC</span><span class="pp">-</span><span class="ss">88464</span><span class="pp">]</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Variable</span> not in scope: hellWorld :: IO <span class="er">(</span><span class="kw">)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Suggested</span> fix: Perhaps use ‘helloWorld’ <span class="er">(</span><span class="ex">imported</span> from Lib<span class="kw">)</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">|</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="ex">6</span> <span class="kw">|</span> <span class="ex">main</span> = hellWorld</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">|</span>        <span class="ex">^^^^^^^^^</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Error:</span> <span class="pp">[</span><span class="ss">S</span><span class="pp">-</span><span class="ss">7282</span><span class="pp">]</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Stack</span> failed to execute the build plan.</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>       <span class="ex">While</span> executing the build plan, Stack encountered the error:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>       <span class="ex">[S-7011]</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>       <span class="ex">While</span> building package hello-world-0.1.0.0</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Process</span> exited with code: ExitFailure 1</span></code></pre></div>
<p>上のエラーでは, <code>Main.hs</code>の6行目で使用されている,<code>hellWorld</code>が定義されていないという意味になります.
<code>helloWorld</code>と<code>o</code>を追加して正しい名称にしたあともう一度 <code>stack build</code>をしてみましょう.</p>
<p><code>stack exec hello-world-exe</code>の後,<code>Hello World</code>と出力されていれば成功です.</p>
<p>なお,build と exec を併せて一つのコマンド<code>stack run</code> で代替することも可能です.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> stack run hello-world-exe</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">hello-world</span><span class="op">&gt;</span> build <span class="er">(</span><span class="ex">lib</span> + exe<span class="kw">)</span> <span class="ex">with</span> ghc-9.6.4</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Preprocessing</span> library for hello-world-0.1.0.0..</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> library for hello-world-0.1.0.0..</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Preprocessing</span> executable <span class="st">&#39;hello-world-exe&#39;</span> for hello-world-0.1.0.0..</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> executable <span class="st">&#39;hello-world-exe&#39;</span> for hello-world-0.1.0.0..</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">hello-world</span><span class="op">&gt;</span> copy/register</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Registering</span> library for hello-world-0.1.0.0..</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Hello</span> World</span></code></pre></div>
]]></description>
    <pubDate>Fri, 18 Oct 2024 00:00:00 UT</pubDate>
    <guid>/lectures/iap2.html</guid>
    <dc:creator>yakagika</dc:creator>
</item>

    </channel>
</rss>
